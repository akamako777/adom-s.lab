<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mission Ctrl (Flash Edition)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Marked (Markdown Parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        accent: '#22d3ee',
                        dark: '#0f172a',
                        light: '#f8fafc',
                    },
                    animation: {
                        'speaking': 'speaking 1s infinite ease-in-out',
                        'slideUp': 'slideUp 0.4s ease-out',
                        'fadeIn': 'fadeIn 0.2s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'attention': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'gemini-glow': 'geminiGlow 4s ease-in-out infinite',
                    },
                    keyframes: {
                        speaking: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.2)', opacity: '0.7' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        geminiGlow: {
                            '0%, 100%': { 
                                filter: 'drop-shadow(0 0 2px rgba(56, 189, 248, 0.5))', 
                                color: '#38bdf8',
                                transform: 'scale(1)'
                            },
                            '50%': { 
                                filter: 'drop-shadow(0 0 8px rgba(168, 85, 247, 0.8))', 
                                color: '#a855f7',
                                transform: 'scale(1.1)'
                            },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }
        
        .dark body {
            background-color: #020617;
            color: #f8fafc;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(203, 213, 225, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Card Design */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(203, 213, 225, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-card:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        
        /* Markdown Styles */
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body ul, .markdown-body ol { margin-left: 1.2em; list-style: disc; margin-bottom: 0.5em; }
        .markdown-body ol { list-style: decimal; }
        .markdown-body strong { font-weight: 700; color: #0ea5e9; } 
        .dark .markdown-body strong { color: #38bdf8; } 
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 700; margin-top: 0.5em; margin-bottom: 0.2em; }
        .markdown-body code { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; font-family: monospace; border: 1px solid #cbd5e1; }
        .dark .markdown-body code { background: rgba(255,255,255,0.1); border: 1px solid #475569; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animated Background */
        .bg-animated {
            background: #f8fafc;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -2;
            transition: background-color 0.3s;
        }
        .dark .bg-animated {
            background: #020617;
        }
        
        /* Scanline Effect */
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            position: absolute; inset: 0; pointer-events: none; z-index: 10;
        }

        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Tooltip Styles */
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="bg-animated"></div>
    <div id="root" class="h-screen w-screen overflow-hidden"></div>

    <script type="text/babel">
        // ==========================================
        //  CONFIG & MODELS
        // ==========================================
        
        const apiKey = ""; // Canvas Auto-Auth

        // ‚òÖGemini„ÅÆURLË®≠ÂÆö
        const GEM_URL = "https://gemini.google.com/gem/1YwmlwyaTuHtZw0_nZGT5q_qG1dIlfhrb?usp=sharing";

        // Models Configuration
        const MODEL_PRIMARY = "gemini-3.0-flash-preview"; 
        const MODEL_FALLBACK = "gemini-2.5-flash-preview-09-2025";

        const getSystemPrompt = (lang) => {
            const locale = lang === 'en' ? 'en-US' : (lang === 'zh' ? 'zh-CN' : 'ja-JP');
            const now = new Date().toLocaleString(locale);

            const instructions = {
                ja: `„ÅÇ„Å™„Åü„ÅØ„ÄåÂ†¥ÊâÄ„ÅÆÁ¢∫ÂÆö„Äç„Å®„ÄåÊúÄÁü≠ÁµåË∑Ø„Äç„Å´ÁâπÂåñ„Åó„Åü„ÄÅÊúÄÂº∑„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„Éª„Éó„É©„É≥„Éä„Éº„Åß„Åô„ÄÇ
‰ª•Ââç„ÅÆ„Çà„ÅÜ„Å´ÊôÇÈñìÈÖçÂàÜ„ÇíÁ¥∞„Åã„ÅèË®àÁÆó„Åô„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ**„ÄåÁ¢∫ÂÆü„Å™Â†¥ÊâÄ„ÅÆÁâπÂÆö„Äç**„Å®**„Äå‰∫∫Èñì„ÅåÊúÄ„ÇÇÂäπÁéá„Çà„ÅèÁßªÂãï„Åß„Åç„ÇãÊúÄÁü≠„É´„Éº„ÉàÈ†Ü„Äç**„ÅÆÊßãÁØâ„ÇíÊúÄÂÑ™ÂÖà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÈáçË¶ÅÔºöÊßãÈÄ†Âåñ„Éá„Éº„Çø„ÅÆË™≠„ÅøÂèñ„Çä„Äë
„É¶„Éº„Ç∂„Éº„Åå„ÄåË°®ÂΩ¢Âºè„ÅÆ„Éá„Éº„ÇøÔºàMarkdown„ÅÆË°®„ÇÑExcel„Åã„Çâ„Ç≥„Éî„Éº„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„ÉàÔºâ„Äç„ÇíÂÖ•Âäõ„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÈ†ÜÂ∫è„Å®ÂÜÖÂÆπ„ÇíÂ∞äÈáç„Åó„ÄÅÊ≠£Á¢∫„Å´JSON„Éá„Éº„Çø„Å∏Â§âÊèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Äê„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤„Äë
1. **Â†¥ÊâÄ„ÅÆÁ¢∫ÂÆö (ÊúÄÂÑ™ÂÖà):** „É¶„Éº„Ç∂„Éº„ÅÆÂÖ•ÂäõÔºàÂ∫óÂêç„ÇÑÂú∞ÂêçÔºâ„Åã„Çâ„ÄÅÊ≠£Á¢∫„Å™Â†¥ÊâÄ„Éª‰ΩèÊâÄ„ÇíÁâπÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
2. **ÊúÄÁü≠„É´„Éº„ÉàÊßãÁØâ:** Âú∞ÁêÜÁöÑ„Å´ÁÑ°ÈßÑ„ÅÆ„Å™„ÅÑÈ†ÜÁï™„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
3. **ÊèêÊ°à:** ÂøÖË¶Å„Å´Âøú„Åò„Å¶„ÄÅ„É´„Éº„Éà‰∏ä„Å´„ÅÇ„Çã‰æøÂà©„Å™„Éõ„ÉÜ„É´„ÇÑÊñΩË®≠„ÇÇÊèêÊ°à„Å´Âê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊúÄÈáçË¶ÅÁ¶ÅÊ≠¢‰∫ãÈ†Ö„Äë
1. **IDÈáçË§á„ÅÆÂÆåÂÖ®Á¶ÅÊ≠¢:** „Åü„Å®„ÅàÂêå„ÅòÂ†¥ÊâÄÔºà„Éõ„ÉÜ„É´„ÇÑÈßÖ„Å™„Å©Ôºâ„Å´Ë§áÊï∞ÂõûÁ´ã„Å°ÂØÑ„Çã„Éó„É©„É≥„Åß„ÅÇ„Å£„Å¶„ÇÇ„ÄÅ**Ë®™Âïè„Çø„Ç§„Éü„É≥„Ç∞„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÅØ„ÄÅÂøÖ„Åö„É¶„Éã„Éº„ÇØ„Å™ID„ÇíÂâ≤„ÇäÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑ**Ôºà‰æã: ID 5 „Å® ID 14Ôºâ„ÄÇÂêå„ÅòID„Çí‰Ωø„ÅÑÂõû„Åô„Å®„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„Å´„Å™„Çä„Åæ„Åô„ÄÇ
2. **„Çπ„ÉÜ„Éº„Çø„ÇπÁ∂≠ÊåÅ:** „É¶„Éº„Ç∂„Éº„Å®„ÅÆ‰ºöË©±Â±•Ê≠¥ÂÜÖ„Åß„ÄÅÊó¢„Å´ status: "completed" „Å´„Å™„Å£„Å¶„ÅÑ„ÇãÈ†ÖÁõÆ„ÅØ„ÄÅ‰ªäÂõû„ÅÆÂá∫Âäõ„Åß„ÇÇÂøÖ„Åö "completed" „ÅÆ„Åæ„ÅæÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂãùÊâã„Å´Êú™ÂÆå‰∫Ü„Å´Êàª„Åï„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÁ¶ÅÊ≠¢‰∫ãÈ†Ö„Äë
1. **ÁßªÂãïÊôÇÈñì„ÅÆË®àÁÆóÁ¶ÅÊ≠¢:** ‰∫§ÈÄöÁä∂Ê≥Å„ÅØÂ§âÂåñ„Åô„Çã„Åü„ÇÅ„ÄÅÁßªÂãïÊôÇÈñì„ÅÆ‰∫àÊ∏¨„ÅØË°å„Çè„Åö„ÄÅGoogle„Éû„ÉÉ„Éó„Å´Âßî„Å≠„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
2. **Êû∂Á©∫„ÅÆ‰ΩèÊâÄÁ¶ÅÊ≠¢:** ÂÆüÂú®„ÅåÊÄ™„Åó„ÅÑÂ†¥ÊâÄ„ÅØ„ÄÅÂøÖ„Åö note „Å´„Äå‚ö†Ô∏èË¶ÅÁ¢∫Ë™ç„Äç„Å®Ë®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÂá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Äë
‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„Åß„Éá„Éº„Çø„ÇíÂá∫Âäõ„Åó„ÄÅ„Åù„ÅÆÂæå„ÄÅÁ∞°Âçò„Å™Ë£úË∂≥Ë™¨Êòé„ÇíMarkdown„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
\`\`\`json
{
  "route": [
    { 
      "id": 1, 
      "name": "Ê≠£ÂºèÂêçÁß∞", 
      "address": "‰ΩèÊâÄ„Åæ„Åü„ÅØGoogle„Éû„ÉÉ„ÉóÊ§úÁ¥¢Áî®„Ç≠„Éº„ÉØ„Éº„Éâ", 
      "note": "„ÉØ„É≥„Éù„Ç§„É≥„Éà„É°„É¢ÔºàÂÆö‰ºëÊó•„ÇÑÁâπÂæ¥„Å™„Å©Ôºâ",
      "status": "pending" 
    },
    ...
  ]
}
\`\`\`
`,
                en: `You are the ultimate Mission Planner, specializing in "Location Confirmation" and "Shortest Paths".
When the user provides tabular data (Markdown table or pasted Excel text), respect its content and order, and convert it accurately into JSON.

[CRITICAL RULES]
1. **NO DUPLICATE IDs:** Even if the route visits the same location multiple times (e.g., Hotel -> Ski -> Hotel), you MUST assign a **UNIQUE ID** for each visit (e.g., ID 5 and ID 14). Reusing IDs causes system crashes.
2. **Preserve Status:** If an item is already marked as status: "completed" in the context, you MUST keep it as "completed". Do not revert it to pending.

[Your Role]
1. **Identify Locations (Top Priority):** Identify exact locations/addresses from user input.
2. **Build Shortest Route:** Propose a geographically efficient order.
3. **Suggestion:** Suggest convenient hotels or facilities along the route if necessary.

[Output Format]
Output data in the following JSON format, followed by a brief Markdown explanation.
\`\`\`json
{
  "route": [
    { "id": 1, "name": "Name", "address": "Address or Search Keyword", "note": "Memo", "status": "pending" },
    ...
  ]
}
\`\`\`
`,
            };

            const commonPrompt = `
„ÄêContext Info„Äë
Current Time: ${now}
Answer in the user's selected language (${lang}).
`;
            return (instructions[lang] || instructions.ja) + commonPrompt;
        };

        // ==========================================
        //  Hooks & Utilities
        // ==========================================
        const { useState, useEffect, useRef } = React;

        const translations = {
            ja: {
                title: "Mission Ctrl",
                placeholder: "ÁõÆÁöÑÂú∞„ÇíÂÖ•Âäõ„ÄÅ„Åæ„Åü„ÅØGem„ÅÆÂá∫ÂäõË°®„ÇíË≤º„Çä‰ªò„Åë...",
                location: "ÁèæÂú®Âú∞ÂÖ•Âäõ",
                ctrlEnter: "Ctrl+Enter„ÅßÈÄÅ‰ø°",
                tabChat: "„ÉÅ„É£„ÉÉ„Éà",
                tabMap: "„É´„Éº„ÉàÁ¢∫Ë™ç",
                listTitle: "Mission List",
                noRoute: "„Åì„Åì„Å´„É´„Éº„Éà„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô",
                startNavi: "„Éä„ÉìÈñãÂßã",
                fullMap: "ÂÖ®„É´„Éº„Éà",
                fullMapTooltip: "ÂÖ®„Å¶„ÅÆÁõÆÁöÑÂú∞„ÇíÂê´„Çì„Å†Âú∞Âõ≥„ÇíË°®Á§∫",
                map: "Google„Éû„ÉÉ„Éó",
                now: "NOW",
                done: "DONE",
                export: "‰øùÂ≠ò",
                import: "Âæ©ÂÖÉ",
                print: "Âç∞Âà∑ / PDF",
                backupTitle: "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó",
                errorTitle: "„Ç®„É©„Éº",
                warnTitle: "Ê≥®ÊÑè",
                successTitle: "ÊàêÂäü",
                geoNotSupported: "„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ",
                geoLocating: "ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠...",
                geoSuccessPrefix: "[ÁèæÂú®Âú∞:",
                geoFailed: "ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
                networkError: "ÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",
                popupBlocked: "„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                downloadComplete: "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ",
                restoreComplete: "„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü„ÄÇ",
                invalidFormat: "‰∏çÊ≠£„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇ",
                loadFailed: "„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",
                deletedMsg: "„Çí„É™„Çπ„Éà„Åã„ÇâÂ§ñ„Åó„Åæ„Åó„ÅüÔºÅ",
                langTooltip: "Ë®ÄË™ûÂàá„ÇäÊõø„Åà",
                themeTooltip: "ËÉåÊôØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà",
                backupTooltip: "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó (‰øùÂ≠ò/Âæ©ÂÖÉ)",
                settingsTooltip: "APIË®≠ÂÆö",
                geminiTooltip: "ÊúÄÂº∑„Éó„É©„É≥„Éä„Éº(Gem)„ÇíÈñã„Åè",
                generatingReport: "„Éü„ÉÉ„Ç∑„Éß„É≥„Éª„Éñ„É™„Éº„Éï„Ç£„É≥„Ç∞(ÊóÖ„ÅÆ„Åó„Åä„Çä)„Çí‰ΩúÊàê‰∏≠...",
                searchNearby: "Âë®Ëæ∫Ê§úÁ¥¢",
                attachTooltip: "ÁîªÂÉè/PDF„ÇíÊ∑ª‰ªò",
                voiceTooltip: "Èü≥Â£∞ÂÖ•Âäõ",
                sendTooltip: "ÈÄÅ‰ø°",
                fileSizeError: "„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô (ÊúÄÂ§ß 10MB)",
                settingsTitle: "API Settings",
                apiKeyLabel: "Your Google Gemini API Key",
                apiKeyPlaceholder: "Enter your API Key here...",
                saveSettings: "‰øùÂ≠ò„Åô„Çã",
                resetTooltip: "„É™„Çª„ÉÉ„Éà",
                resetConfirm: "„ÄêË≠¶Âëä„Äë\nÁèæÂú®„ÅÆ‰ºöË©±Â±•Ê≠¥„Å®„É´„Éº„ÉàÊÉÖÂ†±„Çí„Åô„Åπ„Å¶Ê∂àÂéª„Åó„Å¶„ÄÅÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„ÄÇ\n„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
                resetComplete: "„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ",
                cancel: "„Ç≠„É£„É≥„Çª„É´",
                execute: "ÂÆüË°å„Åô„Çã",
                deleteConfirm: "‰ª•‰∏ã„ÅÆÈ†ÖÁõÆ„Çí„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n",
                completedLog: "‚úÖ ÂÆå‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü„ÄÇ",
                pendingLog: "‚Ü©Ô∏è Êú™ÂÆå‰∫Ü„Å´Êàª„Åó„Åæ„Åó„Åü„ÄÇ",
                deletedLog: "üóëÔ∏è „É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ",
                analyzing: "Ëß£Êûê‰∏≠...",
                fallbackMsg: "‚ÄªÊ®ôÊ∫ñ„É¢„Éá„É´„ÅßÂÜçÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇ",
            },
            en: {
                title: "Mission Ctrl",
                placeholder: "Enter destinations or paste table from Gem...",
                location: "Current Loc",
                ctrlEnter: "Ctrl+Enter to send",
                tabChat: "Chat",
                tabMap: "Map Route",
                listTitle: "Mission List",
                noRoute: "Route will appear here",
                startNavi: "Start Navi",
                fullMap: "Full Map",
                fullMapTooltip: "Show map with all destinations",
                map: "Google Map",
                now: "NOW",
                done: "DONE",
                export: "Export",
                import: "Import",
                print: "Print / PDF",
                backupTitle: "Backup",
                errorTitle: "Error",
                warnTitle: "Warning",
                successTitle: "Success",
                geoNotSupported: "Geolocation is not supported by your browser.",
                geoLocating: "Locating...",
                geoSuccessPrefix: "[Location:",
                geoFailed: "Failed to get location.",
                networkError: "Network error.",
                popupBlocked: "Popup blocked. Please check settings.",
                downloadComplete: "Backup saved.",
                restoreComplete: "Data restored.",
                invalidFormat: "Invalid file format.",
                loadFailed: "Failed to load file.",
                deletedMsg: "removed from list!",
                langTooltip: "Language",
                themeTooltip: "Toggle Theme",
                backupTooltip: "Backup (Export/Import)",
                settingsTooltip: "Settings",
                geminiTooltip: "Open Ultimate Planner (Gem)",
                generatingReport: "Generating Mission Briefing...",
                searchNearby: "Search Nearby",
                attachTooltip: "Attach Image/PDF",
                voiceTooltip: "Voice Input",
                sendTooltip: "Send",
                fileSizeError: "File too large (Max 10MB)",
                settingsTitle: "Settings",
                apiKeyLabel: "Your Google Gemini API Key",
                apiKeyPlaceholder: "Enter your API Key here...",
                saveSettings: "Save",
                resetTooltip: "Reset",
                resetConfirm: "[Warning]\nThis will clear all chat history and route data.\nAre you sure?",
                resetComplete: "Reset complete.",
                cancel: "Cancel",
                execute: "Execute",
                deleteConfirm: "Remove this item from list?\n",
                completedLog: "‚úÖ Marked as completed.",
                pendingLog: "‚Ü©Ô∏è Marked as pending.",
                deletedLog: "üóëÔ∏è Removed from list.",
                analyzing: "Analyzing...",
                fallbackMsg: "* Re-executed with standard model.",
            }
        };

        const useSpeechRecognition = (lang) => {
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState("");
            const recognitionRef = useRef(null);

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = lang === 'en' ? 'en-US' : (lang === 'zh' ? 'zh-CN' : 'ja-JP');
                    recognition.interimResults = false;
                    recognition.onstart = () => setIsListening(true);
                    recognition.onend = () => setIsListening(false);
                    recognition.onresult = (event) => {
                        const text = event.results[0][0].transcript;
                        setTranscript(text);
                    };
                    recognitionRef.current = recognition;
                }
            }, [lang]);

            const startListening = () => {
                if (recognitionRef.current) {
                    try { recognitionRef.current.start(); } catch(e) { console.log("Already started"); }
                } else {
                    alert("Speech API not supported");
                }
            };

            return { isListening, transcript, startListening, setTranscript };
        };

        const Modal = ({ isOpen, title, message, onClose, type = "info" }) => {
            if (!isOpen) return null;
            const typeStyles = {
                info: "from-blue-600 to-indigo-600",
                error: "from-red-600 to-pink-700",
                warn: "from-amber-500 to-orange-600",
                success: "from-emerald-600 to-teal-600"
            };
            const iconStyles = {
                info: "text-indigo-600 dark:text-indigo-300",
                error: "text-red-600 dark:text-red-400",
                warn: "text-amber-600 dark:text-amber-400",
                success: "text-emerald-600 dark:text-emerald-400"
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-1 rounded-2xl shadow-2xl max-w-sm w-full">
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-6 relative overflow-hidden">
                            <h3 className={`text-xl font-bold mb-2 flex items-center gap-2 relative z-10 ${iconStyles[type]}`}>
                                <i className={`fas fa-${type === 'error' ? 'exclamation-triangle' : (type === 'success' ? 'check-circle' : 'info-circle')}`}></i>
                                {title}
                            </h3>
                            <p className="text-slate-700 dark:text-slate-200 mb-6 relative z-10 text-sm leading-relaxed whitespace-pre-line font-medium">{message}</p>
                            <button onClick={onClose} className={`w-full py-2.5 rounded-lg font-bold text-white bg-gradient-to-r ${typeStyles[type]} shadow-md hover:shadow-lg transition-all`}>OK</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onCancel, onConfirm, texts, isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-1 rounded-2xl shadow-2xl max-w-sm w-full">
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-6 relative overflow-hidden">
                            <h3 className={`text-xl font-bold mb-2 flex items-center gap-2 relative z-10 ${isDanger ? 'text-red-600 dark:text-red-400' : 'text-indigo-600 dark:text-indigo-400'}`}>
                                <i className={`fas fa-${isDanger ? 'exclamation-triangle' : 'question-circle'}`}></i>
                                {title}
                            </h3>
                            <p className="text-slate-700 dark:text-slate-200 mb-6 relative z-10 text-sm leading-relaxed whitespace-pre-line font-medium">{message}</p>
                            <div className="flex gap-3 relative z-10">
                                <button onClick={onCancel} className="flex-1 py-2.5 rounded-lg font-bold text-slate-600 dark:text-slate-300 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-all">{texts.cancel}</button>
                                <button onClick={onConfirm} className={`flex-1 py-2.5 rounded-lg font-bold text-white shadow-md hover:shadow-lg transition-all ${isDanger ? 'bg-gradient-to-r from-red-600 to-pink-700' : 'bg-gradient-to-r from-indigo-600 to-blue-600'}`}>{texts.execute}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CooldownOverlay = ({ cooldown, isLoading, showOverlay, t }) => {
            // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫Êù°‰ª∂: „É≠„Éº„Éâ‰∏≠„Åã„Å§showOverlay„ÅåTrue„ÄÅ„Åæ„Åü„ÅØCooldown‰∏≠
            if ((!isLoading || !showOverlay) && cooldown === 0) return null;
            if (!showOverlay && isLoading) return null; // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂá¶ÁêÜ‰∏≠„ÅØÂá∫„Åï„Å™„ÅÑ

            return (
                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex flex-col items-center justify-center text-center p-4">
                    <div className="scanlines"></div>
                    <div className="relative z-20 max-w-md w-full">
                        {cooldown > 0 ? (
                            <div className="animate-[pulse-slow]">
                                <h2 className="text-3xl font-black text-amber-500 mb-2 tracking-widest uppercase gltich-effect" style={{fontFamily: 'monospace'}}>
                                    <i className="fas fa-triangle-exclamation mr-3"></i>
                                    {t.cooldownTitle}
                                </h2>
                                <p className="text-amber-200 mb-8 font-mono text-sm uppercase tracking-wider">{t.cooldownMsg}</p>
                                <div className="text-8xl font-black text-white mb-8 font-mono tabular-nums tracking-tighter">
                                    {cooldown}<span className="text-2xl text-amber-500 ml-1">s</span>
                                </div>
                                <div className="w-full bg-amber-900/50 h-2 rounded-full overflow-hidden border border-amber-800">
                                    <div className="h-full bg-amber-500 transition-all duration-1000 ease-linear" style={{width: `${(cooldown / 35) * 100}%`}}></div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center">
                                <div className="relative w-24 h-24 mb-6">
                                    <div className="absolute inset-0 border-4 border-indigo-500/30 rounded-full"></div>
                                    <div className="absolute inset-0 border-4 border-t-indigo-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
                                    <div className="absolute inset-4 border-4 border-cyan-400/30 rounded-full"></div>
                                    <div className="absolute inset-4 border-4 border-t-cyan-400 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin" style={{animationDirection: 'reverse', animationDuration: '1.5s'}}></div>
                                </div>
                                <h2 className="text-2xl font-bold text-white tracking-widest animate-pulse">{t.analyzing}</h2>
                                <p className="text-indigo-300 mt-2 font-mono text-xs">AI AGENT WORKING...</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, t, userApiKey, onApiKeyChange, onSave }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-1 rounded-2xl shadow-2xl max-w-md w-full">
                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-6 relative">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-200">
                                <i className="fas fa-cog text-slate-400"></i> {t.settingsTitle}
                            </h3>
                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">{t.apiKeyLabel}</label>
                                    
                                    {/* API Key Input Field */}
                                    <input 
                                        type="password" 
                                        value={userApiKey}
                                        onChange={(e) => onApiKeyChange(e.target.value)}
                                        placeholder={t.apiKeyPlaceholder}
                                        className="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-800 dark:text-slate-200 focus:outline-none focus:border-indigo-500 transition-colors"
                                    />

                                    <p className="text-[10px] text-slate-400 mt-2">
                                        * Using optimized Flash models (Auto-Selection: v3.0 / v2.5)<br/>
                                        * Your key is stored locally in your browser.
                                    </p>
                                    
                                    {/* ‚òÖ‰øÆÊ≠£„Éù„Ç§„É≥„Éà1: AI Studio„Å∏„ÅÆ„É™„É≥„ÇØËøΩÂä† */}
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-xs text-indigo-500 hover:underline block mt-2 flex items-center gap-1">
                                        <i className="fas fa-external-link-alt"></i> Get API Key here (Google AI Studio)
                                    </a>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => { onSave(); onClose(); }} className="flex-1 py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition-colors">{t.saveSettings}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ------------------------------------------
        //  Main App Component
        // ------------------------------------------
        const App = () => {
            const [input, setInput] = useState("");
            const [activeTab, setActiveTab] = useState("chat");
            // ‚òÖ‰øÆÊ≠£„Éù„Ç§„É≥„Éà2: ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ§âÊõ¥
            const [messages, setMessages] = useState([
                { role: "model", text: "„Åì„Çì„Å´„Å°„ÅØÔºÅ„Éü„ÉÉ„Ç∑„Éß„É≥„Éª„Ç≥„É≥„Ç∑„Çß„É´„Ç∏„É•ÔºàFlash EditionÔºâ„Åß„Åô‚ú®\n\n„ÇÇ„Åó‰∏Ä„Åã„Çâ„Éó„É©„É≥„ÇíËÄÉ„Åà„Åü„ÅÑÊñπ„ÅØ„ÄÅ‰∏ä„ÅÆ**Gem„Éú„Çø„É≥**„Åã„Çâ„Éó„É©„É≥‰ΩúÊàêÂèØËÉΩ„Åß„Åô„ÄÇ\n‰ΩúÊàê„Åó„Åü„É´„Éº„ÉàË°®„Çí„ÄÅ„Åì„Å°„Çâ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„ÇÇ„Å°„Çç„Çì„ÄÅÂ∑°Âõû„Åó„Åü„ÅÑÂ†¥ÊâÄ„ÇíÁõ¥Êé•ÂÖ•Âäõ„Åó„Å¶„ÇÇOK„Åß„ÅôÔºÅ" }
            ]);
            const [routeData, setRouteData] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [showOverlay, setShowOverlay] = useState(true); // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫Âà∂Âæ°Áî®
            const [modal, setModal] = useState({ isOpen: false, title: "", message: "", type: "info" });
            const chatEndRef = useRef(null);
            
            // API Key State (Persisted in localStorage)
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('missionCtrlApiKey') || "");

            // Initialization Handshake
            const [history, setHistory] = useState([{ role: "user", parts: [{ text: "Start" }] }]);
            
            const [darkMode, setDarkMode] = useState(true);
            const [lang, setLang] = useState('ja'); 
            const [showSettings, setShowSettings] = useState(false);
            
            const [confirmDialog, setConfirmDialog] = useState({
                isOpen: false, title: "", message: "", actionType: "", payload: null, isDanger: false
            });

            const [attachment, setAttachment] = useState(null); 
            const fileInputRef = useRef(null);
            const [openMenu, setOpenMenu] = useState(null); 
            const [cooldown, setCooldown] = useState(0); 

            const t = translations[lang];
            const { isListening, transcript, startListening, setTranscript } = useSpeechRecognition(lang);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (!e.target.closest('.menu-container')) {
                        setOpenMenu(null);
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            useEffect(() => {
                if (transcript) {
                    setInput(prev => (prev ? prev + " " : "") + transcript);
                    setTranscript("");
                }
            }, [transcript]);

            useEffect(() => {
                if (activeTab === 'chat') {
                    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages, activeTab]);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // Save API Key
            const handleSaveSettings = () => {
                localStorage.setItem('missionCtrlApiKey', userApiKey);
            };

            const handleLangChange = (newLang) => {
                setLang(newLang);
                setOpenMenu(null); 
            };

            const handleResetRequest = () => {
                setConfirmDialog({
                    isOpen: true,
                    title: t.warnTitle,
                    message: t.resetConfirm,
                    actionType: 'RESET',
                    payload: null,
                    isDanger: true
                });
            };

            const handleDeleteRequest = (id, name) => {
                setConfirmDialog({
                    isOpen: true,
                    title: t.warnTitle,
                    message: `${t.deleteConfirm}"${name}"`,
                    actionType: 'DELETE',
                    payload: { id, name },
                    isDanger: true
                });
            };

            const executeConfirmAction = () => {
                const { actionType, payload } = confirmDialog;
                if (actionType === 'RESET') {
                    setMessages([
                        { role: "model", text: "„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑÁõÆÁöÑÂú∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" }
                    ]);
                    setRouteData([]);
                    setHistory([{ role: "user", parts: [{ text: "Start" }] }]);
                    setAttachment(null);
                    setInput("");
                    setModal({ isOpen: true, title: t.successTitle, message: t.resetComplete, type: "success" });
                } else if (actionType === 'DELETE') {
                    const newRouteData = routeData.filter(item => item.id !== payload.id);
                    setRouteData(newRouteData);
                    setMessages(prev => [...prev, { role: "model", text: `${t.deletedLog} **${payload.name}**` }]);
                    
                    // Ëá™ÂãïÂÜçË®àÁÆóÔºà„Ç™„Éº„Éê„Éº„É¨„Ç§„Å™„Åó„ÅßÂÆüË°åÔºâ
                    callGemini("È†ÖÁõÆÂâäÈô§„Å´‰º¥„ÅÑ„ÄÅ„É´„Éº„Éà„ÇíÂÜçÊúÄÈÅ©Âåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", null, newRouteData, false);
                }
                setConfirmDialog({ ...confirmDialog, isOpen: false });
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 10 * 1024 * 1024) { 
                    setModal({ isOpen: true, title: t.warnTitle, message: t.fileSizeError, type: "warn" });
                    e.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64Data = event.target.result.split(',')[1];
                    const mimeType = file.type;
                    let previewUrl = null;
                    if (mimeType.startsWith('image/')) {
                        previewUrl = event.target.result;
                    }
                    setAttachment({
                        data: base64Data,
                        mimeType: mimeType,
                        name: file.name,
                        preview: previewUrl
                    });
                };
                reader.readAsDataURL(file);
                e.target.value = ''; 
            };

            const clearAttachment = () => {
                setAttachment(null);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const triggerFileSelect = () => {
                fileInputRef.current?.click();
            };

            const handleGetLocation = () => {
                if (!navigator.geolocation) {
                    setModal({ isOpen: true, title: t.warnTitle, message: t.geoNotSupported, type: "warn" });
                    return;
                }
                const originalPlaceholder = document.getElementById('main-input')?.placeholder;
                if(document.getElementById('main-input')) document.getElementById('main-input').placeholder = t.geoLocating;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setInput(prev => (prev ? prev + "\n" : "") + `${t.geoSuccessPrefix} ${latitude}, ${longitude}]`);
                        if(document.getElementById('main-input')) document.getElementById('main-input').placeholder = originalPlaceholder;
                    },
                    (error) => {
                        setModal({ isOpen: true, title: t.warnTitle, message: t.geoFailed, type: "warn" });
                        if(document.getElementById('main-input')) document.getElementById('main-input').placeholder = originalPlaceholder;
                    }
                );
            };

            // ==========================================
            //  INTELLIGENT API CALLER (No wait logic)
            // ==========================================
            // showOverlayÂºïÊï∞„ÇíËøΩÂä†Ôºö„Éá„Éï„Ç©„É´„Éàtrue„ÄÇDone/DeleteÊôÇ„ÅØfalse„Å´„Åó„Å¶„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÂá∫„Åï„Å™„ÅÑ
            const callGemini = async (userText, displayText = null, overrideRouteData = null, isOverlayVisible = true) => {
                if (isLoading) return; 
                setIsLoading(true);
                setShowOverlay(isOverlayVisible);
                
                // Use User API Key if available, otherwise use Canvas Auto-Auth Key
                const effectiveKey = userApiKey || apiKey;

                // Construct Request Payload
                const constructPayload = (text) => {
                    const currentData = overrideRouteData || routeData;
                    const currentRouteJson = JSON.stringify(currentData.map(r => ({
                        id: r.id, name: r.name, status: r.status, address: r.address
                    })));
                    const systemContext = `[System: Current Client Route State]\n${currentRouteJson}\n---\n`;
                    const effectiveUserText = currentData.length > 0 
                        ? systemContext + "User Request: " + text 
                        : text;
                    const userParts = [{ text: effectiveUserText }];
                    if (attachment) {
                        userParts.push({ inlineData: { mimeType: attachment.mimeType, data: attachment.data } });
                    }
                    return {
                        contents: [...history, { role: "user", parts: userParts }],
                        systemInstruction: { parts: [{ text: getSystemPrompt(lang) }] }
                    };
                };

                const executeRequest = async () => {
                    // 1. Try Primary Model (Gemini 3 Flash)
                    let usedModel = MODEL_PRIMARY;
                    let payload = constructPayload(userText);
                    let url = `https://generativelanguage.googleapis.com/v1beta/models/${usedModel}:generateContent?key=${effectiveKey}`;
                    
                    try {
                        let response = await fetch(url, {
                            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                        });

                        // 2. Fallback Logic: If 404/400, try Backup Model (Gemini 2.5 Flash) immediately
                        if (!response.ok) {
                            console.warn(`Primary model ${usedModel} failed (${response.status}). Switching to fallback...`);
                            usedModel = MODEL_FALLBACK;
                            url = `https://generativelanguage.googleapis.com/v1beta/models/${usedModel}:generateContent?key=${effectiveKey}`;
                            response = await fetch(url, {
                                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                            });
                            if (!response.ok) throw new Error(`Fallback model also failed: ${response.status}`);
                        }

                        const data = await response.json();
                        if (!data.candidates?.[0]) throw new Error("No response candidates.");

                        const aiTextRaw = data.candidates[0].content.parts[0].text;
                        const jsonMatch = aiTextRaw.match(/<<<JSON([\s\S]*?)JSON>>>/);
                        let displayMessage = aiTextRaw.replace(/<<<JSON[\s\S]*?JSON>>>/g, "").trim();
                        displayMessage = displayMessage.replace(/```json[\s\S]*?```/g, "").trim();

                        if (jsonMatch) {
                            try {
                                const jsonData = JSON.parse(jsonMatch[1]);
                                if (jsonData.route) {
                                    // ‚òÖ„Çπ„ÉÜ„Éº„Çø„ÇπÁ∂≠ÊåÅ & „Éû„Éº„Ç∏„É≠„Ç∏„ÉÉ„ÇØ
                                    // AI„ÅåÁîüÊàê„Åó„ÅüÊñ∞„Åó„ÅÑ„É™„Çπ„Éà„ÅÆÂêÑ„Ç¢„Ç§„ÉÜ„É†„Å´ÂØæ„Åó„ÄÅÊó¢Â≠ò„É™„Çπ„Éà„Åã„Çâ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂºï„ÅçÁ∂ô„Åê
                                    // ID„ÅåÂêå„Åò„Å™„Çâ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÑ™ÂÖà„ÄÇ
                                    const currentData = overrideRouteData || routeData;
                                    
                                    // ÈáçË§áID„ÉÅ„Çß„ÉÉ„ÇØ & „É™„Éä„É≥„Éê„É™„É≥„Ç∞ (ÂÆâÂÖ®Á≠ñ)
                                    // ID„ÅÆÂá∫ÁèæÂõûÊï∞„Çí„Ç´„Ç¶„É≥„Éà
                                    const idCounts = {};
                                    jsonData.route.forEach(r => { idCounts[r.id] = (idCounts[r.id] || 0) + 1; });
                                    
                                    // ÈáçË§á„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„É™„Éä„É≥„Éê„É™„É≥„Ç∞ÂÆüË°å
                                    let safeRoute = jsonData.route;
                                    const hasDuplicate = Object.values(idCounts).some(c => c > 1);
                                    if (hasDuplicate) {
                                        safeRoute = jsonData.route.map((item, idx) => ({ ...item, id: idx + 1000 })); // ‰ªÆID
                                    }

                                    const mergedRoute = safeRoute.map(newItem => {
                                        // ID„Åß„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                                        const originalItem = currentData.find(oldItem => oldItem.id === newItem.id);
                                        // ÂêçÂâç„Åß„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÔºàID„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅÆ‰øùÈô∫Ôºâ
                                        const nameMatchItem = !originalItem && currentData.find(oldItem => oldItem.name === newItem.name && oldItem.address === newItem.address);
                                        
                                        const matched = originalItem || nameMatchItem;
                                        
                                        if (matched) {
                                            return { ...newItem, status: matched.status };
                                        }
                                        return newItem;
                                    });
                                    
                                    setRouteData(mergedRoute);
                                }
                            } catch (e) { console.error(e); }
                        } else {
                             // Fallback for raw JSON block
                             const rawJsonMatch = aiTextRaw.match(/```json([\s\S]*?)```/);
                             if (rawJsonMatch) {
                                try {
                                    const jsonData = JSON.parse(rawJsonMatch[1]);
                                    if (jsonData.route) {
                                        // ÂêåÊßò„ÅÆ„Éû„Éº„Ç∏Âá¶ÁêÜ
                                        const currentData = overrideRouteData || routeData;
                                        const mergedRoute = jsonData.route.map(newItem => {
                                            const matched = currentData.find(oldItem => oldItem.id === newItem.id);
                                            return matched ? { ...newItem, status: matched.status } : newItem;
                                        });
                                        setRouteData(mergedRoute);
                                    }
                                } catch (e) { console.error(e); }
                             }
                        }

                        // Add messages to state
                        const msgToShow = displayText || userText;
                        const userMsgText = attachment ? `[üìé ${attachment.name}] ${msgToShow}` : msgToShow;
                        
                        setMessages(prev => [
                            ...prev, 
                            { role: "user", text: userMsgText },
                            { role: "model", text: displayMessage + (usedModel === MODEL_FALLBACK ? `\n\n${t.fallbackMsg}` : "") }
                        ]);
                        
                        // Update History
                        setHistory(prev => [...prev, { role: "user", parts: payload.contents[payload.contents.length-1].parts }, { role: "model", parts: [{ text: aiTextRaw }] }]);
                        setAttachment(null);

                    } catch (error) {
                        console.error("API Error:", error);
                        setModal({ isOpen: true, title: t.errorTitle, message: t.networkError, type: "error" });
                    } finally {
                        setIsLoading(false);
                        setShowOverlay(true); // „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô
                    }
                };

                executeRequest();
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!input.trim() && !attachment) return;
                const textToSend = input.trim() || (attachment ? (lang === 'en' ? "Analyze this file." : "„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíËß£Êûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ") : "");
                callGemini(textToSend, null, null, true); // ÈÄöÂ∏∏ÈÄÅ‰ø°„ÅØ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÇ„Çä
                setInput("");
            };

            const startNavi = (point) => {
                const query = encodeURIComponent(point.address || point.name);
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${query}`, '_blank');
            };
            
            const openWebSearch = (point) => {
                const query = encodeURIComponent(`${point.name} ${point.address || ""}`);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
            };

            const searchNearby = (point) => {
                const locationQuery = point.address || point.name;
                const searchQuery = encodeURIComponent(`„Ç≥„É≥„Éì„Éã ÂÖ¨Ë°Ü„Éà„Ç§„É¨ near ${locationQuery}`);
                window.open(`https://www.google.com/maps/search/${searchQuery}`, '_blank');
            };

            // ‚òÖÊñ∞Ë¶èÊ©üËÉΩ: ÂÖ®„É´„Éº„ÉàË°®Á§∫„Éú„Çø„É≥
            const openFullMap = () => {
                if (routeData.length === 0) return;
                
                // 1Âú∞ÁÇπ„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØÂçòÁ¥î„Å™Ê§úÁ¥¢
                if (routeData.length === 1) {
                    startNavi(routeData[0]);
                    return;
                }

                // Ë§áÊï∞Âú∞ÁÇπ„ÅÆÂ†¥Âêà„ÄÅDirections APIÂΩ¢Âºè„ÅßURLÊßãÁØâ
                const origin = encodeURIComponent(routeData[0].address || routeData[0].name);
                const destination = encodeURIComponent(routeData[routeData.length - 1].address || routeData[routeData.length - 1].name);
                
                let waypoints = "";
                if (routeData.length > 2) {
                    const points = routeData.slice(1, routeData.length - 1).map(p => encodeURIComponent(p.address || p.name));
                    waypoints = `&waypoints=${points.join('|')}`;
                }

                window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}`, '_blank');
            };

            const toggleStatus = (id, name) => {
                let newStatus = 'pending';
                const newRouteData = routeData.map(point => {
                    if (point.id === id) {
                        newStatus = point.status === 'completed' ? 'pending' : 'completed';
                        return { ...point, status: newStatus };
                    }
                    return point;
                });
                
                setRouteData(newRouteData);
                
                setMessages(prev => [...prev, { 
                    role: "model", 
                    text: newStatus === 'completed' ? `${t.completedLog} **${name}**` : `${t.pendingLog} **${name}**`
                }]);
                
                // Ëá™ÂãïÂÜçË®àÁÆóÔºà„Ç™„Éº„Éê„Éº„É¨„Ç§„Å™„Åó„Åß„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂÆüË°åÔºâ
                callGemini("„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü„ÄÇÁèæÂú®„ÅÆÁä∂Ê≥Å„Å´Âêà„Çè„Åõ„Å¶„ÄÅÊúÄÈÅ©„Å™„É´„Éº„ÉàÈ†ÜÂ∫è„ÇíÂÜçÁ¢∫Ë™ç„ÉªÂÜçÊßãÁØâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", null, newRouteData, false);
            };

            // ------------------------------------------
            // Printing (Portrait A4 with AI Report)
            // ------------------------------------------
            const handlePrint = async () => {
                if (routeData.length === 0) return;

                const printWindow = window.open('', '_blank', 'height=800,width=1000');
                if (!printWindow) { 
                    setModal({isOpen:true, title:t.errorTitle, message:t.popupBlocked, type:"error"}); 
                    return; 
                }

                printWindow.document.write(`
                    <html><head><title>${t.generatingReport}</title>
                    <style>body{font-family:sans-serif;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#f8fafc;color:#334155;}
                    .loader{border:4px solid #e2e8f0;border-top:4px solid #6366f1;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:16px;}
                    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
                    </head><body><div class="loader"></div><h3>${t.generatingReport}</h3><p>AI is writing "Mission Guidebook"...</p></body></html>
                `);

                setIsLoading(true);
                setShowOverlay(true);

                // Use User API Key if available
                const effectiveKey = userApiKey || apiKey;

                try {
                    // AI„Å´„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åï„Åõ„Çã
                    const prompt = `Based on the following route data and our conversation history, generate a "Mission Guidebook" (travel itinerary) for printing. 
                    Format as clear Markdown. 
                    - Include a title.
                    - Briefly explain the route concept.
                    - List key highlights.
                    - Keep it concise enough to fit on the first half of A4 paper.
                    - Lang: ${lang}

                    Route Data:
                    ${JSON.stringify(routeData)}`;

                    // 1. Try Primary Model (Gemini 3 Flash)
                    let usedModel = MODEL_PRIMARY;
                    let url = `https://generativelanguage.googleapis.com/v1beta/models/${usedModel}:generateContent?key=${effectiveKey}`;
                    
                    const payload = {
                        contents: [...history, { role: "user", parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: getSystemPrompt(lang) }] }
                    };

                    let response = await fetch(url, {
                        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                    });

                    // Fallback
                    if (!response.ok) {
                        usedModel = MODEL_FALLBACK;
                        url = `https://generativelanguage.googleapis.com/v1beta/models/${usedModel}:generateContent?key=${effectiveKey}`;
                        response = await fetch(url, {
                            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error("Report generation failed.");
                    }

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const cleanText = aiText.replace(/<<<JSON([\s\S]*?)JSON>>>/g, "").trim();

                    // HTMLÁîüÊàê
                    const reportHtml = marked.parse(cleanText);

                    // Êó¢Â≠ò„É™„Çπ„Éà„ÅÆHTMLÁîüÊàê
                    const listHtml = routeData.map((item, idx) => `
                        <div class="item">
                            <span class="number">#${idx + 1}</span>
                            <div class="content">
                                <span class="name">${item.name}</span>
                                <span class="address">${item.address}</span>
                                ${item.note ? `<span class="note">Note: ${item.note}</span>` : ''}
                            </div>
                        </div>
                    `).join('');

                    // Âç∞Âà∑Áî®CSS (Ê®™ÂπÖÁµ±‰∏Ä„ÉªA4Ë™øÊï¥„Éªword-wrapÂØæÁ≠ñ„ÉªÊñáÂ≠ó„Çµ„Ç§„Ç∫Á∏ÆÂ∞è)
                    const printStyle = `
                        <style>
                            @page { size: A4 portrait; margin: 12mm; }
                            body { 
                                font-family: "Helvetica Neue", "Zen Maru Gothic", Arial, sans-serif; 
                                padding: 0; 
                                margin: 0;
                                color: #111; 
                                font-size: 9pt; /* ÊñáÂ≠ó„Çµ„Ç§„Ç∫Á∏ÆÂ∞è */
                                line-height: 1.6;
                                width: 100%;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .container {
                                width: 100%;
                                max-width: 100%;
                                box-sizing: border-box;
                                padding: 0 10px;
                            }
                            h1, h2, h3 { color: #111; margin-top: 0.8em; margin-bottom: 0.4em; page-break-after: avoid; }
                            h1 { text-align: center; border-bottom: 2px solid #6366f1; padding-bottom: 5px; margin-bottom: 15px; font-size: 16pt; }
                            h2 { font-size: 11pt; border-bottom: 1px solid #ddd; padding-bottom: 2px; }
                            h3 { font-size: 10pt; font-weight: bold; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; }
                            
                            /* AI Report Section */
                            .guidebook-section { 
                                background: #fff; 
                                padding: 10px 0; 
                                margin-bottom: 20px; 
                                width: 100%;
                                box-sizing: border-box;
                                word-wrap: break-word;
                            }
                            .guidebook-section p { margin-bottom: 0.8em; }
                            .guidebook-section ul { margin-left: 1.5em; margin-bottom: 0.8em; }
                            
                            /* Mission List Section */
                            .mission-list {
                                width: 100%;
                                box-sizing: border-box;
                                display: flex;
                                flex-direction: column;
                                gap: 8px;
                            }
                            .item { 
                                border: 1px solid #cbd5e1; 
                                border-radius: 6px; 
                                padding: 8px 12px; 
                                break-inside: avoid; 
                                display: flex; 
                                align-items: flex-start;
                                background: white;
                                width: 100%;
                                box-sizing: border-box;
                            }
                            .number { 
                                background: #6366f1; 
                                color: white; 
                                font-weight: bold; 
                                padding: 2px 8px; 
                                border-radius: 4px; 
                                margin-right: 12px; 
                                font-size: 10pt; 
                                min-width: 24px;
                                text-align: center;
                                flex-shrink: 0; 
                                height: fit-content;
                                margin-top: 2px;
                            }
                            .content { flex: 1; min-width: 0; }
                            .name { font-weight: bold; font-size: 11pt; display: block; margin-bottom: 2px; }
                            .address { color: #64748b; font-size: 8pt; margin-bottom: 2px; display: block; }
                            .note { background: #fff7ed; color: #c2410c; padding: 1px 6px; border-radius: 4px; font-size: 8pt; display: inline-block; margin-top: 2px; border: 1px solid #ffedd5; }
                            .footer { text-align: center; margin-top: 20px; color: #94a3b8; font-size: 7pt; border-top: 1px solid #e2e8f0; padding-top: 5px; }
                        </style>
                    `;

                    // „Éâ„Ç≠„É•„É°„É≥„Éà„Çí‰∏ÄÊó¶„ÇØ„É™„Ç¢„Åó„Å¶Êõ∏„ÅçÁõ¥„Åô
                    printWindow.document.open();
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Mission Report</title>
                            <script src="https://cdn.tailwindcss.com"></`+`script>
                            <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
                            ${printStyle}
                        </head>
                        <body>
                            <div class="container">
                                <h1>Mission Guidebook</h1>
                                
                                <div class="guidebook-section markdown-body">
                                    ${reportHtml}
                                </div>
                                
                                <h2 style="font-size: 14pt; margin-top: 20px; border-bottom: 2px solid #6366f1;">Mission List</h2>
                                <div class="mission-list">
                                    ${listHtml}
                                </div>
                                
                                <div class="footer">Generated by Mission Ctrl AI - ${new Date().toLocaleString()}</div>
                            </div>
                            <script>
                                // ÁîªÂÉèË™≠„ÅøËæº„ÅøÁ≠â„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÂç∞Âà∑
                                window.onload = function() {
                                    setTimeout(function() {
                                        try {
                                            window.focus();
                                            window.print();
                                        } catch(e) { console.error(e); }
                                    }, 1000);
                                };
                            </`+`script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();

                    // „ÉÅ„É£„ÉÉ„ÉàÊ¨Ñ„Å´„ÇÇ„É≠„Ç∞„ÇíÊÆã„Åô
                    setMessages(prev => [...prev, 
                        { role: "user", text: `üñ®Ô∏è ${t.generatingReport}` },
                        { role: "model", text: cleanText }
                    ]);

                } catch (error) {
                    console.error(error);
                    printWindow.document.body.innerHTML = `<h3 style="color:red">Error: ${t.networkError}</h3>`;
                    let msg = t.networkError;
                    if (error.message.includes("404")) msg = "„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (404)„ÄÇ";
                    setModal({ isOpen: true, title: t.errorTitle, message: msg, type: "error" });
                } finally {
                    setIsLoading(false);
                }
            };

            // Import/Export ... (Kept same logic as previous)
            const handleExport = () => {
                const data = { messages, routeData, history, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mission-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setModal({ isOpen: true, title: t.successTitle, message: t.downloadComplete, type: "success" });
                setOpenMenu(null);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.messages && data.routeData && data.history) {
                            setMessages(data.messages);
                            setRouteData(data.routeData);
                            setHistory(data.history);
                            setModal({ isOpen: true, title: t.successTitle, message: t.restoreComplete, type: "success" });
                        } else { throw new Error("Invalid format"); }
                    } catch (error) {
                        setModal({ isOpen: true, title: t.errorTitle, message: t.loadFailed, type: "error" });
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
                setOpenMenu(null);
            };

            const toggleMenu = (menuName, e) => {
                e.stopPropagation();
                setOpenMenu(openMenu === menuName ? null : menuName);
            };


            return (
                <div className="flex flex-col h-full w-full relative z-10 text-slate-800 dark:text-slate-100 transition-colors duration-300">
                    <Modal isOpen={modal.isOpen} title={modal.title} message={modal.message} type={modal.type} onClose={() => setModal({ ...modal, isOpen: false })} />
                    
                    <ConfirmModal 
                        isOpen={confirmDialog.isOpen} 
                        title={confirmDialog.title} 
                        message={confirmDialog.message} 
                        isDanger={confirmDialog.isDanger}
                        texts={t}
                        onCancel={() => setConfirmDialog({ ...confirmDialog, isOpen: false })}
                        onConfirm={executeConfirmAction}
                    />
                    
                    <CooldownOverlay cooldown={cooldown} isLoading={isLoading} showOverlay={showOverlay} t={t} />

                    <SettingsModal 
                        isOpen={showSettings} 
                        onClose={() => setShowSettings(false)} 
                        t={t} 
                        userApiKey={userApiKey}
                        onApiKeyChange={setUserApiKey}
                        onSave={handleSaveSettings}
                    />

                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* LEFT PANEL (CHAT) */}
                        <div className={`
                            flex flex-col glass-panel transition-all duration-300 z-20
                            ${activeTab === 'chat' ? 'absolute inset-0 md:static md:w-[450px] lg:w-[500px]' : 'hidden md:flex md:w-[450px] lg:w-[500px]'}
                        `}>
                            {/* Header */}
                            <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-900/50">
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => setShowSettings(true)}
                                        className="text-slate-400 hover:text-indigo-500 dark:hover:text-cyan-400 p-2 rounded hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                                        title={t.settingsTooltip}
                                    >
                                        <i className="fas fa-cog"></i>
                                    </button>
                                    <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-cyan-500 dark:from-indigo-400 dark:to-cyan-400">
                                        <i className="fas fa-rocket mr-2 text-indigo-500 dark:text-indigo-400"></i>{t.title}
                                    </h1>
                                </div>
                                <div className="flex items-center gap-3">
                                    
                                    {/* ‚òÖGemini„Ç≠„É©„Éû„Éº„ÇØ„Éú„Çø„É≥ (Â∏∏ÊôÇÁÇπÊªÖ„Ç®„Éï„Çß„ÇØ„Éà‰ªò„Åç) */}
                                    <a 
                                        href={GEM_URL} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-indigo-500 dark:text-cyan-400 p-2 rounded hover:bg-black/5 dark:hover:bg-white/10 transition-colors animate-gemini-glow"
                                        title={t.geminiTooltip}
                                    >
                                        {/* GeminiÈ¢®„Çπ„Éë„Éº„ÇØ„É´„Ç¢„Ç§„Ç≥„É≥ */}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" className="drop-shadow-sm">
                                            <path d="M12 2L14.8 9.2L22 12L14.8 14.8L12 22L9.2 14.8L2 12L9.2 9.2L12 2Z"></path>
                                        </svg>
                                    </a>

                                    <button 
                                        onClick={handleResetRequest}
                                        className="text-slate-500 dark:text-slate-400 hover:text-red-500 dark:hover:text-red-400 p-2 rounded hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                                        title={t.resetTooltip}
                                    >
                                        <i className="fas fa-eraser"></i>
                                    </button>

                                    <div className="relative menu-container">
                                        <button onClick={(e) => toggleMenu('lang', e)} className="text-slate-500 dark:text-slate-400 hover:text-indigo-500 dark:hover:text-cyan-400 p-2 rounded" title={t.langTooltip}>
                                            <i className="fas fa-globe"></i>
                                        </button>
                                        <div className={`absolute right-0 mt-2 w-32 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 z-50 overflow-hidden ${openMenu === 'lang' ? 'block' : 'hidden'}`}>
                                            <button onClick={() => handleLangChange('ja')} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-200">Êó•Êú¨Ë™û</button>
                                            <button onClick={() => handleLangChange('en')} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-200">English</button>
                                            <button onClick={() => handleLangChange('zh')} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-200">ÁÆÄ‰Ωì‰∏≠Êñá</button>
                                        </div>
                                    </div>

                                    <button onClick={() => setDarkMode(!darkMode)} className="text-slate-500 dark:text-slate-400 hover:text-indigo-500 dark:hover:text-cyan-400 p-2 rounded" title={t.themeTooltip}>
                                        <i className={`fas fa-${darkMode ? 'sun' : 'moon'}`}></i>
                                    </button>
                                    
                                    <div className="relative menu-container">
                                        <button onClick={(e) => toggleMenu('backup', e)} className="text-slate-500 dark:text-slate-400 hover:text-indigo-500 dark:hover:text-cyan-400 p-2 rounded" title={t.backupTooltip}>
                                            <i className="fas fa-database"></i>
                                        </button>
                                        <div className={`absolute right-0 mt-2 w-40 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 z-50 ${openMenu === 'backup' ? 'block' : 'hidden'}`}>
                                            <button onClick={handleExport} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-600 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700">
                                                <i className="fas fa-download text-indigo-500"></i> {t.export}
                                            </button>
                                            <label className="w-full text-left px-4 py-3 text-sm font-bold text-slate-600 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2 cursor-pointer">
                                                <i className="fas fa-upload text-emerald-500"></i> {t.import}
                                                <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Messages */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-5 custom-scrollbar bg-white/20 dark:bg-slate-900/30">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`relative max-w-[90%] md:max-w-[85%] group`}>
                                            <div className={`
                                                p-4 text-sm leading-relaxed shadow-sm rounded-2xl
                                                ${msg.role === 'user' 
                                                    ? 'bg-gradient-to-br from-indigo-500 to-blue-500 text-white rounded-tr-none' 
                                                    : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-tl-none markdown-body text-slate-800 dark:text-slate-200'}
                                            `}
                                            dangerouslySetInnerHTML={{ __html: msg.role === 'user' ? msg.text : marked.parse(msg.text) }}
                                            />
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>

                            {/* Input */}
                            <form onSubmit={handleSubmit} className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-black/40">
                                <div className="flex flex-col gap-2">
                                    <div className="flex justify-between px-1">
                                        <button type="button" onClick={handleGetLocation} className="text-[11px] font-bold text-cyan-600 dark:text-cyan-400 hover:underline flex items-center gap-1">
                                            <i className="fas fa-location-crosshairs"></i> {t.location}
                                        </button>
                                        <span className="text-[10px] text-slate-400 font-mono">{t.ctrlEnter}</span>
                                    </div>
                                    
                                    {attachment && (
                                        <div className="relative inline-block animate-[fadeIn_0.2s_ease-out]">
                                            <div className="relative bg-indigo-50 dark:bg-slate-700 rounded-lg p-2 border border-indigo-200 dark:border-slate-600 flex items-center gap-3 pr-8">
                                                {attachment.preview ? (
                                                    <img src={attachment.preview} alt="preview" className="h-10 w-10 object-cover rounded" />
                                                ) : (
                                                    <div className="h-10 w-10 flex items-center justify-center bg-white dark:bg-slate-600 rounded text-red-500 text-xl">
                                                        <i className="fas fa-file-pdf"></i>
                                                    </div>
                                                )}
                                                <div className="flex flex-col overflow-hidden">
                                                    <span className="text-xs font-bold text-slate-700 dark:text-slate-200 truncate max-w-[150px]">{attachment.name}</span>
                                                </div>
                                                <button type="button" onClick={clearAttachment} className="absolute top-1 right-1 w-5 h-5 bg-slate-400 hover:bg-red-500 text-white rounded-full flex items-center justify-center text-[10px]"><i className="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="relative">
                                        <textarea
                                            id="main-input"
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            placeholder={t.placeholder}
                                            className="w-full bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-600 rounded-xl pl-3 pr-32 py-3 focus:outline-none focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-900 transition-all text-sm min-h-[60px] resize-none font-medium shadow-inner placeholder-slate-400"
                                            onKeyDown={(e) => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) handleSubmit(e); }}
                                        ></textarea>
                                        <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*, application/pdf" className="hidden" />

                                        <div className="absolute right-2 bottom-2 flex items-center gap-2">
                                            
                                            {/* Ê∑ª‰ªò„Éú„Çø„É≥ + „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */}
                                            <div className="relative group">
                                                <button type="button" onClick={triggerFileSelect} 
                                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors shadow-sm border border-slate-200 dark:border-slate-600 hover:text-indigo-600 dark:hover:text-cyan-400
                                                    ${attachment ? 'bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300' : 'bg-white dark:bg-slate-700 text-slate-400'}`}
                                                >
                                                    <i className="fas fa-paperclip"></i>
                                                </button>
                                                <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-[10px] font-bold text-white bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                                                    {t.attachTooltip}
                                                </span>
                                            </div>

                                            {/* Èü≥Â£∞ÂÖ•Âäõ„Éú„Çø„É≥ + „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */}
                                            <div className="relative group">
                                                <button type="button" onClick={startListening} 
                                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors shadow-sm border border-slate-200 dark:border-slate-600 ${isListening ? 'bg-red-500 animate-speaking text-white' : 'bg-white dark:bg-slate-700 text-slate-400 hover:text-indigo-600 dark:hover:text-white'}`}
                                                >
                                                    <i className={`fas fa-${isListening ? 'microphone-lines' : 'microphone'}`}></i>
                                                </button>
                                                <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-[10px] font-bold text-white bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                                                    {t.voiceTooltip}
                                                </span>
                                            </div>
                                            
                                            {/* ÈÄÅ‰ø°„Éú„Çø„É≥ + „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */}
                                            <div className="relative group">
                                                <button type="submit" disabled={isLoading} 
                                                    className={`h-8 w-8 rounded-lg flex items-center justify-center transition-all shadow-md px-3 font-bold text-xs 
                                                    ${isLoading ? 'bg-slate-400 cursor-not-allowed' : 'bg-indigo-500 dark:bg-indigo-600 text-white hover:bg-indigo-600'}`}>
                                                    {isLoading ? <i className="fas fa-circle-notch fa-spin"></i> : <i className="fas fa-paper-plane"></i>}
                                                </button>
                                                <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-[10px] font-bold text-white bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50">
                                                    {t.sendTooltip}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div className="h-16 md:hidden bg-white dark:bg-slate-900"></div>
                        </div>

                        {/* RIGHT PANEL (CONTENT) */}
                        <div className={`
                            flex-1 bg-slate-100 dark:bg-slate-950 overflow-y-auto relative transition-all duration-300 z-20
                            ${activeTab === 'map' ? 'absolute inset-0 md:static' : 'hidden md:block'}
                        `}>
                            {/* Header */}
                            <div className="sticky top-0 z-30 p-4 glass flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-2">
                                    <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700 dark:text-white">
                                        <i className="fas fa-map-marked-alt text-cyan-500 dark:text-cyan-400"></i> {t.listTitle}
                                    </h2>
                                    {routeData.length > 0 && (
                                        <>
                                            {/* ÂÖ®„É´„Éº„Éà„Éû„ÉÉ„Éó„Éú„Çø„É≥ËøΩÂä† */}
                                            <button onClick={openFullMap} disabled={isLoading} 
                                                className={`text-xs px-2 py-1 rounded transition-colors flex items-center gap-1
                                                ${isLoading ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-200 dark:hover:bg-emerald-800'}`}
                                                title={t.fullMapTooltip}>
                                                <i className="fas fa-globe-asia"></i> {t.fullMap}
                                            </button>
                                        </>
                                    )}
                                </div>
                                <button onClick={handlePrint} className="bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-200 transition-colors shadow-sm">
                                    <i className="fas fa-print mr-1"></i> {t.print}
                                </button>
                            </div>

                            <div id="mission-report" className="p-4 md:p-8 max-w-4xl mx-auto pb-24 space-y-8">
                                <section className="space-y-4">
                                    <div className="flex items-center gap-4 mb-2 px-2">
                                        <h3 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest font-mono">{t.listTitle}</h3>
                                        <div className="h-px bg-slate-300 dark:bg-slate-700 flex-1"></div>
                                    </div>
                                    
                                    {routeData.length === 0 && (
                                        <div className="text-center py-12 border border-dashed border-slate-300 dark:border-slate-700 rounded-2xl bg-slate-50 dark:bg-slate-900/50">
                                            <p className="text-slate-500 dark:text-slate-400 font-bold">{t.noRoute}</p>
                                        </div>
                                    )}

                                    {routeData.map((point, idx) => {
                                        const isCurrent = point.status === 'current';
                                        const isCompleted = point.status === 'completed';
                                        const isSkipped = point.status === 'skipped';
                                        const hasWarning = point.note && point.note.includes("Ë¶ÅÁ¢∫Ë™ç");
                                        const warningClass = hasWarning ? "bg-amber-100 dark:bg-amber-900/40 border-amber-300 dark:border-amber-600" : "";

                                        return (
                                            <div key={point.id} className={`
                                                glass-card rounded-xl p-5 flex flex-col relative overflow-hidden text-slate-800 dark:text-slate-100
                                                ${isCurrent ? 'bg-indigo-50/80 dark:bg-slate-800 !border-indigo-300 dark:!border-indigo-500 shadow-md' : ''}
                                                ${isSkipped ? 'opacity-60 grayscale bg-slate-100 dark:bg-slate-900' : ''}
                                                ${warningClass}
                                            `}>
                                                {isCurrent && <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-indigo-400 to-cyan-400"></div>}
                                                
                                                <div className="flex gap-4">
                                                    <button onClick={() => toggleStatus(point.id, point.name)} 
                                                        className={`no-print flex-shrink-0 mt-0.5 w-12 h-12 rounded-xl flex items-center justify-center transition-all shadow-sm border
                                                        ${isCompleted 
                                                            ? 'bg-emerald-500 border-emerald-600 text-white' 
                                                            : 'bg-white dark:bg-slate-700 border-slate-200 dark:border-slate-600 text-slate-400 hover:border-indigo-400'}`}>
                                                        {isCompleted ? <i className="fas fa-check text-xl"></i> : <i className="fas fa-map-pin text-xl"></i>}
                                                    </button>
                                                    
                                                    <div className="flex-1 min-w-0 pr-8">
                                                        <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                            <span className={`text-[10px] font-extrabold px-2 py-0.5 rounded shadow-sm
                                                                ${isCurrent ? 'bg-indigo-500 text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}`}>
                                                                {isCurrent ? t.now : (isCompleted ? t.done : `#${idx+1}`)}
                                                            </span>
                                                            {hasWarning && (
                                                                <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-amber-500 text-white animate-pulse">
                                                                    <i className="fas fa-exclamation-triangle"></i> Ë¶ÅÁ¢∫Ë™ç
                                                                </span>
                                                            )}
                                                            <button 
                                                                onClick={() => openWebSearch(point)}
                                                                className="font-bold text-lg hover:text-indigo-600 dark:hover:text-cyan-400 hover:underline transition-colors text-left flex items-center gap-2 group truncate max-w-full"
                                                            >
                                                                <span className="truncate">{point.name}</span>
                                                                <i className="fas fa-external-link-alt text-xs opacity-50 group-hover:opacity-100 flex-shrink-0"></i>
                                                            </button>
                                                        </div>
                                                        <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-2 flex items-center truncate">
                                                            <i className="fas fa-location-dot mr-1.5 opacity-70 flex-shrink-0"></i>
                                                            <span className="truncate">{point.address}</span>
                                                        </p>

                                                        {point.note && <div className="text-xs font-bold text-amber-700 dark:text-amber-300 bg-amber-100 dark:bg-amber-900/30 px-3 py-1.5 rounded-lg inline-flex items-center border border-amber-200 dark:border-amber-800/50"><i className="fas fa-info-circle mr-1.5"></i>{point.note}</div>}
                                                    </div>

                                                    <div className="absolute top-4 right-4">
                                                         <button 
                                                            onClick={() => handleDeleteRequest(point.id, point.name)}
                                                            className="no-print text-slate-300 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                                            title="Delete"
                                                        >
                                                            <i className="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="mt-4 flex justify-between items-center no-print">
                                                    <button onClick={() => searchNearby(point)} 
                                                        className="text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-cyan-400 flex items-center gap-1 transition-colors"
                                                    >
                                                        <i className="fas fa-store"></i> üè™ / üöª
                                                    </button>

                                                    <button onClick={() => startNavi(point)} disabled={isSkipped} 
                                                        className={`w-auto px-6 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm active:scale-95 border
                                                        ${isCurrent 
                                                            ? 'bg-indigo-600 hover:bg-indigo-500 text-white border-transparent shadow-indigo-200 dark:shadow-none' 
                                                            : 'bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-300 dark:border-slate-600'}`}>
                                                        <i className="fas fa-location-arrow"></i>
                                                        {isCurrent ? t.startNavi : t.map}
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </section>
                            </div>
                             <div className="h-16 md:hidden bg-slate-100 dark:bg-slate-950"></div>
                        </div>
                    </div>

                    <div className="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 z-50 flex justify-around items-center safe-area-pb shadow-lg">
                        <button onClick={() => setActiveTab('chat')} className={`flex flex-col items-center gap-1 p-2 w-full transition-colors ${activeTab === 'chat' ? 'text-indigo-600 dark:text-cyan-400' : 'text-slate-400'}`}>
                            <i className="fas fa-comments text-xl"></i><span className="text-[10px] font-bold">{t.tabChat}</span>
                        </button>
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center gap-1 p-2 w-full transition-colors ${activeTab === 'map' ? 'text-indigo-600 dark:text-cyan-400' : 'text-slate-400'}`}>
                            <i className="fas fa-map-marked-alt text-xl"></i><span className="text-[10px] font-bold">{t.tabMap}</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>