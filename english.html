<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Buddy 2.0 - Immersive AI</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
<style>
    /* å…¨è¦ç´ ã«border-boxã‚’é©ç”¨ã—ã¦ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹ã¯ã¿å‡ºã—ã‚’é˜²æ­¢ */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    :root {
        --primary-color: #4A90E2;
        --secondary-color: #50E3C2;
        --accent-color: #FF6B6B;
        --bg-color: #F0F4F8;
        --chat-bg: #FFFFFF;
        --user-msg-bg: #D1E8FF;
        --ai-msg-bg: #EAEAEA;
    }

    body {
        font-family: 'Zen Maru Gothic', 'Nunito', sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- Header & Status Bar --- */
    header {
        background: white;
        padding: 8px 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
        height: 65px;
    }

    .app-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
        display: flex;
        flex-direction: column;
        line-height: 1.1;
        cursor: pointer;
    }
    .app-title span.sub { font-size: 0.7em; color: #888; font-family: 'Nunito', sans-serif; }

    .status-bar {
        display: flex;
        gap: 5px; /* ãƒœã‚¿ãƒ³é–“éš”ã‚’å°‘ã—ç‹­ã‚ã‚‹ */
        align-items: center;
        font-size: 0.8rem;
    }

    .level-badge {
        background: var(--primary-color);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-weight: bold;
        text-align: center;
        line-height: 1.1;
        cursor: pointer;
    }
    .level-badge small { display: block; font-size: 0.7em; opacity: 0.9; }

    .xp-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 80px; /* å°‘ã—ç¸®å° */
        cursor: pointer; /* Clickable for stats */
        padding: 2px 5px;
        border-radius: 5px;
        transition: background 0.2s;
    }
    .xp-container:hover { background: #f0f0f0; }

    .xp-label { font-size: 0.7em; color: #666; margin-bottom: 2px; font-weight: bold; }
    
    .xp-bar-bg {
        width: 100%;
        height: 8px;
        background: #ddd;
        border-radius: 5px;
        overflow: hidden;
    }

    .xp-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
        width: 0%;
        transition: width 0.5s ease;
    }

    /* --- Main Chat Area --- */
    #chat-container {
        flex-grow: 1;
        padding: 20px;
        padding-bottom: 90px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
        scroll-behavior: smooth;
    }

    .message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.6;
        position: relative;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.ai {
        align-self: flex-start;
        background-color: var(--ai-msg-bg);
        border-bottom-left-radius: 4px;
        padding-bottom: 35px;
        margin-left: 10px; /* ã‚¢ã‚¤ã‚³ãƒ³åˆ†ã®ä½™ç™½ç¢ºä¿ */
    }
    
    /* ã‚¢ã‚¤ã‚³ãƒ³ä½ç½®èª¿æ•´: leftã‚’-28pxã‹ã‚‰-22pxã«å¤‰æ›´ã—ã¦å³å¯„ã› */
    .message.ai::before {
        content: 'ğŸ¤–';
        position: absolute;
        left: -22px; 
        bottom: 5px;
        font-size: 1.4rem;
    }

    .speak-btn {
        position: absolute;
        bottom: 5px;
        right: 10px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 15px;
        padding: 2px 8px;
        font-size: 0.8rem;
        cursor: pointer;
        color: #555;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
    }
    .speak-btn:hover { background: #f0f8ff; color: var(--primary-color); border-color: var(--primary-color); }

    .message.user {
        align-self: flex-end;
        background-color: var(--user-msg-bg);
        border-bottom-right-radius: 4px;
        text-align: right;
    }

    .translation {
        display: block;
        margin-top: 5px;
        font-size: 0.85em;
        color: #555;
        border-top: 1px dashed #ccc;
        padding-top: 4px;
        text-align: left;
    }

    .correction {
        margin-top: 8px;
        padding: 8px;
        background: #fff;
        border-left: 4px solid var(--accent-color);
        font-size: 0.9em;
        color: #333;
        border-radius: 4px;
        text-align: left;
    }

    .score-popup {
        position: absolute;
        font-weight: bold;
        pointer-events: none;
        animation: floatUp 1.5s forwards;
        z-index: 100;
        font-size: 1.2rem;
        text-shadow: 1px 1px 0 #fff;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

    /* --- Controls --- */
    .controls {
        background: white;
        padding: 10px 10px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 8px;
        align-items: center;
        position: fixed;
        bottom: 0;
        width: 100%;
        z-index: 20;
    }

    input[type="text"] {
        flex-grow: 1;
        padding: 10px 15px;
        border: 2px solid #eee;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
    }
    input[type="text"]:focus { border-color: var(--primary-color); }

    .btn-icon {
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        min-width: 45px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: transform 0.1s, background 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-icon:active { transform: scale(0.95); }

    .btn-send { background: var(--primary-color); color: white; }
    .btn-mic { background: #f0f0f0; color: #555; }
    .btn-mic.listening { 
        background: var(--accent-color); 
        color: white; 
        animation: pulse 1.5s infinite;
        border: 2px solid #fff;
    }

    .btn-end { 
        background: #fff0f0; 
        color: var(--accent-color); 
        border: 1px solid #ffcccc;
        border-radius: 12px;
        padding: 5px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 45px;
        min-width: 60px;
    }
    .btn-end span.main { font-weight: bold; font-size: 0.9rem; line-height: 1; }
    .btn-end span.sub { font-size: 0.65rem; opacity: 0.8; font-family: 'Nunito', sans-serif; }

    /* Kids Music Toggle Button (New) */
    .btn-music-toggle {
        display: none; /* Initially hidden */
        position: absolute;
        left: 10px;
        top: -40px; /* Above controls */
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.8rem;
        color: #555;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 15;
    }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }

    /* --- Webcam Overlay --- */
    /* ä¸è¦ãªãŸã‚éè¡¨ç¤ºã¾ãŸã¯å‰Šé™¤ */
    #webcam-container {
        display: none !important; 
    }

    /* --- Modals --- */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }
    .modal {
        background: white;
        padding: 25px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal h2 { margin-top: 0; color: var(--primary-color); font-family: 'Zen Maru Gothic', sans-serif; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;}

    /* Tools Menu (Top Right) */
    .tools-menu { 
        position: absolute; 
        top: 65px; 
        right: 10px; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
        display: none; 
        flex-direction: column; 
        overflow: hidden; 
        z-index: 90; 
        min-width: 280px; 
    }
    .tools-menu-item {
        width: 100%; 
        border-radius: 0; 
        text-align: left; 
        padding: 12px 15px; 
        background: white; 
        color: #333; 
        font-size: 0.95rem; 
        justify-content: flex-start; 
        height: auto; 
        border: none;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        cursor: pointer;
    }
    .tools-menu-item:last-child { border-bottom: none; }
    .tools-menu-item:hover { background: #f9f9f9; }
    .tools-menu-item span.sub-text { font-size: 0.75rem; color: #888; font-family: 'Nunito', sans-serif; margin-left: 0; margin-top: 2px; }

    /* Speed Control in Menu */
    .speed-control {
        display: flex;
        gap: 3px; 
        margin-top: 5px;
        width: 100%;
    }
    .speed-btn {
        flex: 1;
        padding: 5px 2px;
        font-size: 0.75rem; 
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f5f5f5;
        cursor: pointer;
        white-space: nowrap;
    }
    .speed-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Level Selection Buttons */
    .level-btn {
        width: 100%; 
        border-radius: 15px; 
        margin-bottom: 12px; 
        height: auto; 
        padding: 15px; 
        text-align: left;
        background: #fff;
        border: 2px solid #eee;
        display: block;
        transition: all 0.2s;
        cursor: pointer;
    }
    .level-btn:hover { border-color: var(--primary-color); background: #fdfdfd; transform: translateY(-2px); }
    .level-btn b { display: block; font-size: 1.1em; margin-bottom: 4px; color: var(--primary-color); }
    .level-btn small { color: #555; line-height: 1.4; display: block; }
    .level-btn .en-label { font-size: 0.8em; color: #888; margin-left: 5px; font-weight: normal; font-family: 'Nunito', sans-serif; }

    /* Kids Mode Button Style */
    .level-btn.kids {
        border-color: #FFD700;
        background: #FFFBE6;
    }
    .level-btn.kids:hover {
        background: #FFF8C5;
        border-color: #FFC107;
    }
    .level-btn.kids b { color: #F5A623; }

    /* Scenario Grid */
    .scenario-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    .scenario-btn {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #f9f9f9;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .scenario-btn:hover {
        background: #eef6ff;
        border-color: var(--primary-color);
        transform: scale(1.02);
    }

    /* Stats Bars */
    .stat-row {
        margin-bottom: 15px;
        text-align: left;
    }
    .stat-label {
        font-size: 0.9rem;
        font-weight: bold;
        color: #555;
        display: flex;
        justify-content: space-between;
    }
    .stat-bg {
        height: 10px;
        background: #eee;
        border-radius: 5px;
        margin-top: 5px;
        overflow: hidden;
    }
    .stat-fill {
        height: 100%;
        background: var(--secondary-color);
        width: 0%;
        transition: width 0.8s ease;
    }

    /* Report Card Styles */
    .report-card-content {
        text-align: left;
        background: #fdfdfd;
        border: 2px dashed #ddd;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-family: 'Nunito', 'Zen Maru Gothic', sans-serif;
    }
    /* ãƒ¬ãƒãƒ¼ãƒˆå†…ã®è¦ç´ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (AIå‡ºåŠ›HTMLç”¨) */
    .report-card-content h3 { 
        border-bottom: 2px solid var(--primary-color); 
        padding-bottom: 5px; 
        color: #444; 
        margin-top: 15px; 
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    .report-card-content p {
        margin-bottom: 10px;
        line-height: 1.6;
        color: #555;
    }
    .report-card-content ul { 
        padding-left: 20px; 
        margin-bottom: 10px;
        list-style-type: disc;
    }
    .report-card-content li {
        margin-bottom: 5px;
        color: #555;
    }

    /* Hidden Print Area */
    #print-area { display: none; }

</style>
</head>
<body>

<header>
    <div class="app-title" onclick="toggleTools()">
        è‹±ä¼šè©±ãƒãƒ‡ã‚£
        <span class="sub">English Buddy</span>
    </div>
    <div class="status-bar">
        <div class="level-badge" id="level-display" onclick="changeLevel()">
            åˆç´š <small>Beginner</small>
        </div>
        <div class="xp-container" title="è©³ç´°ã‚¹ã‚³ã‚¢ã‚’è¦‹ã‚‹" onclick="showStats()">
            <div class="xp-label">Total Score: <span id="total-score-display">0</span></div>
            <div class="xp-bar-bg">
                <div class="xp-bar-fill" id="xp-bar" style="width: 0%"></div>
            </div>
        </div>
        <!-- éµãƒœã‚¿ãƒ³ (API Key) -->
        <button onclick="showApiKeyModal()" class="btn-icon" style="width:36px; height:36px; font-size:1rem; background:white; color:#aaa;" title="APIã‚­ãƒ¼è¨­å®š (Settings)">ğŸ”‘</button>
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button onclick="toggleTools()" class="btn-icon" style="width:36px; height:36px; font-size:1rem; background:white;" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (Menu)">âš™ï¸</button>
    </div>
</header>

<div class="tools-menu" id="tools-menu">
    <!-- Save -->
    <button class="tools-menu-item" onclick="saveData(true)">
        ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
        <span class="sub-text">Save Backup File</span>
    </button>
    
    <!-- Load -->
    <button class="tools-menu-item" onclick="document.getElementById('restore-file').click()">
        ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        <span class="sub-text">Load Backup File</span>
    </button>
    <input type="file" id="restore-file" style="display:none" onchange="loadDataFromFile(this)" accept=".json">

    <!-- Reset Chat Only -->
    <button class="tools-menu-item" onclick="resetChatOnly()">
        ğŸ’¬ ä¼šè©±ã‚’ã¯ã˜ã‚ã‹ã‚‰ã‚„ã‚Šç›´ã™
        <span class="sub-text">Reset Chat Only (Keep Score)</span>
    </button>

    <!-- Speed -->
    <div class="tools-menu-item" style="cursor: default;">
        ğŸ—£ï¸ éŸ³å£°é€Ÿåº¦ (Voice Speed)
        <div class="speed-control">
            <button class="speed-btn" id="spd-0.6" onclick="setSpeed(0.6)">é…ã„</button>
            <button class="speed-btn" id="spd-0.8" onclick="setSpeed(0.8)">ã‚†ã£ãã‚Š</button>
            <button class="speed-btn" id="spd-1" onclick="setSpeed(1.0)">ãµã¤ã†</button>
            <button class="speed-btn" id="spd-1.2" onclick="setSpeed(1.2)">é€Ÿã„</button>
        </div>
    </div>

    <!-- Level -->
    <button class="tools-menu-item" onclick="changeLevel()">
        ğŸ“¶ ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã™ã‚‹
        <span class="sub-text">Change Level</span>
    </button>

    <!-- Full Reset -->
    <button class="tools-menu-item" onclick="resetApp()" style="color: #ff4444;">
        âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        <span class="sub-text">Reset All Data</span>
    </button>
</div>

<div id="webcam-container">
    <video id="webcam-video" autoplay playsinline muted></video>
</div>

<div id="chat-container">
    <!-- Messages will appear here -->
</div>

<div class="controls">
    <!-- Music Toggle Button (Kids only) -->
    <button id="music-toggle" class="btn-music-toggle" onclick="toggleKidsMusic()">ğŸµ éŸ³æ¥½ã‚ªãƒ•</button>

    <button class="btn-end" onclick="finishLesson()" title="ãƒ¬ãƒƒã‚¹ãƒ³ã‚’çµ‚äº†ã—ã¦æˆç¸¾ã‚’è¦‹ã‚‹">
        <span class="main">çµ‚äº†</span>
        <span class="sub">End</span>
    </button>
    
    <input type="text" id="user-input" placeholder="ã“ã“ã«å…¥åŠ› (Type here)..." onkeypress="handleKeyPress(event)" autocomplete="off">
    
    <button class="btn-icon btn-mic" id="mic-btn" onclick="toggleMic()" title="éŸ³å£°å…¥åŠ› (Speak)">ğŸ™ï¸</button>
    <button class="btn-icon btn-send" onclick="sendMessage()" title="é€ä¿¡ (Send)">â¤</button>
</div>

<!-- Report Card Modal (Lesson End) -->
<div class="modal-overlay" id="report-modal">
    <div class="modal" id="report-card">
        <h2>ğŸ‰ ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†ï¼<br><span style="font-size:0.6em; color:#888;">Lesson Complete</span></h2>
        <div id="report-content" class="report-card-content">
            <p style="text-align:center; color:#888;">ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆä¸­...<br><small>Generating report...</small></p>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="btn-icon btn-send" onclick="prepareAndPrint()" style="width: auto; padding: 0 20px; border-radius: 20px;">
                ğŸ–¨ï¸ å°åˆ· (Print)
            </button>
            <button class="btn-end" onclick="closeReport()" style="width: auto; padding: 0 20px; border-radius: 20px; background:#eee; color:#333; border:none; height: 45px;">
                <span class="main">é–‰ã˜ã‚‹</span>
                <span class="sub">Close</span>
            </button>
        </div>
    </div>
</div>

<!-- Stats Modal -->
<div class="modal-overlay" id="stats-modal">
    <div class="modal" style="max-width: 450px;">
        <h2>èƒ½åŠ›ãƒ¬ãƒãƒ¼ãƒˆ<br><span style="font-size:0.6em; color:#888;">Your Ability Stats</span></h2>
        <div class="report-card-content" id="stats-content">
            <!-- Bars will be injected here -->
        </div>
        <button class="btn-end" onclick="document.getElementById('stats-modal').style.display='none'" style="width: 100%; border-radius: 10px; background:#eee; color:#333; border:none;">
            <span class="main">é–‰ã˜ã‚‹ (Close)</span>
        </button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div class="modal-overlay" id="confirm-modal" style="z-index: 2000;">
    <div class="modal" style="max-width: 400px;">
        <h2 id="confirm-title">ç¢ºèª</h2>
        <p id="confirm-msg" style="margin: 20px 0;">ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-send" id="confirm-yes" style="width: auto; padding: 0 25px; border-radius: 20px;">ã¯ã„ (Yes)</button>
            <button class="btn-end" id="confirm-no" style="width: auto; padding: 0 25px; border-radius: 20px;">ã„ã„ãˆ (No)</button>
        </div>
    </div>
</div>

<!-- API Key Input Modal (Updated for Privacy) -->
<div class="modal-overlay" id="apikey-modal" style="z-index: 3000;">
    <div class="modal" style="max-width: 450px;">
        <h2>ğŸ”‘ APIã‚­ãƒ¼è¨­å®š</h2>
        <p style="text-align:left; font-size:0.9rem; color:#555; line-height:1.6;">
            ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯Google Geminiã®APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>
            ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            <small style="color:#888;">(â€»ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™)</small>
        </p>
        
        <div style="margin: 15px 0; text-align:center;">
             <a href="https://aistudio.google.com/app/apikey" target="_blank" style="display:inline-block; padding:8px 15px; background:#f0f0f0; border-radius:5px; text-decoration:none; color:#4A90E2; font-weight:bold; border:1px solid #ddd;">
                ğŸ”— Google AI Studioã§ã‚­ãƒ¼ã‚’å–å¾—
             </a>
        </div>

        <div style="position:relative; margin-bottom:15px;">
            <input type="password" id="manual-api-key" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ (Paste API Key here)" style="width:100%; box-sizing:border-box; padding:12px; padding-right:45px; border:2px solid #ddd; border-radius:8px;">
            <button onclick="toggleApiKeyVisibility()" title="è¡¨ç¤º/éè¡¨ç¤º" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); border:none; background:none; cursor:pointer; font-size:1.2rem; color:#888;">ğŸ‘ï¸</button>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn-send" id="apikey-submit" style="flex:1; border-radius: 20px;">ä¿å­˜ã—ã¦é–‹å§‹ (Save & Start)</button>
            <button class="btn-end" id="apikey-delete" onclick="deleteApiKey()" style="flex:0 0 auto; display:none; border-radius:20px;">å‰Šé™¤ (Delete)</button>
        </div>
        <button id="apikey-close" onclick="closeApiKeyModal()" style="margin-top:10px; background:none; border:none; color:#888; text-decoration:underline; cursor:pointer; display:none;">
            é–‰ã˜ã‚‹ (Close)
        </button>
    </div>
</div>

<!-- Level Select Modal -->
<div class="modal-overlay" id="level-modal" style="display: none;" onclick="closeLevelModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div id="level-step-1">
            <h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã­<br><span style="font-size:0.6em; color:#888;">Select Your Level</span></h2>
            
            <!-- Kids Level (Music) -->
            <button class="level-btn kids" onclick="showScenarios(0)">
                <b>ğŸ£ ã‚­ãƒƒã‚º <span class="en-label">Kids</span></b>
                <small>ğŸµ ãŸã®ã—ã„ãŠã‚“ãŒããƒ»ã²ã‚‰ãŒãªãƒ¢ãƒ¼ãƒ‰<br>(ã‚ˆã†ã˜ã€œã—ã‚‡ã†ãŒã£ã“ã†ã¦ã„ãŒãã­ã‚“)</small>
            </button>

            <button class="level-btn" onclick="showScenarios(1)">
                <b>ğŸŒ± åˆç´š <span class="en-label">Beginner</span></b>
                <small>æ—¥æœ¬èªè¨³ä»˜ãã€‚ã‚„ã•ã—ãã€‚<br>(å°å­¦ç”Ÿã€œä¸­1å‘ã‘)</small>
            </button>
            
            <button class="level-btn" onclick="showScenarios(2)">
                <b>âœˆï¸ ä¸­ç´š <span class="en-label">Intermediate</span></b>
                <small>æ—¥å¸¸ä¼šè©±ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã€‚<br>(ä¸­2ã€œé«˜1å‘ã‘)</small>
            </button>
            
            <button class="level-btn" onclick="showScenarios(3)">
                <b>ğŸš€ ä¸Šç´š <span class="en-label">Advanced</span></b>
                <small>All English. è­°è«–ã‚„ãƒ“ã‚¸ãƒã‚¹ã€‚<br>(é«˜æ ¡ç”Ÿä»¥ä¸Š)</small>
            </button>

            <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ -->
            <button id="level-cancel-btn" onclick="closeLevelModal(null, true)" style="display:none; width: 100%; margin-top:15px; background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">
                Ã— é–‰ã˜ã‚‹ (Cancel)
            </button>
        </div>

        <div id="level-step-2" style="display:none;">
            <h2>ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³<br><span style="font-size:0.6em; color:#888;">Select a Scenario</span></h2>
            <div id="scenario-list" class="scenario-grid">
                <!-- Buttons injected by JS -->
            </div>
            <button onclick="backToLevels()" style="margin-top:15px; background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">
                â† ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹ (Back)
            </button>
        </div>
    </div>
</div>

<!-- Dedicated Print Area (Invisible normally) -->
<div id="print-area">
    <h2>English Buddy - Report Card</h2>
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
        <span>Date: <span id="print-date"></span></span>
        <span>Total Score: <span id="print-score"></span></span>
    </div>
    
    <!-- ã“ã“ã«ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ãŒå…¥ã‚‹ -->
    <div id="print-content" class="report-card-content"></div>

    <div style="margin-top: 30px;">
        <h3>èƒ½åŠ›ã‚¹ã‚³ã‚¢ (Ability Stats)</h3>
        <div id="print-stats"></div>
    </div>
</div>

<script>
    // --- 1. Configuration & State ---
    const defaultApiKey = ""; 
    
    let chatHistory = [];
    let state = {
        level: 1, 
        scenarioName: "General",
        xp: 0,
        totalScore: 0,
        speechRate: 0.8, // Default set to Slow
        detailedScores: {
            knowledge: 0,
            thinking: 0,
            expression: 0,
            attitude: 0,
            vocabulary: 0
        }
    };

    const SCENARIOS = {
        0: [ // Kids
            { id: "animals", label: "ã©ã†ã¶ã¤ (Animals)" },
            { id: "colors", label: "ã„ã‚ (Colors)" },
            { id: "fruits", label: "ãã ã‚‚ã® (Fruits)" },
            { id: "numbers", label: "ã‹ãš (Numbers)" },
            { id: "greetings", label: "ã‚ã„ã•ã¤ (Greetings)" },
            { id: "body", label: "ã‹ã‚‰ã  (Body)" }
        ],
        1: [
            { id: "self_intro", label: "è‡ªå·±ç´¹ä»‹ (Self Intro)" },
            { id: "school", label: "å­¦æ ¡ã§ (At School)" },
            { id: "shopping", label: "ãŠè²·ã„ç‰© (Shopping)" },
            { id: "pet_shop", label: "ãƒšãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ— (Pet Shop)" },
            { id: "restaurant", label: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ (Restaurant)" },
            { id: "friends", label: "å‹é”ã¨ (With Friends)" },
            { id: "family", label: "å®¶æ— (Family)" },
            { id: "weather", label: "å¤©æ°— (Weather)" },
            { id: "park", label: "å…¬åœ’ã§ (At the Park)" },
            { id: "food", label: "å¥½ããªé£Ÿã¹ç‰© (Favorite Food)" }
        ],
        2: [
            { id: "airport", label: "ç©ºæ¸¯ (Airport)" },
            { id: "hotel", label: "ãƒ›ãƒ†ãƒ« (Hotel)" },
            { id: "doctor", label: "ç—…é™¢ (Hospital)" },
            { id: "directions", label: "é“æ¡ˆå†… (Directions)" },
            { id: "cooking", label: "æ–™ç† (Cooking)" },
            { id: "phone", label: "é›»è©± (Phone Call)" },
            { id: "cinema", label: "æ˜ ç”»é¤¨ (Cinema)" },
            { id: "lost_found", label: "è½ã¨ã—ç‰© (Lost & Found)" },
            { id: "weekend", label: "é€±æœ«ã®äºˆå®š (Weekend Plans)" },
            { id: "dreams", label: "å°†æ¥ã®å¤¢ (Future Dreams)" }
        ],
        3: [
            { id: "interview", label: "é¢æ¥ (Job Interview)" },
            { id: "environment", label: "ç’°å¢ƒå•é¡Œ (Environment)" },
            { id: "tech", label: "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ (Tech)" },
            { id: "debate", label: "è¨è«– (Debate)" },
            { id: "culture", label: "æ–‡åŒ– (Culture)" },
            { id: "news", label: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ (News)" },
            { id: "ai_future", label: "AIã®æœªæ¥ (Future of AI)" },
            { id: "space", label: "å®‡å®™æ—…è¡Œ (Space Travel)" },
            { id: "health", label: "å¥åº·çš„ãªç”Ÿæ´» (Healthy Lifestyle)" },
            { id: "education", label: "æ•™è‚²ã«ã¤ã„ã¦ (Education)" }
        ]
    };

    // --- 2. Helper Functions (Defined BEFORE Usage) ---

    // Simple Synth for Kids BGM (Web Audio API)
    // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã‚ãšã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å„ªã—ã„ã‚ªãƒ«ã‚´ãƒ¼ãƒ«é¢¨ã®éŸ³ã‚’ç”Ÿæˆã—ã¾ã™
    const KidsMusic = {
        ctx: null,
        isPlaying: false,
        timeoutId: null,
        userEnabled: true, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ON/OFF
        
        // æ˜ã‚‹ã„éŸ³éš (Pentatonic): C, D, E, G, A (High C, High D)
        // å°‘ã—é«˜ã‚ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã§ã‚­ãƒ©ã‚­ãƒ©æ„Ÿã‚’å‡ºã™
        notes: [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50], 
        
        init: function() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
        },
        
        playNote: function(freq, duration) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = 'sine'; // å„ªã—ã„ã‚µã‚¤ãƒ³æ³¢
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            
            // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ— (ã½ã‚ãƒ¼ã‚“ã¨ã„ã†éŸ³ - æ˜ã‚‹ãçŸ­ã‚ã«)
            gain.gain.setValueAtTime(0, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + 0.05); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration); // Decay
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        loop: function() {
            if (!this.isPlaying || !this.userEnabled) return;
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³ã‚’é¸ã¶ (å’ŒéŸ³ã£ã½ã2éŸ³å‡ºã™ã“ã¨ã‚‚)
            const note = this.notes[Math.floor(Math.random() * this.notes.length)];
            
            // æ˜ã‚‹ã„ãƒ†ãƒ³ãƒ (0.8ç§’ã€œ2.0ç§’é–“éš”)
            const wait = 800 + Math.random() * 1200;
            
            this.playNote(note, 2.0); 
            
            // ãŸã¾ã«2éŸ³ç›®ã‚’é³´ã‚‰ã™ (ã‚­ãƒ©ã‚­ãƒ©æ„Ÿ)
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    const note2 = this.notes[Math.floor(Math.random() * this.notes.length)];
                    this.playNote(note2, 2.0);
                }, 200);
            }

            this.timeoutId = setTimeout(() => this.loop(), wait);
        },

        start: function() {
            if (!this.userEnabled) return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒOFFã«ã—ã¦ãŸã‚‰é³´ã‚‰ã•ãªã„
            
            this.init();
            if (this.isPlaying) return;
            this.isPlaying = true;
            if (this.ctx.state === 'suspended') this.ctx.resume();
            this.loop();
        },

        stop: function() {
            this.isPlaying = false;
            if (this.timeoutId) clearTimeout(this.timeoutId);
        },

        toggle: function() {
            this.userEnabled = !this.userEnabled;
            if (this.userEnabled) {
                this.start();
                return true;
            } else {
                this.stop();
                return false;
            }
        }
    };


    // API Key Management
    function getStoredApiKey() {
        return localStorage.getItem('geminiApiKey') || defaultApiKey;
    }

    function toggleApiKeyVisibility() {
        const input = document.getElementById('manual-api-key');
        if (input.type === "password") {
            input.type = "text";
        } else {
            input.type = "password";
        }
    }

    function showApiKeyModal(isInitial = false) {
        const modal = document.getElementById('apikey-modal');
        const input = document.getElementById('manual-api-key');
        const closeBtn = document.getElementById('apikey-close');
        const deleteBtn = document.getElementById('apikey-delete');
        
        input.value = getStoredApiKey();
        // åˆæœŸçŠ¶æ…‹ã¯å¿…ãšéè¡¨ç¤º(password)ã«æˆ»ã™
        input.type = "password";
        modal.style.display = 'flex';
        
        if (isInitial) {
            closeBtn.style.display = 'none';
        } else {
            closeBtn.style.display = 'block';
        }

        if (localStorage.getItem('geminiApiKey')) {
            deleteBtn.style.display = 'block';
        } else {
            deleteBtn.style.display = 'none';
        }

        document.getElementById('apikey-submit').onclick = () => {
            const val = input.value.trim();
            if (val) {
                localStorage.setItem('geminiApiKey', val);
                modal.style.display = 'none';
                if(isInitial) {
                    checkFirstRun();
                }
            } else {
                alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Please enter an API Key)");
            }
        };
    }

    function closeApiKeyModal() {
        document.getElementById('apikey-modal').style.display = 'none';
    }

    function deleteApiKey() {
        if(confirm("ä¿å­˜ã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('manual-api-key').value = '';
            document.getElementById('apikey-delete').style.display = 'none';
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        }
    }


    // ã€é«˜æ©Ÿèƒ½å°åˆ·é–¢æ•°ã€‘
    const handlePrint = (targetId, orientation = 'portrait') => {
        const content = document.getElementById(targetId);
        if (!content) return;
        const contentHtml = content.outerHTML;

        const printWindow = window.open('', '_blank', 'height=800,width=1000');
        if (!printWindow) return;

        const pageStyle = orientation === 'landscape' 
            ? '@page { size: landscape; margin: 10mm; }' 
            : '@page { size: portrait; margin: 10mm; }';

        printWindow.document.write(`
            <html>
            <head>
                <meta charset="UTF-8">
                <title>å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
                <style>
                    body { 
                        font-family: 'Zen Maru Gothic', sans-serif;
                        background-color: white;
                        margin: 0; padding: 20px;
                        -webkit-print-color-adjust: exact; 
                        print-color-adjust: exact;
                    }
                    ${pageStyle}
                    #${targetId} {
                        transform: none !important;
                        margin: 0 auto !important;
                        box-shadow: none !important;
                        width: 100% !important;
                        height: auto !important;
                        display: block !important;
                    }
                    .report-card-content {
                        border: 2px solid #333;
                        padding: 20px;
                        border-radius: 10px;
                    }
                    .report-card-content h3 { 
                        border-bottom: 1px solid #333; 
                        margin-top: 15px; 
                        font-size: 1.1rem;
                    }
                    .stat-row { margin-bottom: 10px; }
                    .stat-label { display: flex; justify-content: space-between; font-weight: bold; }
                    .stat-bg { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; border: 1px solid #ccc; }
                    .stat-fill { height: 100%; background: #666; } 
                </style>
            </head>
            <body>
                ${contentHtml}
                <script>
                    setTimeout(function() { 
                        window.focus();
                        window.print();
                    }, 1000);
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    };

    function showConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirm-modal');
            const msgEl = document.getElementById('confirm-msg');
            const yesBtn = document.getElementById('confirm-yes');
            const noBtn = document.getElementById('confirm-no');

            msgEl.innerText = message;
            modal.style.display = 'flex';

            const close = (result) => {
                modal.style.display = 'none';
                yesBtn.onclick = null;
                noBtn.onclick = null;
                resolve(result);
            };

            yesBtn.onclick = () => close(true);
            noBtn.onclick = () => close(false);
        });
    }

    // Save/Load Logic
    function saveData(isFile = false) {
        localStorage.setItem('englishBuddyState', JSON.stringify(state));
        localStorage.setItem('englishBuddyHistory', JSON.stringify(chatHistory));
        if(isFile) {
            const data = JSON.stringify({state, chatHistory}, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `english_buddy_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
    }

    function loadData() {
        const s = localStorage.getItem('englishBuddyState');
        const h = localStorage.getItem('englishBuddyHistory');
        if(s) {
            const loadedState = JSON.parse(s);
            state = { ...state, ...loadedState }; 
        }
        if(h) chatHistory = JSON.parse(h);
    }

    // UI Updates
    function updateUI() {
        const levelDisplay = document.getElementById('level-display');
        const xpBar = document.getElementById('xp-bar');
        const totalScoreDisplay = document.getElementById('total-score-display');
        
        const levels = ["ã‚­ãƒƒã‚º Kids", "åˆç´š Beginner", "ä¸­ç´š Intermediate", "ä¸Šç´š Advanced"];
        const levelLabels = {0: "ã‚­ãƒƒã‚º Kids", 1: "åˆç´š Beginner", 2: "ä¸­ç´š Intermediate", 3: "ä¸Šç´š Advanced"};

        levelDisplay.innerHTML = `${levelLabels[state.level]}<br><small>${state.scenarioName}</small>`;
        
        const xpPercent = Math.min(100, Math.max(0, state.xp));
        xpBar.style.width = `${xpPercent}%`;
        totalScoreDisplay.innerText = state.totalScore || 0;
    }

    function setSpeedUI(rate) {
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
        const btnId = `spd-${rate}`;
        const target = document.getElementById(btnId);
        if (target) target.classList.add('active');
        else {
             const fb = document.getElementById('spd-0.8');
             if(fb) fb.classList.add('active');
        }
    }

    function addMessage(text, sender) {
        const chatContainer = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        if (sender === 'ai') {
            let formatted = text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/(\(.*?\))/g, '<span class="translation">$1</span>')
                .replace(/(One Point Advice:|One point advice!)/i, '<br><b>ğŸ’¡ Advice:</b>');
            
            div.innerHTML = formatted;

            const btn = document.createElement('button');
            btn.className = 'speak-btn';
            btn.innerHTML = 'ğŸ”Š èã';
            btn.onclick = () => speakText(text);
            div.appendChild(btn);
        } else {
            div.innerText = text;
        }

        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderChatHistory() {
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        chatHistory.forEach(msg => {
            let txt = msg.parts[0].text;
            txt = txt.replace(/<<<JSON[\s\S]*?JSON>>>/, '').replace(/<<<SCORE:.*?>>>/, '');
            addMessage(txt, msg.role === 'model' ? 'ai' : 'user');
        });
    }

    // System Prompt
    const getSystemPrompt = () => {
        const levelNames = {0: "Kids", 1: "Beginner", 2: "Intermediate", 3: "Advanced"};
        const currentLevelName = levelNames[state.level];
        
        let levelInstruction = "";
        if (state.level === 0) {
            levelInstruction = `
            - **Kids Level (Important)**:
            - TALK IN "HIRAGANA" (Japanese) ONLY. NO KANJI.
            - Teach 1 English word at a time. (e.g., "ã‚Šã‚“ã”ï¼ Apple! ğŸ")
            - Be super energetic and friendly! Use many Emojis!
            - Ask simple quiz questions. (e.g., "ã“ã‚Œ ãªãƒ¼ã‚“ã ï¼Ÿ")
            `;
        } else if (state.level === 1) {
            levelInstruction = `- **Beginner**: ALWAYS provide Japanese translation in parenthesis. Short sentences. Do NOT make Japanese translation bold.`;
        } else if (state.level === 2) {
            levelInstruction = `- **Intermediate**: English mostly. Provide "One Point Advice" for mistakes.`;
        } else {
            levelInstruction = `- **Advanced**: English only. Sophisticated.`;
        }

        return `
        You are "English Buddy", a friendly AI tutor.
        
        CONTEXT:
        - Level: ${currentLevelName} (Level ${state.level})
        - Scenario: ${state.scenarioName}
        
        CORE INSTRUCTIONS:
        1. **Scoring (JSON)**: 
           - Evaluate the user's response.
           - At the END of your response, strictly output a JSON block like this (HIDDEN from user):
           <<<JSON
           {
             "score": 10,
             "details": {
               "knowledge": 2,
               "thinking": 1,
               "expression": 2,
               "attitude": 3,
               "vocabulary": 1
             }
           }
           JSON>>>
        
        2. **Scenario**:
           - Act out the role: ${state.scenarioName}.
           - If this is the first message, start by setting the scene for ${state.scenarioName}.

        3. **Level Rules**:
           ${levelInstruction}

        4. **Safety**:
           - If user says "Cow", "Potato" etc. abruptly, ask "Is that your name?" nicely. 
           - Never scold.
        `;
    };

    // API Call
    async function callGeminiAPI(history, systemInstructionText, retryKey = null) {
        const baseUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const storedKey = getStoredApiKey();
        const keyToUse = retryKey !== null ? retryKey : storedKey;
        
        const url = `${baseUrl}?key=${keyToUse}`;
        
        const payload = {
            contents: history,
            systemInstruction: { parts: [{ text: systemInstructionText }] }
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if ((response.status === 400 || response.status === 401 || response.status === 403) && !retryKey) {
                    showApiKeyModal(); 
                    throw new Error("API Key required. Please check settings.");
                }
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't understand that.";
            
        } catch (e) {
            throw e; 
        }
    }

    // --- 3. Initialization (onload) ---
    window.onload = () => {
        const key = getStoredApiKey();
        if (!key) {
            showApiKeyModal(true); 
        } else {
            checkFirstRun();
        }
    };

    function checkFirstRun() {
        loadData();
        
        if (typeof state.speechRate === 'undefined') state.speechRate = 0.8;
        if (!state.detailedScores) {
            state.detailedScores = { knowledge:0, thinking:0, expression:0, attitude:0, vocabulary:0 };
        }
        if (!state.scenarioName) state.scenarioName = "General";

        updateUI();
        setSpeedUI(state.speechRate);
        
        // ã‚‚ã—ãƒ­ãƒ¼ãƒ‰ã—ãŸçŠ¶æ…‹ã§Kidsãƒ¢ãƒ¼ãƒ‰ãªã‚‰BGMé–‹å§‹
        if (state.level === 0) {
            showMusicButton(true);
            KidsMusic.start();
        } else {
            showMusicButton(false);
        }

        if (!localStorage.getItem('englishBuddyState')) {
            document.getElementById('level-modal').style.display = 'flex';
        } else {
            renderChatHistory();
        }
    }

    // --- 4. Event Handlers ---

    window.toggleKidsMusic = () => {
        const isPlaying = KidsMusic.toggle();
        const btn = document.getElementById('music-toggle');
        if (isPlaying) {
            btn.innerText = "ğŸµ éŸ³æ¥½ã‚ªãƒ•";
        } else {
            btn.innerText = "ğŸ”‡ éŸ³æ¥½ã‚ªãƒ³";
        }
    };
    
    function showMusicButton(show) {
        document.getElementById('music-toggle').style.display = show ? 'block' : 'none';
    }

    window.sendMessage = async () => {
        const userInput = document.getElementById('user-input');
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';
        chatHistory.push({ role: "user", parts: [{ text: text }] });
        
        const chatContainer = document.getElementById('chat-container');
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai';
        loadingDiv.innerText = '...';
        loadingDiv.id = 'loading-msg';
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const rawText = await callGeminiAPI(chatHistory, getSystemPrompt());

            const loader = document.getElementById('loading-msg');
            if(loader) loader.remove();

            let displayText = rawText;
            const jsonMatch = rawText.match(/<<<JSON([\s\S]*?)JSON>>>/);
            
            if (jsonMatch) {
                try {
                    const scoreData = JSON.parse(jsonMatch[1]);
                    updateScores(scoreData);
                    displayText = rawText.replace(jsonMatch[0], '');
                } catch(e) { console.error("Score Parse Error", e); }
            } else {
                const scoreMatch = rawText.match(/<<<SCORE:(-?\d+)>>>/);
                if (scoreMatch) {
                    updateScores({ score: parseInt(scoreMatch[1]) });
                    displayText = rawText.replace(scoreMatch[0], '');
                }
            }

            chatHistory.push({ role: "model", parts: [{ text: rawText }] });
            addMessage(displayText, 'ai');
            speakText(displayText);
            saveData();

        } catch (error) {
            console.error(error);
            const loader = document.getElementById('loading-msg');
            if(loader) {
                loader.innerText = "âš ï¸ " + error.message;
            }
        }
    };

    function updateScores(data) {
        const points = data.score || 0;
        state.xp += points;
        state.totalScore = (state.totalScore || 0) + points;

        if (data.details) {
            for (let key in data.details) {
                if (state.detailedScores[key] !== undefined) {
                    state.detailedScores[key] += data.details[key];
                }
            }
        }

        const chatContainer = document.getElementById('chat-container');
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.innerText = points >= 0 ? `+${points} XP` : `${points} XP`;
        popup.style.color = points >= 0 ? '#50E3C2' : '#FF6B6B';
        popup.style.right = (20 + Math.random()*40) + 'px';
        popup.style.top = (chatContainer.scrollTop + 100) + 'px'; 
        chatContainer.appendChild(popup);
        setTimeout(() => popup.remove(), 1500);

        if (state.xp >= 100) {
            state.xp -= 100;
            const celebrate = document.createElement('div');
            celebrate.className = 'message ai';
            celebrate.style.background = '#fff3cd';
            celebrate.innerHTML = `ğŸ‰ <b>Level Up Bonus!</b><br>Good job! Keep going!`;
            chatContainer.appendChild(celebrate);
        } else if (state.xp < 0) state.xp = 0;

        updateUI();
    }

    window.showStats = () => {
        const labels = {
            knowledge: "çŸ¥è­˜ãƒ»æŠ€èƒ½ (Knowledge)",
            thinking: "æ€è€ƒãƒ»åˆ¤æ–­ (Logic)",
            expression: "è¡¨ç¾åŠ› (Expression)",
            attitude: "ä¸»ä½“æ€§ (Attitude)",
            vocabulary: "èªå½™åŠ› (Vocabulary)"
        };
        
        let html = '';
        const maxVal = Math.max(...Object.values(state.detailedScores), 50);

        for (let key in state.detailedScores) {
            const val = state.detailedScores[key];
            const pct = Math.min(100, (val / maxVal) * 100);
            html += `
            <div class="stat-row">
                <div class="stat-label">
                    <span>${labels[key]}</span>
                    <span>${val}</span>
                </div>
                <div class="stat-bg">
                    <div class="stat-fill" style="width: ${pct}%"></div>
                </div>
            </div>`;
        }
        document.getElementById('stats-content').innerHTML = html;
        document.getElementById('stats-modal').style.display = 'flex';
    };

    window.changeLevel = () => {
        // ãƒ¬ãƒ™ãƒ«å¤‰æ›´æ™‚ã¯éŸ³æ¥½ã‚’æ­¢ã‚ã‚‹
        KidsMusic.stop();

        document.getElementById('level-step-1').style.display = 'block';
        document.getElementById('level-step-2').style.display = 'none';
        document.getElementById('level-modal').style.display = 'flex';
        document.getElementById('tools-menu').style.display = 'none';
        
        const hasData = chatHistory.length > 0 || localStorage.getItem('englishBuddyState');
        const cancelBtn = document.getElementById('level-cancel-btn');
        if (cancelBtn) cancelBtn.style.display = hasData ? 'block' : 'none';
    };

    window.closeLevelModal = (e, force = false) => {
        const hasData = chatHistory.length > 0 || localStorage.getItem('englishBuddyState');
        if (!hasData) return;

        if (force || (e && e.target.id === 'level-modal')) {
            document.getElementById('level-modal').style.display = 'none';
            // é–‰ã˜ãŸã¨ãã«Kidsãƒ¢ãƒ¼ãƒ‰ãªã‚‰éŸ³æ¥½å†é–‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’å°Šé‡)
            if (state.level === 0) {
                showMusicButton(true);
                KidsMusic.start();
            } else {
                showMusicButton(false);
            }
        }
    };

    window.showScenarios = (lv) => {
        state.level = lv;
        
        // Kidsãƒ¢ãƒ¼ãƒ‰(0)ãªã‚‰éŸ³æ¥½ã‚¹ã‚¿ãƒ¼ãƒˆã€ãã‚Œä»¥å¤–ã¯ã‚¹ãƒˆãƒƒãƒ—
        if (lv === 0) {
            showMusicButton(true);
            KidsMusic.start();
        } else {
            showMusicButton(false);
            KidsMusic.stop();
        }

        const list = document.getElementById('scenario-list');
        list.innerHTML = '';
        SCENARIOS[lv].forEach(sc => {
            const btn = document.createElement('div');
            btn.className = 'scenario-btn';
            btn.innerText = sc.label;
            btn.onclick = () => setScenario(sc.label);
            list.appendChild(btn);
        });
        document.getElementById('level-step-1').style.display = 'none';
        document.getElementById('level-step-2').style.display = 'block';
    };

    window.backToLevels = () => {
        // æˆ»ã‚‹æ™‚ã¯ä¸€æ—¦åœæ­¢
        KidsMusic.stop();
        document.getElementById('level-step-1').style.display = 'block';
        document.getElementById('level-step-2').style.display = 'none';
    };

    window.setScenario = (name) => {
        state.scenarioName = name;
        state.xp = 0; 
        chatHistory = []; 
        saveData();
        updateUI();
        renderChatHistory();
        document.getElementById('level-modal').style.display = 'none';
        setTimeout(() => { startScenarioAI(); }, 500);
    };

    async function startScenarioAI() {
        try {
            const prompt = `(System: The user selected the scenario "${state.scenarioName}". Please start the conversation with a friendly greeting and set the scene.)`;
            const initialHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const aiText = await callGeminiAPI(initialHistory, getSystemPrompt());
            let displayText = aiText.replace(/<<<JSON[\s\S]*?JSON>>>/, '').replace(/<<<SCORE:.*?>>>/, '');
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            addMessage(displayText, 'ai');
            speakText(displayText);
            saveData();
        } catch(e) { console.error(e); }
    }

    window.resetChatOnly = async () => {
        const sure = await showConfirm("ä¼šè©±ã®å±¥æ­´ã ã‘ã‚’æ¶ˆã—ã¦ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\n(Reset chat history? Score will be kept.)");
        if(!sure) return;
        chatHistory = [];
        state.xp = 0;
        saveData();
        renderChatHistory();
        document.getElementById('tools-menu').style.display = 'none';
        startScenarioAI();
    };

    window.setSpeed = (rate) => {
        state.speechRate = rate;
        setSpeedUI(rate);
        saveData();
    };

    window.toggleMic = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
            return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        const micBtn = document.getElementById('mic-btn');
        const userInput = document.getElementById('user-input');

        recognition.onstart = () => micBtn.classList.add('listening');
        recognition.onend = () => micBtn.classList.remove('listening');
        recognition.onresult = (e) => {
            userInput.value = e.results[0][0].transcript;
            userInput.focus();
        };
        recognition.start();
    };

    function speakText(text) {
        if (!window.speechSynthesis) return;
        const cleanText = text
            .replace(/\(.*?\)/g, "")
            .replace(/<<<.*?>>>/g, "")
            .replace(/[*":_`~#]/g, "")
            .replace(/\s+/g, " ")
            .replace(/[^\x00-\x7F]+/g, "")
            .trim(); 
        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'en-US';
        u.rate = state.speechRate || 1.0;
        const voices = speechSynthesis.getVoices();
        const enVoice = voices.find(v => v.lang.includes('en-US') && !v.name.includes('Google'));
        if (enVoice) u.voice = enVoice;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
    }

    let stream = null;
    window.toggleWebcam = async () => {
        const webcamContainer = document.getElementById('webcam-container');
        const webcamVideo = document.getElementById('webcam-video');
        if (webcamContainer.style.display === 'block') {
            webcamContainer.style.display = 'none';
            if(stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        } else {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = stream;
                webcamContainer.style.display = 'block';
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        }
    };

    window.loadDataFromFile = (input) => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.state && data.chatHistory) {
                    state = { ...state, ...data.state };
                    chatHistory = data.chatHistory;
                    if (!state.detailedScores) state.detailedScores = { knowledge:0, thinking:0, expression:0, attitude:0, vocabulary:0 };
                    saveData();
                    updateUI();
                    setSpeedUI(state.speechRate);
                    renderChatHistory();
                    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼");
                    document.getElementById('tools-menu').style.display = 'none';
                }
            } catch (err) { alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
        };
        reader.readAsText(file);
        input.value = '';
    };

    window.resetApp = async () => {
        const sure = await showConfirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(Delete All Data?)");
        if(sure) {
            localStorage.removeItem('englishBuddyState');
            localStorage.removeItem('englishBuddyHistory');
            localStorage.removeItem('geminiApiKey'); // Reset Key
            KidsMusic.stop(); // Stop Music
            location.reload();
        }
    };

    window.toggleTools = () => {
        const toolsMenu = document.getElementById('tools-menu');
        toolsMenu.style.display = toolsMenu.style.display === 'flex' ? 'none' : 'flex';
    };

    // --- Report & Print Updates ---

    window.finishLesson = async () => {
        addMessage("... æˆç¸¾è¡¨ã‚’ä½œæˆã—ã¦ã„ã¾ã™ ...<br>(Generating Report Card...)", 'ai');
        try {
            const historyText = chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join("\n");
            
            const prompt = `
            Generate "Report Card" for the student.
            Output format: HTML.
            Use <h3> for section headers.
            Use <ul> and <li> for lists.
            Use <p> for normal text.
            Do NOT use Markdown syntax (like ## or - or **).
            
            sections:
            1. Overall Evaluation (Brief comment)
            2. Score Summary
            3. 3 Learned Words (with Japanese meaning)
            4. Teacher's Message
            
            HISTORY: ${historyText.slice(-2000)}
            `;
            
            const tempHistory = [{ role: 'user', parts: [{ text: prompt }] }];
            const reportText = await callGeminiAPI(tempHistory, getSystemPrompt());
            
            document.getElementById('report-content').innerHTML = reportText;
            document.getElementById('report-modal').style.display = 'flex';
        } catch(e) {
            document.getElementById('report-content').innerHTML = "<p>ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
            document.getElementById('report-modal').style.display = 'flex';
        }
    };

    window.closeReport = () => {
        document.getElementById('report-modal').style.display = 'none';
    };

    // å°åˆ·å®Ÿè¡Œ
    window.prepareAndPrint = () => {
        document.getElementById('print-content').innerHTML = document.getElementById('report-content').innerHTML;
        document.getElementById('print-date').innerText = new Date().toLocaleDateString();
        document.getElementById('print-score').innerText = state.totalScore || 0;
        
        const labels = {
            knowledge: "çŸ¥è­˜ãƒ»æŠ€èƒ½", thinking: "æ€è€ƒãƒ»åˆ¤æ–­", expression: "è¡¨ç¾åŠ›", attitude: "ä¸»ä½“æ€§", vocabulary: "èªå½™åŠ›"
        };
        let statsHtml = '';
        const maxVal = Math.max(...Object.values(state.detailedScores), 50);
        for (let key in state.detailedScores) {
            const val = state.detailedScores[key];
            const pct = Math.min(100, (val / maxVal) * 100);
            statsHtml += `
            <div class="stat-row">
                <div class="stat-label"><span>${labels[key]}</span><span>${val}</span></div>
                <div class="stat-bg"><div class="stat-fill" style="width: ${pct}%"></div></div>
            </div>`;
        }
        document.getElementById('print-stats').innerHTML = statsHtml;
        handlePrint('print-area', 'portrait');
    };

    window.handleKeyPress = (e) => {
        if(e.key === 'Enter') window.sendMessage();
    };

</script>
</body>
</html>