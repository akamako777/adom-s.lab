<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- スマホでも無理に縮小せず、PC用の幅(1100px)として認識させる -->
    <meta name="viewport" content="width=1100">
    <title>先生のクラス管理ツール Pro</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (cdnjs: より安定) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (cdnjs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- SheetJS (cdnjs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f0f9ff;
            /* 画面が狭くても潰れないように最小幅を固定し、横スクロールを許可する */
            min-width: 1100px;
            overflow-x: auto;
        }

        /* 印刷設定（通常画面用） */
        @media print {
            body { 
                display: none; /* 通常の印刷機能は無効化し、JSで制御する */
            }
        }

        .roulette-active .seat-card {
            animation: pulse 0.1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* モーダル */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            display: grid;
            place-items: center;
            overflow-y: auto;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* トースト通知 */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            min-width: 250px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast-success { background-color: #10B981; }
        .toast-error { background-color: #EF4444; }
        .toast-info { background-color: #3B82F6; }
        .toast-warning { background-color: #F59E0B; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ユーティリティ: アイコン ---
        const Icons = {
            Users: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Grid: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Calendar: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Layers: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Download: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Printer: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Trash: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Shuffle: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>,
            Plus: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Alert: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Check: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Smile: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>,
            ClipboardList: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            X: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ArrowDown: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
            ArrowUp: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
            RefreshCw: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Lock: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            AlertOctagon: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Info: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
        };

        // --- 印刷用ユーティリティ ---
        const handlePrint = (targetId, showToast) => {
            const content = document.getElementById(targetId);
            const header = document.getElementById('print-header');
            
            if (!content) {
                showToast("印刷対象が見つかりません", "error");
                return;
            }

            const contentHtml = content.innerHTML;
            const headerHtml = header ? header.innerHTML : '';
            const printWindow = window.open('', '_blank', 'height=800,width=1000');

            if (!printWindow) {
                showToast("ポップアップがブロックされました。設定を確認してください。", "error");
                return;
            }

            printWindow.document.write(`
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>印刷プレビュー</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');
                        body { 
                            font-family: 'Zen Maru Gothic', sans-serif;
                            background-color: white; 
                            -webkit-print-color-adjust: exact; 
                            print-color-adjust: exact;
                            padding: 20px;
                        }
                        .print-header-wrapper { text-align: center; margin-bottom: 2rem; }
                        .no-print { display: none !important; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 4px; }
                        @page { size: landscape; margin: 10mm; }
                    </style>
                </head>
                <body>
                    <div class="print-header-wrapper">${headerHtml}</div>
                    <div>${contentHtml}</div>
                    <script>
                        setTimeout(function() { window.print(); }, 1000);
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
            // printWindow.focus(); // モバイル等でエラーになることがあるため省略
        };

        // --- コンポーネント: トースト通知 ---
        const ToastContainer = ({ toasts, removeToast }) => {
            return (
                <div className="toast-container no-print">
                    {toasts.map(t => (
                        <div key={t.id} className={`toast toast-${t.type}`}>
                            {t.type === 'success' && <Icons.Check size={20} />}
                            {t.type === 'error' && <Icons.Alert size={20} />}
                            {t.type === 'info' && <Icons.Info size={20} />}
                            {t.type === 'warning' && <Icons.Alert size={20} />}
                            {t.message}
                        </div>
                    ))}
                </div>
            );
        };

        // --- コンポーネント: UIパーツ ---
        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, title = "" }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm text-sm whitespace-nowrap";
            const variants = {
                primary: "bg-blue-500 hover:bg-blue-600 text-white",
                secondary: "bg-white hover:bg-gray-50 text-gray-700 border border-gray-300",
                danger: "bg-red-500 hover:bg-red-600 text-white",
                success: "bg-green-500 hover:bg-green-600 text-white",
                ghost: "bg-transparent hover:bg-gray-100 text-gray-600"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} disabled={disabled} title={title}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, title, action, id }) => (
            <div id={id} className="bg-white rounded-xl shadow-lg p-6 mb-6">
                {(title || action) && (
                    <div className="flex justify-between items-center mb-4 border-b pb-2 no-print">
                        {title && <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">{title}</h2>}
                        <div>{action}</div>
                    </div>
                )}
                {children}
            </div>
        );

        const ConfirmModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay no-print">
                    <div className="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full animate-fade-in">
                        <h3 className="text-lg font-bold mb-2 flex items-center gap-2 text-gray-800">
                            <Icons.Alert /> 確認
                        </h3>
                        <p className="text-gray-600 mb-6 whitespace-pre-wrap">{message}</p>
                        <div className="flex justify-end gap-3">
                            <Button variant="secondary" onClick={onClose}>キャンセル</Button>
                            <Button variant="danger" onClick={() => { onConfirm(); onClose(); }}>実行する</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const PasswordModal = ({ isOpen, onClose, onConfirm, isLocking }) => {
            const [pass, setPass] = useState('');
            if(!isOpen) return null;
            return (
                <div className="modal-overlay no-print">
                    <div className="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full animate-fade-in">
                        <h3 className="text-lg font-bold mb-2 flex items-center gap-2 text-gray-800">
                            {isLocking ? <Icons.Lock /> : <Icons.Unlock />} 
                            {isLocking ? "ロック設定" : "ロック解除"}
                        </h3>
                        <p className="text-sm text-gray-600 mb-2">
                            {isLocking ? "パスワードを設定してください" : "パスワードを入力してください"}
                        </p>
                        <input type="password" className="w-full border rounded p-2 mb-4 font-mono text-center text-lg" 
                            autoFocus
                            placeholder="****"
                            value={pass} onChange={e=>setPass(e.target.value)} />
                        <div className="flex justify-end gap-3">
                            <Button variant="secondary" onClick={()=>{setPass(''); onClose();}}>キャンセル</Button>
                            <Button variant="primary" onClick={()=>{ onConfirm(pass); setPass(''); }} disabled={!pass}>OK</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const PasteModal = ({ isOpen, onClose, onImport, title, placeholder }) => {
            const [text, setText] = useState('');
            if (!isOpen) return null;
            return (
                <div className="modal-overlay no-print">
                    <div className="bg-white rounded-xl shadow-2xl w-[90vw] max-w-lg flex flex-col max-h-[80vh] animate-fade-in">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <Icons.ClipboardList /> {title}
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700"><Icons.X /></button>
                        </div>
                        <div className="p-6 flex-grow overflow-auto">
                            <p className="text-sm text-gray-600 mb-2">Excelなどのセルをコピーして、下の枠に貼り付けてください。</p>
                            <textarea 
                                className="w-full h-64 p-4 border rounded-lg font-mono text-sm bg-gray-50"
                                placeholder={placeholder} value={text} onChange={(e) => setText(e.target.value)}
                            ></textarea>
                        </div>
                        <div className="p-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-xl">
                            <Button variant="secondary" onClick={onClose}>キャンセル</Button>
                            <Button variant="primary" onClick={() => { onImport(text); setText(''); onClose(); }} disabled={!text.trim()}>
                                <Icons.Check /> 取り込み
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 1. 名簿登録 ---
        const StudentRegistration = ({ data, setData, isLocked, setIsLocked, lockPass, setLockPass, resetAll, showToast }) => {
            const [isImportModalOpen, setImportModalOpen] = useState(false);
            const [deleteId, setDeleteId] = useState(null);
            const [showPassModal, setShowPassModal] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            const generateId = () => 's_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);

            // 男女・混合カウント
            const counts = data.students.reduce((acc, s) => {
                if(s.gender === 'boy') acc.boy++;
                else if(s.gender === 'girl') acc.girl++;
                else acc.mixed++;
                return acc;
            }, {boy:0, girl:0, mixed:0});

            const addStudent = () => {
                const newStudent = {
                    id: generateId(),
                    name: '',
                    gender: 'mixed',
                    needsSupport: false,
                    fixedSeat: null,
                    avoid: ['', '', '']
                };
                setData(prev => ({ ...prev, students: [...prev.students, newStudent] }));
                // スクロール最下部へなどUX向上も可
            };

            const update = (id, field, val) => {
                if (field === 'fixedSeat') {
                    if (val === '') {
                        setData(prev => ({ ...prev, students: prev.students.map(s => s.id === id ? { ...s, [field]: null } : s) }));
                        return;
                    }

                    let seatNum = parseInt(val);
                    if (isNaN(seatNum)) return;
                    if (seatNum < 1) seatNum = 1;
                    if (seatNum > data.students.length) seatNum = data.students.length;

                    // 重複チェック
                    const isDuplicate = data.students.some(s => s.id !== id && s.fixedSeat === seatNum);
                    if (isDuplicate) {
                        showToast(`席番号 ${seatNum} は既に他の生徒に設定されています`, "error");
                        return;
                    }
                    val = seatNum;
                }
                
                setData(prev => ({ ...prev, students: prev.students.map(s => s.id === id ? { ...s, [field]: val } : s) }));
            };

            const remove = () => {
                setData(prev => ({ ...prev, students: prev.students.filter(s => s.id !== deleteId) }));
                setDeleteId(null);
                showToast("生徒を削除しました", "success");
            };
            const bulkImport = (text) => {
                const lines = text.split(/\r\n|\n|\r/).filter(l => l.trim());
                const newStudents = lines.map((l, i) => {
                    const parts = l.split('\t');
                    let gender = 'mixed';
                    if (parts[1] && /男|boy/i.test(parts[1])) gender = 'boy';
                    if (parts[1] && /女|girl/i.test(parts[1])) gender = 'girl';
                    return { 
                        id: generateId() + '_' + i, 
                        name: parts[0].trim(), gender, needsSupport: false, fixedSeat: null, avoid: ['', '', ''] 
                    };
                });
                setData(prev => ({ ...prev, students: [...prev.students, ...newStudents] }));
                showToast(`${newStudents.length}名のデータを取り込みました`, "success");
            };

            const handleLockAction = (inputPass) => {
                const input = String(inputPass);
                const saved = String(lockPass);

                if(isLocked) {
                    if(input === saved) {
                        setIsLocked(false);
                        setLockPass(null); 
                        showToast("ロックを解除しました", "success");
                    } else {
                        showToast("パスワードが違います", "error");
                    }
                } else {
                    setLockPass(input);
                    setIsLocked(true);
                    showToast("編集ロックを設定しました", "success");
                }
                setShowPassModal(false);
            };

            return (
                <div className="space-y-6">
                    <ConfirmModal isOpen={!!deleteId} onClose={() => setDeleteId(null)} onConfirm={remove} message="本当に削除しますか？" />
                    <ConfirmModal isOpen={showResetConfirm} onClose={() => setShowResetConfirm(false)} onConfirm={() => {resetAll(); setShowResetConfirm(false);}} message="注意：すべてのデータ（名簿、設定、班など）が消去されます。\n本当によろしいですか？" />
                    <PasteModal isOpen={isImportModalOpen} onClose={() => setImportModalOpen(false)} onImport={bulkImport} 
                        title="Excelから一括登録" placeholder={`氏名\n氏名\t性別\n...`} />
                    <PasswordModal isOpen={showPassModal} onClose={()=>setShowPassModal(false)} onConfirm={handleLockAction} isLocking={!isLocked} />
                    
                    <Card title="クラス基本情報">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label className="block"><span className="text-gray-700 font-bold">学校名</span><input type="text" disabled={isLocked} className="mt-1 block w-full border rounded p-2" value={data.settings.school} onChange={e => setData({...data, settings: {...data.settings, school: e.target.value}})} /></label>
                            <label className="block"><span className="text-gray-700 font-bold">学年・組</span><input type="text" disabled={isLocked} className="mt-1 block w-full border rounded p-2" value={data.settings.gradeClass} onChange={e => setData({...data, settings: {...data.settings, gradeClass: e.target.value}})} /></label>
                            <label className="block"><span className="text-gray-700 font-bold">担任名</span><input type="text" disabled={isLocked} className="mt-1 block w-full border rounded p-2" value={data.settings.teacher} onChange={e => setData({...data, settings: {...data.settings, teacher: e.target.value}})} /></label>
                        </div>
                    </Card>

                    <Card title={`生徒名簿 (${data.students.length}名)`} action={
                        <div className="flex gap-2">
                            <Button onClick={() => setShowResetConfirm(true)} variant="danger" title="全データ初期化">
                                <Icons.AlertOctagon /> オールクリア
                            </Button>

                            <Button onClick={() => setShowPassModal(true)} variant={isLocked ? "danger" : "secondary"} title={isLocked ? "ロック解除" : "編集ロック"}>
                                {isLocked ? <Icons.Lock /> : <Icons.Unlock />} {isLocked ? "解除" : "ロック"}
                            </Button>
                            
                            <Button onClick={() => setImportModalOpen(true)} disabled={isLocked} variant="secondary"><Icons.ClipboardList /> Excel取込</Button>
                            <Button onClick={addStudent} disabled={isLocked} variant="success"><Icons.Plus /> 追加</Button>
                        </div>
                    }>
                        <div className="mb-4 flex gap-4 text-sm font-bold text-gray-600 bg-gray-50 p-2 rounded no-print">
                            <span className="text-blue-600">男: {counts.boy}名</span>
                            <span className="text-red-600">女: {counts.girl}名</span>
                            <span className="text-gray-600">未設定: {counts.mixed}名</span>
                        </div>

                        {isLocked ? (
                            <div className="text-center py-10 text-gray-400 bg-gray-50 rounded border-2 border-dashed">
                                <Icons.Lock size={48} />
                                <p className="mt-2">名簿はロックされています</p>
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase">No.</th>
                                            <th className="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase w-40">氏名</th>
                                            <th className="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase">性別</th>
                                            <th className="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase">指導対象/固定席</th>
                                            <th className="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase">NG生徒</th>
                                            <th className="px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase">削除</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {data.students.map((s, i) => (
                                            <tr key={s.id}>
                                                <td className="px-3 py-2 text-gray-500">{i + 1}</td>
                                                <td className="px-3 py-2"><input className="w-full border rounded p-1" value={s.name} onChange={e => update(s.id, 'name', e.target.value)} /></td>
                                                <td className="px-3 py-2">
                                                    <select className="border rounded p-1" value={s.gender} onChange={e => update(s.id, 'gender', e.target.value)}>
                                                        <option value="mixed">任意</option><option value="boy">男</option><option value="girl">女</option>
                                                    </select>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div className="flex items-center gap-2">
                                                        <input type="checkbox" checked={s.needsSupport} onChange={e => update(s.id, 'needsSupport', e.target.checked)} />
                                                        {s.needsSupport && <input type="number" min="1" max={data.students.length} className="w-12 border rounded p-1 text-xs" placeholder="席" value={s.fixedSeat||''} onChange={e => update(s.id, 'fixedSeat', e.target.value)} />}
                                                    </div>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div className="flex gap-1">{[0,1,2].map(k => (
                                                        <select key={k} className="w-20 text-xs border rounded" value={s.avoid[k]} onChange={e => {
                                                            const nav = [...s.avoid]; nav[k] = e.target.value; update(s.id, 'avoid', nav);
                                                        }}>
                                                            <option value="">-</option>
                                                            {data.students.filter(o => o.id !== s.id).map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
                                                        </select>
                                                    ))}</div>
                                                </td>
                                                <td className="px-3 py-2 text-center"><button onClick={() => setDeleteId(s.id)} className="text-red-500"><Icons.Trash /></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        // --- 2. 席替え (強化版) ---
        const SeatingTool = ({ data, setData, showToast }) => {
            const [layout, setLayout] = useState([]);
            const [running, setRunning] = useState(false);
            
            useEffect(() => {
                const cols = data.seatConfig.cols || 1;
                const rows = data.seatConfig.rows || 1;
                const total = cols * rows;
                const students = data.students || [];
                
                const newLayout = Array(total).fill(null);
                students.forEach((s, i) => { if (i < total) newLayout[i] = s; });
                setLayout(newLayout);
            }, [data.seatConfig.rows, data.seatConfig.cols, data.students.length]); 

            const safeCols = Math.max(1, data.seatConfig.cols || 1);
            const safeRows = Math.max(1, data.seatConfig.rows || 1);
            const seatCount = safeRows * safeCols;
            const studentCount = data.students.length;
            const isShortage = seatCount < studentCount;

            const shuffle = () => {
                setRunning(true);
                let count = 0;
                const timer = setInterval(() => {
                    setLayout(prev => {
                        const temp = [...prev];
                        for (let i = temp.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [temp[i], temp[j]] = [temp[j], temp[i]];
                        }
                        return temp;
                    });
                    if (++count > 15) {
                        clearInterval(timer);
                        finalize();
                    }
                }, 100);
            };

            const finalize = () => {
                const total = safeRows * safeCols;
                if (total <= 0) {
                    setRunning(false);
                    return;
                }

                let best = null, minScore = Infinity;
                // 試行回数を 50 -> 500 に増加
                const TRIALS = 500; 
                
                for(let k=0; k < TRIALS; k++) {
                    const current = Array(total).fill(null);
                    const pool = [...data.students];
                    
                    const fixed = pool.filter(s => s.fixedSeat !== null);
                    const others = pool.filter(s => s.fixedSeat === null);
                    
                    fixed.forEach(s => {
                        const seatIdx = s.fixedSeat - 1;
                        if(seatIdx >= 0 && seatIdx < total && !current[seatIdx]) {
                            current[seatIdx] = s;
                        } else {
                            others.push(s);
                        }
                    });

                    // othersをシャッフル
                    for (let i = others.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [others[i], others[j]] = [others[j], others[i]];
                    }
                    
                    // 空いている席に詰める
                    let p = 0;
                    for(let i=0; i<total; i++) if(!current[i] && p < others.length) current[i] = others[p++];
                    
                    let score = 0;
                    for(let i=0; i<total; i++) {
                        const s1 = current[i];
                        if(!s1) continue;

                        // --- 右隣チェック ---
                        if((i+1) % safeCols !== 0) {
                            const s2 = current[i+1];
                            if(s2) {
                                // NG
                                if(s1.avoid.includes(s2.id) || s2.avoid.includes(s1.id)) score += 100;
                                // 同性隣り合わせ回避（推奨）
                                if (s1.gender !== 'mixed' && s2.gender !== 'mixed' && s1.gender === s2.gender) score += 10; 
                            }
                        }

                        // --- ★追加: 真下（前後）チェック ---
                        // 最後の行以外なら、真下の席をチェック
                        if (i + safeCols < total) {
                            const sDown = current[i + safeCols];
                            if (sDown) {
                                // NG (前後は隣と同じくらい重要なのでペナルティ大)
                                if (s1.avoid.includes(sDown.id) || sDown.avoid.includes(s1.id)) score += 100;
                            }
                        }
                    }

                    if(score < minScore) { minScore = score; best = current; }
                    if(score === 0) break; // 完全な配置が見つかれば即終了
                }
                
                setLayout(best);
                setRunning(false);
                if (minScore === 0) {
                    showToast("最適な配置が見つかりました！", "success");
                } else if (minScore < 100) {
                    showToast("配置完了（性別などの条件を一部妥協しました）", "info");
                } else {
                    showToast("配置完了（※NG条件を完全に満たせませんでした）", "error");
                }
            };

            const onDragStart = (e, i) => e.dataTransfer.setData("idx", i);
            const onDragOver = (e) => e.preventDefault();
            const onDrop = (e, to) => {
                const from = e.dataTransfer.getData("idx");
                if(from === "") return;
                const next = [...layout];
                [next[from], next[to]] = [next[to], next[from]];
                setLayout(next);
            };

            const doPrint = () => handlePrint('print-target', showToast);

            // --- Excel出力機能 (新規追加) ---
            const doExcel = () => {
                if (layout.length === 0) return showToast("座席データがありません", "error");

                const wb = XLSX.utils.book_new();
                const rows = [];

                // 1. 教卓行 (中央に配置)
                const pulpitRow = Array(safeCols).fill("");
                // 単純に中央付近のセルに「教卓」と入れる
                const centerIdx = Math.floor((safeCols - 1) / 2);
                pulpitRow[centerIdx] = "教卓";
                rows.push(pulpitRow);
                
                // 空行
                rows.push(Array(safeCols).fill(""));

                // 2. 座席データ (グリッドに合わせて配置)
                for (let r = 0; r < safeRows; r++) {
                    const rowData = [];
                    for (let c = 0; c < safeCols; c++) {
                        const idx = r * safeCols + c;
                        const student = layout[idx];
                        rowData.push(student ? student.name : "");
                    }
                    rows.push(rowData);
                    // 見やすさのために空行を入れても良いが、今回はシンプルに詰める
                }

                const ws = XLSX.utils.aoa_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, "席替え結果");
                XLSX.writeFile(wb, "席替え表.xlsx");
                showToast("Excelファイルをダウンロードしました", "success");
            };
            
            const handleConfigChange = (field, value) => {
                let num = parseInt(value);
                if (isNaN(num)) num = 1;
                
                const currentVal = data.seatConfig[field];
                // 急激に大きな値を入力された場合のガード
                if (num > currentVal) {
                    const otherVal = field === 'cols' ? data.seatConfig.rows : data.seatConfig.cols;
                    const newTotal = num * otherVal;
                    const limit = Math.max(data.students.length * 2, 60);
                    if (newTotal > limit) return;
                }
                
                const safeVal = Math.max(1, num);
                setData({...data, seatConfig:{...data.seatConfig, [field]: safeVal}});
            };

            return (
                <div className="space-y-4">
                    <Card title="席替え" action={
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={doPrint}><Icons.Printer /> 印刷</Button>
                            <Button variant="secondary" onClick={doExcel}><Icons.Download /> Excel</Button>
                        </div>
                    }>
                        <div className="flex flex-wrap gap-4 mb-4 items-end no-print">
                            <label className="text-sm font-bold text-gray-700">横 <input type="number" className="w-16 border rounded p-1" value={data.seatConfig.cols} onChange={e=>handleConfigChange('cols', e.target.value)} /></label>
                            <label className="text-sm font-bold text-gray-700">縦 <input type="number" className="w-16 border rounded p-1" value={data.seatConfig.rows} onChange={e=>handleConfigChange('rows', e.target.value)} /></label>
                            <Button onClick={shuffle} disabled={running}><Icons.Shuffle /> スタート</Button>
                            
                            <div className={`ml-2 font-bold text-sm flex items-center px-3 py-1 rounded-full border ${isShortage ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                <span className="mr-3 text-gray-600">生徒数: {studentCount}名</span>
                                {isShortage ? (
                                    <span className="text-red-500 flex items-center gap-1 animate-pulse">
                                        <Icons.Alert size={16}/> 席数が足りていません
                                    </span>
                                ) : (
                                    <span className="text-green-600 flex items-center gap-1">
                                        <Icons.Check size={16}/> OK
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <div id="print-target" className="p-4 border rounded bg-gray-50 print:border-none print:p-0">
                            <div className="text-center font-bold text-xl mb-4 text-gray-700 print:text-black">教卓</div>
                            <div className="grid gap-2 mx-auto" style={{ gridTemplateColumns: `repeat(${safeCols}, 1fr)` }}>
                                {layout.map((s, i) => (
                                    <div key={i} draggable={!running} onDragStart={e=>onDragStart(e, i)} onDragOver={onDragOver} onDrop={e=>onDrop(e, i)}
                                        className={`aspect-[5/4] border-2 rounded flex items-center justify-center p-1 text-center font-bold text-lg bg-white
                                            ${s?.gender==='boy'?'border-blue-300':s?.gender==='girl'?'border-red-300':'border-gray-300'}
                                            ${running ? 'bg-yellow-100' : ''}`}
                                    >
                                        {s ? s.name : ''}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- 3. 係り・当番 (Smart Gender Logic & Fixed Slots & EXEMPTION Implemented) ---
        const DutyTool = ({ data, setData, showToast }) => {
            // 初期データ構造に genderReq, fixedStudentId を追加
            const initialDuties = data.dutyConfig.jobs?.length 
                ? data.dutyConfig.jobs.map(j => ({...j, genderReq: j.genderReq || 'none', fixedStudentId: j.fixedStudentId || null})) 
                : [{name:'黒板', count:2, genderReq:'none', fixedStudentId: null}];
            
            const [duties, setDuties] = useState(initialDuties);
            const [schedule, setSchedule] = useState([]);
            const [importOpen, setImportOpen] = useState(false);
            const [shiftVal, setShiftVal] = useState(1);
            
            useEffect(() => {
                setData(prev => ({...prev, dutyConfig: {...prev.dutyConfig, jobs: duties}}));
            }, [duties]);

            // --- ★排他制御ロジック (Smart Exclusion) ---
            // 「固定」または「免除」で既に選ばれている生徒IDをリスト化（自分自身は除くため、レンダリング時にチェック）
            // これにより、Aさんを「固定」に選んだら、他のプルダウンからAさんが消える
            const usedStudentIds = new Set(
                duties
                    .filter(d => (d.genderReq === 'fixed' || d.genderReq === 'exempt') && d.fixedStudentId)
                    .map(d => d.fixedStudentId)
            );

            // 在庫計算（固定生徒 と 免除生徒 を除く）
            const availableStudents = data.students.filter(s => !usedStudentIds.has(s.id));
            
            const rosterCounts = availableStudents.reduce((acc, s) => {
                acc[s.gender || 'mixed'] = (acc[s.gender || 'mixed'] || 0) + 1;
                return acc;
            }, {boy:0, girl:0, mixed:0});

            const dutyCounts = duties.reduce((acc, d) => {
                if(d.genderReq === 'fixed' || d.genderReq === 'exempt') return acc; // 固定・免除はカウントしない
                if(d.genderReq === 'boy') acc.boy += d.count;
                else if(d.genderReq === 'girl') acc.girl += d.count;
                else acc.none += d.count;
                return acc;
            }, {boy:0, girl:0, none:0});

            const remainingStudents = availableStudents.length;
            const requiredSlots = dutyCounts.boy + dutyCounts.girl + dutyCounts.none;
            const remainingSlots = remainingStudents - requiredSlots;

            const updateCount = (index, newCount) => {
                if (isNaN(newCount) || newCount < 1) return; 
                // 生徒数上限チェック
                if (newCount > duties[index].count && remainingSlots <= 0) {
                    showToast("生徒数が不足しています", "error");
                    return; 
                }
                const nd = [...duties];
                nd[index].count = newCount;
                setDuties(nd);
            };

            const updateGender = (index, val) => {
                const nd = [...duties];
                nd[index].genderReq = val;
                // 固定/免除から切り替えた場合、カウントを1に戻すなど
                if(val === 'fixed' || val === 'exempt') nd[index].count = 1;
                setDuties(nd);
            };

            const updateFixedStudent = (index, sId) => {
                const nd = [...duties];
                nd[index].fixedStudentId = sId;
                setDuties(nd);
            };

            const addJob = () => {
                if (remainingSlots <= 0) return;
                setDuties([...duties, {name:'', count:1, genderReq:'none', fixedStudentId: null}]);
            };

            const generate = (sortType) => {
                if(data.students.length === 0) return showToast("生徒がいません", "error");

                // --- 1. 事前検証 (Safety Check) ---
                if (rosterCounts.boy < dutyCounts.boy) return showToast(`男子が不足しています (必要: ${dutyCounts.boy}, 対象: ${rosterCounts.boy})`, "error");
                if (rosterCounts.girl < dutyCounts.girl) return showToast(`女子が不足しています (必要: ${dutyCounts.girl}, 対象: ${rosterCounts.girl})`, "error");
                if (remainingStudents < requiredSlots) return showToast("全体の生徒数が不足しています", "error");

                // --- 2. リスト準備 ---
                // 固定・免除以外の生徒を取得
                let pool = data.students.filter(s => !usedStudentIds.has(s.id));

                // ソート適用
                if(sortType === 'random') {
                    for (let i = pool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [pool[i], pool[j]] = [pool[j], pool[i]];
                    }
                } else if (sortType === 'desc') {
                    pool.reverse();
                }

                // 属性別リストに分割
                const boysList = pool.filter(s => s.gender === 'boy');
                const girlsList = pool.filter(s => s.gender === 'girl');
                // 全体リスト（指定なし用）
                const allList = [...pool]; 

                // 係スロット展開
                const slotsInfo = [];
                duties.forEach(d => {
                    if (d.genderReq === 'fixed') {
                        slotsInfo.push({
                            name: d.name,
                            genderReq: 'fixed',
                            fixedStudentId: d.fixedStudentId
                        });
                    } else if (d.genderReq === 'exempt') {
                        // 免除行はスロットを作らない（人数-1）
                        return;
                    } else {
                        for(let i=0; i<d.count; i++) {
                            slotsInfo.push({
                                name: d.count > 1 ? `${d.name}${i+1}` : d.name,
                                genderReq: d.genderReq
                            });
                        }
                    }
                });

                const weeks = data.dutyConfig.duration || 10;
                const newSchedule = []; 
                
                // 3つの独立したカウンター（歯車）
                let boyIndex = 0;
                let girlIndex = 0;
                let globalIndex = 0;

                // --- 3. 週ごとの生成ループ ---
                for(let w=1; w<=weeks; w++) {
                    const weekAssignments = {};
                    const usedInThisWeek = new Set(); // 今週すでに割り当てられた生徒ID

                    // A. 固定枠の割り当て (最優先)
                    slotsInfo.forEach(slot => {
                        if (slot.genderReq === 'fixed') {
                            const student = data.students.find(s => s.id === slot.fixedStudentId);
                            weekAssignments[slot.name] = student ? student.name : "(未設定)";
                            if (student) usedInThisWeek.add(student.id);
                        }
                    });

                    // B. 男子指定枠の割り当て (男子歯車)
                    slotsInfo.forEach(slot => {
                        if (slot.genderReq !== 'boy') return;
                        
                        if (boysList.length > 0) {
                            const student = boysList[boyIndex % boysList.length];
                            weekAssignments[slot.name] = student.name;
                            usedInThisWeek.add(student.id);
                            boyIndex++; // 次の人のために進める
                        } else {
                            weekAssignments[slot.name] = "(不足)";
                        }
                    });

                    // C. 女子指定枠の割り当て (女子歯車)
                    slotsInfo.forEach(slot => {
                        if (slot.genderReq !== 'girl') return;

                        if (girlsList.length > 0) {
                            const student = girlsList[girlIndex % girlsList.length];
                            weekAssignments[slot.name] = student.name;
                            usedInThisWeek.add(student.id);
                            girlIndex++; // 次の人のために進める
                        } else {
                            weekAssignments[slot.name] = "(不足)";
                        }
                    });

                    // D. 指定なし枠の割り当て (全体歯車 + スキップロジック)
                    slotsInfo.forEach(slot => {
                        if (slot.genderReq !== 'none') return;

                        // まだ今週割り当てられていない人を探す
                        // globalIndexからスタートして、1周するまで探す
                        let found = false;
                        for (let k = 0; k < allList.length; k++) {
                            const currentIndex = (globalIndex + k) % allList.length;
                            const student = allList[currentIndex];
                            
                            if (!usedInThisWeek.has(student.id)) {
                                weekAssignments[slot.name] = student.name;
                                usedInThisWeek.add(student.id);
                                globalIndex = (currentIndex + 1) % allList.length; // 次回開始位置を更新
                                found = true;
                                break;
                            }
                        }
                        if (!found) weekAssignments[slot.name] = "-";
                    });

                    // シフトロジック（係人数 < 生徒数の場合は自動でずれるが、＝の場合は強制シフトが必要）
                    if (requiredSlots === remainingStudents) {
                         boyIndex += shiftVal;
                         girlIndex += shiftVal;
                         globalIndex += shiftVal;
                    }

                    newSchedule.push({ id: w, mapping: weekAssignments });
                }

                setSchedule({ slots: slotsInfo.map(s=>s.name), weeks: newSchedule });
                showToast("当番表を作成しました", "success");
            };

            const doPrint = () => handlePrint('print-target', showToast);
            const doExcel = () => {
                if(!schedule.slots) return;
                const rows = [];
                const header = ["係名", ...schedule.weeks.map(w => `${w.id}${data.dutyConfig.type==='week'?'週':'月'}`)];
                rows.push(header);
                schedule.slots.forEach(duty => {
                    const row = [duty];
                    schedule.weeks.forEach(w => {
                        row.push(w.mapping[duty] || "");
                    });
                    rows.push(row);
                });
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "当番表");
                XLSX.writeFile(wb, "当番表.xlsx");
                showToast("Excelファイルをダウンロードしました", "success");
            };

            return (
                <div className="space-y-6">
                    <PasteModal isOpen={importOpen} onClose={()=>setImportOpen(false)} title="係リスト取込" placeholder={`係名\n係名\t人数`}
                        onImport={(txt)=>{
                            const ls = txt.split(/\r\n|\n/).filter(l=>l.trim());
                            const nd = ls.map(l=>{
                                const p = l.split('\t');
                                return {name:p[0].trim(), count:parseInt(p[1])||1, genderReq: 'none', fixedStudentId: null};
                            });
                            setDuties([...duties, ...nd]);
                        }}
                    />

                    <Card title="係り・当番設定">
                        <div className="space-y-4">
                            <div className="no-print">
                                <div className="flex justify-between mb-2">
                                    <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                        係りの構成 
                                        <span className={`text-sm ml-2 ${remainingSlots < 0 ? 'text-red-500' : 'text-blue-600'}`}>
                                            (残り生徒: {remainingSlots}名)
                                        </span>
                                    </h3>
                                    <Button variant="secondary" onClick={()=>setImportOpen(true)} className="text-xs py-1"><Icons.ClipboardList /> 取込</Button>
                                </div>
                                <div className="bg-orange-50 p-2 mb-2 rounded text-xs text-orange-800 border border-orange-200">
                                    <span className="font-bold">現在の対象人数 (固定・免除除く):</span> 男子 {rosterCounts.boy}名 / 女子 {rosterCounts.girl}名 
                                </div>

                                {duties.map((d,i)=>(
                                    <div key={i} className={`flex gap-2 mb-2 items-center p-2 rounded ${d.genderReq==='exempt' ? 'bg-gray-100 border border-gray-300' : ''}`}>
                                        <input className="border rounded p-2 flex-grow" value={d.name} placeholder={d.genderReq === 'exempt' ? '理由 (例: 入院中)' : '係名'} onChange={e=>{
                                            const nd=[...duties]; nd[i].name=e.target.value; setDuties(nd);
                                        }} />
                                        
                                        <select className={`border rounded p-2 w-24 text-sm font-bold
                                            ${d.genderReq==='boy'?'bg-blue-50 text-blue-800':
                                              d.genderReq==='girl'?'bg-red-50 text-red-800':
                                              d.genderReq==='fixed'?'bg-purple-100 text-purple-800':
                                              d.genderReq==='exempt'?'bg-gray-200 text-gray-600':''}`}
                                            value={d.genderReq} onChange={e=>updateGender(i, e.target.value)}
                                        >
                                            <option value="none">指定なし</option>
                                            <option value="boy">男子のみ</option>
                                            <option value="girl">女子のみ</option>
                                            <option value="fixed">★固定</option>
                                            <option value="exempt">🚫免除</option>
                                        </select>
                                        
                                        {d.genderReq === 'fixed' || d.genderReq === 'exempt' ? (
                                            <select className={`border rounded p-2 w-40 text-sm ${d.genderReq==='fixed'?'bg-purple-50':'bg-gray-50'}`} 
                                                value={d.fixedStudentId || ''} 
                                                onChange={e=>updateFixedStudent(i, e.target.value)}
                                            >
                                                <option value="">生徒を選択...</option>
                                                {data.students.map(s => {
                                                    // 排他制御: 自分自身か、誰にも使われていない生徒のみ表示
                                                    if (s.id === d.fixedStudentId || !usedStudentIds.has(s.id)) {
                                                        return <option key={s.id} value={s.id}>{s.name}</option>;
                                                    }
                                                    return null;
                                                })}
                                            </select>
                                        ) : (
                                            <input type="number" className="border rounded p-2 w-16" value={d.count} min="1" onChange={e => updateCount(i, parseInt(e.target.value))} />
                                        )}
                                        
                                        <Button variant="danger" onClick={()=>setDuties(duties.filter((_,x)=>x!==i))}><Icons.Trash /></Button>
                                    </div>
                                ))}
                                <Button variant="secondary" onClick={addJob} disabled={remainingSlots <= 0} title={remainingSlots <= 0 ? "生徒数上限に達しています" : ""}>
                                    <Icons.Plus /> 追加
                                </Button>
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg border no-print">
                                <div className="flex flex-wrap gap-4 items-center mb-4">
                                    <label className="font-bold text-sm">期間: 
                                        <select className="ml-2 border rounded p-1" value={data.dutyConfig.type} onChange={e=>setData({...data, dutyConfig:{...data.dutyConfig, type:e.target.value}})}>
                                            <option value="week">週交代</option><option value="month">月交代</option>
                                        </select>
                                    </label>
                                    <label className="font-bold text-sm">回数: 
                                        <input type="number" className="ml-2 w-16 border rounded p-1" value={data.dutyConfig.duration} onChange={e=>setData({...data, dutyConfig:{...data.dutyConfig, duration:parseInt(e.target.value)}})} />
                                    </label>
                                    <label className="font-bold text-sm">ずらす数: 
                                        <input type="number" className="ml-2 w-12 border rounded p-1" value={shiftVal} min="1" onChange={e=>setShiftVal(parseInt(e.target.value)||1)} />
                                    </label>
                                </div>
                                
                                <div className="flex flex-col gap-2">
                                    <div className="text-sm font-bold text-gray-600">① 名簿の並び順を選んで作成</div>
                                    <div className="flex gap-2 flex-wrap">
                                        <Button onClick={()=>generate('asc')} variant="secondary" title="名簿順のまま上から順に割り当てます"><Icons.ArrowDown /> 名簿順（昇順）</Button>
                                        <Button onClick={()=>generate('desc')} variant="secondary" title="名簿の逆順で上から順に割り当てます"><Icons.ArrowUp /> 逆順（降順）</Button>
                                        <Button onClick={()=>generate('random')} variant="secondary" title="シャッフルしてから順に割り当てます"><Icons.Shuffle /> ランダム</Button>
                                    </div>
                                    <div className="text-xs text-gray-500 mt-2 p-2 bg-white border rounded">
                                        <p className="font-bold text-gray-700 mb-1">💡 ヒント</p>
                                        <ul className="list-disc list-inside space-y-1">
                                            <li><strong>「固定」</strong>: 特定の生徒をその係にロックします（他の係からは除外）。</li>
                                            <li><strong>「免除」</strong>: 生徒を今回の係決め全体から除外します（人数も減ります）。係名欄に理由をメモできます。</li>
                                            <li>固定・免除で選んだ生徒は、他のプルダウンから自動的に消えるので重複しません。</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {schedule.slots && (
                            <div className="mt-6">
                                <div className="flex justify-end gap-2 mb-2 no-print">
                                    <Button variant="secondary" onClick={doPrint}><Icons.Printer /> 印刷</Button>
                                    <Button variant="secondary" onClick={doExcel}><Icons.Download /> Excel</Button>
                                </div>
                                <div id="print-target" className="overflow-x-auto border rounded">
                                    <table className="w-full text-sm text-center border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border p-2 min-w-[100px] bg-gray-200">係 \ 回</th>
                                                {schedule.weeks.map(w => (
                                                    <th key={w.id} className="border p-2 min-w-[60px]">
                                                        {w.id}{data.dutyConfig.type==='week'?'週':'月'}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {schedule.slots.map((duty, i) => (
                                                <tr key={i}>
                                                    <td className="border p-2 font-bold bg-gray-50 text-left px-4">{duty}</td>
                                                    {schedule.weeks.map(w => (
                                                        <td key={w.id} className="border p-2">
                                                            {w.mapping[duty]}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        // --- 4. グループ分け ---
        const ClubTool = ({ data, setData, showToast }) => {
            const [groups, setGroups] = useState(data.clubConfig.clubs?.length ? data.clubConfig.clubs : [{id:'g1', name:'班1', members:[]}]);
            const [unassigned, setUnassigned] = useState([]);
            const [delGId, setDelGId] = useState(null);
            const [resetConfirm, setResetConfirm] = useState(false);

            useEffect(() => {
                const assigned = new Set();
                groups.forEach(g => g.members.forEach(m => assigned.add(m.id)));
                setUnassigned(data.students.filter(s => !assigned.has(s.id)));
            }, [data.students, groups]);

            useEffect(() => {
                setData(p=>({...p, clubConfig:{...p.clubConfig, clubs:groups}}));
            }, [groups]);

            const deleteGroup = () => {
                const g = groups.find(x => x.id === delGId);
                if(g) {
                    setGroups(groups.filter(x => x.id !== delGId));
                }
                setDelGId(null);
                showToast("班を削除しました", "success");
            };

            const resetAll = () => {
                setGroups([]);
                setResetConfirm(false);
                showToast("班をリセットしました", "success");
            };

            const canAddGroup = unassigned.length > 0;

            const addGroup = () => {
                if(!canAddGroup) return;
                const newId = 'g_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
                setGroups([...groups, {id: newId, name:`班${groups.length+1}`, members:[]}]);
            };

            const onDrag = (e, sid, gid) => {
                e.dataTransfer.setData("sid", sid);
                e.dataTransfer.setData("src", gid);
            };
            const onDrop = (e, dest) => {
                const sid = e.dataTransfer.getData("sid");
                const src = e.dataTransfer.getData("src");
                if(!sid) return;
                
                if (dest !== 'un') {
                    const destGroup = groups.find(g => g.id === dest);
                    if (destGroup && destGroup.members.some(m => m.id === sid)) {
                        return; 
                    }
                }

                const student = data.students.find(s=>s.id===sid);
                let newGroups = groups.map(g => ({...g, members: [...g.members]}));
                
                if(src !== 'un') {
                    const srcG = newGroups.find(g => g.id === src);
                    if(srcG) srcG.members = srcG.members.filter(m => m.id !== sid);
                }
                
                if(dest !== 'un') {
                    const destG = newGroups.find(g => g.id === dest);
                    if(destG) destG.members.push(student);
                }
                
                setGroups(newGroups);
            };

            const autoAssign = (mode) => {
                if (groups.length === 0) return showToast("班を作ってください", "error");
                if (unassigned.length === 0) return showToast("未所属の生徒がいません", "error");

                let targets = [...unassigned];

                if (mode === 'random') {
                    const TRIALS = 500;
                    let bestGroups = null;
                    let minConflicts = Infinity;

                    for (let k = 0; k < TRIALS; k++) {
                        let currentTargets = [...unassigned];
                        for (let i = currentTargets.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [currentTargets[i], currentTargets[j]] = [currentTargets[j], currentTargets[i]];
                        }

                        let tempGroups = groups.map(g => ({...g, members: [...g.members]}));
                        let currentConflicts = 0;

                        currentTargets.forEach(s => {
                            let minLen = Math.min(...tempGroups.map(g => g.members.length));
                            let candidates = tempGroups.filter(g => g.members.length === minLen);
                            
                            let validCandidates = candidates.filter(g => 
                                !g.members.some(m => s.avoid.includes(m.id) || m.avoid.includes(s.id))
                            );

                            let targetGroup;
                            if (validCandidates.length > 0) {
                                targetGroup = validCandidates[Math.floor(Math.random() * validCandidates.length)];
                            } else {
                                targetGroup = candidates[Math.floor(Math.random() * candidates.length)];
                                if (targetGroup.members.some(m => s.avoid.includes(m.id) || m.avoid.includes(s.id))) {
                                    currentConflicts++;
                                }
                            }
                            targetGroup.members.push(s);
                        });

                        if (currentConflicts < minConflicts) {
                            minConflicts = currentConflicts;
                            bestGroups = tempGroups;
                        }
                        if (minConflicts === 0) break;
                    }

                    setGroups(bestGroups);
                    if (minConflicts === 0) {
                        showToast("最適な班分けができました！", "success");
                    } else {
                        showToast(`班分け完了（※NG条件を${minConflicts}件 解消できませんでした）`, "warning");
                    }

                } else {
                    if (mode === 'desc') {
                        targets.reverse();
                    }

                    let newGroups = groups.map(g => ({...g, members: [...g.members]}));
                    let gIdx = 0; 

                    targets.forEach(s => {
                        let assigned = false;
                        const startIdx = gIdx;

                        for (let i = 0; i < newGroups.length; i++) {
                            const currentGIdx = (startIdx + i) % newGroups.length;
                            const group = newGroups[currentGIdx];
                            
                            const hasConflict = group.members.some(m => s.avoid.includes(m.id) || m.avoid.includes(s.id));
                            const minMembers = Math.min(...newGroups.map(g => g.members.length));
                            
                            if (!hasConflict && group.members.length <= minMembers + 1) {
                                group.members.push(s);
                                gIdx = (currentGIdx + 1) % newGroups.length; 
                                assigned = true;
                                break;
                            }
                        }

                        if (!assigned) {
                            let minLen = Infinity;
                            let targetGIdx = 0;
                            newGroups.forEach((g, i) => {
                                if(g.members.length < minLen) {
                                    minLen = g.members.length;
                                    targetGIdx = i;
                                }
                            });
                            newGroups[targetGIdx].members.push(s);
                        }
                    });

                    setGroups(newGroups);
                    showToast("順序通りに振り分けました", "success");
                }
            };

            const doPrint = () => handlePrint('print-target', showToast);

            const doExcel = () => {
                const rows = [];
                let maxLen = 0;
                groups.forEach(g => { if(g.members.length > maxLen) maxLen = g.members.length; });
                
                const header = groups.map(g => g.name);
                rows.push(header);
                
                for(let i=0; i<maxLen; i++) {
                    const row = [];
                    groups.forEach(g => {
                        row.push(g.members[i] ? g.members[i].name : "");
                    });
                    rows.push(row);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "班分け");
                XLSX.writeFile(wb, "班分け.xlsx");
                showToast("Excelファイルをダウンロードしました", "success");
            };

            return (
                <div className="space-y-4">
                    <ConfirmModal isOpen={!!delGId} onClose={()=>setDelGId(null)} onConfirm={deleteGroup} message="班を削除しますか？メンバーは未所属に戻ります。" />
                    <ConfirmModal isOpen={resetConfirm} onClose={()=>setResetConfirm(false)} onConfirm={resetAll} message="全ての班を削除し、全員を未所属に戻しますか？" />
                    
                    <Card title="グループ分け" action={
                        <div className="flex gap-2">
                                <Button variant="secondary" onClick={doPrint}><Icons.Printer /> 印刷</Button>
                                <Button variant="secondary" onClick={doExcel}><Icons.Download /> Excel</Button>
                        </div>
                    }>
                        <div className="no-print mb-4 p-4 bg-gray-50 rounded border flex flex-col gap-3">
                            <div className="flex gap-2 items-center">
                                <Button variant="secondary" onClick={addGroup} disabled={!canAddGroup} title={!canAddGroup ? "未所属の生徒がいません" : ""}>
                                    <Icons.Plus /> 班追加
                                </Button>
                                <Button variant="danger" onClick={()=>setResetConfirm(true)} disabled={groups.length===0}>
                                    <Icons.Trash /> 全削除
                                </Button>
                                <span className="text-sm text-gray-500 ml-2">※未所属がいる場合のみ班を追加できます</span>
                            </div>
                            
                            <div className="flex gap-2 items-center border-t pt-3">
                                <span className="text-sm font-bold text-gray-700">自動振り分け:</span>
                                <Button variant="ghost" className="text-xs" onClick={()=>autoAssign('asc')} disabled={unassigned.length===0}>名簿順</Button>
                                <Button variant="ghost" className="text-xs" onClick={()=>autoAssign('desc')} disabled={unassigned.length===0}>逆順</Button>
                                <Button variant="ghost" className="text-xs" onClick={()=>autoAssign('random')} disabled={unassigned.length===0}>ランダム</Button>
                            </div>
                        </div>

                        <div id="print-target" className="flex gap-4 overflow-x-auto pb-4 min-h-[400px]">
                            <div className="min-w-[180px] bg-gray-100 p-4 rounded border-2 border-dashed no-print" onDragOver={e=>e.preventDefault()} onDrop={e=>onDrop(e,'un')}>
                                <div className="font-bold text-gray-500 mb-2">未所属 ({unassigned.length})</div>
                                {unassigned.map(s=>(
                                    <div key={s.id} draggable onDragStart={e=>onDrag(e,s.id,'un')} 
                                        className={`p-2 rounded shadow mb-2 text-sm cursor-grab border hover:opacity-80
                                            ${s.gender==='boy' ? 'bg-blue-50 border-blue-200 text-blue-900' : 
                                              s.gender==='girl' ? 'bg-red-50 border-red-200 text-red-900' : 
                                              'bg-white border-transparent'}`}
                                    >
                                        {s.name}
                                    </div>
                                ))}
                            </div>
                            {groups.map(g=>(
                                <div key={g.id} className="min-w-[180px] bg-white border p-4 rounded shadow-sm flex flex-col" onDragOver={e=>e.preventDefault()} onDrop={e=>onDrop(e,g.id)}>
                                    <input className="font-bold border-b mb-2 w-full focus:outline-none focus:border-blue-500" value={g.name} onChange={e=>{
                                        const ng=groups.map(gx => gx.id===g.id ? {...gx, name:e.target.value} : gx); 
                                        setGroups(ng);
                                    }} />
                                    <div className="flex-grow min-h-[50px]">
                                        {g.members.map(s=>(
                                            <div key={s.id} draggable onDragStart={e=>onDrag(e,s.id,g.id)} 
                                                className={`p-2 rounded mb-2 text-sm cursor-grab border hover:opacity-80
                                                    ${s.gender==='boy' ? 'bg-blue-100 border-blue-300 text-blue-900' : 
                                                      s.gender==='girl' ? 'bg-red-100 border-red-300 text-red-900' : 
                                                      'bg-blue-50 border-blue-100'}`}
                                            >
                                                {s.name}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="text-right mt-2 text-xs text-gray-400">{g.members.length}名</div>
                                    <button onClick={()=>setDelGId(g.id)} className="text-red-300 text-right mt-1 no-print hover:text-red-500"><Icons.Trash size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
            );
        };

        // --- メインアプリ ---
        const App = () => {
            const [data, setData] = useState(() => {
                const s = localStorage.getItem('classToolDataV2');
                return s ? JSON.parse(s) : { settings:{school:'', teacher:'', gradeClass:''}, students:[], seatConfig:{rows:5, cols:6}, dutyConfig:{jobs:[], duration:15, type:'week'}, clubConfig:{clubs:[]} };
            });
            const [tab, setTab] = useState('students');
            const [appState, setAppState] = useState(() => {
                const s = localStorage.getItem('classToolAppState');
                return s ? JSON.parse(s) : { isLocked: false, lockPass: null }; 
            });

            // --- トースト管理 ---
            const [toasts, setToasts] = useState([]);
            const showToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);

            useEffect(() => {
                localStorage.setItem('classToolDataV2', JSON.stringify(data));
            }, [data]);

            useEffect(() => {
                localStorage.setItem('classToolAppState', JSON.stringify(appState));
            }, [appState]);

            const resetAllData = () => {
                const initialData = { settings:{school:'', teacher:'', gradeClass:''}, students:[], seatConfig:{rows:5, cols:6}, dutyConfig:{jobs:[], duration:15, type:'week'}, clubConfig:{clubs:[]} };
                const initialAppState = { isLocked: false, lockPass: null };
                
                setData(initialData);
                setAppState(initialAppState);
                localStorage.removeItem('classToolDataV2');
                localStorage.removeItem('classToolAppState');
                
                showToast("全てのデータを初期化しました", "success");
            };

            return (
                <div className="min-h-screen pb-20 relative">
                    <ToastContainer toasts={toasts} />
                    
                    <header className="bg-white shadow-sm border-b sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icons.Smile /> クラス管理ツール</h1>
                            <div className="flex gap-2">
                                <Button onClick={()=>setTab('students')} variant={tab==='students'?'primary':'ghost'}><Icons.Users /> 名簿</Button>
                                <Button onClick={()=>setTab('seats')} variant={tab==='seats'?'primary':'ghost'}><Icons.Grid /> 席替</Button>
                                <Button onClick={()=>setTab('duties')} variant={tab==='duties'?'primary':'ghost'}><Icons.Calendar /> 当番</Button>
                                <Button onClick={()=>setTab('clubs')} variant={tab==='clubs'?'primary':'ghost'}><Icons.Layers /> 班</Button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="hidden print:block text-center mb-4" id="print-header">
                            <h1 className="text-2xl font-bold">{data.settings.school} {data.settings.gradeClass}</h1>
                            <div className="text-right">担任: {data.settings.teacher}</div>
                        </div>
                        {tab==='students' && (
                            <StudentRegistration 
                                data={data} 
                                setData={setData}
                                isLocked={appState.isLocked}
                                setIsLocked={(val) => setAppState(prev => ({...prev, isLocked: val}))}
                                lockPass={appState.lockPass}
                                setLockPass={(val) => setAppState(prev => ({...prev, lockPass: val}))}
                                resetAll={resetAllData} 
                                showToast={showToast}
                            />
                        )}
                        {tab==='seats' && <SeatingTool data={data} setData={setData} showToast={showToast} />}
                        {tab==='duties' && <DutyTool data={data} setData={setData} showToast={showToast} />}
                        {tab==='clubs' && <ClubTool data={data} setData={setData} showToast={showToast} />}
                    </main>
                    
                    <footer className="no-print fixed bottom-0 w-full bg-white border-t py-2 text-center text-xs text-gray-400">
                        自動保存中
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
