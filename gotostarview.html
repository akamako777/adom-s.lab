<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Five Islands Stargazer v18.0 (The Holy Order)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* ğŸ›‘ Core Stability */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-user-select: none; user-select: none; color: white;
            overscroll-behavior: none;
        }

        /* ğŸŒŒ Layers */
        #layers-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #camera-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0; transition: opacity 0.8s; }
        #sky-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        .glass {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* ğŸŒ“ Modes */
        body.mode-red #layers-container { filter: sepia(100%) hue-rotate(-50deg) saturate(300%) contrast(1.2) brightness(0.6); }
        body.mode-red #ui-layer { filter: sepia(100%) hue-rotate(-50deg) saturate(200%); }
        
        body.mode-solar { background-color: #87CEEB; color: #0f172a; }
        body.mode-solar .glass { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0,0,0,0.1); color: #0f172a; }
        body.mode-solar h1, body.mode-solar h2, body.mode-solar h3, body.mode-solar span, body.mode-solar div { color: #0f172a; text-shadow: none !important; }
        body.mode-solar .text-cyan-400 { color: #0066cc !important; }
        body.mode-solar .text-white { color: #0f172a !important; }
        
        /* ğŸšª PC Gate */
        #star-gate {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            overflow-y: auto; padding-top: 10vh; padding-bottom: 40px;
        }

        /* Navigation Arrow */
        @keyframes pulse-target { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        .target-lock { animation: pulse-target 1s infinite; }

        .hidden-force { display: none !important; }
        .check-box { appearance: none; width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; background: transparent; cursor: pointer; position: relative; transition: all 0.2s; }
        .check-box:checked { background: #22d3ee; border-color: #22d3ee; }
        .check-box:checked::after { content: 'âœ”'; position: absolute; top: 0px; left: 5px; color: #000; font-size: 16px; font-weight: bold; }
        body.mode-solar .check-box { border-color: rgba(0,0,0,0.3); }
        body.mode-solar .check-box:checked { background: #0066cc; border-color: #0066cc; }
        body.mode-solar .check-box:checked::after { color: #fff; }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #22d3ee; border: 2px solid #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        body.mode-solar input[type=range]::-webkit-slider-thumb { background: #0066cc; border-color: #fff; }
        body.mode-solar input[type=range]::-webkit-slider-runnable-track { background: rgba(0,0,0,0.2); }
        
        /* Debug HUD */
        #debug-hud { font-family: 'Share Tech Mono', monospace; font-size: 10px; text-shadow: 1px 1px 0 #000; }
    </style>
</head>
<body>

    <!-- ğŸšª PC GATE -->
    <div id="star-gate" class="hidden-force">
        <div class="relative z-10 flex flex-col items-center max-w-md text-center p-4">
            <div class="text-8xl mb-4 drop-shadow-[0_0_20px_rgba(34,211,238,0.5)]">ğŸŒŒ</div>
            <h1 class="text-4xl font-black text-white mb-2 tracking-tight">Five Islands<br><span class="text-cyan-400">Stargazer v18.0</span></h1>
            <p class="text-slate-400 text-sm font-bold tracking-[0.2em] mb-8 uppercase">The Holy Order</p>
            
            <div class="bg-white p-3 rounded-2xl shadow-2xl mb-6 transform transition hover:scale-105 duration-500">
                <canvas id="qr-canvas"></canvas>
            </div>
            
            <p class="text-slate-300 text-sm leading-relaxed font-medium mb-8">
                ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å°‚ç”¨ã§ã™ã€‚<br>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>
            
            <button onclick="Gate.startUnlock()" 
                class="group flex items-center gap-2 px-6 py-3 rounded-full bg-slate-800/50 border border-slate-700 hover:bg-slate-700 hover:border-cyan-500 transition-all cursor-pointer">
                <span class="text-yellow-400 text-xl group-hover:animate-spin">â˜…</span>
                <span class="text-xs font-bold text-slate-300 group-hover:text-white">PC DEBUG MODE</span>
            </button>
        </div>
    </div>

    <!-- ğŸ“± APP CONTAINER -->
    <div id="app-container" class="hidden-force w-full h-full relative">
        <div id="layers-container">
            <video id="camera-feed" autoplay playsinline muted></video>
            <canvas id="sky-canvas"></canvas>
        </div>

        <!-- NAV UI -->
        <div id="nav-ui" class="absolute inset-0 pointer-events-none hidden-force z-30">
            <div id="nav-msg" class="absolute top-24 w-full text-center">
                <div class="inline-block bg-black/60 backdrop-blur px-4 py-2 rounded-lg border border-cyan-500/50">
                    <div class="text-[10px] text-cyan-300 uppercase tracking-widest mb-1 font-mono">NAVIGATING TO</div>
                    <div id="nav-target-name" class="text-xl font-bold text-white drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">Target</div>
                </div>
            </div>
            <div id="lock-on" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300">
                <div class="w-24 h-24 border-2 border-green-400 rounded-full target-lock flex items-center justify-center">
                    <div class="w-1 h-1 bg-green-400 rounded-full"></div>
                </div>
                <div class="absolute top-28 w-full text-center text-green-400 font-bold text-sm tracking-widest bg-black/50 px-2 rounded font-mono">TARGET LOCKED</div>
            </div>
        </div>

        <!-- UI LAYER -->
        <div id="ui-layer" class="safe-area-inset p-4">
            <!-- Top -->
            <div class="flex justify-between items-start interactive pt-2">
                <button onclick="App.toggleLocation()" class="glass px-3 py-2 rounded-full flex items-center gap-2 active:scale-95 transition">
                    <span id="gps-icon" class="text-sm">ğŸ“</span>
                    <div class="flex flex-col items-start">
                        <span class="text-[8px] font-bold text-cyan-400 tracking-widest uppercase">LOCATION</span>
                        <span id="loc-name" class="text-[10px] font-bold text-white leading-none">äº”å³¶åˆ—å³¶ (å›ºå®š)</span>
                    </div>
                </button>
                <div class="flex gap-3">
                    <button onclick="Guide.toggle()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition border border-white/20 bg-cyan-900/30">ğŸ“–</button>
                    <button onclick="App.toggleSettings()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition">âš™ï¸</button>
                    <button onclick="App.toggleViewMode()" id="btn-mode" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-indigo-900/50 border-indigo-500/30">ğŸŒ™</button>
                </div>
            </div>

            <!-- Debug Info (Lower Left) -->
            <div class="absolute bottom-24 left-4 pointer-events-none opacity-60">
                <div id="debug-hud" class="text-cyan-300 leading-tight">
                    <div>AZ: <span id="debug-az">0</span>Â°</div>
                    <div>ALT: <span id="debug-alt">0</span>Â°</div>
                    <div class="text-[8px] text-slate-400 mt-1">Gyro: YXZ Remapped</div>
                </div>
            </div>

            <!-- Bottom -->
            <div class="flex justify-center items-end pb-8 interactive gap-6">
                <button onclick="App.takeScreenshot()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-cyan-400 shadow-lg">
                    <span class="text-xl">ğŸ“¸</span>
                </button>
                <button id="btn-cancel-nav" onclick="Guide.stopNav()" class="hidden-force glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-red-500/50 bg-red-900/20 active:scale-90 transition text-red-300 font-bold text-xs">
                    STOP
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ“– GUIDE MODAL -->
    <div id="guide-modal" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-xl hidden-force interactive flex flex-col">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
            <h2 class="font-bold text-white text-lg flex items-center gap-2">
                <span class="text-2xl">ğŸ“–</span> æ˜Ÿåº§å›³é‘‘ (ç†ç§‘ã¨ç¥è©±)
            </h2>
            <button onclick="Guide.toggle()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition text-xl">âœ•</button>
        </div>
        <div id="guide-list" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20"></div>
    </div>

    <!-- ğŸš€ START MODAL -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] interactive">
        <div class="relative z-10 w-full max-w-sm px-6 text-center">
            <div class="text-6xl mb-4 animate-bounce">âœ¨</div>
            <h1 class="text-3xl font-black text-white mb-2">Five Islands<br><span class="text-cyan-400 font-light">Stargazer</span></h1>
            <p class="text-slate-400 text-xs font-bold tracking-widest mb-8">FIXED EDITION v18</p>
            <button onclick="App.init()" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition hover:shadow-cyan-500/30">
                æ˜Ÿç©ºã¸å‡ºç™º (START)
            </button>
            <p class="text-[10px] text-slate-500 mt-4">ARã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™</p>
        </div>
    </div>

    <!-- âš™ï¸ SETTINGS MODAL -->
    <div id="settings-modal" onclick="if(event.target === this) App.toggleSettings()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur hidden-force flex items-center justify-center interactive transition-opacity duration-300 cursor-pointer">
        <div onclick="event.stopPropagation()" class="glass bg-[#0f172a]/95 w-11/12 max-w-sm rounded-2xl border border-white/10 p-6 space-y-6 shadow-2xl overflow-y-auto max-h-[85vh] cursor-default">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <h2 class="font-bold text-white text-lg">è¨­å®š (Settings)</h2>
                <button onclick="App.toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-slate-300 hover:text-white transition text-xl">âœ•</button>
            </div>
            
            <!-- Category Boxes -->
            <div class="space-y-3">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª (Categories)</p>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold">ğŸ¦ æœ‰åãªæ˜Ÿåº§ (Famous)</span>
                    <input type="checkbox" checked onchange="App.setRank(1, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold">ğŸ» æ™®é€šã®æ˜Ÿåº§ (Medium)</span>
                    <input type="checkbox" checked onchange="App.setRank(2, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold">ğŸ¦ ãƒã‚¤ãƒŠãƒ¼æ˜Ÿåº§ (Minor)</span>
                    <input type="checkbox" onchange="App.setRank(3, this.checked)" class="check-box">
                </label>
            </div>

            <!-- Visibility -->
            <div class="space-y-4 pt-4 border-t border-white/10">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider">è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ (Visibility)</p>
                
                <div class="flex items-center justify-between bg-cyan-900/30 p-2 rounded-lg border border-cyan-500/20">
                    <div>
                        <span class="text-sm font-bold text-cyan-300">ğŸŒŸ æ˜Ÿåº§ã®è§£èª¬ã‚’è¡¨ç¤º</span>
                        <div class="text-[10px] text-slate-400">è¦‹ã¦ã„ã‚‹æ˜Ÿåº§ã®ç‰¹å¾´ã‚’è¡¨ç¤ºã—ã¾ã™</div>
                    </div>
                    <input type="checkbox" checked onchange="App.setFlag('showInfo', this.checked)" class="check-box">
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-sm">ğŸ¥ ARã‚«ãƒ¡ãƒ©</span>
                    <input type="checkbox" id="toggle-ar" onchange="App.toggleAR(this.checked)" class="check-box">
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span>èƒŒæ™¯ã®æ¿ƒã•</span><span id="val-bg" class="text-cyan-400">100%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="App.setOpacity('bg', this.value)">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span>å¤©ã®å· (Milky Way)</span><span id="val-milky" class="text-cyan-400">50%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="App.setOpacity('milky', this.value)">
                </div>

                <div class="flex items-center justify-between pt-2">
                    <span class="text-sm">ğŸŒ  æµã‚Œæ˜Ÿ (Meteors)</span>
                    <input type="checkbox" checked onchange="App.setFlag('meteorEnabled', this.checked)" class="check-box">
                </div>
            </div>

            <!-- Emergency Axis Fix -->
             <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm font-bold text-red-300">ğŸ”„ Axis Fix (å›è»¢è£œæ­£)</span>
                        <div class="text-[10px] text-slate-400">å›è»¢ãŒé€†ã«ãªã‚‹å ´åˆã®ã¿ON</div>
                    </div>
                    <input type="checkbox" onchange="App.state.reverseAlpha = this.checked" class="check-box">
                </div>
            </div>

            <!-- Language -->
            <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-300">ğŸ‡ºğŸ‡¸ English Mode</span>
                    <input type="checkbox" onchange="App.setLang(this.checked ? 'en' : 'ja')" class="check-box">
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full shadow-2xl text-sm opacity-0 pointer-events-none transition-opacity z-[60] border border-cyan-500/30 font-bold text-center w-max max-w-[90%] backdrop-blur">Msg</div>

<script>
/**
 * ğŸŒŒ FIVE ISLANDS STARGAZER v18.0 (The Holy Order)
 * Engine: YXZ Euler Order + Gamma Inversion + Last-Step Screen Rotation
 * 2027 Protocol: The Definitive Fix for Landscape AR
 */

// --- 0. DATA & CONSTANTS ---
const RANK = { FAMOUS: 1, MEDIUM: 2, MINOR: 3 };

const CONSTELLATION_DB = [
    { 
        id: "ori", rank: 1, name: "ã‚ªãƒªã‚ªãƒ³åº§", en: "Orion", 
        desc: "ã€å†¬ã®ç‹è€…ã€‘çœŸã‚“ä¸­ã®ä¸‰ã¤æ˜ŸãŒç‰¹å¾´ã€‚å·¦ä¸Šã®èµ¤ã„æ˜Ÿã€Œãƒ™ãƒ†ãƒ«ã‚®ã‚¦ã‚¹ã€ã¯ã€ã‚‚ã†ã™ãçˆ†ç™ºã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„è¶…å·¨å¤§ãªæ˜Ÿã§ã™ã€‚", 
        myth: "ã€ç¥è©±ã€‘æµ·ã®ç¥ãƒã‚»ã‚¤ãƒ‰ãƒ³ã®å­ã§ã€ä¹±æš´è€…ã®ç‹©äººã€‚ã‚µã‚½ãƒªã«åˆºã•ã‚Œã¦æ­»ã‚“ã ãŸã‚ã€ã‚µã‚½ãƒªåº§ãŒæ˜‡ã‚‹ã¨é€ƒã’ã‚‹ã‚ˆã†ã«æ²ˆã‚“ã§ã„ãã¾ã™ã€‚ã€è±†çŸ¥è­˜ã€‘æ—¥æœ¬ã§ã¯ä¸‰ã¤æ˜Ÿã‚’ã€Œå¹³å®¶æ˜Ÿã€ã€Œæºæ°æ˜Ÿã€ã¨å‘¼ã‚“ã§ã„ã¾ã—ãŸã€‚",
        centerRA: 5.6, centerDec: 0.0, 
        lines: ["Betelgeuse","Alnitak", "Alnitak","Saiph", "Rigel","Mintaka", "Mintaka","Alnilam", "Alnilam","Alnitak", "Betelgeuse","Bellatrix", "Mintaka","Bellatrix", "Alnitak","Rigel"] 
    },
    { 
        id: "sco", rank: 1, name: "ã•ãã‚Šåº§", en: "Scorpius", 
        desc: "ã€å¤ã®Så­—ã€‘å—ã®ç©ºã®å¤§ããªSå­—ã‚«ãƒ¼ãƒ–ã€‚èµ¤ã„1ç­‰æ˜Ÿã€Œã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ã€ã¯ã€Œç«æ˜Ÿã«å¯¾æŠ—ã™ã‚‹ã‚‚ã®ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚", 
        myth: "ã€ç¥è©±ã€‘ã‚ªãƒªã‚ªãƒ³ã‚’å€’ã—ãŸæ‰‹æŸ„ã§æ˜Ÿåº§ã«ãªã‚Šã¾ã—ãŸã€‚ã ã‹ã‚‰ã‚ªãƒªã‚ªãƒ³åº§ã¨ã¯æ±ºã—ã¦åŒã˜ç©ºã«ã¯ç¾ã‚Œã¾ã›ã‚“ã€‚",
        centerRA: 16.5, centerDec: -26.0, 
        lines: ["Antares","Dschubba", "Dschubba","Graffias", "Antares","Wei", "Antares","Tau Sco", "Tau Sco","Epsilon Sco", "Epsilon Sco","Mu Sco", "Mu Sco","Zeta Sco", "Zeta Sco","Eta Sco", "Eta Sco","Sargas", "Sargas","Shaula"] 
    },
    { 
        id: "sum", rank: 1, name: "å¤ã®å¤§ä¸‰è§’", en: "Summer Triangle", 
        desc: "ã€å¤ã®ç›®å°ã€‘ã“ã¨åº§ã®ãƒ™ã‚¬ï¼ˆç¹”å§«ï¼‰ã€ã‚ã—åº§ã®ã‚¢ãƒ«ã‚¿ã‚¤ãƒ«ï¼ˆå½¦æ˜Ÿï¼‰ã€ã¯ãã¡ã‚‡ã†åº§ã®ãƒ‡ãƒãƒ–ã‚’çµã¶å·¨å¤§ãªä¸‰è§’å½¢ã€‚", 
        myth: "ã€ç†ç§‘ã€‘ãƒ™ã‚¬ã¾ã§ã®è·é›¢ã¯25å…‰å¹´ã§ã™ãŒã€ãƒ‡ãƒãƒ–ã¯1400å…‰å¹´ã‚‚å½¼æ–¹ã«ã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒãƒ–ã¯è¶…ãƒ»è¶…å·¨å¤§ãªæ˜Ÿã ã‹ã‚‰ã€é ãã¦ã‚‚æ˜ã‚‹ãè¦‹ãˆã‚‹ã®ã§ã™ã€‚",
        centerRA: 19.5, centerDec: 28.0, 
        lines: ["Vega","Altair", "Altair","Deneb", "Deneb","Vega"] 
    },
    { 
        id: "tau", rank: 1, name: "ãŠã†ã—åº§", en: "Taurus", 
        desc: "ã€å†¬ã®Vå­—ã€‘Vå­—å‹ã®é¡”ã¨ã€ç¾ã—ã„æ˜Ÿå›£ã€Œãƒ—ãƒ¬ã‚¢ãƒ‡ã‚¹ï¼ˆã™ã°ã‚‹ï¼‰ã€ãŒç‰¹å¾´ã€‚", 
        myth: "ã€è±†çŸ¥è­˜ã€‘ã€Œã™ã°ã‚‹ã€ã¯ã€Œçµ±ï¼ˆã™ï¼‰ã¹ã‚‹ï¼é›†ã¾ã‚‹ã€ã¨ã„ã†æ„å‘³ã®å¤ã„æ—¥æœ¬èªã€‚è‡ªå‹•è»Šãƒ¡ãƒ¼ã‚«ãƒ¼ã€ŒSUBARUã€ã®ã‚¨ãƒ³ãƒ–ãƒ¬ãƒ ã«ã‚‚ãªã£ã¦ã„ã¾ã™ã€‚",
        centerRA: 4.5, centerDec: 16.0, 
        lines: ["Aldebaran","Elnath", "Aldebaran","Zeta Tau"] 
    },
    { 
        id: "gem", rank: 1, name: "ãµãŸã”åº§", en: "Gemini", 
        desc: "ã€ä»²è‰¯ã—å…„å¼Ÿã€‘ã‚«ã‚¹ãƒˆãƒ«ï¼ˆå…„ãƒ»éŠ€ï¼‰ã¨ãƒãƒ«ãƒƒã‚¯ã‚¹ï¼ˆå¼Ÿãƒ»é‡‘ï¼‰ãŒä¸¦ã‚“ã§è¼ã„ã¦ã„ã¾ã™ã€‚", 
        myth: "ã€ç†ç§‘ã€‘å®Ÿã¯ã‚«ã‚¹ãƒˆãƒ«ã¯6ã¤ã®æ˜ŸãŒé‡ãªã£ãŸã€Œ6é‡é€£æ˜Ÿã€ã¨ã„ã†ã€ã¨ã‚“ã§ã‚‚ãªãè¤‡é›‘ãªæ˜Ÿã§ã™ã€‚æœ›é é¡ãŒãªã„ã¨1ã¤ã«è¦‹ãˆã¾ã™ã€‚",
        centerRA: 7.0, centerDec: 22.0, 
        lines: ["Castor","Pollux"] 
    },
    { 
        id: "leo", rank: 1, name: "ã—ã—åº§", en: "Leo", 
        desc: "ã€æ˜¥ã®éŒã€‘ã€Œï¼Ÿã€ã‚’è£è¿”ã—ãŸã‚ˆã†ãªå½¢ï¼ˆã—ã—ã®å¤§éŒï¼‰ãŒé ­ã€‚1ç­‰æ˜Ÿãƒ¬ã‚°ãƒ«ã‚¹ã¯ã€Œå°ã•ãªç‹æ§˜ã€ã¨ã„ã†æ„å‘³ã€‚", 
        myth: "ã€ç¥è©±ã€‘è‹±é›„ãƒ˜ãƒ©ã‚¯ãƒ¬ã‚¹ã¨æˆ¦ã£ãŸä¸æ­»èº«ã®ãƒ©ã‚¤ã‚ªãƒ³ã€‚ç¡¬ã„çš®è†šã‚’æŒã£ã¦ã„ã¾ã—ãŸãŒã€ãƒ˜ãƒ©ã‚¯ãƒ¬ã‚¹ã«é¦–ã‚’çµã‚ã‚‰ã‚Œã¦é€€æ²»ã•ã‚Œã¾ã—ãŸã€‚",
        centerRA: 10.5, centerDec: 15.0, 
        lines: ["Regulus","Denebola", "Regulus","Algieba"] 
    },
    { 
        id: "vir", rank: 1, name: "ãŠã¨ã‚åº§", en: "Virgo", 
        desc: "ã€æ˜¥ã®å¥³ç¥ã€‘ç™½ãè¼ãã‚¹ãƒ”ã‚«ãŒç›®å°ã€‚ã€Œã‚¹ãƒ”ã‚«ã€ã¯ã€Œéº¦ã®ç©‚ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚", 
        myth: "ã€ç¥è©±ã€‘è¾²æ¥­ã®å¥³ç¥ãƒ‡ãƒ¡ãƒ†ãƒ«ã€ã¾ãŸã¯ãã®å¨˜ãƒšãƒ«ã‚»ãƒãƒã®å§¿ã€‚å½¼å¥³ãŒåœ°ä¸‹ã®å›½ã«è¡Œãã¨å†¬ã«ãªã‚Šã€æˆ»ã£ã¦ãã‚‹ã¨æ˜¥ã«ãªã‚Šã¾ã™ã€‚",
        centerRA: 13.3, centerDec: -2.0, 
        lines: ["Spica","Porrima", "Spica","Vindemiatrix"] 
    },
    { 
        id: "cas", rank: 2, name: "ã‚«ã‚·ã‚ªãƒšãƒ¤åº§", en: "Cassiopeia", 
        desc: "ã€åŒ—ã®Wã€‘åŒ—æ¥µæ˜Ÿã‚’æ¢ã™ãŸã‚ã®ç›®å°ã€‚å­£ç¯€ã«ã‚ˆã£ã¦ã€ŒWã€ã«è¦‹ãˆãŸã‚Šã€ŒMã€ã«è¦‹ãˆãŸã‚Šã—ã¾ã™ã€‚", 
        myth: "ã€ç¥è©±ã€‘ã€Œå¨˜ã®æ–¹ãŒç¥ã‚ˆã‚Šç¾ã—ã„ã€ã¨è‡ªæ…¢ã—ãŸãŸã‚ã€ç½°ã¨ã—ã¦æ¤…å­ã«ç¸›ã‚‰ã‚ŒãŸã¾ã¾ç©ºã‚’å›ã•ã‚Œç¶šã‘ã¦ã„ã‚‹ç‹å¦ƒã§ã™ã€‚",
        centerRA: 1.0, centerDec: 60.0, 
        lines: ["Caph","Schedar", "Schedar","Gamma Cas", "Gamma Cas","Ruchbah", "Ruchbah","Segin"] 
    },
    { 
        id: "and", rank: 2, name: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€åº§", en: "Andromeda", 
        desc: "ã€éŠ€æ²³ã®çª“ã€‘è‚‰çœ¼ã§è¦‹ãˆã‚‹æœ€ã‚‚é ã„å¤©ä½“ã€Œã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ã€ãŒã‚ã‚‹å ´æ‰€ã§ã™ã€‚", 
        myth: "ã€ç†ç§‘ã€‘ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ã¯ã€ç§ãŸã¡ã®å¤©ã®å·éŠ€æ²³ã¨ç´„40å„„å¹´å¾Œã«è¡çªãƒ»åˆä½“ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚",
        centerRA: 0.7, centerDec: 38.0, 
        lines: ["Alpheratz","Mirach", "Mirach","Almach"] 
    },
    { 
        id: "peg", rank: 2, name: "ãƒšã‚¬ã‚¹ã‚¹åº§", en: "Pegasus", 
        desc: "ã€ç§‹ã®å››è¾ºå½¢ã€‘å¤§ããªå››è§’å½¢ãŒèƒ´ä½“ã€‚é€†ã•ã¾ã«ãªã£ã¦é£›ã‚“ã§ã„ã‚‹å¤©é¦¬ã®å§¿ã§ã™ã€‚", 
        myth: "ã€ç¥è©±ã€‘ãƒ¡ãƒ‰ã‚¥ãƒ¼ã‚µã®è¡€ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸç¿¼ã®ã‚ã‚‹é¦¬ã€‚è‹±é›„ãƒ™ãƒ¬ãƒ­ãƒ•ã‚©ãƒ³ã‚’ä¹—ã›ã¦æ€ªç‰©ã‚­ãƒã‚¤ãƒ©ã‚’å€’ã—ã¾ã—ãŸã€‚",
        centerRA: 23.0, centerDec: 20.0, 
        lines: ["Markab","Scheat", "Scheat","Alpheratz", "Alpheratz","Algenib", "Algenib","Markab"] 
    },
    { 
        id: "cyg", rank: 2, name: "ã¯ãã¡ã‚‡ã†åº§", en: "Cygnus", 
        desc: "ã€åŒ—åå­—ã€‘å¤©ã®å·ã®ä¸Šã‚’é£›ã¶åå­—æ¶ã®å½¢ã€‚ãã¡ã°ã—ã®æ˜Ÿã‚¢ãƒ«ãƒ“ãƒ¬ã‚ªã¯ã€å®çŸ³ã®ã‚ˆã†ã«ç¾ã—ã„äºŒé‡æ˜Ÿã§ã™ã€‚", 
        myth: "ã€ç†ç§‘ã€‘ãƒ‡ãƒãƒ–ã®è¿‘ãã«ã¯ã€ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«å€™è£œã¨ã—ã¦æœ‰åãªã€Œã¯ãã¡ã‚‡ã†åº§X-1ã€ãŒã‚ã‚Šã¾ã™ï¼ˆç›®ã«ã¯è¦‹ãˆã¾ã›ã‚“ï¼‰ã€‚",
        centerRA: 20.5, centerDec: 42.0, 
        lines: ["Deneb","Sadr", "Sadr","Albireo", "Sadr","Gienah", "Sadr","Rukh"] 
    },
    { 
        id: "umi", rank: 2, name: "ã“ãã¾åº§", en: "Ursa Minor", 
        desc: "ã€å‹•ã‹ãªã„æ˜Ÿã€‘åŒ—æ¥µæ˜Ÿï¼ˆãƒãƒ©ãƒªã‚¹ï¼‰ãŒã‚ã‚‹æ˜Ÿåº§ã€‚ä¸€å¹´ä¸­ã€åŒ—ã®ç©ºã«è¦‹ãˆã¾ã™ã€‚", 
        myth: "ã€ç†ç§‘ã€‘ç¾åœ¨ã®åŒ—æ¥µæ˜Ÿã¯ãƒãƒ©ãƒªã‚¹ã§ã™ãŒã€åœ°çƒã®é¦–æŒ¯ã‚Šé‹å‹•ï¼ˆæ­³å·®ï¼‰ã«ã‚ˆã‚Šã€1ä¸‡2åƒå¹´å¾Œã«ã¯ã€Œãƒ™ã‚¬ã€ãŒåŒ—æ¥µæ˜Ÿã«ãªã‚Šã¾ã™ã€‚",
        centerRA: 15.0, centerDec: 75.0, 
        lines: ["Polaris","Yildun", "Yildun","Epsilon UMi", "Epsilon UMi","Zeta UMi", "Zeta UMi","Kochab", "Kochab","Pherkad", "Pherkad","Zeta UMi"] 
    }
];

const STARS_DATA = [
    { name: "Polaris", ra: 2.53, dec: 89.26, mag: 1.97, ci: 0.6 },
    { name: "Sirius", ra: 6.75, dec: -16.71, mag: -1.46, ci: 0.0 },
    { name: "Betelgeuse", ra: 5.91, dec: 7.40, mag: 0.45, ci: 1.5 },
    { name: "Rigel", ra: 5.24, dec: -8.20, mag: 0.12, ci: -0.03 },
    { name: "Vega", ra: 18.61, dec: 38.78, mag: 0.03, ci: 0.0 },
    { name: "Altair", ra: 19.84, dec: 8.87, mag: 0.77, ci: 0.22 },
    { name: "Deneb", ra: 20.69, dec: 45.28, mag: 1.25, ci: 0.09 },
    { name: "Antares", ra: 16.49, dec: -26.43, mag: 1.06, ci: 1.83 },
    { name: "Arcturus", ra: 14.26, dec: 19.18, mag: -0.05, ci: 1.23 },
    { name: "Capella", ra: 5.27, dec: 45.99, mag: 0.08, ci: 0.8 },
    { name: "Procyon", ra: 7.65, dec: 5.22, mag: 0.34, ci: 0.4 },
    { name: "Spica", ra: 13.42, dec: -11.16, mag: 0.98, ci: -0.2 },
    { name: "Aldebaran", ra: 4.60, dec: 16.50, mag: 0.87, ci: 1.5 },
    { name: "Pollux", ra: 7.75, dec: 28.02, mag: 1.15, ci: 1.0 },
    { name: "Castor", ra: 7.58, dec: 31.88, mag: 1.58, ci: 0.0 },
    { name: "Regulus", ra: 10.14, dec: 11.96, mag: 1.36, ci: -0.1 },
    { name: "Alnitak", ra: 5.67, dec: -1.94, mag: 1.7, ci: -0.2 },
    { name: "Alnilam", ra: 5.60, dec: -1.20, mag: 1.6, ci: -0.2 },
    { name: "Mintaka", ra: 5.53, dec: -0.29, mag: 2.2, ci: -0.2 },
    { name: "Saiph", ra: 5.79, dec: -9.66, mag: 2.0, ci: -0.1 },
    { name: "Bellatrix", ra: 5.41, dec: 6.34, mag: 1.6, ci: -0.2 },
    { name: "Schedar", ra: 0.67, dec: 56.53, mag: 2.2, ci: 1.1 },
    { name: "Caph", ra: 0.15, dec: 59.14, mag: 2.2, ci: 0.3 },
    { name: "Gamma Cas", ra: 0.94, dec: 60.71, mag: 2.1, ci: -0.1 },
    { name: "Ruchbah", ra: 1.42, dec: 60.23, mag: 2.6, ci: 0.1 },
    { name: "Segin", ra: 1.90, dec: 63.67, mag: 3.3, ci: 0.3 },
    { name: "Dschubba", ra: 16.00, dec: -22.62, mag: 2.3, ci: -0.1 },
    { name: "Graffias", ra: 16.08, dec: -19.80, mag: 2.5, ci: -0.1 },
    { name: "Wei", ra: 16.83, dec: -38.02, mag: 2.2, ci: 1.1 },
    { name: "Sargas", ra: 17.62, dec: -43.00, mag: 1.8, ci: 0.4 },
    { name: "Shaula", ra: 17.56, dec: -37.10, mag: 1.6, ci: -0.2 },
    { name: "Sadr", ra: 20.37, dec: 40.25, mag: 2.2, ci: 0.6 },
    { name: "Albireo", ra: 19.51, dec: 27.96, mag: 3.0, ci: 1.0 },
    { name: "Gienah", ra: 20.77, dec: 33.96, mag: 2.4, ci: 1.0 },
    { name: "Rukh", ra: 19.76, dec: 45.13, mag: 2.8, ci: -0.1 },
    { name: "Kochab", ra: 14.84, dec: 74.15, mag: 2.0, ci: 1.0 },
    { name: "Pherkad", ra: 15.34, dec: 71.83, mag: 3.0, ci: 0.0 },
    { name: "Yildun", ra: 17.53, dec: 86.58, mag: 4.3, ci: 0.0 },
    { name: "Arneb", ra: 5.55, dec: -17.82, mag: 2.5, ci: 0.2 },
    { name: "Nihal", ra: 5.47, dec: -20.76, mag: 2.8, ci: 0.5 },
    { name: "Alpheratz", ra: 0.13, dec: 29.09, mag: 2.0, ci: -0.1 },
    { name: "Mirach", ra: 1.16, dec: 35.62, mag: 2.0, ci: 1.6 },
    { name: "Almach", ra: 2.06, dec: 42.33, mag: 2.1, ci: 1.3 },
    { name: "Markab", ra: 23.08, dec: 15.21, mag: 2.5, ci: -0.1 },
    { name: "Scheat", ra: 23.06, dec: 28.08, mag: 2.4, ci: 1.6 },
    { name: "Algenib", ra: 0.22, dec: 15.18, mag: 2.8, ci: -0.1 },
    { name: "Denebola", ra: 11.82, dec: 14.57, mag: 2.1, ci: 0.0 },
    { name: "Algieba", ra: 10.33, dec: 19.84, mag: 2.0, ci: 1.2 },
    { name: "Elnath", ra: 5.43, dec: 28.60, mag: 1.6, ci: -0.1 },
    { name: "Zeta Tau", ra: 5.62, dec: 21.14, mag: 3.0, ci: -0.2 },
    { name: "Porrima", ra: 12.69, dec: -1.45, mag: 2.7, ci: 0.3 },
    { name: "Vindemiatrix", ra: 13.04, dec: 10.96, mag: 2.8, ci: 0.9 }
];

// --- 1. VECTOR & QUATERNION ENGINE (v18 YXZ + Gamma Fix) ---
const Math3D = {
    qMultiply: (a, b) => {
        const ax = a[0], ay = a[1], az = a[2], aw = a[3];
        const bx = b[0], by = b[1], bz = b[2], bw = b[3];
        return [
            ax * bw + aw * bx + ay * bz - az * by,
            ay * bw + aw * by + az * bx - ax * bz,
            az * bw + aw * bz + ax * by - ay * bx,
            aw * bw - ax * bx - ay * by - az * bz
        ];
    },
    qFromAxisAngle: (axis, angle) => {
        const halfAngle = angle / 2;
        const s = Math.sin(halfAngle);
        return [axis[0] * s, axis[1] * s, axis[2] * s, Math.cos(halfAngle)];
    },
    matFromQ: (q) => {
        const x = q[0], y = q[1], z = q[2], w = q[3];
        const x2 = x + x, y2 = y + y, z2 = z + z;
        const xx = x * x2, xy = x * y2, xz = x * z2;
        const yy = y * y2, yz = y * z2, zz = z * z2;
        const wx = w * x2, wy = w * y2, wz = w * z2;
        return [
            1 - (yy + zz), xy - wz, xz + wy, 0,
            xy + wz, 1 - (xx + zz), yz - wx, 0,
            xz - wy, yz + wx, 1 - (xx + yy), 0,
            0, 0, 0, 1
        ];
    },
    project: (vec, viewMat, width, height, fovDeg) => {
        // Transpose for inverse (Camera -> World)
        const x = vec.x*viewMat[0] + vec.y*viewMat[4] + vec.z*viewMat[8];
        const y = vec.x*viewMat[1] + vec.y*viewMat[5] + vec.z*viewMat[9];
        const z = vec.x*viewMat[2] + vec.y*viewMat[6] + vec.z*viewMat[10];
        if (z >= -0.1) return null;
        const scale = (height / 2) / Math.tan(fovDeg * Math.PI / 360);
        return { x: x*(scale/-z)+width/2, y: -y*(scale/-z)+height/2, z: z };
    }
};

// --- 2. ASTRO PHYSICS ---
const Astro = {
    getLST: (lon, date = new Date()) => {
        const d = (date.getTime()/1000 - 946727935.816) / 86400;
        return ((18.697374558 + 24.06570982441908 * d) % 24 + lon/15 + 24) % 24;
    },
    getStarVector: (ra, dec, lat, lst) => {
        const haRad = (lst - ra) * 15 * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const latRad = lat * Math.PI / 180;
        const sinAlt = Math.sin(decRad)*Math.sin(latRad) + Math.cos(decRad)*Math.cos(latRad)*Math.cos(haRad);
        const altRad = Math.asin(sinAlt);
        const cosAz = (Math.sin(decRad) - Math.sin(altRad)*Math.sin(latRad)) / (Math.cos(altRad)*Math.cos(latRad));
        let azRad = Math.acos(Math.min(1, Math.max(-1, cosAz)));
        if (Math.sin(haRad) > 0) azRad = 2*Math.PI - azRad;
        // Map: Z=Up, Y=North, X=East (Right-Handed with Z-Up)
        return { x: Math.sin(azRad)*Math.cos(altRad), y: Math.cos(azRad)*Math.cos(altRad), z: Math.sin(altRad) };
    }
};

// --- 3. UTILS ---
const Utils = {
    toast: (msg) => { const el = document.getElementById('toast'); el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000); },
    bvToColor: (bv) => {
        if (bv < 0.0) return {r:180, g:200, b:255}; if (bv < 0.5) return {r:230, g:240, b:255}; 
        if (bv < 1.0) return {r:255, g:255, b:240}; if (bv < 1.5) return {r:255, g:220, b:180}; 
        return {r:255, g:200, b:180}; 
    }
};

// --- 4. GUIDE SYSTEM ---
const Guide = {
    target: null,
    toggle: () => {
        const el = document.getElementById('guide-modal');
        const isHidden = el.classList.contains('hidden-force');
        if (isHidden) { Guide.buildList(); el.classList.remove('hidden-force'); } else { el.classList.add('hidden-force'); }
    },
    buildList: () => {
        const list = document.getElementById('guide-list');
        list.innerHTML = '';
        CONSTELLATION_DB.forEach(c => {
            if (!App.state.ranks[c.rank]) return;
            const card = document.createElement('div');
            card.className = `p-4 rounded-xl border border-white/10 bg-slate-800/80 backdrop-blur-sm`;
            const myth = App.state.lang==='ja' ? `<div class="mt-2 text-xs text-yellow-100/80 p-2 bg-yellow-900/20 rounded border border-yellow-500/10 italic leading-relaxed">${c.myth}</div>` : '';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div><h3 class="font-bold text-lg text-white">${App.state.lang==='en'?c.en:c.name}</h3>${App.state.lang!=='en'?`<p class="text-xs text-cyan-400 font-mono">${c.en}</p>`:''}</div>
                    <span class="px-2 py-1 bg-green-500/20 text-green-400 text-[10px] font-bold rounded uppercase">âœ¨ INFO</span>
                </div>
                <p class="text-sm text-slate-300 mb-2 font-bold leading-relaxed">${c.desc}</p>${myth}
                <button onclick="Guide.startNav('${c.id}')" class="w-full py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 mt-2 bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg">ğŸ”­ GOTO NAVI</button>
            `;
            list.appendChild(card);
        });
        if (list.children.length === 0) list.innerHTML = '<p class="text-center text-slate-500 mt-10">è¨­å®šã§è¡¨ç¤ºã™ã‚‹æ˜Ÿåº§ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚</p>';
    },
    startNav: (id) => {
        const c = CONSTELLATION_DB.find(x => x.id === id); if (!c) return;
        Guide.target = { ...c };
        App.state.mode = 'guide';
        document.getElementById('guide-modal').classList.add('hidden-force');
        document.getElementById('nav-ui').classList.remove('hidden-force');
        document.getElementById('nav-target-name').innerText = App.state.lang==='en' ? c.en : c.name;
        document.getElementById('btn-cancel-nav').classList.remove('hidden-force');
        Utils.toast(`Navigating to ${App.state.lang==='en'?c.en:c.name} ğŸš€`);
    },
    stopNav: () => {
        Guide.target = null; App.state.mode = 'normal';
        document.getElementById('nav-ui').classList.add('hidden-force');
        document.getElementById('btn-cancel-nav').classList.add('hidden-force');
        Utils.toast("Navigation Ended");
    }
};

// --- 5. GATEKEEPER ---
const Gate = {
    check: () => {
        const isMobile = ('ontouchstart' in window) && (window.innerWidth <= 1024);
        if (isMobile) {
            document.getElementById('app-container').classList.remove('hidden-force'); document.getElementById('start-modal').classList.remove('hidden-force');
        } else {
            document.getElementById('star-gate').classList.remove('hidden-force');
            new QRious({element:document.getElementById('qr-canvas'),value:window.location.href,size:180});
        }
    },
    startUnlock: () => {
        Utils.toast("PC DEBUG STARTED");
        document.getElementById('star-gate').classList.add('hidden-force');
        document.getElementById('app-container').classList.remove('hidden-force');
        document.getElementById('start-modal').classList.remove('hidden-force');
        App.state.isDev = true;
    }
};

// --- 6. APP CORE ---
const App = {
    canvas: null, ctx: null, width: 0, height: 0,
    state: {
        lat: 32.698, lon: 128.839, // Goto Islands
        viewMat: [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1],
        manualOffset: 0, reverseAlpha: false,
        mode: 'normal', viewMode: 0,
        ranks: { [RANK.FAMOUS]: true, [RANK.MEDIUM]: true, [RANK.MINOR]: false },
        isAR: false, useGPS: false, opacity: {bg:1, milky:0.5},
        showInfo: true, meteorEnabled: true, lang: 'ja',
        stars: [], milkyWay: [], meteors: [],
        isDev: false, fov: 60, orientation: { alpha: 0, beta: 90, gamma: 0 }
    },

    init: async () => {
        document.getElementById('start-modal').classList.add('hidden-force');
        App.canvas = document.getElementById('sky-canvas'); App.ctx = App.canvas.getContext('2d');
        
        STARS_DATA.forEach(s => App.state.stars.push(s));
        for(let i=0; i<800; i++) {
            App.state.stars.push({
                ra: Math.random()*24, dec: Math.random()*180-90, mag: Math.random()*3+3.5, ci: Math.random()*1.5, isProc: true
            });
        }
        const mwPoints = [{ra:0,dec:63},{ra:3,dec:50},{ra:6,dec:10},{ra:7.5,dec:-20},{ra:12,dec:-60},{ra:17,dec:-30},{ra:18,dec:-15},{ra:20,dec:40},{ra:23,dec:60}];
        for(let i=0; i<mwPoints.length-1; i++) {
            const p1 = mwPoints[i]; const p2 = mwPoints[i+1];
            for(let j=0; j<80; j++) {
                const t = j/80;
                App.state.milkyWay.push({
                    ra: p1.ra+(p2.ra-p1.ra)*t+(Math.random()-0.5)*2, dec: p1.dec+(p2.dec-p1.dec)*t+(Math.random()-0.5)*15, 
                    size: Math.random()*30+15, alpha: Math.random()*0.02
                });
            }
        }

        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { const res = await DeviceOrientationEvent.requestPermission(); if (res==='granted') window.addEventListener('deviceorientation', App.handleOri); } catch(e){}
        } else { window.addEventListener('deviceorientation', App.handleOri); }
        
        try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}

        window.addEventListener('resize', App.resize);
        App.setupTouch(); App.resize(); App.loop();
    },

    handleOri: (e) => {
        if (!e.alpha && !e.beta && !e.gamma) return;
        App.state.orientation = { alpha: e.alpha, beta: e.beta, gamma: e.gamma, isIOS: !!e.webkitCompassHeading, webkitCompass: e.webkitCompassHeading };
    },

    updateViewMatrix: () => {
        const { alpha, beta, gamma, isIOS, webkitCompass } = App.state.orientation;
        if(alpha == null) return;

        const deg2rad = Math.PI / 180;
        
        // 1. Get Screen Orientation
        let screenOrient = 0;
        if (window.screen && window.screen.orientation && window.screen.orientation.angle !== undefined) {
            screenOrient = window.screen.orientation.angle;
        } else if (window.orientation !== undefined) {
            screenOrient = window.orientation;
        }

        // 2. Normalize Alpha (Z-Axis)
        let a = alpha;
        if (isIOS && webkitCompass != null) {
            a = -webkitCompass; 
        } else {
             a = alpha;
             if (!isIOS) a -= 270; 
        }
        a += App.state.manualOffset;
        if (App.state.reverseAlpha) a = -a;

        // 3. Convert to Radians
        const rAlpha = a * deg2rad;
        const rBeta = beta * deg2rad;
        const rGamma = gamma * deg2rad;
        const rOrient = screenOrient * deg2rad;

        // 4. Construct Quaternion (THE HOLY ORDER: Y-X-Z)
        // Three.js Standard: setFromEuler(beta, alpha, -gamma, 'YXZ')
        // Important: Gamma is inverted here for proper landscape behavior
        const qY = Math3D.qFromAxisAngle([0, 1, 0], rAlpha);     // Alpha -> Y axis (in YXZ logic)
        const qX = Math3D.qFromAxisAngle([1, 0, 0], rBeta);      // Beta -> X axis
        const qZ = Math3D.qFromAxisAngle([0, 0, 1], -rGamma);    // Gamma -> Z axis (INVERTED!)

        // Composition: qDev = Y * X * Z
        let qDev = Math3D.qMultiply(qY, qX);
        qDev = Math3D.qMultiply(qDev, qZ);

        // 5. Camera Adjustment (-90 deg X to look forward)
        const qCamFix = Math3D.qFromAxisAngle([1, 0, 0], -90 * deg2rad);
        
        // 6. Screen Orientation Adjustment (Rotate around Z)
        const qScreen = Math3D.qFromAxisAngle([0, 0, 1], -rOrient);

        // Final Chain: 
        // q = qDev * qCamFix * qScreen (Applied in local space chain)
        let qFinal = Math3D.qMultiply(qDev, qCamFix);
        qFinal = Math3D.qMultiply(qFinal, qScreen);

        App.state.viewMat = Math3D.matFromQ(qFinal);

        // Debug output
        const fwdX = -App.state.viewMat[8], fwdY = -App.state.viewMat[9], fwdZ = -App.state.viewMat[10];
        const alt = Math.asin(fwdZ) * 180/Math.PI; 
        let az = Math.atan2(fwdX, fwdY) * 180/Math.PI;
        if(az<0) az+=360;
        document.getElementById('debug-az').innerText = Math.round(az);
        document.getElementById('debug-alt').innerText = Math.round(alt);
    },

    loop: () => {
        App.updateViewMatrix();
        const {ctx, width, height, state} = App;
        ctx.clearRect(0,0,width,height);
        
        // 1. Background
        const isSolar = state.viewMode === 2;
        if (state.opacity.bg > 0) {
            const alpha = state.isAR ? state.opacity.bg : 1;
            const grad = ctx.createLinearGradient(0,0,0,height);
            if (isSolar) { grad.addColorStop(0, `rgba(135,206,235,${alpha})`); grad.addColorStop(1, `rgba(224,247,250,${alpha})`); }
            else { grad.addColorStop(0, `rgba(2,6,23,${alpha})`); grad.addColorStop(1, `rgba(15,23,42,${alpha})`); }
            ctx.fillStyle = grad; ctx.fillRect(0,0,width,height);
        }

        const lst = Astro.getLST(state.lon);
        
        // 2. Milky Way
        if (!isSolar && state.opacity.milky > 0) {
            ctx.globalCompositeOperation = 'lighter';
            state.milkyWay.forEach(p => {
                const vec = Astro.getStarVector(p.ra, p.dec, state.lat, lst);
                const pos = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if (pos) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha * state.opacity.milky})`;
                    ctx.beginPath(); ctx.arc(pos.x, pos.y, p.size * (width/1500), 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.globalCompositeOperation = 'source-over';
        }

        const starPos = {};

        // 3. Stars
        state.stars.forEach(s => {
            const vec = Astro.getStarVector(s.ra, s.dec, state.lat, lst);
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            if (p) {
                if(s.name) starPos[s.name] = p;
                let col = s.isProc ? {r:255,g:255,b:255} : Utils.bvToColor(s.ci||0.5);
                let size = s.isProc ? Math.random()*1 : Math.max(0.8, (3.5-s.mag)*1.2);
                let alpha = (s.mag<2?1.0:0.6);
                if (isSolar) { size*=0.8; alpha=0.7; col={r:0,g:0,b:0}; }
                ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${alpha})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI*2); ctx.fill();
            }
        });

        // 4. Constellations
        ctx.strokeStyle = isSolar ? "rgba(0,0,0,0.3)" : "rgba(34,211,238,0.4)"; ctx.lineWidth = 1;
        ctx.beginPath();
        const visibleConsts = [];
        CONSTELLATION_DB.forEach(c => {
            if (!state.ranks[c.rank]) return;
            const isTarget = (state.mode === 'guide' && Guide.target && Guide.target.id === c.id);
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = "#4ade80"; ctx.lineWidth = 3; }
            
            let cx=0, cy=0, n=0;
            for(let i=0; i<c.lines.length; i+=2) {
                const p1 = starPos[c.lines[i]]; const p2 = starPos[c.lines[i+1]];
                if(p1 && p2) { 
                    ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); 
                    cx+=(p1.x+p2.x)/2; cy+=(p1.y+p2.y)/2; n++;
                }
            }
            if(n>0) {
                cx/=n; cy/=n;
                const d = Math.hypot(cx-width/2, cy-height/2);
                if(c.rank === 1 || d < 200) {
                    visibleConsts.push({c, x:cx, y:cy, dist:d});
                    ctx.fillStyle = isTarget ? "#4ade80" : (isSolar ? "#000" : "#fff");
                    ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                    ctx.fillText(state.lang==='en'?c.en:c.name, cx, cy);
                }
            }
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = isSolar?"rgba(0,0,0,0.3)":"rgba(34,211,238,0.4)"; ctx.lineWidth = 1; }
        });
        ctx.stroke();

        // 5. Info Overlay
        if (state.showInfo && visibleConsts.length > 0) {
            visibleConsts.sort((a,b) => a.dist - b.dist);
            const target = visibleConsts[0];
            if (target.dist < 150) {
                const text = state.lang==='en' ? target.c.en : target.c.desc;
                const tx = target.x, ty = target.y + 20;
                ctx.fillStyle = isSolar ? "rgba(255,255,255,0.9)" : "rgba(15,23,42,0.9)";
                ctx.strokeStyle = "#22d3ee";
                const w = Math.min(260, ctx.measureText(text).width*1.5);
                ctx.beginPath(); ctx.roundRect(tx - w/2, ty, w, 40, 8); ctx.fill(); ctx.stroke();
                ctx.fillStyle = isSolar ? "#000" : "#fff"; ctx.font = "11px 'Zen Maru Gothic'"; ctx.textAlign = "center";
                ctx.fillText(text.substring(0,35)+(text.length>35?"...":""), tx, ty+24); ctx.textAlign = "start";
            }
        }

        // 6. Meteors
        if (state.meteorEnabled && !isSolar) {
            if (Math.random() < 0.01) state.meteors.push({x: Math.random()*width, y: Math.random()*height*0.5, vx: (Math.random()-0.5)*20, vy: Math.random()*15+5, life: 1});
            ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 2;
            state.meteors = state.meteors.filter(m => {
                ctx.globalAlpha = m.life; ctx.beginPath(); ctx.moveTo(m.x, m.y); ctx.lineTo(m.x-m.vx*4, m.y-m.vy*4); ctx.stroke();
                m.x+=m.vx; m.y+=m.vy; m.life-=0.04; return m.life>0;
            });
            ctx.globalAlpha = 1;
        }

        // 7. Target Lock
        if (state.mode === 'guide' && Guide.target) {
            const t = Guide.target;
            const vec = Astro.getStarVector(t.centerRA, t.centerDec, state.lat, lst);
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            const lockEl = document.getElementById('lock-on');
            if (p && p.x>50 && p.x<width-50 && p.y>50 && p.y<height-50) {
                lockEl.style.opacity = 1; lockEl.style.left = p.x + 'px'; lockEl.style.top = p.y + 'px';
                document.getElementById('nav-msg').style.transform = `translate(0,0)`;
            } else {
                lockEl.style.opacity = 0;
            }
        }
        requestAnimationFrame(App.loop);
    },

    resize: () => { App.width = window.innerWidth; App.height = window.innerHeight; App.canvas.width = App.width; App.canvas.height = App.height; App.state.fov = (App.width>App.height)?45:60; },
    toggleLocation: () => { App.state.useGPS = !App.state.useGPS; document.getElementById('loc-name').innerText=App.state.useGPS?"GPS (ç¾åœ¨åœ°)":"äº”å³¶åˆ—å³¶ (å›ºå®š)"; Utils.toast(App.state.useGPS?"GPS Mode":"Goto Mode"); },
    toggleSettings: () => document.getElementById('settings-modal').classList.toggle('hidden-force'),
    toggleAR: (v) => { App.state.isAR = v; document.getElementById('camera-feed').style.opacity = v?1:0; App.setOpacity('bg', v?0.0:1); document.querySelector('input[oninput*="bg"]').value = v?0.0:1; },
    toggleViewMode: () => {
        App.state.viewMode = (App.state.viewMode + 1) % 3;
        const body = document.body; const btn = document.getElementById('btn-mode');
        body.classList.remove('mode-red', 'mode-solar');
        if(App.state.viewMode === 1) { body.classList.add('mode-red'); btn.innerText = "ğŸ”´"; }
        else if(App.state.viewMode === 2) { body.classList.add('mode-solar'); btn.innerText = "â˜€ï¸"; }
        else { btn.innerText = "ğŸŒ™"; }
    },
    setOpacity: (k,v) => { App.state.opacity[k] = parseFloat(v); if(k==='bg')document.getElementById('val-bg').innerText=Math.round(v*100)+"%"; if(k==='milky')document.getElementById('val-milky').innerText=Math.round(v*100)+"%"; },
    setRank: (r,v) => App.state.ranks[r] = v,
    setFlag: (k,v) => App.state[k] = v,
    setLang: (l) => { App.state.lang = l; Guide.buildList(); },
    takeScreenshot: () => { const l=document.createElement('a'); l.download='stargazer-v18.0.png'; l.href=App.canvas.toDataURL(); l.click(); Utils.toast("ä¿å­˜ã—ã¾ã—ãŸ ğŸ“¸"); },
    setupTouch: () => {
        let lx = 0;
        window.addEventListener('touchstart', e => lx = e.touches[0].clientX);
        window.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - lx; App.state.manualOffset += dx * 0.2; lx = e.touches[0].clientX;
        });
    }
};

window.onload = () => Gate.check();
</script>
</body>
</html>
