<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Compass Proto v1.1</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Consolas, monospace; color: #0f0; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .hud-row { padding: 10px; display: flex; justify-content: space-between; pointer-events: auto; }
        
        /* Buttons */
        button {
            background: rgba(0, 20, 0, 0.7);
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            backdrop-filter: blur(4px);
            touch-action: manipulation;
        }
        button:active { background: #0f0; color: #000; }
        
        /* Specific Controls */
        #debug-info { font-size: 10px; background: rgba(0,0,0,0.5); padding: 5px; max-width: 50%; }
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: auto;
        }
        #start-btn { font-size: 24px; padding: 20px 40px; border: 2px solid #0f0; }
        
        .control-group { display: flex; gap: 10px; align-items: center; }
        .big-btn { width: 60px; height: 60px; font-size: 20px; border-radius: 50%; }

        /* PC Warning Screen */
        #pc-warning {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 10000;
            color: #0f0;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        #pc-warning h1 { font-size: 2em; margin-bottom: 20px; border-bottom: 2px solid #0f0; padding-bottom: 10px; }
        #qr-container { margin: 30px; padding: 10px; background: #fff; border-radius: 8px; }
        #qr-container img { display: block; width: 200px; height: 200px; }
        .pc-message { max-width: 600px; line-height: 1.6; font-size: 1.2em; color: #aaa; }

    </style>
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- PC Warning Screen -->
    <div id="pc-warning">
        <h1>MOBILE DEVICE REQUIRED</h1>
        <div class="pc-message">
            „Åì„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅØ„ÄÅ„Ç∏„É£„Ç§„É≠„Çª„É≥„Çµ„Éº„ÇíÊê≠Ëºâ„Åó„Åü<br>
            „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Åæ„Åü„ÅØ„Çø„Éñ„É¨„ÉÉ„ÉàÂ∞ÇÁî®„Åß„Åô„ÄÇ<br><br>
            „ÅäÊâãÊåÅ„Å°„ÅÆ„Éá„Éê„Ç§„Çπ„Åß‰ª•‰∏ã„ÅÆQR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çä„ÄÅ<br>
            „Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>
        <div id="qr-container">
            <!-- QR Code injected by JS -->
        </div>
        <div style="font-size: 0.8em; color: #555;">Star Compass Engine v1.1</div>
    </div>

    <!-- Start Overlay for iOS Permissions -->
    <div id="start-overlay">
        <h1 style="color:#0f0; text-shadow:0 0 10px #0f0;">STAR COMPASS v1</h1>
        <p style="color:#aaa; text-align:center; padding:0 20px;">
            1. Stand facing NORTH.<br>
            2. Hold device vertically.<br>
            3. Tap Start.
        </p>
        <button id="start-btn">START SYSTEM</button>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- HUD -->
    <div id="ui-layer">
        <!-- Top Row: Info -->
        <div class="hud-row">
            <div id="debug-info">Initializing...</div>
            <button id="btn-calibrate">SET NORTH (0¬∞)</button>
        </div>

        <!-- Center: Crosshair (Visual only) -->
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:20px; height:20px; border:1px solid rgba(0,255,0,0.5); border-radius:50%; pointer-events:none;"></div>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:2px; height:10px; background:rgba(0,255,0,0.5); pointer-events:none;"></div>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:10px; height:2px; background:rgba(0,255,0,0.5); pointer-events:none;"></div>

        <!-- Bottom Row: Manual Controls -->
        <div class="hud-row" style="justify-content: center; gap: 20px; padding-bottom: 30px;">
            <button class="big-btn" id="btn-minus90">‚Ü∂</button>
            <div style="display:flex; flex-direction:column; align-items:center; color:#0f0; font-size:10px;">
                <span>MANUAL</span>
                <span>OFFSET</span>
                <span id="offset-display">0¬∞</span>
            </div>
            <button class="big-btn" id="btn-plus90">‚Ü∑</button>
        </div>
    </div>

    <script>
        /**
         * üåå STAR COMPASS ENGINE V1.1
         * Feature: Mobile Detection & QR Landing Page
         */

        // --- Device Detection Logic ---
        function checkDevice() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobile = /iphone|ipad|ipod|android|blackberry|windows phone/i.test(ua);
            
            // If not mobile, show Warning and generate QR
            if (!isMobile) {
                const warningEl = document.getElementById('pc-warning');
                const overlayEl = document.getElementById('start-overlay');
                const uiEl = document.getElementById('ui-layer');
                const canvasEl = document.getElementById('canvas-container');

                warningEl.style.display = 'flex';
                overlayEl.style.display = 'none';
                uiEl.style.display = 'none';
                canvasEl.style.display = 'none';

                // Generate QR Code for current URL
                const currentUrl = encodeURIComponent(window.location.href);
                const qrContainer = document.getElementById('qr-container');
                // Using a reliable public QR API
                const qrImg = document.createElement('img');
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${currentUrl}`;
                qrImg.alt = "Scan to open on mobile";
                qrContainer.appendChild(qrImg);

                return false; // Stop initialization
            }
            return true; // Continue
        }

        // --- Configuration ---
        const CONFIG = {
            fov: 75,
            defaultLat: 35.6895, // Tokyo (Fallback)
            starScale: 1.0,
            gridRadius: 200,
            starDistance: 500
        };

        // --- State ---
        let state = {
            alphaOffset: 0,
            manualOffset: 0,
            currentAlpha: 0,
            currentBeta: 0,
            currentGamma: 0,
            isRunning: false
        };

        // --- Three.js Globals ---
        let scene, camera, renderer;
        let starGroup, horizonGroup;
        
        // --- Star Data ---
        const STARS = [
            { name: "Polaris", ra: 2.53, dec: 89.26, mag: 1.97, color: 0xFFFFCC, size: 2.0 },
            { name: "Betelgeuse", ra: 5.92, dec: 7.41, mag: 0.45, color: 0xFFAA88, size: 1.8 },
            { name: "Rigel", ra: 5.24, dec: -8.2, mag: 0.12, color: 0xAACCFF, size: 1.8 },
            { name: "Bellatrix", ra: 5.42, dec: 6.35, mag: 1.64, color: 0xCCCCFF, size: 1.2 },
            { name: "Mintaka", ra: 5.53, dec: -0.3, mag: 2.25, color: 0xCCCCFF, size: 1.0 },
            { name: "Alnilam", ra: 5.60, dec: -1.2, mag: 1.69, color: 0xCCCCFF, size: 1.1 },
            { name: "Alnitak", ra: 5.68, dec: -1.9, mag: 1.74, color: 0xCCCCFF, size: 1.1 },
            { name: "Saiph", ra: 5.79, dec: -9.6, mag: 2.07, color: 0xCCCCFF, size: 1.0 },
            { name: "Sirius", ra: 6.75, dec: -16.7, mag: -1.46, color: 0xFFFFFF, size: 2.5 },
            { name: "Mirzam", ra: 6.38, dec: -17.9, mag: 1.98, color: 0xCCCCFF, size: 1.0 },
            { name: "Aldebaran", ra: 4.60, dec: 16.5, mag: 0.87, color: 0xFFDDAA, size: 1.6 },
            { name: "Elnath", ra: 5.43, dec: 28.6, mag: 1.65, color: 0xCCCCFF, size: 1.2 },
            { name: "Pollux", ra: 7.76, dec: 28.0, mag: 1.14, color: 0xFFDDAA, size: 1.5 },
            { name: "Castor", ra: 7.58, dec: 31.9, mag: 1.58, color: 0xFFFFFF, size: 1.4 },
            { name: "Alhena", ra: 6.63, dec: 16.4, mag: 1.93, color: 0xFFFFFF, size: 1.1 },
            { name: "Procyon", ra: 7.65, dec: 5.21, mag: 0.34, color: 0xFFFFEE, size: 1.6 },
            { name: "Capella", ra: 5.28, dec: 46.0, mag: 0.08, color: 0xFFFFDD, size: 1.7 },
            { name: "Schedar", ra: 0.67, dec: 56.5, mag: 2.2, color: 0xFFAAAA, size: 1.0 },
            { name: "Deneb", ra: 20.69, dec: 45.28, mag: 1.25, color: 0xFFFFFF, size: 1.2 }
        ];

        const CONSTELLATION_LINES = [
            ["Betelgeuse", "Bellatrix"], ["Betelgeuse", "Alnitak"], ["Rigel", "Saiph"], 
            ["Rigel", "Mintaka"], ["Bellatrix", "Mintaka"], ["Saiph", "Alnitak"],
            ["Mintaka", "Alnilam"], ["Alnilam", "Alnitak"],
            ["Sirius", "Mirzam"], ["Aldebaran", "Elnath"], ["Pollux", "Castor"]
        ];

        // --- Initialization ---
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(CONFIG.fov, window.innerWidth / window.innerHeight, 0.1, 2000);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            createGrid();
            createStars();
            
            window.addEventListener('resize', onResize);
            animate();
        }

        // --- 3D Object Creation ---
        
        function createGrid() {
            horizonGroup = new THREE.Group();
            const geometry = new THREE.RingGeometry(CONFIG.gridRadius - 0.5, CONFIG.gridRadius, 64);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide });
            const ring = new THREE.Mesh(geometry, material);
            ring.rotation.x = -Math.PI / 2;
            horizonGroup.add(ring);

            addTextSprite("N", 0, 0, -CONFIG.gridRadius, 0xff0000);
            addTextSprite("S", 0, 0, CONFIG.gridRadius, 0x00ff00);
            addTextSprite("E", CONFIG.gridRadius, 0, 0, 0x00ff00);
            addTextSprite("W", -CONFIG.gridRadius, 0, 0, 0x00ff00);
            
            const points = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, CONFIG.gridRadius, 0)];
            const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
            const lineMat = new THREE.LineBasicMaterial({ color: 0x003300 });
            horizonGroup.add(new THREE.Line(lineGeo, lineMat));

            scene.add(horizonGroup);
        }

        function addTextSprite(message, x, y, z, color) {
            const canvas = document.createElement('canvas');
            const size = 64;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#' + color.toString(16).padStart(6, '0');
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, size/2, size/2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMat = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.position.set(x, y + 10, z);
            sprite.scale.set(20, 20, 1);
            horizonGroup.add(sprite);
        }

        function createStars() {
            starGroup = new THREE.Group();
            const starMap = {};

            STARS.forEach(star => {
                const raRad = (star.ra / 24) * Math.PI * 2;
                const decRad = (star.dec / 180) * Math.PI;
                const r = CONFIG.starDistance;
                const x = r * Math.cos(decRad) * Math.cos(raRad);
                const z = r * Math.cos(decRad) * Math.sin(raRad);
                const y = r * Math.sin(decRad);
                
                const geometry = new THREE.SphereGeometry(star.size, 8, 8);
                const material = new THREE.MeshBasicMaterial({ color: star.color });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set(x, y, z);
                starGroup.add(mesh);
                starMap[star.name] = mesh.position;
            });

            const material = new THREE.LineBasicMaterial({ color: 0x333333, transparent: true, opacity: 0.5 });
            CONSTELLATION_LINES.forEach(pair => {
                if (starMap[pair[0]] && starMap[pair[1]]) {
                    const points = [starMap[pair[0]], starMap[pair[1]]];
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const line = new THREE.Line(geometry, material);
                    starGroup.add(line);
                }
            });

            scene.add(starGroup);
        }

        function updateStarRotation() {
            const tilt = -(90 - CONFIG.defaultLat) * (Math.PI / 180);
            starGroup.rotation.x = tilt; 
            starGroup.rotation.y = Math.PI; 
        }

        // --- Sensor Logic ---

        function handleOrientation(event) {
            state.currentAlpha = event.alpha ? event.alpha : 0;
            state.currentBeta = event.beta ? event.beta : 0;
            state.currentGamma = event.gamma ? event.gamma : 0;
            updateCamera();
            updateDebug();
        }

        function updateCamera() {
            if (!state.currentAlpha) return;

            const alpha = state.currentAlpha + state.alphaOffset + state.manualOffset;
            const beta = state.currentBeta;
            const gamma = state.currentGamma;
            
            const euler = new THREE.Euler();
            const q1 = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5)); 
            
            euler.set(
                beta * (Math.PI / 180), 
                alpha * (Math.PI / 180), 
                -gamma * (Math.PI / 180), 
                'YXZ'
            );
            
            const q = new THREE.Quaternion();
            q.setFromEuler(euler);
            q.multiply(q1); 
            
            camera.quaternion.copy(q);
        }

        function calibrateNorth() {
            state.alphaOffset = -state.currentAlpha;
            updateDebug();
        }

        function adjustManual(deg) {
            state.manualOffset += deg;
            document.getElementById('offset-display').innerText = state.manualOffset + "¬∞";
        }

        function updateDebug() {
            const el = document.getElementById('debug-info');
            el.innerHTML = `
                A: ${Math.round(state.currentAlpha)}<br>
                B: ${Math.round(state.currentBeta)}<br>
                G: ${Math.round(state.currentGamma)}<br>
                OFF: ${state.manualOffset}
            `;
        }

        function animate() {
            if (!state.isRunning) return;
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function onResize() {
            if (!camera) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Start Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            // Check Device First
            if (checkDevice()) {
                document.getElementById('start-btn').addEventListener('click', () => {
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    startSystem();
                                } else {
                                    alert('Permission denied. Reload to try again.');
                                }
                            })
                            .catch(console.error);
                    } else {
                        startSystem();
                    }
                });
            }
        });

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            window.addEventListener('deviceorientation', handleOrientation, true);
            init();
            updateStarRotation();
            state.isRunning = true;
        }
        
        document.getElementById('btn-calibrate').addEventListener('click', calibrateNorth);
        document.getElementById('btn-minus90').addEventListener('click', () => adjustManual(-90));
        document.getElementById('btn-plus90').addEventListener('click', () => adjustManual(90));

    </script>
</body>
</html>
```

### üì¶ Deployment Checklist

GitHub„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊôÇ„ÅØ„ÄÅÂâçÂõûÂêåÊßò `sw.js` „ÅÆÊõ¥Êñ∞„Çí„ÅäÂøò„Çå„Å™„Åè„ÄÇ

```javascript
// sw.js
const CACHE_NAME = 'adom-lab-v5.1'; // Increment version
const INITIAL_ASSETS = [
  // ...other files
  './star-compass.html' 
];
