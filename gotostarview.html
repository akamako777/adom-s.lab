<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Five Islands Stargazer v25.5 (Final Polish)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* ğŸ›‘ Core Stability */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-user-select: none; user-select: none; color: white;
            overscroll-behavior: none;
        }

        /* ğŸŒŒ Layers */
        #layers-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #camera-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0; transition: opacity 0.8s; }
        #sky-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        
        /* Overlay for Smart Bubble */
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; overflow: hidden; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        .glass {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* ğŸŒ“ Modes */
        body.mode-red #layers-container { filter: sepia(100%) hue-rotate(-50deg) saturate(300%) contrast(1.2) brightness(0.6); }
        body.mode-red #ui-layer { filter: sepia(100%) hue-rotate(-50deg) saturate(200%); }
        
        body.mode-solar { background-color: #87CEEB; color: #0f172a; }
        body.mode-solar .glass { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0,0,0,0.1); color: #0f172a; }
        body.mode-solar h1, body.mode-solar h2, body.mode-solar h3, body.mode-solar span, body.mode-solar div { color: #0f172a; text-shadow: none !important; }
        body.mode-solar .text-cyan-400 { color: #0066cc !important; }
        body.mode-solar .text-white { color: #0f172a !important; }
        
        /* Smart Bubble (Compact) */
        .info-bubble {
            position: absolute;
            transition: opacity 0.3s, transform 0.1s linear;
            will-change: transform, left, top;
        }
        .bubble-tail {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-top: 8px solid rgba(15, 23, 42, 0.9);
        }
        body.mode-solar .bubble-tail { border-top-color: rgba(255, 255, 255, 0.95); }

        /* Time Slider */
        #time-slider-container {
            position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 400px; z-index: 30;
            display: flex; flex-direction: column; items-center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #time-slider-container.active { opacity: 1; pointer-events: auto; }
        .time-label { font-size: 12px; color: #fbbf24; text-align: center; font-weight: bold; margin-bottom: 4px; text-shadow: 0 0 5px black; }

        /* Calibration Modal */
        #calib-modal {
            position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #calib-modal.active { opacity: 1; pointer-events: auto; }
        
        .level-bubble {
            width: 180px; height: 180px; border: 4px solid #475569; border-radius: 50%;
            position: relative; overflow: hidden; background: #0f172a; margin-bottom: 20px;
        }
        .level-target {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border: 2px solid #22d3ee; border-radius: 50%; z-index: 10;
        }
        .level-ball {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            background: #ef4444; border-radius: 50%; opacity: 0.8;
            transform: translate(-50%, -50%); transition: all 0.1s linear;
        }
        .level-ok .level-ball { background: #22c55e; }

        /* ğŸšª PC Gate */
        #star-gate {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            overflow-y: auto; padding-top: 10vh; padding-bottom: 40px;
        }

        @keyframes pulse-target { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        .target-lock { animation: pulse-target 1s infinite; }
        .hidden-force { display: none !important; }
        .check-box { appearance: none; width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; background: transparent; cursor: pointer; position: relative; transition: all 0.2s; }
        .check-box:checked { background: #22d3ee; border-color: #22d3ee; }
        .check-box:checked::after { content: 'âœ”'; position: absolute; top: 0px; left: 5px; color: #000; font-size: 16px; font-weight: bold; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #22d3ee; border: 2px solid #ffffff; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        
        #debug-hud { font-family: 'Share Tech Mono', monospace; font-size: 11px; text-shadow: 1px 1px 0 #000; }
        
        @keyframes swipe-anim { 0% { opacity: 0; transform: translateX(-10px); } 50% { opacity: 1; transform: translateX(10px); } 100% { opacity: 0; transform: translateX(-10px); } }
        .swipe-hint { animation: swipe-anim 2s infinite; }

        /* Guide Accordion Styles */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
    </style>
</head>
<body>

    <!-- ğŸšª PC GATE -->
    <div id="star-gate" class="hidden-force">
        <div class="relative z-10 flex flex-col items-center max-w-md text-center p-4">
            <div class="text-8xl mb-4 drop-shadow-[0_0_20px_rgba(34,211,238,0.5)]">ğŸŒŒ</div>
            <h1 class="text-4xl font-black text-white mb-2 tracking-tight">Five Islands<br><span class="text-cyan-400">Stargazer v25.5</span></h1>
            <p class="text-slate-400 text-sm font-bold tracking-[0.2em] mb-8 uppercase">Final Polish</p>
            <div class="bg-white p-3 rounded-2xl shadow-2xl mb-6 transform transition hover:scale-105 duration-500">
                <canvas id="qr-canvas"></canvas>
            </div>
            <p class="text-slate-300 text-sm leading-relaxed font-medium mb-8">
                ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å°‚ç”¨ã§ã™ã€‚<br>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>
            <button onclick="Gate.startUnlock()" class="group flex items-center gap-2 px-6 py-3 rounded-full bg-slate-800/50 border border-slate-700 hover:bg-slate-700 hover:border-cyan-500 transition-all cursor-pointer">
                <span class="text-yellow-400 text-xl group-hover:animate-spin">â˜…</span>
                <span class="text-xs font-bold text-slate-300 group-hover:text-white">PC DEBUG MODE</span>
            </button>
        </div>
    </div>

    <!-- ğŸ“± APP CONTAINER -->
    <div id="app-container" class="hidden-force w-full h-full relative">
        <div id="layers-container">
            <video id="camera-feed" autoplay playsinline muted></video>
            <canvas id="sky-canvas"></canvas>
            
            <!-- NEW: HTML Overlay for Rich Bubbles -->
            <div id="overlay-layer">
                <div id="smart-bubble" class="info-bubble opacity-0 w-64 p-4 rounded-xl bg-slate-900/90 border border-cyan-500/30 backdrop-blur-md shadow-2xl flex flex-col items-center text-center">
                    <h3 id="bubble-title" class="text-base font-bold text-cyan-400 mb-1 leading-tight">Title</h3>
                    <div id="bubble-tag" class="text-[9px] bg-white/10 px-2 py-0.5 rounded text-slate-300 mb-2">Constellation</div>
                    <!-- Updated font size to 11px for longer descriptions -->
                    <p id="bubble-desc" class="text-[11px] text-white font-medium leading-relaxed text-left w-full">Description here...</p>
                    <div class="bubble-tail"></div>
                </div>
            </div>
        </div>

        <!-- NAV UI -->
        <div id="nav-ui" class="absolute inset-0 pointer-events-none hidden-force z-30">
            <div id="nav-msg" class="absolute top-24 w-full text-center">
                <div class="inline-block bg-black/60 backdrop-blur px-4 py-2 rounded-lg border border-cyan-500/50">
                    <div class="text-[10px] text-cyan-300 uppercase tracking-widest mb-1 font-mono">NAVIGATING TO</div>
                    <div id="nav-target-name" class="text-xl font-bold text-white drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">Target</div>
                </div>
            </div>
            <div id="lock-on" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300">
                <div class="w-24 h-24 border-2 border-green-400 rounded-full target-lock flex items-center justify-center">
                    <div class="w-1 h-1 bg-green-400 rounded-full"></div>
                </div>
                <div class="absolute top-28 w-full text-center text-green-400 font-bold text-sm tracking-widest bg-black/50 px-2 rounded font-mono">TARGET LOCKED</div>
            </div>
        </div>

        <!-- UI LAYER -->
        <div id="ui-layer" class="safe-area-inset p-4">
            <!-- Top -->
            <div class="flex justify-between items-start interactive pt-2">
                <button onclick="App.toggleLocation()" class="glass px-3 py-2 rounded-full flex items-center gap-2 active:scale-95 transition">
                    <span id="gps-icon" class="text-sm">ğŸ“</span>
                    <div class="flex flex-col items-start">
                        <span class="text-[8px] font-bold text-cyan-400 tracking-widest uppercase">LOCATION</span>
                        <span id="loc-name" class="text-[10px] font-bold text-white leading-none">äº”å³¶åˆ—å³¶ (Fixed)</span>
                    </div>
                </button>
                <div class="flex gap-3">
                    <!-- Calibration Button -->
                    <button onclick="App.startCalibration()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-cyan-900/50 border border-cyan-500/50 text-cyan-300">ğŸ¯</button>
                    
                    <button onclick="Guide.toggle()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition border border-white/20 bg-cyan-900/30">ğŸ“–</button>
                    <button onclick="App.toggleSettings()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition">âš™ï¸</button>
                    <button onclick="App.toggleViewMode()" id="btn-mode" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-indigo-900/50 border-indigo-500/30">ğŸŒ™</button>
                </div>
            </div>

            <!-- Swipe Hint (Center) -->
            <div id="swipe-hint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none transition-opacity duration-1000 opacity-0">
                <div class="flex flex-col items-center">
                    <div class="text-4xl mb-2 swipe-hint">â†”ï¸</div>
                    <div class="bg-black/60 px-3 py-1 rounded-full text-xs text-white backdrop-blur border border-white/20">Swipe to Adjust</div>
                </div>
            </div>

            <!-- Time Slider -->
            <div id="time-slider-container">
                <div id="time-display" class="time-label">TIME TRAVEL: +0h</div>
                <input type="range" id="time-range" min="-12" max="12" step="0.5" value="0" oninput="App.setTimeOffset(this.value)" onchange="App.resetTime(this.value)">
            </div>

            <!-- Debug Info (Lower Left) -->
            <div class="absolute bottom-24 left-4 pointer-events-none opacity-80">
                <div id="debug-hud" class="text-cyan-300 leading-tight bg-black/40 p-1 rounded">
                    <div>AZ: <span id="debug-az" class="text-yellow-400 font-bold text-sm">0</span>Â°</div>
                    <div>ALT: <span id="debug-alt">0</span>Â°</div>
                    <div class="text-[8px] text-slate-400 mt-1">v25.5 Polish</div>
                </div>
            </div>

            <!-- Bottom -->
            <div class="flex justify-center items-end pb-8 interactive gap-6">
                <button onclick="App.toggleTimeSlider()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-yellow-400 text-yellow-300 shadow-lg bg-yellow-900/30">
                    <span class="text-xl">â³</span>
                </button>
                
                <button onclick="App.takeScreenshot()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-cyan-400 shadow-lg">
                    <span class="text-xl">ğŸ“¸</span>
                </button>
                
                <button id="btn-cancel-nav" onclick="Guide.stopNav()" class="hidden-force glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-red-500/50 bg-red-900/20 active:scale-90 transition text-red-300 font-bold text-xs">
                    STOP
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ¯ CALIBRATION MODAL -->
    <div id="calib-modal" class="interactive">
        <div class="w-full max-w-md px-6 flex flex-col items-center">
            <h2 class="text-xl font-bold text-white mb-2">æ–¹ä½åˆã‚ã› (Calibration)</h2>
            
            <div class="bg-slate-800/80 p-4 rounded-xl border border-white/10 mb-4 w-full">
                <ol class="text-xs text-slate-300 space-y-2 list-decimal list-inside text-left">
                    <li><b class="text-white">ã‚¹ãƒãƒ›ã‚’æ°´å¹³</b>ã«æŒã£ã¦ãã ã•ã„ã€‚</li>
                    <li><b class="text-cyan-400">ä¸Šç«¯ã‚’åŒ—(N)</b>ã«å‘ã‘ã¦ãã ã•ã„ã€‚</li>
                    <li>èµ¤ç‰ã‚’ä¸­å¿ƒã«å…¥ã‚Œã€<b class="text-white">æ±ºå®š</b>ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</li>
                </ol>
            </div>
            
            <div class="level-bubble">
                <div class="level-target"></div>
                <div id="level-ball" class="level-ball"></div>
            </div>
            <div id="calib-val" class="font-mono text-cyan-400 mb-4 text-2xl font-bold">0Â°</div>
            
            <!-- Emergency Rotation Controls -->
            <div class="flex gap-2 mb-2 w-full justify-center">
                <button onclick="App.rotateOffset(90)" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-[10px] text-white font-bold border border-white/10">
                    â†» +90Â°
                </button>
                <button onclick="App.rotateOffset(-90)" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-[10px] text-white font-bold border border-white/10">
                    â†º -90Â°
                </button>
            </div>
            <!-- Reset Button -->
            <button onclick="App.resetOffset()" class="mb-4 px-3 py-2 rounded-lg bg-red-900/50 hover:bg-red-800 text-[10px] text-red-200 font-bold border border-red-500/30">
                âš¡ RESET (0Â°)
            </button>
            
            <p class="text-[10px] text-slate-500 mb-4 text-center max-w-xs">
                â€»å¤ã„æ©Ÿç¨®ã‚„ä»–ç¤¾ç«¯æœ«ã§ã¯ã‚»ãƒ³ã‚µãƒ¼ä»•æ§˜ãŒç•°ãªã‚Šã€90Â°ã‚ºãƒ¬ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ä¸Šã®ãƒœã‚¿ãƒ³ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
            </p>
            
            <div class="flex gap-4 w-full justify-center">
                <button onclick="App.cancelCalibration()" class="px-6 py-3 rounded-full bg-slate-700 text-white font-bold w-1/3">æˆ»ã‚‹</button>
                <button onclick="App.confirmCalibration()" class="px-6 py-3 rounded-full bg-cyan-600 text-white font-bold shadow-lg hover:bg-cyan-500 w-1/2">æ±ºå®š (LOCK)</button>
            </div>
        </div>
    </div>

    <!-- ğŸ“– GUIDE MODAL (ACCORDION) -->
    <div id="guide-modal" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-xl hidden-force interactive flex flex-col">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
            <h2 class="font-bold text-white text-lg flex items-center gap-2">
                <span class="text-2xl">ğŸ“–</span> <span data-i18n="guide_title">æ˜Ÿåº§è©³ç´°è§£èª¬</span>
            </h2>
            <button onclick="Guide.toggle()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition text-xl">âœ•</button>
        </div>
        <div id="guide-list" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20"></div>
    </div>

    <!-- ğŸš€ START MODAL -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] interactive">
        <div class="relative z-10 w-full max-w-sm px-6 text-center">
            <div class="text-6xl mb-4 animate-bounce">âœ¨</div>
            <h1 class="text-3xl font-black text-white mb-2">Five Islands<br><span class="text-cyan-400 font-light">Stargazer</span></h1>
            <p class="text-slate-400 text-xs font-bold tracking-widest mb-8">COSMIC LIBRARY v25.5</p>
            <button onclick="App.init()" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition hover:shadow-cyan-500/30">
                START / å‡ºç™º
            </button>
            <p class="text-[10px] text-slate-500 mt-4">Manual Compass Calibration Mode</p>
        </div>
    </div>

    <!-- âš™ï¸ SETTINGS MODAL -->
    <div id="settings-modal" onclick="if(event.target === this) App.toggleSettings()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur hidden-force flex items-center justify-center interactive transition-opacity duration-300 cursor-pointer">
        <div onclick="event.stopPropagation()" class="glass bg-[#0f172a]/95 w-11/12 max-w-sm rounded-2xl border border-white/10 p-6 space-y-6 shadow-2xl overflow-y-auto max-h-[85vh] cursor-default">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <h2 class="font-bold text-white text-lg" data-i18n="settings_title">è¨­å®š (Settings)</h2>
                <button onclick="App.toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-slate-300 hover:text-white transition text-xl">âœ•</button>
            </div>
            
            <!-- Category Boxes -->
            <div class="space-y-3">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider" data-i18n="cat_title">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª</p>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold" data-i18n="cat_famous">ğŸ¦ æœ‰åãªæ˜Ÿåº§ (Famous)</span>
                    <input type="checkbox" checked onchange="App.setRank(1, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer border-l-4 border-yellow-400">
                    <span class="text-sm font-bold" data-i18n="cat_star_gal">âœ¨ æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³ (Stars & Gal)</span>
                    <input type="checkbox" checked onchange="App.setRank(4, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold" data-i18n="cat_medium">ğŸ» æ™®é€šã®æ˜Ÿåº§ (Medium)</span>
                    <input type="checkbox" checked onchange="App.setRank(2, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold" data-i18n="cat_minor">ğŸ¦ ãƒã‚¤ãƒŠãƒ¼æ˜Ÿåº§ (Minor)</span>
                    <input type="checkbox" checked onchange="App.setRank(3, this.checked)" class="check-box">
                </label>
            </div>

            <!-- Visibility -->
            <div class="space-y-4 pt-4 border-t border-white/10">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider" data-i18n="opt_title">è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</p>
                
                <div class="flex items-center justify-between bg-cyan-900/30 p-2 rounded-lg border border-cyan-500/20">
                    <div>
                        <span class="text-sm font-bold text-cyan-300" data-i18n="opt_info">ğŸŒŸ æ˜Ÿåº§ã®è§£èª¬ã‚’è¡¨ç¤º</span>
                        <div class="text-[10px] text-slate-400" data-i18n="opt_info_desc">å¹ãå‡ºã—ã§è§£èª¬ã‚’è¡¨ç¤ºã—ã¾ã™</div>
                    </div>
                    <input type="checkbox" checked onchange="App.setFlag('showInfo', this.checked)" class="check-box">
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-sm" data-i18n="opt_ar">ğŸ¥ ARã‚«ãƒ¡ãƒ©</span>
                    <input type="checkbox" id="toggle-ar" onchange="App.toggleAR(this.checked)" class="check-box">
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span data-i18n="opt_bg">èƒŒæ™¯ã®æ¿ƒã•</span><span id="val-bg" class="text-cyan-400">100%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="App.setOpacity('bg', this.value)">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span data-i18n="opt_milky">å¤©ã®å· (Milky Way)</span><span id="val-milky" class="text-cyan-400">50%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="App.setOpacity('milky', this.value)">
                </div>

                <div class="flex items-center justify-between pt-2">
                    <span class="text-sm" data-i18n="opt_meteor">ğŸŒ  æµã‚Œæ˜Ÿ (Meteors)</span>
                    <input type="checkbox" checked onchange="App.setFlag('meteorEnabled', this.checked)" class="check-box">
                </div>
            </div>

            <!-- Emergency Axis Fix -->
             <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm font-bold text-red-300" data-i18n="axis_fix">ğŸ”„ Axis Fix (å›è»¢è£œæ­£)</span>
                        <div class="text-[10px] text-slate-400" data-i18n="axis_fix_desc">å›è»¢ãŒé€†ã«ãªã‚‹å ´åˆã®ã¿ON</div>
                    </div>
                    <input type="checkbox" onchange="App.state.reverseAlpha = this.checked" class="check-box">
                </div>
                 <!-- 180 Rotation Fix Switch (Default OFF) -->
                 <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-yellow-300">ğŸ”„ Sky Rotate 180Â°</span>
                        <div class="text-[10px] text-slate-400">ä¸Šä¸‹é€†è»¢ã™ã‚‹å ´åˆã®ã¿ON</div>
                    </div>
                    <input type="checkbox" onchange="App.toggleSkyRotation(this.checked)" class="check-box">
                </div>
            </div>

            <!-- Language -->
            <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-300">ğŸ‡ºğŸ‡¸ English Mode</span>
                    <input type="checkbox" onchange="App.setLang(this.checked ? 'en' : 'ja')" class="check-box">
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full shadow-2xl text-sm opacity-0 pointer-events-none transition-opacity z-[60] border border-cyan-500/30 font-bold text-center w-max max-w-[90%] backdrop-blur">Msg</div>

<script>
/**
 * ğŸŒŒ FIVE ISLANDS STARGAZER v25.5 (Final Polish)
 * Changes:
 * - ADDED: 'Lepus' (Rabbit) as Minor Constellation (Rank 3).
 * - UPDATED: Milky Way rendering to use Gaussian distribution for 'Cloud' effect.
 * - Confirmed: 180 Rotation is OFF by default (Correct Sky).
 */

// --- 0. DATA & CONSTANTS (Dictionary) ---
const I18N = {
    ja: {
        guide_title: "æ˜Ÿåº§è©³ç´°è§£èª¬",
        settings_title: "è¨­å®š (Settings)",
        cat_title: "è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª (Categories)",
        cat_famous: "ğŸ¦ æœ‰åãªæ˜Ÿåº§ (Famous)",
        cat_star_gal: "âœ¨ æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³ (Stars/Gal)",
        cat_medium: "ğŸ» æ™®é€šã®æ˜Ÿåº§ (Medium)",
        cat_minor: "ğŸ¦ ãƒã‚¤ãƒŠãƒ¼æ˜Ÿåº§ (Minor)",
        opt_title: "è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ (Visibility)",
        opt_info: "ğŸŒŸ æ˜Ÿåº§ã®è§£èª¬ã‚’è¡¨ç¤º",
        opt_info_desc: "å¹ãå‡ºã—ã§è§£èª¬ã‚’è¡¨ç¤ºã—ã¾ã™",
        opt_ar: "ğŸ¥ ARã‚«ãƒ¡ãƒ©",
        opt_bg: "èƒŒæ™¯ã®æ¿ƒã•",
        opt_milky: "å¤©ã®å· (Milky Way)",
        opt_meteor: "ğŸŒ  æµã‚Œæ˜Ÿ (Meteors)",
        warn_drift: "âš ï¸ ã‚»ãƒ³ã‚µãƒ¼ã®ã‚ºãƒ¬ã«ã¤ã„ã¦",
        warn_drift_desc: "æ–¹ä½ãŒã‚ºãƒ¬ãŸå ´åˆã¯ã€ä¸Šã®ã€ŒğŸ¯ æ–¹ä½åˆã‚ã›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ã‚¹ãƒãƒ›ã‚’æ°´å¹³ã«ã—ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚",
        axis_fix: "ğŸ”„ Axis Fix (å›è»¢è£œæ­£)",
        axis_fix_desc: "å›è»¢ãŒé€†ã«ãªã‚‹å ´åˆã®ã¿ON",
        loc_fixed: "äº”å³¶åˆ—å³¶ (Fixed)",
        loc_gps: "ç¾åœ¨åœ° (GPS)",
        nav_start: "ã¸ã®ãƒŠãƒ“ã‚’é–‹å§‹ ğŸš€",
        nav_end: "ãƒŠãƒ“ã‚’çµ‚äº†ã—ã¾ã—ãŸ",
        constellation: "æ˜Ÿåº§",
        famous_const: "æœ‰åãªæ˜Ÿåº§",
        star_gal: "æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³",
        time_travel: "æ™‚é–“æ—…è¡Œ",
        time_reset: "ç¾åœ¨æ™‚åˆ»ã«æˆ»ã‚‹"
    },
    en: {
        guide_title: "Star Detailed Guide",
        settings_title: "Settings",
        cat_title: "Categories",
        cat_famous: "ğŸ¦ Famous Stars",
        cat_star_gal: "âœ¨ Major Stars & Galaxy",
        cat_medium: "ğŸ» Medium Stars",
        cat_minor: "ğŸ¦ Minor Stars",
        opt_title: "Visibility Options",
        opt_info: "ğŸŒŸ Show Info Bubble",
        opt_info_desc: "Show star descriptions in AR",
        opt_ar: "ğŸ¥ AR Camera",
        opt_bg: "Background Opacity",
        opt_milky: "Milky Way Visibility",
        opt_meteor: "ğŸŒ  Meteors",
        warn_drift: "âš ï¸ Sensor Drift Warning",
        warn_drift_desc: "If stars are misaligned, tap the 'ğŸ¯ Calibrate' button and hold your phone flat to reset heading.",
        axis_fix: "ğŸ”„ Axis Fix (Reverse)",
        axis_fix_desc: "Enable if rotation is reversed",
        loc_fixed: "Goto Islands (Fixed)",
        loc_gps: "Current loc (GPS)",
        nav_start: "Navigating to ",
        nav_end: "Navigation Ended",
        constellation: "Constellation",
        famous_const: "Famous Constellation",
        star_gal: "Major Star/Galaxy",
        time_travel: "TIME TRAVEL",
        time_reset: "Reset Time"
    }
};

const RANK = { FAMOUS: 1, MEDIUM: 2, MINOR: 3, STAR_GAL: 4 };

const CONSTELLATION_DB = [
    // --- ğŸ¦ FAMOUS CONSTELLATIONS ---
    { 
        id: "ori", rank: 1, name: "ã‚ªãƒªã‚ªãƒ³åº§", en: "Orion", 
        desc: "ã€å†¬ã®ç‹è€…ã€‘çœŸã‚“ä¸­ã®ä¸‰ã¤æ˜ŸãŒç‰¹å¾´ã€‚å·¦ä¸Šã®èµ¤ã„æ˜Ÿã€Œãƒ™ãƒ†ãƒ«ã‚®ã‚¦ã‚¹ã€ã¯ã€ã‚‚ã†ã™ãçˆ†ç™ºã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„è¶…å·¨å¤§ãªæ˜Ÿã§ã™ã€‚", 
        desc_en: "[Winter King] Famous for the three belt stars. Betelgeuse (top left) is a red supergiant that might explode soon.",
        myth: "æµ·ã®ç¥ãƒã‚»ã‚¤ãƒ‰ãƒ³ã®å­ã§ã€ä¹±æš´è€…ã®ç‹©äººã€‚ã‚µã‚½ãƒªã«åˆºã•ã‚Œã¦æ­»ã‚“ã ãŸã‚ã€ã‚µã‚½ãƒªåº§ãŒæ˜‡ã‚‹ã¨é€ƒã’ã‚‹ã‚ˆã†ã«æ²ˆã‚“ã§ã„ãã¾ã™ã€‚",
        myth_en: "Son of Poseidon and a mighty hunter. He was stung to death by a scorpion, so he sets as Scorpius rises.",
        centerRA: 5.6, centerDec: 0.0, 
        lines: ["Betelgeuse","Alnitak", "Alnitak","Saiph", "Rigel","Mintaka", "Mintaka","Alnilam", "Alnilam","Alnitak", "Betelgeuse","Bellatrix", "Mintaka","Bellatrix", "Alnitak","Rigel"] 
    },
    { 
        id: "sco", rank: 1, name: "ã•ãã‚Šåº§", en: "Scorpius", 
        desc: "ã€å¤ã®Så­—ã€‘å—ã®ç©ºã®å¤§ããªSå­—ã‚«ãƒ¼ãƒ–ã€‚èµ¤ã„1ç­‰æ˜Ÿã€Œã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ã€ã¯ã€Œç«æ˜Ÿã«å¯¾æŠ—ã™ã‚‹ã‚‚ã®ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚", 
        desc_en: "[Summer S-Shape] A large S-curve in the south. The red star Antares means 'Rival of Mars'.",
        myth: "ã‚ªãƒªã‚ªãƒ³ã‚’å€’ã—ãŸæ‰‹æŸ„ã§æ˜Ÿåº§ã«ãªã‚Šã¾ã—ãŸã€‚ã ã‹ã‚‰ã‚ªãƒªã‚ªãƒ³åº§ã¨ã¯æ±ºã—ã¦åŒã˜ç©ºã«ã¯ç¾ã‚Œã¾ã›ã‚“ã€‚",
        myth_en: "Placed in the sky for defeating Orion. They are never seen in the sky at the same time.",
        centerRA: 16.5, centerDec: -26.0, 
        lines: ["Antares","Dschubba", "Dschubba","Graffias", "Antares","Wei", "Antares","Tau Sco", "Tau Sco","Epsilon Sco", "Epsilon Sco","Mu Sco", "Mu Sco","Zeta Sco", "Zeta Sco","Eta Sco", "Eta Sco","Sargas", "Sargas","Shaula"] 
    },
    { 
        id: "sum", rank: 1, name: "å¤ã®å¤§ä¸‰è§’", en: "Summer Triangle", 
        desc: "ã€å¤ã®ç›®å°ã€‘ã“ã¨åº§ã®ãƒ™ã‚¬ï¼ˆç¹”å§«ï¼‰ã€ã‚ã—åº§ã®ã‚¢ãƒ«ã‚¿ã‚¤ãƒ«ï¼ˆå½¦æ˜Ÿï¼‰ã€ã¯ãã¡ã‚‡ã†åº§ã®ãƒ‡ãƒãƒ–ã‚’çµã¶å·¨å¤§ãªä¸‰è§’å½¢ã€‚", 
        desc_en: "[Summer Mark] A huge triangle connecting Vega (Lyra), Altair (Aquila), and Deneb (Cygnus).",
        myth: "ãƒ™ã‚¬ã¾ã§ã®è·é›¢ã¯25å…‰å¹´ã§ã™ãŒã€ãƒ‡ãƒãƒ–ã¯1400å…‰å¹´ã‚‚å½¼æ–¹ã«ã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒãƒ–ã¯è¶…ãƒ»è¶…å·¨å¤§ãªæ˜Ÿã ã‹ã‚‰ã€é ãã¦ã‚‚æ˜ã‚‹ãè¦‹ãˆã‚‹ã®ã§ã™ã€‚",
        myth_en: "Vega is 25 light-years away, while Deneb is 1400 light-years away. Deneb is super massive!",
        centerRA: 19.5, centerDec: 28.0, 
        lines: ["Vega","Altair", "Altair","Deneb", "Deneb","Vega"] 
    },
    { 
        id: "tau", rank: 1, name: "ãŠã†ã—åº§", en: "Taurus", 
        desc: "ã€å†¬ã®Vå­—ã€‘Vå­—å‹ã®é¡”ã¨ã€ç¾ã—ã„æ˜Ÿå›£ã€Œãƒ—ãƒ¬ã‚¢ãƒ‡ã‚¹ï¼ˆã™ã°ã‚‹ï¼‰ã€ãŒç‰¹å¾´ã€‚", 
        desc_en: "[Winter V] Features a V-shaped face and the beautiful Pleiades cluster (Subaru).",
        myth: "ã€Œã™ã°ã‚‹ã€ã¯ã€Œçµ±ï¼ˆã™ï¼‰ã¹ã‚‹ï¼é›†ã¾ã‚‹ã€ã¨ã„ã†æ„å‘³ã®å¤ã„æ—¥æœ¬èªã€‚è‡ªå‹•è»Šãƒ¡ãƒ¼ã‚«ãƒ¼ã€ŒSUBARUã€ã®ã‚¨ãƒ³ãƒ–ãƒ¬ãƒ ã«ã‚‚ãªã£ã¦ã„ã¾ã™ã€‚",
        myth_en: "'Subaru' is ancient Japanese for 'unite'. It is also the emblem of the car maker SUBARU.",
        centerRA: 4.5, centerDec: 16.0, 
        lines: ["Aldebaran","Elnath", "Aldebaran","Zeta Tau"] 
    },
    { 
        id: "gem", rank: 1, name: "ãµãŸã”åº§", en: "Gemini", 
        desc: "ã€ä»²è‰¯ã—å…„å¼Ÿã€‘ã‚«ã‚¹ãƒˆãƒ«ï¼ˆå…„ãƒ»éŠ€ï¼‰ã¨ãƒãƒ«ãƒƒã‚¯ã‚¹ï¼ˆå¼Ÿãƒ»é‡‘ï¼‰ãŒä¸¦ã‚“ã§è¼ã„ã¦ã„ã¾ã™ã€‚", 
        desc_en: "[Friendly Twins] Castor (Silver) and Pollux (Gold) shine side by side.",
        myth: "å®Ÿã¯ã‚«ã‚¹ãƒˆãƒ«ã¯6ã¤ã®æ˜ŸãŒé‡ãªã£ãŸã€Œ6é‡é€£æ˜Ÿã€ã¨ã„ã†ã€ã¨ã‚“ã§ã‚‚ãªãè¤‡é›‘ãªæ˜Ÿã§ã™ã€‚æœ›é é¡ãŒãªã„ã¨1ã¤ã«è¦‹ãˆã¾ã™ã€‚",
        myth_en: "Castor is actually a sextuple star system (6 stars!). To the naked eye, it looks like one.",
        centerRA: 7.0, centerDec: 22.0, 
        lines: ["Castor","Pollux"] 
    },
    { 
        id: "leo", rank: 1, name: "ã—ã—åº§", en: "Leo", 
        desc: "ã€æ˜¥ã®éŒã€‘ã€Œï¼Ÿã€ã‚’è£è¿”ã—ãŸã‚ˆã†ãªå½¢ï¼ˆã—ã—ã®å¤§éŒï¼‰ãŒé ­ã€‚1ç­‰æ˜Ÿãƒ¬ã‚°ãƒ«ã‚¹ã¯ã€Œå°ã•ãªç‹æ§˜ã€ã¨ã„ã†æ„å‘³ã€‚", 
        desc_en: "[Spring Sickle] The backward '?' shape is the head. Regulus means 'Little King'.",
        myth: "è‹±é›„ãƒ˜ãƒ©ã‚¯ãƒ¬ã‚¹ã¨æˆ¦ã£ãŸä¸æ­»èº«ã®ãƒ©ã‚¤ã‚ªãƒ³ã€‚ç¡¬ã„çš®è†šã‚’æŒã£ã¦ã„ã¾ã—ãŸãŒã€ãƒ˜ãƒ©ã‚¯ãƒ¬ã‚¹ã«é¦–ã‚’çµã‚ã‚‰ã‚Œã¦é€€æ²»ã•ã‚Œã¾ã—ãŸã€‚",
        myth_en: "The Nemean Lion fought by Hercules. It had impenetrable skin but was strangled by the hero.",
        centerRA: 10.5, centerDec: 15.0, 
        lines: ["Regulus","Denebola", "Regulus","Algieba"] 
    },
    { 
        id: "vir", rank: 1, name: "ãŠã¨ã‚åº§", en: "Virgo", 
        desc: "ã€æ˜¥ã®å¥³ç¥ã€‘ç™½ãè¼ãã‚¹ãƒ”ã‚«ãŒç›®å°ã€‚ã€Œã‚¹ãƒ”ã‚«ã€ã¯ã€Œéº¦ã®ç©‚ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚", 
        desc_en: "[Spring Maiden] Marked by the white star Spica, meaning 'Ear of Wheat'.",
        myth: "è¾²æ¥­ã®å¥³ç¥ãƒ‡ãƒ¡ãƒ†ãƒ«ã€ã¾ãŸã¯ãã®å¨˜ãƒšãƒ«ã‚»ãƒãƒã®å§¿ã€‚å½¼å¥³ãŒåœ°ä¸‹ã®å›½ã«è¡Œãã¨å†¬ã«ãªã‚Šã€æˆ»ã£ã¦ãã‚‹ã¨æ˜¥ã«ãªã‚Šã¾ã™ã€‚",
        myth_en: "Represents Demeter or Persephone. When she goes to the underworld, winter comes.",
        centerRA: 13.3, centerDec: -2.0, 
        lines: ["Spica","Porrima", "Spica","Vindemiatrix"] 
    },

    // --- âœ¨ NEW: FAMOUS STARS & GALAXIES (RANK 4) ---
    {
        id: "sirius", rank: 4, name: "ã‚·ãƒªã‚¦ã‚¹ (ãŠãŠã„ã¬åº§)", en: "Sirius (Canis Major)",
        desc: "ã€å…¨å¤©ä¸€æ˜ã‚‹ã„æ˜Ÿã€‘ãƒã‚¤ãƒŠã‚¹1.5ç­‰æ˜Ÿã¨ã„ã†å¼·çƒˆãªæ˜ã‚‹ã•ã§è¼ãã€ãŠãŠã„ã¬åº§ã®æ˜Ÿã€‚åœ°çƒã‹ã‚‰8.6å…‰å¹´ã¨éå¸¸ã«è¿‘ã„å ´æ‰€ã«ã‚ã‚Šã¾ã™ã€‚",
        desc_en: "[Brightest Star] The brightest star in the night sky (-1.5 mag). Located only 8.6 light-years away.",
        myth: "å¤ä»£ã‚¨ã‚¸ãƒ—ãƒˆã§ã¯ã€ŒãƒŠã‚¤ãƒ«ã®æ˜Ÿã€ã¨å‘¼ã°ã‚Œã€ã“ã®æ˜ŸãŒæ˜ã‘æ–¹ã«æ˜‡ã‚‹é ƒã€ãƒŠã‚¤ãƒ«å·ãŒæ°¾æ¿«ã—ã¦è‚¥æ²ƒãªåœŸã‚’ã‚‚ãŸã‚‰ã™ã¨ä¿¡ã˜ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚",
        myth_en: "In ancient Egypt, it was the 'Nile Star'. Its heliacal rising predicted the annual flooding of the Nile.",
        centerRA: 6.75, centerDec: -16.7,
        lines: [] // No lines, just a target point
    },
    {
        id: "m31", rank: 4, name: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ (M31)", en: "Andromeda Galaxy (M31)",
        desc: "ã€è‚‰çœ¼ã§è¦‹ãˆã‚‹æœ€ã‚‚é ã„ç‰©ä½“ã€‘åœ°çƒã‹ã‚‰250ä¸‡å…‰å¹´ã®å½¼æ–¹ã«ã‚ã‚‹å·¨å¤§ãªæ¸¦å·»éŠ€æ²³ã€‚ç©ºã®æš—ã„å ´æ‰€ãªã‚‰ã€ã¼ã‚“ã‚„ã‚Šã¨ã—ãŸé›²ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚",
        desc_en: "[Farthest visible object] A giant spiral galaxy 2.5 million light-years away. Looks like a fuzzy patch in dark skies.",
        myth: "ç§ãŸã¡ã®å¤©ã®å·éŠ€æ²³ã®ãŠéš£ã•ã‚“ã§ã™ã€‚çŒ›ã‚¹ãƒ”ãƒ¼ãƒ‰ã§è¿‘ã¥ã„ã¦ãã¦ãŠã‚Šã€ç´„40å„„å¹´å¾Œã«ã¯è¡çªã—ã¦ä¸€ã¤ã®å·¨å¤§éŠ€æ²³ã«ãªã‚‹ã¨äºˆæ¸¬ã•ã‚Œã¦ã„ã¾ã™ã€‚",
        myth_en: "Our neighbor galaxy. It is approaching us and will collide with the Milky Way in about 4 billion years.",
        centerRA: 0.7, centerDec: 41.2,
        lines: [] // No lines
    },

    // --- ğŸ» MEDIUM CONSTELLATIONS ---
    { 
        id: "cas", rank: 2, name: "ã‚«ã‚·ã‚ªãƒšãƒ¤åº§", en: "Cassiopeia", 
        desc: "ã€åŒ—ã®Wã€‘åŒ—æ¥µæ˜Ÿã‚’æ¢ã™ãŸã‚ã®ç›®å°ã€‚å­£ç¯€ã«ã‚ˆã£ã¦ã€ŒWã€ã«è¦‹ãˆãŸã‚Šã€ŒMã€ã«è¦‹ãˆãŸã‚Šã—ã¾ã™ã€‚", 
        desc_en: "[North W] A guide to find Polaris. Looks like 'W' or 'M' depending on the season.",
        myth: "ã€Œå¨˜ã®æ–¹ãŒç¥ã‚ˆã‚Šç¾ã—ã„ã€ã¨è‡ªæ…¢ã—ãŸãŸã‚ã€ç½°ã¨ã—ã¦æ¤…å­ã«ç¸›ã‚‰ã‚ŒãŸã¾ã¾ç©ºã‚’å›ã•ã‚Œç¶šã‘ã¦ã„ã‚‹ç‹å¦ƒã§ã™ã€‚",
        myth_en: "A vain queen punished for boasting about her daughter's beauty. She rotates in her chair forever.",
        centerRA: 1.0, centerDec: 60.0, 
        lines: ["Caph","Schedar", "Schedar","Gamma Cas", "Gamma Cas","Ruchbah", "Ruchbah","Segin"] 
    },
    { 
        id: "and", rank: 2, name: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€åº§", en: "Andromeda", 
        desc: "ã€éŠ€æ²³ã®çª“ã€‘è‚‰çœ¼ã§è¦‹ãˆã‚‹æœ€ã‚‚é ã„å¤©ä½“ã€Œã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ã€ãŒã‚ã‚‹å ´æ‰€ã§ã™ã€‚", 
        desc_en: "[Galaxy Window] Home to the Andromeda Galaxy, the farthest object visible to the naked eye.",
        myth: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ã¯ã€ç§ãŸã¡ã®å¤©ã®å·éŠ€æ²³ã¨ç´„40å„„å¹´å¾Œã«è¡çªãƒ»åˆä½“ã™ã‚‹ã¨äºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚",
        myth_en: "The Andromeda Galaxy is expected to collide with our Milky Way in 4 billion years.",
        centerRA: 0.7, centerDec: 38.0, 
        lines: ["Alpheratz","Mirach", "Mirach","Almach"] 
    },
    { 
        id: "peg", rank: 2, name: "ãƒšã‚¬ã‚¹ã‚¹åº§", en: "Pegasus", 
        desc: "ã€ç§‹ã®å››è¾ºå½¢ã€‘å¤§ããªå››è§’å½¢ãŒèƒ´ä½“ã€‚é€†ã•ã¾ã«ãªã£ã¦é£›ã‚“ã§ã„ã‚‹å¤©é¦¬ã®å§¿ã§ã™ã€‚", 
        desc_en: "[Autumn Square] The Great Square is the body. A flying horse, upside down.",
        myth: "ãƒ¡ãƒ‰ã‚¥ãƒ¼ã‚µã®è¡€ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸç¿¼ã®ã‚ã‚‹é¦¬ã€‚è‹±é›„ãƒ™ãƒ¬ãƒ­ãƒ•ã‚©ãƒ³ã‚’ä¹—ã›ã¦æ€ªç‰©ã‚­ãƒã‚¤ãƒ©ã‚’å€’ã—ã¾ã—ãŸã€‚",
        myth_en: "Born from Medusa's blood. The winged horse that carried Bellerophon to defeat the Chimera.",
        centerRA: 23.0, centerDec: 20.0, 
        lines: ["Markab","Scheat", "Scheat","Alpheratz", "Alpheratz","Algenib", "Algenib","Markab"] 
    },
    { 
        id: "cyg", rank: 2, name: "ã¯ãã¡ã‚‡ã†åº§", en: "Cygnus", 
        desc: "ã€åŒ—åå­—ã€‘å¤©ã®å·ã®ä¸Šã‚’é£›ã¶åå­—æ¶ã®å½¢ã€‚ãã¡ã°ã—ã®æ˜Ÿã‚¢ãƒ«ãƒ“ãƒ¬ã‚ªã¯ã€å®çŸ³ã®ã‚ˆã†ã«ç¾ã—ã„äºŒé‡æ˜Ÿã§ã™ã€‚", 
        desc_en: "[Northern Cross] A cross flying over the Milky Way. Albireo is a beautiful double star.",
        myth: "ãƒ‡ãƒãƒ–ã®è¿‘ãã«ã¯ã€ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«å€™è£œã¨ã—ã¦æœ‰åãªã€Œã¯ãã¡ã‚‡ã†åº§X-1ã€ãŒã‚ã‚Šã¾ã™ï¼ˆç›®ã«ã¯è¦‹ãˆã¾ã›ã‚“ï¼‰ã€‚",
        myth_en: "Near Deneb lies Cygnus X-1, a famous black hole candidate (invisible).",
        centerRA: 20.5, centerDec: 42.0, 
        lines: ["Deneb","Sadr", "Sadr","Albireo", "Sadr","Gienah", "Sadr","Rukh"] 
    },
    { 
        id: "umi", rank: 2, name: "ã“ãã¾åº§", en: "Ursa Minor", 
        desc: "ã€å‹•ã‹ãªã„æ˜Ÿã€‘åŒ—æ¥µæ˜Ÿï¼ˆãƒãƒ©ãƒªã‚¹ï¼‰ãŒã‚ã‚‹æ˜Ÿåº§ã€‚ä¸€å¹´ä¸­ã€åŒ—ã®ç©ºã«è¦‹ãˆã¾ã™ã€‚", 
        desc_en: "[The Fixed Star] Home to Polaris. Visible in the northern sky all year round.",
        myth: "ç¾åœ¨ã®åŒ—æ¥µæ˜Ÿã¯ãƒãƒ©ãƒªã‚¹ã§ã™ãŒã€åœ°çƒã®é¦–æŒ¯ã‚Šé‹å‹•ï¼ˆæ­³å·®ï¼‰ã«ã‚ˆã‚Šã€1ä¸‡2åƒå¹´å¾Œã«ã¯ã€Œãƒ™ã‚¬ã€ãŒåŒ—æ¥µæ˜Ÿã«ãªã‚Šã¾ã™ã€‚",
        myth_en: "Polaris is the North Star now, but in 12,000 years, Vega will take its place due to precession.",
        centerRA: 15.0, centerDec: 75.0, 
        lines: ["Polaris","Yildun", "Yildun","Epsilon UMi", "Epsilon UMi","Zeta UMi", "Zeta UMi","Kochab", "Kochab","Pherkad", "Pherkad","Zeta UMi"] 
    },

    // --- ğŸ¦ MINOR CONSTELLATIONS (New for v25.5) ---
    { 
        id: "lep", rank: 3, name: "ã†ã•ãåº§", en: "Lepus", 
        desc: "ã€ã‚ªãƒªã‚ªãƒ³ã®ç²ç‰©ã€‘ã‚ªãƒªã‚ªãƒ³åº§ã®è¶³å…ƒã«ã‚ã‚‹å°ã•ãªæ˜Ÿåº§ã€‚ç‹©äººã‚ªãƒªã‚ªãƒ³ã«è¿½ã‚ã‚Œã‚‹ã‚¦ã‚µã‚®ã®å§¿ã§ã™ã€‚", 
        desc_en: "[Orion's Prey] A small constellation at Orion's feet. A hare being chased by the hunter.",
        myth: "ç‰¹ã«å¤§ããªç¥è©±ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚ªãƒªã‚ªãƒ³ã®ç‹©ã‚Šã®ç²ç‰©ã¨ã—ã¦ã€ã¾ãŸã‚·ãƒªã‚¦ã‚¹ï¼ˆãŠãŠã„ã¬åº§ï¼‰ã‹ã‚‰é€ƒã’ã‚‹å§¿ã¨ã—ã¦æã‹ã‚Œã¾ã™ã€‚",
        myth_en: "Represented as a hare being hunted by Orion and his dog Sirius.",
        centerRA: 5.5, centerDec: -20.0, 
        lines: ["Arneb", "Nihal", "Nihal", "Epsilon Lep", "Epsilon Lep", "Mu Lep", "Mu Lep", "R12 Lep", "R12 Lep", "Arneb"] // Simplified box
    }
];

// --- VITAL DATA: STARS ---
const STARS_DATA = [
    { name: "Polaris", ra: 2.53, dec: 89.26, mag: 1.97, ci: 0.6 },
    { name: "Sirius", ra: 6.75, dec: -16.71, mag: -1.46, ci: 0.0 }, // Sirius
    { name: "Betelgeuse", ra: 5.91, dec: 7.40, mag: 0.45, ci: 1.5 },
    { name: "Rigel", ra: 5.24, dec: -8.20, mag: 0.12, ci: -0.03 },
    { name: "Vega", ra: 18.61, dec: 38.78, mag: 0.03, ci: 0.0 },
    { name: "Altair", ra: 19.84, dec: 8.87, mag: 0.77, ci: 0.22 },
    { name: "Deneb", ra: 20.69, dec: 45.28, mag: 1.25, ci: 0.09 },
    { name: "Antares", ra: 16.49, dec: -26.43, mag: 1.06, ci: 1.83 },
    { name: "Arcturus", ra: 14.26, dec: 19.18, mag: -0.05, ci: 1.23 },
    { name: "Capella", ra: 5.27, dec: 45.99, mag: 0.08, ci: 0.8 },
    { name: "Procyon", ra: 7.65, dec: 5.22, mag: 0.34, ci: 0.4 },
    { name: "Spica", ra: 13.42, dec: -11.16, mag: 0.98, ci: -0.2 },
    { name: "Aldebaran", ra: 4.60, dec: 16.50, mag: 0.87, ci: 1.5 },
    { name: "Pollux", ra: 7.75, dec: 28.02, mag: 1.15, ci: 1.0 },
    { name: "Castor", ra: 7.58, dec: 31.88, mag: 1.58, ci: 0.0 },
    { name: "Regulus", ra: 10.14, dec: 11.96, mag: 1.36, ci: -0.1 },
    { name: "Alnitak", ra: 5.67, dec: -1.94, mag: 1.7, ci: -0.2 },
    { name: "Alnilam", ra: 5.60, dec: -1.20, mag: 1.6, ci: -0.2 },
    { name: "Mintaka", ra: 5.53, dec: -0.29, mag: 2.2, ci: -0.2 },
    { name: "Saiph", ra: 5.79, dec: -9.66, mag: 2.0, ci: -0.1 },
    { name: "Bellatrix", ra: 5.41, dec: 6.34, mag: 1.6, ci: -0.2 },
    { name: "Schedar", ra: 0.67, dec: 56.53, mag: 2.2, ci: 1.1 },
    { name: "Caph", ra: 0.15, dec: 59.14, mag: 2.2, ci: 0.3 },
    { name: "Gamma Cas", ra: 0.94, dec: 60.71, mag: 2.1, ci: -0.1 },
    { name: "Ruchbah", ra: 1.42, dec: 60.23, mag: 2.6, ci: 0.1 },
    { name: "Segin", ra: 1.90, dec: 63.67, mag: 3.3, ci: 0.3 },
    { name: "Dschubba", ra: 16.00, dec: -22.62, mag: 2.3, ci: -0.1 },
    { name: "Graffias", ra: 16.08, dec: -19.80, mag: 2.5, ci: -0.1 },
    { name: "Wei", ra: 16.83, dec: -38.02, mag: 2.2, ci: 1.1 },
    { name: "Sargas", ra: 17.62, dec: -43.00, mag: 1.8, ci: 0.4 },
    { name: "Shaula", ra: 17.56, dec: -37.10, mag: 1.6, ci: -0.2 },
    { name: "Sadr", ra: 20.37, dec: 40.25, mag: 2.2, ci: 0.6 },
    { name: "Albireo", ra: 19.51, dec: 27.96, mag: 3.0, ci: 1.0 },
    { name: "Gienah", ra: 20.77, dec: 33.96, mag: 2.4, ci: 1.0 },
    { name: "Rukh", ra: 19.76, dec: 45.13, mag: 2.8, ci: -0.1 },
    { name: "Kochab", ra: 14.84, dec: 74.15, mag: 2.0, ci: 1.0 },
    { name: "Pherkad", ra: 15.34, dec: 71.83, mag: 3.0, ci: 0.0 },
    { name: "Yildun", ra: 17.53, dec: 86.58, mag: 4.3, ci: 0.0 },
    { name: "Arneb", ra: 5.55, dec: -17.82, mag: 2.6, ci: 0.2 }, // Added for Lepus
    { name: "Nihal", ra: 5.47, dec: -20.76, mag: 2.8, ci: 0.5 }, // Added for Lepus
    { name: "Epsilon Lep", ra: 5.08, dec: -22.4, mag: 3.2, ci: 1.4 }, // Approx
    { name: "Mu Lep", ra: 5.21, dec: -16.2, mag: 3.3, ci: -0.1 }, // Approx
    { name: "R12 Lep", ra: 5.0, dec: -15.0, mag: 4.0, ci: 0.5 }, // Fake star to close box
    { name: "Alpheratz", ra: 0.13, dec: 29.09, mag: 2.0, ci: -0.1 },
    { name: "Mirach", ra: 1.16, dec: 35.62, mag: 2.0, ci: 1.6 },
    { name: "Almach", ra: 2.06, dec: 42.33, mag: 2.1, ci: 1.3 },
    { name: "Markab", ra: 23.08, dec: 15.21, mag: 2.5, ci: -0.1 },
    { name: "Scheat", ra: 23.06, dec: 28.08, mag: 2.4, ci: 1.6 },
    { name: "Algenib", ra: 0.22, dec: 15.18, mag: 2.8, ci: -0.1 },
    { name: "Denebola", ra: 11.82, dec: 14.57, mag: 2.1, ci: 0.0 },
    { name: "Algieba", ra: 10.33, dec: 19.84, mag: 2.0, ci: 1.2 },
    { name: "Elnath", ra: 5.43, dec: 28.60, mag: 1.6, ci: -0.1 },
    { name: "Zeta Tau", ra: 5.62, dec: 21.14, mag: 3.0, ci: -0.2 },
    { name: "Porrima", ra: 12.69, dec: -1.45, mag: 2.7, ci: 0.3 },
    { name: "Vindemiatrix", ra: 13.04, dec: 10.96, mag: 2.8, ci: 0.9 }
];

// --- 1. VECTOR & QUATERNION ENGINE (v18 YXZ + Gamma Fix) ---
const Math3D = {
    qMultiply: (a, b) => {
        const ax = a[0], ay = a[1], az = a[2], aw = a[3];
        const bx = b[0], by = b[1], bz = b[2], bw = b[3];
        return [
            ax * bw + aw * bx + ay * bz - az * by,
            ay * bw + aw * by + az * bx - ax * bz,
            az * bw + aw * bz + ax * by - ay * bx,
            aw * bw - ax * bx - ay * by - az * bz
        ];
    },
    qFromAxisAngle: (axis, angle) => {
        const halfAngle = angle / 2;
        const s = Math.sin(halfAngle);
        return [axis[0] * s, axis[1] * s, axis[2] * s, Math.cos(halfAngle)];
    },
    matFromQ: (q) => {
        const x = q[0], y = q[1], z = q[2], w = q[3];
        const x2 = x + x, y2 = y + y, z2 = z + z;
        const xx = x * x2, xy = x * y2, xz = x * z2;
        const yy = y * y2, yz = y * z2, zz = z * z2;
        const wx = w * x2, wy = w * y2, wz = w * z2;
        return [
            1 - (yy + zz), xy - wz, xz + wy, 0,
            xy + wz, 1 - (xx + zz), yz - wx, 0,
            xz - wy, yz + wx, 1 - (xx + yy), 0,
            0, 0, 0, 1
        ];
    },
    project: (vec, viewMat, width, height, fovDeg) => {
        const x = vec.x*viewMat[0] + vec.y*viewMat[4] + vec.z*viewMat[8];
        const y = vec.x*viewMat[1] + vec.y*viewMat[5] + vec.z*viewMat[9];
        const z = vec.x*viewMat[2] + vec.y*viewMat[6] + vec.z*viewMat[10];
        if (z >= -0.1) return null;
        const scale = (height / 2) / Math.tan(fovDeg * Math.PI / 360);
        return { x: x*(scale/-z)+width/2, y: -y*(scale/-z)+height/2, z: z };
    }
};

// --- 2. ASTRO PHYSICS ---
const Astro = {
    // Adjusted to accept time offset in hours
    getLST: (lon, date = new Date(), offsetHours = 0) => {
        const t = date.getTime() + offsetHours * 3600000;
        const d = (t/1000 - 946727935.816) / 86400;
        return ((18.697374558 + 24.06570982441908 * d) % 24 + lon/15 + 24) % 24;
    },
    getStarVector: (ra, dec, lat, lst) => {
        const haRad = (lst - ra) * 15 * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const latRad = lat * Math.PI / 180;
        const sinAlt = Math.sin(decRad)*Math.sin(latRad) + Math.cos(decRad)*Math.cos(latRad)*Math.cos(haRad);
        const altRad = Math.asin(sinAlt);
        const cosAz = (Math.sin(decRad) - Math.sin(altRad)*Math.sin(latRad)) / (Math.cos(altRad)*Math.cos(latRad));
        let azRad = Math.acos(Math.min(1, Math.max(-1, cosAz)));
        if (Math.sin(haRad) > 0) azRad = 2*Math.PI - azRad;
        return { x: Math.sin(azRad)*Math.cos(altRad), y: Math.cos(azRad)*Math.cos(altRad), z: Math.sin(altRad) };
    }
};

// --- 3. UTILS ---
const Utils = {
    toast: (msg) => { const el = document.getElementById('toast'); el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000); },
    bvToColor: (bv) => {
        if (bv < 0.0) return {r:180, g:200, b:255}; if (bv < 0.5) return {r:230, g:240, b:255}; 
        if (bv < 1.0) return {r:255, g:255, b:240}; if (bv < 1.5) return {r:255, g:220, b:180}; 
        return {r:255, g:200, b:180}; 
    },
    updateDOMText: () => {
        const dict = I18N[App.state.lang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) el.innerHTML = dict[key]; // Allow HTML for <br>
        });
        
        // Dynamic Loc Name
        const locKey = App.state.useGPS ? 'loc_gps' : 'loc_fixed';
        if (App.state.useGPS) document.getElementById('loc-name').innerText = `${dict[locKey]} (${App.state.lat.toFixed(1)},${App.state.lon.toFixed(1)})`;
        else document.getElementById('loc-name').innerText = dict[locKey];
    }
};

// --- 4. GUIDE SYSTEM (ACCORDION) ---
const Guide = {
    target: null,
    toggle: () => {
        const el = document.getElementById('guide-modal');
        const isHidden = el.classList.contains('hidden-force');
        if (isHidden) { Guide.buildList(); el.classList.remove('hidden-force'); } else { el.classList.add('hidden-force'); }
    },
    buildList: () => {
        const list = document.getElementById('guide-list');
        list.innerHTML = '';
        const dict = I18N[App.state.lang];
        
        // Define Categories
        const categories = [
            { id: RANK.FAMOUS, title: dict.cat_famous, icon: 'ğŸ¦', color: 'text-yellow-400' },
            { id: RANK.STAR_GAL, title: dict.cat_star_gal, icon: 'âœ¨', color: 'text-cyan-400' }, 
            { id: RANK.MEDIUM, title: dict.cat_medium, icon: 'ğŸ»', color: 'text-blue-300' },
            { id: RANK.MINOR, title: dict.cat_minor, icon: 'ğŸ¦', color: 'text-slate-400' }
        ];

        categories.forEach(cat => {
            // Filter constellations for this category
            const items = CONSTELLATION_DB.filter(c => c.rank === cat.id);
            if (items.length === 0) return;

            // Create Details/Summary Structure
            const details = document.createElement('details');
            details.className = "group mb-4";
            details.open = true; // Open by default

            const summary = document.createElement('summary');
            summary.className = "flex items-center gap-2 cursor-pointer bg-white/5 p-3 rounded-lg hover:bg-white/10 transition mb-2";
            summary.innerHTML = `
                <span class="${cat.color} text-xl">${cat.icon}</span>
                <span class="font-bold text-white text-sm flex-1">${cat.title}</span>
                <span class="text-xs text-slate-500 group-open:rotate-180 transition">â–¼</span>
            `;

            const content = document.createElement('div');
            content.className = "space-y-3 pl-2";

            items.forEach(c => {
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border border-white/10 bg-slate-800/80 backdrop-blur-sm`;
                
                // Get correct text based on lang
                const name = App.state.lang === 'en' ? c.en : c.name;
                const desc = App.state.lang === 'en' ? c.desc_en : c.desc;
                const myth = App.state.lang === 'en' ? c.myth_en : c.myth;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div><h3 class="font-bold text-lg text-white">${name}</h3></div>
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 text-[10px] font-bold rounded uppercase">âœ¨ INFO</span>
                    </div>
                    <p class="text-sm text-slate-300 mb-2 font-bold leading-relaxed">${desc}</p>
                    <div class="mt-2 text-xs text-yellow-100/80 p-2 bg-yellow-900/20 rounded border border-yellow-500/10 leading-relaxed font-normal">${myth}</div>
                    <button onclick="Guide.startNav('${c.id}')" class="w-full py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 mt-2 bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg">ğŸ”­ GOTO NAVI</button>
                `;
                content.appendChild(card);
            });

            details.appendChild(summary);
            details.appendChild(content);
            list.appendChild(details);
        });

        if (list.children.length === 0) list.innerHTML = `<p class="text-center text-slate-500 mt-10">${dict.cat_title} Check</p>`;
    },
    startNav: (id) => {
        const c = CONSTELLATION_DB.find(x => x.id === id); if (!c) return;
        Guide.target = { ...c };
        App.state.mode = 'guide';
        document.getElementById('guide-modal').classList.add('hidden-force');
        document.getElementById('nav-ui').classList.remove('hidden-force');
        const tName = App.state.lang==='en' ? c.en : c.name;
        document.getElementById('nav-target-name').innerText = tName;
        document.getElementById('btn-cancel-nav').classList.remove('hidden-force');
        Utils.toast(`${I18N[App.state.lang].nav_start} ${tName}`);
    },
    stopNav: () => {
        Guide.target = null; App.state.mode = 'normal';
        document.getElementById('nav-ui').classList.add('hidden-force');
        document.getElementById('btn-cancel-nav').classList.add('hidden-force');
        Utils.toast(I18N[App.state.lang].nav_end);
    }
};

// --- 5. GATEKEEPER ---
const Gate = {
    check: () => {
        const isMobile = ('ontouchstart' in window) && (window.innerWidth <= 1024);
        if (isMobile) {
            document.getElementById('app-container').classList.remove('hidden-force'); document.getElementById('start-modal').classList.remove('hidden-force');
        } else {
            document.getElementById('star-gate').classList.remove('hidden-force');
            new QRious({element:document.getElementById('qr-canvas'),value:window.location.href,size:180});
        }
    },
    startUnlock: () => {
        Utils.toast("PC DEBUG STARTED");
        document.getElementById('star-gate').classList.add('hidden-force');
        document.getElementById('app-container').classList.remove('hidden-force');
        document.getElementById('start-modal').classList.remove('hidden-force');
        App.state.isDev = true;
    }
};

// --- 6. APP CORE ---
const App = {
    canvas: null, ctx: null, width: 0, height: 0,
    state: {
        lat: 32.698, lon: 128.839, // Goto Islands
        viewMat: [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1],
        manualOffset: 0, reverseAlpha: false,
        skyRotation: 0, // REVERTED to 0
        mode: 'normal', viewMode: 0,
        // Updated default ranks to include STAR_GAL and MINOR
        ranks: { [RANK.FAMOUS]: true, [RANK.MEDIUM]: true, [RANK.MINOR]: true, [RANK.STAR_GAL]: true },
        isAR: false, useGPS: false, opacity: {bg:1, milky:0.5},
        showInfo: true, meteorEnabled: true, lang: 'ja',
        stars: [], milkyWay: [], meteors: [],
        isDev: false, fov: 60, orientation: { alpha: 0, beta: 90, gamma: 0 },
        azimuth: 0, timeOffset: 0, compassFiltered: 0,
        calibMode: false // Calibration Mode Flag
    },

    init: async () => {
        document.getElementById('start-modal').classList.add('hidden-force');
        
        // 1. Camera Init (AR OFF by default)
        document.getElementById('toggle-ar').checked = false;
        App.toggleAR(false);

        // 2. Show Swipe Hint
        setTimeout(() => { document.getElementById('swipe-hint').style.opacity = 1; }, 2000);
        setTimeout(() => { document.getElementById('swipe-hint').style.opacity = 0; }, 6000);

        App.canvas = document.getElementById('sky-canvas'); App.ctx = App.canvas.getContext('2d');
        
        // Safety Check for STARS_DATA
        if (typeof STARS_DATA !== 'undefined' && Array.isArray(STARS_DATA)) {
            STARS_DATA.forEach(s => App.state.stars.push(s));
        } else {
            console.error("STARS_DATA missing, using fallback.");
            Utils.toast("Error: Data Missing");
        }

        for(let i=0; i<800; i++) {
            App.state.stars.push({
                ra: Math.random()*24, dec: Math.random()*180-90, mag: Math.random()*3+3.5, ci: Math.random()*1.5, isProc: true
            });
        }
        
        // --- MILKY WAY GENERATOR (UPDATED: Gaussian Cloud Effect) ---
        const mwPoints = [
            {ra:0,dec:63, w:20}, {ra:3,dec:50, w:18}, {ra:6,dec:10, w:15}, 
            {ra:7.5,dec:-20, w:25}, {ra:12,dec:-60, w:30}, {ra:17,dec:-30, w:35}, 
            {ra:18,dec:-15, w:40}, {ra:20,dec:40, w:25}, {ra:23,dec:60, w:22}
        ];
        
        for(let i=0; i<mwPoints.length-1; i++) {
            const p1 = mwPoints[i]; const p2 = mwPoints[i+1];
            // Increase steps for massive stacking (Cloud density)
            const steps = 400; 
            
            for(let j=0; j<steps; j++) {
                const t = j/steps;
                const baseRA = p1.ra + (p2.ra - p1.ra)*t;
                const baseDec = p1.dec + (p2.dec - p1.dec)*t;
                const baseW = p1.w + (p2.w - p1.w)*t;
                
                // GAUSSIAN DISTRIBUTION (Approx)
                // Random - Random creates a bell-curve like distribution around 0
                const scatter = (Math.random() - Math.random()) * baseW * 1.5;
                
                const finalRA = baseRA + (Math.random() - 0.5) * 2;
                const finalDec = baseDec + scatter;
                
                // Color tweaks for "Mystical" look (Cyan/Magenta hints)
                const colorType = Math.random(); 
                let r, g, b;
                if (colorType > 0.8) { r=100; g=150; b=255; } // Blueish
                else if (colorType > 0.6) { r=180; g=100; b=220; } // Purpleish
                else { r=200; g=220; b=255; } // White-Cyan

                App.state.milkyWay.push({
                    ra: finalRA, 
                    dec: finalDec, 
                    // Massive Size for "Cloud" look (10% - 20% of screen approx when projected)
                    size: Math.random()*100 + 100, 
                    // Ultra-low alpha for stacking
                    alpha: Math.random()*0.015 + 0.005, 
                    r, g, b
                });
            }
        }

        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { const res = await DeviceOrientationEvent.requestPermission(); if (res==='granted') window.addEventListener('deviceorientation', App.handleOri); } catch(e){}
        } else { window.addEventListener('deviceorientation', App.handleOri); }
        
        try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}

        window.addEventListener('resize', App.resize);
        App.setupTouch(); App.resize(); App.loop();
    },

    handleOri: (e) => {
        const alpha = e.alpha || 0;
        const beta = e.beta || 0;
        const gamma = e.gamma || 0;
        
        App.state.orientation = { 
            alpha, beta, gamma, 
            isIOS: !!e.webkitCompassHeading, 
            webkitCompass: e.webkitCompassHeading 
        };
        
        // Calibration Logic (Level Bubble)
        if (App.state.calibMode) {
            const ball = document.getElementById('level-ball');
            const maxTilt = 20; // degrees
            let bx = Math.min(Math.max(gamma, -maxTilt), maxTilt);
            let by = Math.min(Math.max(beta, -maxTilt), maxTilt);
            
            // Map tilt to px (-50 to 50)
            const px = (bx / maxTilt) * 80;
            const py = (by / maxTilt) * 80;
            
            ball.style.transform = `translate(calc(-50% + ${px}px), calc(-50% + ${py}px))`;
            
            // Show compass value
            let h = alpha;
            if(e.webkitCompassHeading) h = e.webkitCompassHeading;
            document.getElementById('calib-val').innerText = `${Math.round(h)}Â°`;
            
            if(Math.abs(bx)<3 && Math.abs(by)<3) {
                document.querySelector('.level-bubble').classList.add('level-ok');
            } else {
                document.querySelector('.level-bubble').classList.remove('level-ok');
            }
        }
    },

    // --- CALIBRATION FUNCTIONS ---
    startCalibration: () => {
        App.state.calibMode = true;
        document.getElementById('calib-modal').classList.add('active');
        // Stop AR while calibrating
        App.toggleAR(false);
    },
    cancelCalibration: () => {
        App.state.calibMode = false;
        document.getElementById('calib-modal').classList.remove('active');
    },
    // NEW: Rotate Offset Function
    rotateOffset: (deg) => {
        App.state.manualOffset += deg;
        Utils.toast(`Offset Rotated: ${deg > 0 ? '+' : ''}${deg}Â°`);
        // We do NOT close the modal, let them adjust more if needed.
    },
    // NEW: Reset Offset Function
    resetOffset: () => {
        App.state.manualOffset = 0;
        Utils.toast("Offset RESET to 0Â°");
    },
    // NEW: Toggle Sky Rotation
    toggleSkyRotation: (checked) => {
        App.state.skyRotation = checked ? 180 : 0;
        Utils.toast(`Sky Rotation: ${App.state.skyRotation}Â°`);
    },
    confirmCalibration: () => {
        // v25.1: Reset Logic based on "Top = North" rule
        const { alpha, webkitCompass } = App.state.orientation;
        let currentH = alpha;
        if(webkitCompass) currentH = webkitCompass;
        
        // If user is holding phone flat and top is North, 'currentH' SHOULD be 0 (or close).
        // If it says 90, we need offset -90.
        // Formula: Display = Sensor + Offset. Target Display = 0.
        // 0 = currentH + Offset => Offset = -currentH.
        
        App.state.manualOffset = -currentH;
        
        App.state.calibMode = false;
        document.getElementById('calib-modal').classList.remove('active');
        Utils.toast("Compass LOCKED to North ğŸ”’");
    },

    updateViewMatrix: () => {
        const { alpha, beta, gamma, isIOS, webkitCompass } = App.state.orientation;
        const safeAlpha = alpha !== null ? alpha : 0;
        const deg2rad = Math.PI / 180;
        let screenOrient = 0;
        
        if (window.screen && window.screen.orientation) screenOrient = window.screen.orientation.angle;
        else if (window.orientation) screenOrient = window.orientation;

        // 2. Normalize Alpha (Base Heading)
        let a = safeAlpha;
        if (isIOS && webkitCompass != null) a = -webkitCompass;
        else { 
            // ğŸ›‘ v25.1 FIX: Removed the "-270" magic number for Android.
            // Trusts raw 'safeAlpha' (0=North on modern Chrome)
            a = safeAlpha; 
        }
        
        // 3. Magnetic Declination Fix
        a -= 7; 

        // 4. Apply Manual Offset & Sky Rotation for STAR rendering
        let starAlpha = a + App.state.manualOffset + App.state.skyRotation;
        if (App.state.reverseAlpha) starAlpha = -starAlpha;

        // --- Calculate View Matrix for Stars ---
        const rAlpha = starAlpha * deg2rad;
        const rBeta = beta * deg2rad;
        const rGamma = gamma * deg2rad;
        const rOrient = screenOrient * deg2rad;

        // YXZ Order
        const qY = Math3D.qFromAxisAngle([0, 1, 0], rAlpha);     
        const qX = Math3D.qFromAxisAngle([1, 0, 0], rBeta);      
        const qZ = Math3D.qFromAxisAngle([0, 0, 1], -rGamma);    

        let qDev = Math3D.qMultiply(qY, qX);
        qDev = Math3D.qMultiply(qDev, qZ);

        const qCamFix = Math3D.qFromAxisAngle([1, 0, 0], -90 * deg2rad);
        const qScreen = Math3D.qFromAxisAngle([0, 0, 1], -rOrient);

        let qFinal = Math3D.qMultiply(qDev, qCamFix);
        qFinal = Math3D.qMultiply(qFinal, qScreen);

        App.state.viewMat = Math3D.matFromQ(qFinal);

        // Debug Display
        const starFwdX = -App.state.viewMat[8], starFwdY = -App.state.viewMat[9], starFwdZ = -App.state.viewMat[10];
        const alt = Math.asin(starFwdZ) * 180/Math.PI; 
        let starAz = Math.atan2(starFwdX, starFwdY) * 180/Math.PI; if(starAz<0) starAz+=360;

        document.getElementById('debug-az').innerText = Math.round(starAz);
        document.getElementById('debug-alt').innerText = Math.round(alt);
    },

    loop: () => {
        App.updateViewMatrix();
        const {ctx, width, height, state} = App;
        ctx.clearRect(0,0,width,height);
        
        const isSolar = state.viewMode === 2;
        if (state.opacity.bg > 0) {
            const alpha = state.isAR ? state.opacity.bg : 1;
            const grad = ctx.createLinearGradient(0,0,0,height);
            if (isSolar) { grad.addColorStop(0, `rgba(135,206,235,${alpha})`); grad.addColorStop(1, `rgba(224,247,250,${alpha})`); }
            else { grad.addColorStop(0, `rgba(2,6,23,${alpha})`); grad.addColorStop(1, `rgba(15,23,42,${alpha})`); }
            ctx.fillStyle = grad; ctx.fillRect(0,0,width,height);
        }

        const lst = Astro.getLST(state.lon, new Date(), state.timeOffset);
        
        if (!isSolar && state.opacity.milky > 0) {
            ctx.globalCompositeOperation = 'lighter'; 
            state.milkyWay.forEach(p => {
                const vec = Astro.getStarVector(p.ra, p.dec, state.lat, lst);
                const pos = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if (pos) {
                    // UPDATED: Dynamic scaling for "Cloud" effect
                    const size = p.size * (width/1500);
                    const grad = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, size);
                    const a = p.alpha * state.opacity.milky;
                    
                    grad.addColorStop(0, `rgba(${p.r},${p.g},${p.b},${a})`);
                    grad.addColorStop(1, `rgba(${p.r},${p.g},${p.b},0)`);
                    
                    ctx.fillStyle = grad;
                    ctx.beginPath(); ctx.arc(pos.x, pos.y, size, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.globalCompositeOperation = 'source-over';
        }

        const starPos = {};
        state.stars.forEach(s => {
            const vec = Astro.getStarVector(s.ra, s.dec, state.lat, lst);
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            if (p) {
                if(s.name) starPos[s.name] = p;
                let col = s.isProc ? {r:255,g:255,b:255} : Utils.bvToColor(s.ci||0.5);
                let size = s.isProc ? Math.random()*1 : Math.max(0.8, (3.5-s.mag)*1.2);
                let alpha = (s.mag<2?1.0:0.6);
                if (isSolar) { size*=0.8; alpha=0.7; col={r:0,g:0,b:0}; }
                ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${alpha})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI*2); ctx.fill();
            }
        });

        ctx.strokeStyle = isSolar ? "rgba(0,0,0,0.3)" : "rgba(34,211,238,0.4)"; ctx.lineWidth = 1;
        ctx.beginPath();
        const visibleConsts = [];
        CONSTELLATION_DB.forEach(c => {
            if (!state.ranks[c.rank]) return;
            const isTarget = (state.mode === 'guide' && Guide.target && Guide.target.id === c.id);
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = "#4ade80"; ctx.lineWidth = 3; }
            
            // If it's a star/galaxy (no lines), just calculate center
            if(c.lines.length === 0) {
                const vec = Astro.getStarVector(c.centerRA, c.centerDec, state.lat, lst);
                const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if(p) {
                    visibleConsts.push({c, x:p.x, y:p.y, dist: Math.hypot(p.x-width/2, p.y-height/2)});
                    ctx.fillStyle = isTarget ? "#4ade80" : "#fbbf24"; // Yellow for single objects
                    ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                    
                    const tName = state.lang==='en' ? c.en : c.name;
                    // Draw a marker for single objects
                    ctx.fillText(tName, p.x, p.y - 10);
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                }
            } else {
                // Lines Logic
                let cx=0, cy=0, n=0;
                for(let i=0; i<c.lines.length; i+=2) {
                    const p1 = starPos[c.lines[i]]; const p2 = starPos[c.lines[i+1]];
                    if(p1 && p2) { 
                        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); 
                        cx+=(p1.x+p2.x)/2; cy+=(p1.y+p2.y)/2; n++;
                    }
                }
                if(n>0) {
                    cx/=n; cy/=n;
                    const d = Math.hypot(cx-width/2, cy-height/2);
                    if(c.rank === 1 || d < 200) {
                        visibleConsts.push({c, x:cx, y:cy, dist:d});
                        ctx.fillStyle = isTarget ? "#4ade80" : (isSolar ? "#000" : "#fff");
                        ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                        
                        const tName = state.lang==='en' ? c.en : c.name;
                        ctx.fillText(tName, cx, cy);
                    }
                }
            }
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = isSolar?"rgba(0,0,0,0.3)":"rgba(34,211,238,0.4)"; ctx.lineWidth = 1; }
        });
        ctx.stroke();

        // 5. Smart Bubble Logic
        const bubble = document.getElementById('smart-bubble');
        if (state.showInfo && visibleConsts.length > 0) {
            visibleConsts.sort((a,b) => a.dist - b.dist);
            const target = visibleConsts[0];
            if (target.dist < 150) {
                document.getElementById('bubble-title').innerText = state.lang==='en' ? target.c.en : target.c.name;
                const dict = I18N[state.lang];
                
                let tag = dict.constellation;
                if(target.c.rank === 1) tag = dict.famous_const;
                if(target.c.rank === 4) tag = dict.star_gal; // New Tag
                
                document.getElementById('bubble-tag').innerText = tag;
                document.getElementById('bubble-desc').innerText = state.lang==='en' ? target.c.desc_en : target.c.desc;
                
                const bx = Math.min(Math.max(target.x, 140), width-140);
                const by = Math.max(target.y - 140, 20);
                bubble.style.left = (bx - 128) + 'px'; 
                bubble.style.top = by + 'px';
                bubble.style.opacity = 1;
            } else {
                bubble.style.opacity = 0;
            }
        } else {
            bubble.style.opacity = 0;
        }

        if (state.meteorEnabled && !isSolar) {
            if (Math.random() < 0.01) state.meteors.push({x: Math.random()*width, y: Math.random()*height*0.5, vx: (Math.random()-0.5)*20, vy: Math.random()*15+5, life: 1});
            ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 2;
            state.meteors = state.meteors.filter(m => {
                ctx.globalAlpha = m.life; ctx.beginPath(); ctx.moveTo(m.x, m.y); ctx.lineTo(m.x-m.vx*4, m.y-m.vy*4); ctx.stroke();
                m.x+=m.vx; m.y+=m.vy; m.life-=0.04; return m.life>0;
            });
            ctx.globalAlpha = 1;
        }

        if (state.mode === 'guide' && Guide.target) {
            const t = Guide.target;
            const vec = Astro.getStarVector(t.centerRA, t.centerDec, state.lat, lst);
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            const lockEl = document.getElementById('lock-on');
            if (p && p.x>50 && p.x<width-50 && p.y>50 && p.y<height-50) {
                lockEl.style.opacity = 1; lockEl.style.left = p.x + 'px'; lockEl.style.top = p.y + 'px';
                document.getElementById('nav-msg').style.transform = `translate(0,0)`;
            } else {
                lockEl.style.opacity = 0;
            }
        }
        requestAnimationFrame(App.loop);
    },

    resize: () => { App.width = window.innerWidth; App.height = window.innerHeight; App.canvas.width = App.width; App.canvas.height = App.height; App.state.fov = (App.width>App.height)?45:60; },
    toggleLocation: () => { 
        if(!App.state.useGPS) {
            navigator.geolocation.getCurrentPosition(pos => {
                App.state.lat = pos.coords.latitude; App.state.lon = pos.coords.longitude;
                App.state.useGPS = true;
                Utils.updateDOMText(); // Update Text
                Utils.toast(I18N[App.state.lang].loc_gps + " OK");
            }, () => Utils.toast("GPS Error"));
        } else {
            App.state.lat = 32.698; App.state.lon = 128.839; App.state.useGPS = false;
            Utils.updateDOMText(); // Update Text
            Utils.toast(I18N[App.state.lang].loc_fixed);
        }
    },
    toggleSettings: () => document.getElementById('settings-modal').classList.toggle('hidden-force'),
    
    toggleTimeSlider: () => {
        const slider = document.getElementById('time-slider-container');
        slider.classList.toggle('active');
        Utils.toast(I18N[App.state.lang].time_travel);
    },
    setTimeOffset: (val) => {
        App.state.timeOffset = parseFloat(val);
        const sign = App.state.timeOffset >= 0 ? '+' : '';
        document.getElementById('time-display').innerText = `TIME TRAVEL: ${sign}${App.state.timeOffset}h`;
    },
    resetTime: (val) => {
        if(val == 0) Utils.toast(I18N[App.state.lang].time_reset);
    },

    toggleAR: (v) => { 
        App.state.isAR = v;
        const cam = document.getElementById('camera-feed');
        if (v) {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => { cam.srcObject = stream; cam.style.opacity = 1; })
                    .catch(e => { console.log("Cam Error", e); Utils.toast("Cam Error"); });
            }
            App.setOpacity('bg', 0.0); 
            document.querySelector('input[oninput*="bg"]').value = 0.0;
        } else {
            if (cam.srcObject) {
                cam.srcObject.getTracks().forEach(t => t.stop());
                cam.srcObject = null;
            }
            cam.style.opacity = 0;
            App.setOpacity('bg', 1);
            document.querySelector('input[oninput*="bg"]').value = 1;
        }
    },
    toggleViewMode: () => {
        App.state.viewMode = (App.state.viewMode + 1) % 3;
        const body = document.body; const btn = document.getElementById('btn-mode');
        body.classList.remove('mode-red', 'mode-solar');
        if(App.state.viewMode === 1) { body.classList.add('mode-red'); btn.innerText = "ğŸ”´"; }
        else if(App.state.viewMode === 2) { body.classList.add('mode-solar'); btn.innerText = "â˜€ï¸"; }
        else { btn.innerText = "ğŸŒ™"; }
    },
    setOpacity: (k,v) => { App.state.opacity[k] = parseFloat(v); if(k==='bg')document.getElementById('val-bg').innerText=Math.round(v*100)+"%"; if(k==='milky')document.getElementById('val-milky').innerText=Math.round(v*100)+"%"; },
    setRank: (r,v) => App.state.ranks[r] = v,
    setFlag: (k,v) => App.state[k] = v,
    setLang: (l) => { 
        App.state.lang = l; 
        Guide.buildList(); 
        Utils.updateDOMText(); 
    },
    takeScreenshot: () => { const l=document.createElement('a'); l.download='stargazer-v25.1.png'; l.href=App.canvas.toDataURL(); l.click(); Utils.toast("ä¿å­˜ã—ã¾ã—ãŸ ğŸ“¸"); },
    setupTouch: () => {
        let lx = 0;
        window.addEventListener('touchstart', e => lx = e.touches[0].clientX);
        window.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - lx; App.state.manualOffset += dx * 0.2; lx = e.touches[0].clientX;
        });
    }
};

window.onload = () => Gate.check();
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('StarGazer: SW Registered!', reg))
                .catch(err => console.log('StarGazer: SW Failed', err));
        });
    }
</script>
</body>
</html>
