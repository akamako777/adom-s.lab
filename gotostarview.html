<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Five Islands Stargazer v40.0 (Cosmic Anchor)</title>
    
    <!-- Tailwind CSS (CDN for standalone) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* üõë Core Stability */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-user-select: none; user-select: none; color: white;
            overscroll-behavior: none;
        }

        /* üåå Layers */
        #layers-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #camera-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0; transition: opacity 0.8s; }
        #sky-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; overflow: hidden; }

        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        .glass {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* üåì Modes */
        body.mode-red #layers-container { filter: sepia(100%) hue-rotate(-50deg) saturate(300%) contrast(1.2) brightness(0.6); }
        body.mode-red #ui-layer { filter: sepia(100%) hue-rotate(-50deg) saturate(200%); }
        
        body.mode-solar { background-color: #87CEEB; color: #0f172a; }
        body.mode-solar .glass { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0,0,0,0.1); color: #0f172a; }
        body.mode-solar .text-cyan-400 { color: #0066cc !important; }
        body.mode-solar .text-white { color: #0f172a !important; }

        /* Smart Bubble */
        .info-bubble {
            position: absolute;
            transition: opacity 0.3s, transform 0.15s linear; /* Smooth follow */
            will-change: transform, left, top;
        }
        .bubble-tail {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-top: 8px solid rgba(15, 23, 42, 0.9);
        }

        /* Calibration Modal */
        #setup-wizard {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s, visibility 0.5s;
            opacity: 1; visibility: visible;
        }
        #setup-wizard.hidden-force { opacity: 0; visibility: hidden; pointer-events: none; }
        
        /* Level Bubble Viz */
        .level-bubble {
            width: 160px; height: 160px; border: 4px solid #475569; border-radius: 50%;
            position: relative; overflow: hidden; background: #0f172a; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .level-target {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border: 2px solid #22d3ee; border-radius: 50%; z-index: 10;
        }
        .level-ball {
            position: absolute; top: 50%; left: 50%; width: 36px; height: 36px;
            background: #ef4444; border-radius: 50%; opacity: 0.8;
            transform: translate(-50%, -50%); transition: transform 0.1s linear; /* Smooth visual */
        }
        .level-ok .level-ball { background: #22c55e; box-shadow: 0 0 15px #22c55e; }

        .hidden-force { display: none !important; }
        .check-box { appearance: none; width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; background: transparent; cursor: pointer; position: relative; transition: all 0.2s; }
        .check-box:checked { background: #22d3ee; border-color: #22d3ee; }
        .check-box:checked::after { content: '‚úî'; position: absolute; top: 0px; left: 5px; color: #000; font-size: 16px; font-weight: bold; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #22d3ee; border: 2px solid #ffffff; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }

        /* Animations */
        @keyframes swipe-anim { 0% { opacity: 0; transform: translateX(-10px); } 50% { opacity: 1; transform: translateX(10px); } 100% { opacity: 0; transform: translateX(-10px); } }
        .swipe-hint { animation: swipe-anim 2s infinite; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
    </style>
</head>
<body>

    <!-- üö™ PC GATE -->
    <div id="star-gate" class="hidden-force">
        <div class="relative z-10 flex flex-col items-center max-w-md text-center p-4">
            <div class="text-8xl mb-4 drop-shadow-[0_0_20px_rgba(34,211,238,0.5)]">üåå</div>
            <h1 class="text-4xl font-black text-white mb-2 tracking-tight">Five Islands<br><span class="text-cyan-400">Stargazer v40.0</span></h1>
            <p class="text-slate-400 text-sm font-bold tracking-[0.2em] mb-8 uppercase">Cosmic Anchor</p>
            <div class="bg-white p-3 rounded-2xl shadow-2xl mb-6 transform transition hover:scale-105 duration-500">
                <canvas id="qr-canvas"></canvas>
            </div>
            <p class="text-slate-300 text-sm leading-relaxed font-medium mb-8">
                „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÂ∞ÇÁî®„Åß„Åô„ÄÇ<br>QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </p>
            <button onclick="Gate.startUnlock()" class="px-6 py-2 rounded-full border border-white/20 text-xs text-slate-500 hover:text-white hover:border-white transition">DEBUG MODE</button>
        </div>
    </div>

    <!-- üì± APP CONTAINER -->
    <div id="app-container" class="hidden-force w-full h-full relative">
        <div id="layers-container">
            <video id="camera-feed" autoplay playsinline muted></video>
            <canvas id="sky-canvas"></canvas>
            
            <div id="overlay-layer">
                <div id="smart-bubble" class="info-bubble opacity-0 w-64 p-4 rounded-xl bg-slate-900/90 border border-cyan-500/30 backdrop-blur-md shadow-2xl flex flex-col items-center text-center">
                    <h3 id="bubble-title" class="text-base font-bold text-cyan-400 mb-1 leading-tight">Title</h3>
                    <div id="bubble-tag" class="text-[9px] bg-white/10 px-2 py-0.5 rounded text-slate-300 mb-2">Constellation</div>
                    <p id="bubble-desc" class="text-[11px] text-white font-medium leading-relaxed text-left w-full">Description here...</p>
                    <div class="bubble-tail"></div>
                </div>
            </div>
        </div>

        <!-- NAV UI -->
        <div id="nav-ui" class="absolute inset-0 pointer-events-none hidden-force z-30">
            <div id="nav-msg" class="absolute top-24 w-full text-center">
                <div class="inline-block bg-black/60 backdrop-blur px-4 py-2 rounded-lg border border-cyan-500/50">
                    <div class="text-[10px] text-cyan-300 uppercase tracking-widest mb-1 font-mono">NAVIGATING TO</div>
                    <div id="nav-target-name" class="text-xl font-bold text-white drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">Target</div>
                </div>
            </div>
            <div id="lock-on" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300">
                <div class="w-24 h-24 border-2 border-green-400 rounded-full flex items-center justify-center animate-pulse">
                    <div class="w-1 h-1 bg-green-400 rounded-full"></div>
                </div>
                <div class="absolute top-28 w-full text-center text-green-400 font-bold text-sm tracking-widest bg-black/50 px-2 rounded font-mono">TARGET LOCKED</div>
            </div>
        </div>

        <!-- UI -->
        <div id="ui-layer" class="safe-area-inset p-4">
            <div class="flex justify-between items-start interactive pt-2">
                <button onclick="App.toggleLocation()" class="glass px-3 py-2 rounded-full flex items-center gap-2 active:scale-95 transition">
                    <span class="text-sm">üìç</span>
                    <div class="flex flex-col items-start">
                        <span class="text-[8px] font-bold text-cyan-400 tracking-widest uppercase">LOCATION</span>
                        <span id="loc-name" class="text-[10px] font-bold text-white leading-none">‰∫îÂ≥∂ÂàóÂ≥∂ (Fixed)</span>
                    </div>
                </button>
                <div class="flex gap-3">
                    <button onclick="App.startSetup()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-cyan-900/50 border border-cyan-500/50 text-cyan-300 shadow-[0_0_10px_rgba(34,211,238,0.3)]">üéØ</button>
                    <button onclick="Guide.toggle()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition border border-white/20 bg-cyan-900/30">üìñ</button>
                    <button onclick="App.toggleSettings()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition">‚öôÔ∏è</button>
                    <button onclick="App.toggleViewMode()" id="btn-mode" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-indigo-900/50 border-indigo-500/30">üåô</button>
                </div>
            </div>

            <div id="swipe-hint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity duration-1000">
                <div class="flex flex-col items-center">
                    <div class="text-4xl mb-2 swipe-hint text-white">‚ÜîÔ∏è</div>
                    <div class="bg-black/60 px-3 py-1 rounded-full text-xs text-white backdrop-blur border border-white/20">Swipe to Adjust</div>
                </div>
            </div>

            <!-- Debug Info -->
            <div class="absolute bottom-24 left-4 pointer-events-none opacity-70">
                <div class="text-[9px] text-cyan-300 font-mono bg-black/40 p-2 rounded backdrop-blur-sm border border-white/10">
                    <div>ANCHOR: <span id="debug-anchor" class="text-white">OFF</span></div>
                    <div>AZ: <span id="debug-az" class="text-yellow-400 font-bold">0</span>¬∞</div>
                    <div>ALT: <span id="debug-alt">0</span>¬∞</div>
                </div>
            </div>

            <div class="flex justify-center items-end pb-8 interactive gap-6">
                <button onclick="App.takeScreenshot()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-cyan-400 shadow-lg">
                    <span class="text-xl">üì∏</span>
                </button>
                <button id="btn-cancel-nav" onclick="Guide.stopNav()" class="hidden-force glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-red-500/50 bg-red-900/20 active:scale-90 transition text-red-300 font-bold text-xs">
                    STOP
                </button>
            </div>
        </div>
    </div>

    <!-- ü™Ñ SETUP WIZARD (Cosmic Anchor) -->
    <div id="setup-wizard" class="hidden-force interactive">
        <div class="w-full max-w-md px-6 flex flex-col items-center">
            <h2 class="text-2xl font-black text-white mb-2 tracking-tighter">ALIGNMENT</h2>
            <p class="text-xs font-bold text-cyan-400 mb-6 tracking-widest">QUATERNION ANCHOR</p>
            
            <div class="bg-slate-800/80 p-4 rounded-xl border border-white/10 mb-6 w-full">
                <ol class="text-xs text-slate-300 space-y-3 list-decimal list-inside text-left">
                    <li><b class="text-white">„Çπ„Éû„Éõ„ÇíÊ∞¥Âπ≥</b>„Å´„Åó„ÄÅÊ≥°„Çí‰∏≠ÂøÉ„Å´„ÄÇ</li>
                    <li><b class="text-cyan-400">„ÄåÂåó(N)„Äç</b>„ÅÆÊñπËßí„ÇíÂêë„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</li>
                    <li><b class="text-green-400">„Çª„ÉÉ„Éà</b>„ÇíÊäº„Åô„Å®„ÄÅ„Åù„Åì„ÅåÂåó„Å´„Å™„Çä„Åæ„Åô„ÄÇ</li>
                </ol>
            </div>
            
            <div class="level-bubble">
                <div class="level-target"></div>
                <div id="level-ball" class="level-ball"></div>
            </div>
            
            <div class="flex flex-col items-center mb-6">
                <div id="compass-val" class="text-3xl font-mono font-bold text-white">---¬∞</div>
                <div id="sensor-status" class="text-[10px] font-mono text-slate-400">Waiting for Sensor...</div>
            </div>
            
            <button id="btn-confirm-setup" onclick="App.confirmSetup()" disabled class="px-8 py-4 rounded-full bg-slate-700 text-slate-400 font-bold shadow-lg w-full transition-all duration-300 transform active:scale-95">
                „Çª„É≥„Çµ„ÉºÊ∫ñÂÇô‰∏≠...
            </button>
        </div>
    </div>

    <!-- GUIDE MODAL -->
    <div id="guide-modal" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-xl hidden-force interactive flex flex-col">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
            <h2 class="font-bold text-white text-lg flex items-center gap-2">
                <span class="text-2xl">üìñ</span> <span>ÊòüÂ∫ß„É©„Ç§„Éñ„É©„É™</span>
            </h2>
            <button onclick="Guide.toggle()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition text-xl">‚úï</button>
        </div>
        <div id="guide-list" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20"></div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" onclick="if(event.target === this) App.toggleSettings()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur hidden-force flex items-center justify-center interactive transition-opacity duration-300 cursor-pointer">
        <div onclick="event.stopPropagation()" class="glass bg-[#0f172a]/95 w-11/12 max-w-sm rounded-2xl border border-white/10 p-6 space-y-6 shadow-2xl overflow-y-auto max-h-[85vh] cursor-default">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <h2 class="font-bold text-white text-lg">Ë®≠ÂÆö (Settings)</h2>
                <button onclick="App.toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-slate-300 hover:text-white transition text-xl">‚úï</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm">üé• AR„Ç´„É°„É©</span>
                    <input type="checkbox" id="toggle-ar" onchange="App.toggleAR(this.checked)" class="check-box">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span>ËÉåÊôØ„ÅÆÊøÉ„Åï</span><span id="val-bg" class="text-cyan-400">100%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="App.setOpacity('bg', this.value)">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span>Â§©„ÅÆÂ∑ù (Milky Way)</span><span id="val-milky" class="text-cyan-400">50%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="App.setOpacity('milky', this.value)">
                </div>
            </div>
            <div class="pt-4 border-t border-white/10">
                <button onclick="App.startSetup()" class="w-full py-3 bg-slate-800 rounded-lg text-sm font-bold text-cyan-400 border border-cyan-500/30">üéØ Âº∑Âà∂„Ç≠„É£„É™„Éñ„É¨„Éº„Ç∑„Éß„É≥</button>
            </div>
        </div>
    </div>

    <!-- START MODAL -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] interactive">
        <div class="relative z-10 w-full max-w-sm px-6 text-center">
            <div class="text-6xl mb-4 animate-bounce">üåå</div>
            <h1 class="text-3xl font-black text-white mb-2">Five Islands<br><span class="text-cyan-400 font-light">Stargazer</span></h1>
            <p class="text-slate-400 text-xs font-bold tracking-widest mb-8">v40.0 COSMIC ANCHOR</p>
            <button onclick="App.init()" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition hover:shadow-cyan-500/30">
                START
            </button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full shadow-2xl text-sm opacity-0 pointer-events-none transition-opacity z-[60] border border-cyan-500/30 font-bold text-center w-max max-w-[90%] backdrop-blur">Msg</div>

<script>
/**
 * üåå FIVE ISLANDS STARGAZER v40.0 (Cosmic Anchor)
 * ==========================================
 * MATH CORE UPDATE:
 * - Implemented "Quaternion Anchor" strategy.
 * - Removed scalar offsets for heading.
 * - Uses "lerpAngle" for smooth butter-like tracking.
 */

// --- 0. DATASETS ---
const RANK={FAMOUS:1,MEDIUM:2,MINOR:3,STAR_GAL:4};

// Merged Database (Cleaned)
const CONSTELLATION_DB=[{id:"ori",rank:1,name:"„Ç™„É™„Ç™„É≥Â∫ß",desc:"„ÄêÂÜ¨„ÅÆÁéãËÄÖ„Äë‰∏â„Å§Êòü„ÅåÁâπÂæ¥ÁöÑ„Å™ÊòüÂ∫ß„ÄÇ",centerRA:5.5,centerDec:-1.0,lines:["Betelgeuse","Alnitak","Bellatrix","Mintaka","Alnitak","Saiph","Mintaka","Rigel","Alnitak","Alnilam","Alnilam","Mintaka","Betelgeuse","Bellatrix","Saiph","Rigel","Betelgeuse","Meissa","Bellatrix","Meissa"]},{id:"sco",rank:1,name:"„Åï„Åù„ÇäÂ∫ß",desc:"„ÄêÂ§è„ÅÆSÂ≠ó„Äë„Ç¢„É≥„Çø„É¨„Çπ„ÅåËºù„Åè„ÄÇ",centerRA:16.5,centerDec:-26.0,lines:["Antares","Dschubba","Dschubba","Graffias","Dschubba","Pi Sco","Antares","Wei","Antares","Tau Sco","Wei","Mu Sco","Mu Sco","Zeta Sco","Zeta Sco","Eta Sco","Eta Sco","Sargas","Sargas","Iota Sco","Iota Sco","Kappa Sco","Kappa Sco","Shaula","Shaula","Lesath"]},{id:"tau",rank:1,name:"„Åä„ÅÜ„ÅóÂ∫ß",desc:"„ÄêÂÜ¨„ÅÆVÂ≠ó„Äë„Ç¢„É´„Éá„Éê„É©„É≥„Å®„Åô„Å∞„Çã„ÄÇ",centerRA:4.5,centerDec:16.0,lines:["Aldebaran","Elnath","Aldebaran","Zeta Tau","Aldebaran","Ain","Ain","Hyadum I","Hyadum I","Delta Tau","Delta Tau","Aldebaran","Elnath","Zeta Tau"]},{id:"gem",rank:1,name:"„Åµ„Åü„ÅîÂ∫ß",desc:"„Äê‰ª≤ËâØ„ÅóÂÖÑÂºü„Äë„Ç´„Çπ„Éà„É´„Å®„Éù„É´„ÉÉ„ÇØ„Çπ„ÄÇ",centerRA:7.0,centerDec:22.0,lines:["Castor","Pollux","Castor","Mebsuta","Mebsuta","Tejat","Pollux","Wasat","Wasat","Alhena"]},{id:"leo",rank:1,name:"„Åó„ÅóÂ∫ß",desc:"„ÄêÊò•„ÅÆÈéå„Äë„É¨„Ç∞„É´„Çπ„ÅåËºù„Åè„ÄÇ",centerRA:10.5,centerDec:15.0,lines:["Regulus","Algieba","Algieba","Adhafera","Adhafera","Rasalas","Regulus","Chertan","Chertan","Zosma","Zosma","Denebola","Algieba","Zosma"]},{id:"vir",rank:1,name:"„Åä„Å®„ÇÅÂ∫ß",desc:"„ÄêÊò•„ÅÆÂ•≥Á•û„Äë„Çπ„Éî„Ç´„ÅåËºù„Åè„ÄÇ",centerRA:13.3,centerDec:-2.0,lines:["Spica","Heze","Spica","Porrima","Porrima","Auva","Auva","Zavijava","Porrima","Vindemiatrix","Vindemiatrix","Zavijava"]},{id:"uma",rank:1,name:"„Åä„Åä„Åê„ÅæÂ∫ß",desc:"„ÄêÂåóÊñó‰∏ÉÊòü„ÄëÂåóÊ•µÊòü„ÇíË¶ã„Å§„Åë„ÇãÈçµ„ÄÇ",centerRA:11.5,centerDec:50.0,lines:["Dubhe","Merak","Merak","Phecda","Phecda","Megrez","Megrez","Alioth","Alioth","Mizar","Mizar","Alkaid","Megrez","Dubhe","Phecda","Talitha","Talitha","Tania Borealis","Tania Borealis","Mu UMa"]},{id:"cas",rank:2,name:"„Ç´„Ç∑„Ç™„Éö„É§Â∫ß",desc:"„ÄêÂåó„ÅÆWÂ≠ó„ÄëÂåóÊ•µÊòü„ÇíÊé¢„ÅôÁõÆÂç∞„ÄÇ",centerRA:1.0,centerDec:60.0,lines:["Caph","Schedar","Schedar","Gamma Cas","Gamma Cas","Ruchbah","Ruchbah","Segin"]},{id:"cyg",rank:2,name:"„ÅØ„Åè„Å°„Çá„ÅÜÂ∫ß",desc:"„ÄêÂåóÂçÅÂ≠ó„Äë„Éá„Éç„Éñ„ÇíÂê´„ÇÄÂçÅÂ≠óÊû∂„ÄÇ",centerRA:20.5,centerDec:42.0,lines:["Deneb","Sadr","Sadr","Albireo","Sadr","Gienah","Sadr","Delta Cyg"]},{id:"lyr",rank:2,name:"„Åì„Å®Â∫ß",desc:"„Äê‰∏ÉÂ§ï„ÅÆÊòü„Äë„Éô„Ç¨„ÅåËºù„Åè„ÄÇ",centerRA:18.8,centerDec:36.0,lines:["Vega","Sheliak","Sheliak","Sulafat","Sulafat","Delta Lyr","Delta Lyr","Vega"]},{id:"aql",rank:2,name:"„Çè„ÅóÂ∫ß",desc:"„ÄêÂΩ¶Êòü„Äë„Ç¢„É´„Çø„Ç§„É´„ÅåËºù„Åè„ÄÇ",centerRA:19.8,centerDec:3.0,lines:["Altair","Tarazed","Altair","Alshain","Altair","Delta Aql","Delta Aql","Zeta Aql"]},{id:"umi",rank:2,name:"„Åì„Åê„ÅæÂ∫ß",desc:"„ÄêÂåóÊ•µÊòü„Äë„Éù„É©„É™„Çπ„Åå„ÅÇ„Çã„ÄÇ",centerRA:15.0,centerDec:75.0,lines:["Polaris","Yildun","Yildun","Zeta UMi","Zeta UMi","Eta UMi","Eta UMi","Pherkad","Pherkad","Kochab","Kochab","Zeta UMi"]},{id:"lep",rank:3,name:"„ÅÜ„Åï„ÅéÂ∫ß",desc:"„Äê„Ç™„É™„Ç™„É≥„ÅÆÁç≤Áâ©„Äë„ÄÇ",centerRA:5.5,centerDec:-20.0,lines:["Arneb","Nihal","Nihal","Epsilon Lep","Epsilon Lep","Mu Lep","Mu Lep","Arneb"]},{id:"cnc",rank:3,name:"„Åã„Å´Â∫ß",desc:"„Äê„Éó„É¨„Çª„ÉöÊòüÂõ£„Äë„ÄÇ",centerRA:8.5,centerDec:20.0,lines:["Acubens","Altarf","Asellus Australis","Asellus Borealis","Asellus Australis","Acubens"]},{id:"sirius",rank:4,name:"„Ç∑„É™„Ç¶„Çπ",desc:"„ÄêÂÖ®Â§©‰∏Ä„Äë„Åä„Åä„ÅÑ„Å¨Â∫ß„ÄÇ",centerRA:6.75,centerDec:-16.7,lines:[]},{id:"m45",rank:4,name:"„Åô„Å∞„Çã (M45)",desc:"„Äê„Éó„É¨„Ç¢„Éá„ÇπÊòüÂõ£„Äë„Åä„ÅÜ„ÅóÂ∫ß„ÄÇ",centerRA:3.8,centerDec:24.1,lines:[]}];
const STARS_DATA=[{name:"Betelgeuse",ra:5.919,dec:7.407,mag:0.45,ci:1.85},{name:"Rigel",ra:5.242,dec:-8.202,mag:0.12,ci:-0.03},{name:"Bellatrix",ra:5.418,dec:6.349,mag:1.64,ci:-0.22},{name:"Saiph",ra:5.795,dec:-9.669,mag:2.07,ci:-0.18},{name:"Alnitak",ra:5.679,dec:-1.943,mag:1.74,ci:-0.21},{name:"Alnilam",ra:5.603,dec:-1.202,mag:1.69,ci:-0.19},{name:"Mintaka",ra:5.533,dec:-0.299,mag:2.25,ci:-0.21},{name:"Meissa",ra:5.585,dec:9.934,mag:3.39,ci:-0.14},{name:"Antares",ra:16.490,dec:-26.432,mag:1.06,ci:1.83},{name:"Graffias",ra:16.088,dec:-19.805,mag:2.56,ci:-0.11},{name:"Dschubba",ra:16.005,dec:-22.622,mag:2.29,ci:-0.13},{name:"Pi Sco",ra:15.979,dec:-26.114,mag:2.89,ci:-0.21},{name:"Wei",ra:16.834,dec:-38.020,mag:2.29,ci:1.14},{name:"Mu Sco",ra:16.863,dec:-38.048,mag:3.00,ci:-0.20},{name:"Zeta Sco",ra:16.904,dec:-42.360,mag:3.62,ci:1.50},{name:"Eta Sco",ra:17.202,dec:-43.238,mag:3.32,ci:0.05},{name:"Sargas",ra:17.623,dec:-42.998,mag:1.86,ci:0.38},{name:"Iota Sco",ra:17.795,dec:-40.125,mag:2.99,ci:0.17},{name:"Kappa Sco",ra:17.703,dec:-39.029,mag:2.39,ci:-0.20},{name:"Shaula",ra:17.560,dec:-37.104,mag:1.62,ci:-0.22},{name:"Lesath",ra:17.513,dec:-37.291,mag:2.70,ci:-0.21},{name:"Vega",ra:18.615,dec:38.783,mag:0.03,ci:0.00},{name:"Altair",ra:19.846,dec:8.868,mag:0.76,ci:0.22},{name:"Deneb",ra:20.690,dec:45.280,mag:1.25,ci:0.09},{name:"Aldebaran",ra:4.598,dec:16.509,mag:0.87,ci:1.54},{name:"Elnath",ra:5.438,dec:28.607,mag:1.65,ci:-0.13},{name:"Zeta Tau",ra:5.627,dec:21.142,mag:2.97,ci:-0.22},{name:"Ain",ra:4.478,dec:19.180,mag:3.53,ci:1.02},{name:"Hyadum I",ra:4.331,dec:15.627,mag:3.65,ci:0.97},{name:"Delta Tau",ra:4.381,dec:17.542,mag:3.77,ci:0.96},{name:"Alcyone",ra:3.791,dec:24.105,mag:2.85,ci:-0.09},{name:"Pollux",ra:7.755,dec:28.026,mag:1.16,ci:1.00},{name:"Castor",ra:7.576,dec:31.888,mag:1.58,ci:0.04},{name:"Alhena",ra:6.628,dec:16.399,mag:1.93,ci:0.00},{name:"Tejat",ra:6.248,dec:22.506,mag:2.87,ci:1.56},{name:"Mebsuta",ra:6.733,dec:25.131,mag:3.06,ci:1.40},{name:"Wasat",ra:7.336,dec:21.982,mag:3.50,ci:0.16},{name:"Regulus",ra:10.139,dec:11.967,mag:1.36,ci:-0.11},{name:"Denebola",ra:11.817,dec:14.572,mag:2.14,ci:0.09},{name:"Algieba",ra:10.333,dec:19.841,mag:2.01,ci:1.15},{name:"Zosma",ra:11.236,dec:20.523,mag:2.56,ci:0.12},{name:"Adhafera",ra:10.276,dec:23.417,mag:3.43,ci:1.25},{name:"Rasalas",ra:9.764,dec:23.774,mag:2.97,ci:1.62},{name:"Chertan",ra:11.236,dec:15.428,mag:3.33,ci:0.07},{name:"Spica",ra:13.416,dec:-11.161,mag:0.98,ci:-0.23},{name:"Porrima",ra:12.693,dec:-1.450,mag:2.74,ci:0.36},{name:"Vindemiatrix",ra:13.036,dec:10.959,mag:2.85,ci:0.94},{name:"Heze",ra:13.578,dec:-0.595,mag:3.38,ci:0.16},{name:"Auva",ra:12.926,dec:3.398,mag:3.39,ci:1.38},{name:"Zavijava",ra:11.841,dec:1.765,mag:3.61,ci:0.56},{name:"Dubhe",ra:11.062,dec:61.751,mag:1.81,ci:1.07},{name:"Merak",ra:11.030,dec:56.382,mag:2.34,ci:0.04},{name:"Phecda",ra:11.897,dec:53.694,mag:2.41,ci:0.02},{name:"Megrez",ra:12.257,dec:57.032,mag:3.32,ci:0.08},{name:"Alioth",ra:12.900,dec:55.959,mag:1.76,ci:0.02},{name:"Mizar",ra:13.398,dec:54.925,mag:2.23,ci:0.06},{name:"Alkaid",ra:13.792,dec:49.313,mag:1.85,ci:-0.19},{name:"Talitha",ra:8.987,dec:48.041,mag:3.12,ci:0.20},{name:"Tania Borealis",ra:10.284,dec:42.914,mag:3.45,ci:-0.05},{name:"Mu UMa",ra:10.373,dec:41.498,mag:3.06,ci:1.45},{name:"Polaris",ra:2.530,dec:89.264,mag:1.97,ci:0.63},{name:"Kochab",ra:14.845,dec:74.155,mag:2.07,ci:1.28},{name:"Pherkad",ra:15.346,dec:71.834,mag:3.00,ci:0.05},{name:"Yildun",ra:17.538,dec:86.586,mag:4.35,ci:0.01},{name:"Zeta UMi",ra:15.734,dec:77.795,mag:4.29,ci:-0.06},{name:"Eta UMi",ra:16.292,dec:75.753,mag:4.95,ci:0.40},{name:"Schedar",ra:0.675,dec:56.537,mag:2.24,ci:1.17},{name:"Caph",ra:0.153,dec:59.150,mag:2.28,ci:0.34},{name:"Gamma Cas",ra:0.945,dec:60.717,mag:2.15,ci:-0.1},{name:"Ruchbah",ra:1.430,dec:60.235,mag:2.66,ci:0.13},{name:"Segin",ra:1.907,dec:63.670,mag:3.35,ci:0.26},{name:"Arneb",ra:5.545,dec:-17.822,mag:2.58,ci:0.21},{name:"Nihal",ra:5.470,dec:-20.760,mag:2.81,ci:0.46},{name:"Epsilon Lep",ra:5.087,dec:-22.404,mag:3.19,ci:1.43},{name:"Mu Lep",ra:5.216,dec:-16.208,mag:3.29,ci:-0.12},{name:"Acubens",ra:8.974,dec:11.857,mag:4.26,ci:0.14},{name:"Altarf",ra:8.276,dec:9.186,mag:3.53,ci:1.13},{name:"Asellus Borealis",ra:8.721,dec:21.468,mag:4.66,ci:0.08},{name:"Asellus Australis",ra:8.740,dec:18.156,mag:3.94,ci:1.00},{name:"Sirius",ra:6.752,dec:-16.716,mag:-1.46,ci:0.00},{name:"M45 Pleiades",ra:3.783,dec:24.116,mag:1.6,ci:-0.05}];

// --- 1. ENHANCED MATH ENGINE (Quaternion Power) ---
const Math3D = {
    // Multiply Quaternions (a * b)
    qMultiply: (a, b) => {
        const ax=a[0], ay=a[1], az=a[2], aw=a[3];
        const bx=b[0], by=b[1], bz=b[2], bw=b[3];
        return [
            ax*bw + aw*bx + ay*bz - az*by,
            ay*bw + aw*by + az*bx - ax*bz,
            az*bw + aw*bz + ax*by - ay*bx,
            aw*bw - ax*bx - ay*by - az*bz
        ];
    },
    // Inverse (Conjugate for unit quat)
    qInverse: (q) => {
        return [-q[0], -q[1], -q[2], q[3]];
    },
    // Axis Angle to Quaternion
    qFromAxisAngle: (axis, angle) => {
        const half = angle / 2;
        const s = Math.sin(half);
        return [axis[0]*s, axis[1]*s, axis[2]*s, Math.cos(half)];
    },
    // Create Quaternion from standard Z-X-Y Euler (in Rads)
    qFromZXY: (x, y, z) => {
        const c1 = Math.cos(z/2), c2 = Math.cos(x/2), c3 = Math.cos(y/2);
        const s1 = Math.sin(z/2), s2 = Math.sin(x/2), s3 = Math.sin(y/2);
        return [
            s1*c2*c3 - c1*s2*s3,
            c1*s2*c3 + s1*c2*s3,
            c1*c2*s3 + s1*s2*c3,
            c1*c2*c3 - s1*s2*s3
        ];
    },
    // Matrix from Quaternion
    matFromQ: (q) => {
        const x=q[0], y=q[1], z=q[2], w=q[3];
        const x2=x+x, y2=y+y, z2=z+z;
        const xx=x*x2, xy=x*y2, xz=x*z2;
        const yy=y*y2, yz=y*z2, zz=z*z2;
        const wx=w*x2, wy=w*y2, wz=w*z2;
        return [
            1-(yy+zz), xy-wz, xz+wy, 0,
            xy+wz, 1-(xx+zz), yz-wx, 0,
            xz-wy, yz+wx, 1-(xx+yy), 0,
            0, 0, 0, 1
        ];
    },
    // Invert Matrix (Rotation only)
    matInvert: (m) => {
        return [m[0], m[4], m[8], 0, m[1], m[5], m[9], 0, m[2], m[6], m[10], 0, 0, 0, 0, 1];
    },
    // Project 3D point to Screen
    project: (vec, viewMat, width, height, fovDeg) => {
        const x = vec.x*viewMat[0] + vec.y*viewMat[4] + vec.z*viewMat[8];
        const y = vec.x*viewMat[1] + vec.y*viewMat[5] + vec.z*viewMat[9];
        const z = vec.x*viewMat[2] + vec.y*viewMat[6] + vec.z*viewMat[10];
        if (z >= -0.1) return null;
        const scale = (height / 2) / Math.tan(fovDeg * Math.PI / 360);
        return { 
            x: x * (scale / -z) + width / 2, 
            y: -y * (scale / -z) + height / 2, 
            z: z 
        };
    }
};

// --- 2. ASTRO PHYSICS ---
const Astro = {
    getLST: (lon, date = new Date()) => {
        const d = (date.getTime()/1000 - 946727935.816) / 86400;
        return ((18.697374558 + 24.06570982441908 * d) % 24 + lon/15 + 24) % 24;
    },
    getHorizontalCoords: (ra, dec, lat, lst) => {
        const latRad = lat * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const haRad = (lst - ra) * 15 * Math.PI / 180;
        const sinAlt = Math.sin(decRad) * Math.sin(latRad) + Math.cos(decRad) * Math.cos(latRad) * Math.cos(haRad);
        const altRad = Math.asin(Math.max(-1, Math.min(1, sinAlt)));
        const cosAz = (Math.sin(decRad) - Math.sin(altRad) * Math.sin(latRad)) / (Math.cos(altRad) * Math.cos(latRad));
        let azRad = Math.acos(Math.min(1, Math.max(-1, cosAz)));
        if (Math.sin(haRad) > 0) azRad = 2 * Math.PI - azRad;
        return { alt: altRad, az: azRad };
    },
    getVector: (alt, az) => {
        const cosAlt = Math.cos(alt);
        // Z is Up, Y is North, X is East (Right Hand Rule logic for world space)
        return { x: Math.sin(az) * cosAlt, y: Math.cos(az) * cosAlt, z: Math.sin(alt) };
    }
};

// --- 3. UTILS ---
const Utils = {
    toast: (msg) => { const el = document.getElementById('toast'); el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000); },
    bvToColor: (bv) => {
        if (bv < 0.0) return {r:180, g:200, b:255}; if (bv < 0.5) return {r:230, g:240, b:255}; 
        if (bv < 1.0) return {r:255, g:255, b:240}; if (bv < 1.5) return {r:255, g:220, b:180}; 
        return {r:255, g:200, b:180}; 
    }
};

// --- 4. APP CORE ---
const App = {
    canvas: null, ctx: null, width: 0, height: 0,
    state: {
        lat: 32.698, lon: 128.839, // Goto
        viewMat: [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1],
        mode: 'normal', viewMode: 0, isAR: false, useGPS: false, opacity: {bg:1, milky:0.5},
        ranks: { [RANK.FAMOUS]: true, [RANK.MEDIUM]: true, [RANK.MINOR]: true, [RANK.STAR_GAL]: false },
        stars: [], milkyWay: [],
        fov: 60,
        
        // SENSOR STATE
        lastOri: null,
        smoothedOri: { alpha: 0, beta: 90, gamma: 0 },
        
        // ANCHOR STATE
        setupMode: true,
        anchorCorrectionQ: [0, 0, 0, 1] // Identity
    },

    init: async () => {
        document.getElementById('start-modal').classList.add('hidden-force');
        App.startSetup(); // Start in setup mode
        
        // DeviceOrientation Permission
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { 
                const res = await DeviceOrientationEvent.requestPermission(); 
                if (res === 'granted') window.addEventListener('deviceorientation', App.handleOri); 
            } catch(e){}
        } else { 
            window.addEventListener('deviceorientation', App.handleOri); 
        }

        App.canvas = document.getElementById('sky-canvas'); App.ctx = App.canvas.getContext('2d');
        
        // Load Stars
        STARS_DATA.forEach(s => App.state.stars.push(s));
        for(let i=0; i<800; i++) {
            App.state.stars.push({ra: Math.random()*24, dec: Math.random()*180-90, mag: Math.random()*3+3.5, ci: Math.random()*1.5, isProc: true});
        }
        
        // Load Gaussian Milky Way (Rich Visuals from sensagatigau.html)
        const mwPoints = [{ra:0,dec:63, w:20}, {ra:6,dec:10, w:15}, {ra:12,dec:-60, w:30}, {ra:18,dec:-15, w:40}, {ra:23,dec:60, w:22}];
        for(let i=0; i<mwPoints.length-1; i++) {
            const p1 = mwPoints[i]; const p2 = mwPoints[i+1];
            for(let j=0; j<400; j++) {
                const t = j/400;
                const baseRA = p1.ra + (p2.ra - p1.ra)*t;
                const baseDec = p1.dec + (p2.dec - p1.dec)*t;
                const scatter = (Math.random() - Math.random()) * p1.w * 1.5;
                App.state.milkyWay.push({
                    ra: baseRA + (Math.random()-0.5)*2, dec: baseDec + scatter, 
                    size: Math.random()*100+100, alpha: Math.random()*0.015+0.005,
                    r: 200, g: 220, b: 255
                });
            }
        }
        
        try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}
        window.addEventListener('resize', App.resize);
        App.setupTouch(); App.resize(); App.loop();
    },

    // üåü SENSOR SMOOTHING LOGIC (From sensagatigau.html)
    handleOri: (e) => {
        const k = 0.15; // Butter factor
        let alpha = e.alpha || 0;
        let beta = e.beta || 0;
        let gamma = e.gamma || 0;
        let compass = e.webkitCompassHeading || 0;

        if (!App.state.lastOri) App.state.lastOri = { alpha, beta, gamma, compass };
        const last = App.state.lastOri;

        const lerpAngle = (c, p, f) => {
            let d = c - p;
            while (d > 180) d -= 360;
            while (d < -180) d += 360;
            return p + d * f;
        };

        alpha = lerpAngle(alpha, last.alpha, k);
        beta = lerpAngle(beta, last.beta, k);
        gamma = lerpAngle(gamma, last.gamma, k);
        compass = lerpAngle(compass, last.compass, k);

        App.state.lastOri = { alpha: (alpha+360)%360, beta, gamma, compass: (compass+360)%360 };
        App.state.smoothedOri = { 
            alpha: App.state.lastOri.alpha, 
            beta, gamma, 
            isIOS: !!e.webkitCompassHeading, 
            webkitCompass: e.webkitCompassHeading ? App.state.lastOri.compass : null 
        };

        // Calibration UI Update
        if (App.state.setupMode) {
            const ball = document.getElementById('level-ball');
            const maxTilt = 20; 
            let bx = Math.min(Math.max(gamma, -maxTilt), maxTilt);
            let by = Math.min(Math.max(beta, -maxTilt), maxTilt);
            const px = (bx / maxTilt) * 70;
            const py = (by / maxTilt) * 70;
            ball.style.transform = `translate(calc(-50% + ${px}px), calc(-50% + ${py}px))`;
            
            const isLevel = Math.abs(bx)<3 && Math.abs(by)<3;
            if(isLevel) document.querySelector('.level-bubble').classList.add('level-ok');
            else document.querySelector('.level-bubble').classList.remove('level-ok');

            const btn = document.getElementById('btn-confirm-setup');
            document.getElementById('sensor-status').innerText = "Sensor Active";
            btn.disabled = false;
            btn.innerText = "„Çª„ÉÉ„Éà (SET NORTH)";
            btn.classList.add('bg-gradient-to-r', 'from-cyan-600', 'to-blue-600', 'text-white');
            
            document.getElementById('compass-val').innerText = `${Math.round(App.state.smoothedOri.isIOS ? App.state.smoothedOri.webkitCompass : App.state.smoothedOri.alpha)}¬∞`;
        }
    },

    // üåü SETUP: THE ANCHOR
    startSetup: () => {
        App.state.setupMode = true;
        document.getElementById('setup-wizard').classList.remove('hidden-force');
        App.toggleAR(false);
    },
    
    confirmSetup: () => {
        // Capture Current Quaternion
        const qCurrent = App.getSensorQuaternion();
        
        // Define Target: We assume user is looking at NORTH HORIZON.
        // In our coordinate system (Y=North, Z=Up), looking North means View Vector is (0,1,0).
        // The default camera (Identity) looks down -Z? 
        // Let's standardise: Identity View Matrix looks at -Z.
        // We want world Z to be Up, Y to be North.
        // If we look North Horizon, the camera frame is...
        
        // SIMPLIFIED ANCHOR LOGIC:
        // We want the current sensor state (qCurrent) to map to "North Horizon".
        // Let's define "North Horizon" orientation as qTarget.
        // If phone is upright, looking North:
        // qTarget should produce a view matrix looking North.
        
        // Instead of complex math, let's just say:
        // qCorrection * qCurrent = qIdentity (or qNorth).
        // Let's store qCorrection = qCurrent.inverse().
        // Then applying qCorrection aligns the current view to Identity.
        // We then rotate Identity to face North if needed.
        
        const qInv = Math3D.qInverse(qCurrent);
        App.state.anchorCorrectionQ = qInv;
        
        App.state.setupMode = false;
        document.getElementById('setup-wizard').classList.add('hidden-force');
        document.getElementById('swipe-hint').style.opacity = 1;
        setTimeout(() => document.getElementById('swipe-hint').style.opacity = 0, 3000);
        Utils.toast("ANCHOR LOCKED üîí");
        document.getElementById('debug-anchor').innerText = "ON";
        document.getElementById('debug-anchor').className = "text-green-400 font-bold";
    },

    // üåü CORE MATH: QUATERNION PIPE
    getSensorQuaternion: () => {
        const { alpha, beta, gamma, isIOS, webkitCompass } = App.state.smoothedOri;
        const deg2rad = Math.PI / 180;
        
        // 1. Base Euler (Z-X-Y)
        // Note: We use W3C order Z -> X -> Y
        // But we want to construct it carefully.
        
        // Handle Compass
        let zAngle = alpha;
        if(isIOS && webkitCompass != null) zAngle = webkitCompass;
        
        // Convert to Radians
        const x = beta * deg2rad;
        const y = gamma * deg2rad;
        const z = zAngle * deg2rad;
        
        // Create Rotation Quaternion
        const qZ = Math3D.qFromAxisAngle([0, 0, 1], z);
        const qX = Math3D.qFromAxisAngle([1, 0, 0], x);
        const qY = Math3D.qFromAxisAngle([0, 1, 0], y);
        
        // Combine Z -> X -> Y
        let q = Math3D.qMultiply(qX, qY); // X then Y? 
        // W3C says: Rotate Z, then X, then Y.
        // q = qY * qX * qZ (Standard multiplication order is reverse of operation)
        q = Math3D.qMultiply(q, qZ);
        
        // 2. Adjust for Screen Orientation (Landscape/Portrait)
        const orient = (window.screen.orientation ? window.screen.orientation.angle : 0) * deg2rad;
        const qScreen = Math3D.qFromAxisAngle([0, 0, 1], -orient);
        q = Math3D.qMultiply(qScreen, q); // Screen rotation happens last (visually) or first (physically)?
        // Usually qFinal = qDevice * qScreenCorrection.
        
        return q;
    },

    updateViewMatrix: () => {
        // 1. Get Smoothed Sensor Quaternion
        const qSensor = App.getSensorQuaternion();
        
        // 2. Apply Anchor Correction
        // qAligned = qAnchor * qSensor
        // This makes the calibrated position = Identity (0,0,0)
        let qAligned = Math3D.qMultiply(App.state.anchorCorrectionQ, qSensor);
        
        // 3. Map Identity to World "North Horizon"
        // At Identity (Phone Upright), we want to look at North.
        // Let's assume standard Identity looks -Z (down?).
        // If we calibrated upright, we want that to be North (Y+).
        
        // Let's simply apply a fixed rotation to align Identity to "Looking North".
        // If we calibrated facing North, qAligned is Identity.
        // We want the View Matrix to look North.
        // Standard View Matrix looking North (Y+) with Z+ up.
        // This usually requires rotating the camera frame.
        
        // Fix: Rotate -90 X to bring camera up from down-looking?
        // Let's assume the user calibrated Upright.
        const qFix = Math3D.qFromAxisAngle([1, 0, 0], -Math.PI/2); 
        qAligned = Math3D.qMultiply(qFix, qAligned);
        
        // 4. Invert to get View Matrix
        // ViewMatrix is inverse of Camera Rotation
        const mCam = Math3D.matFromQ(qAligned);
        App.state.viewMat = Math3D.matInvert(mCam);
        
        // Debug
        const fx = -App.state.viewMat[8], fy = -App.state.viewMat[9], fz = -App.state.viewMat[10];
        const alt = Math.asin(fz) * 180/Math.PI;
        let az = Math.atan2(fx, fy) * 180/Math.PI; if(az<0) az+=360;
        document.getElementById('debug-az').innerText = Math.round(az);
        document.getElementById('debug-alt').innerText = Math.round(alt);
    },

    loop: () => {
        App.updateViewMatrix();
        const {ctx, width, height, state} = App;
        ctx.clearRect(0,0,width,height);
        
        const isSolar = state.viewMode === 2;
        if (state.opacity.bg > 0) {
            const alpha = state.isAR ? state.opacity.bg : 1;
            const grad = ctx.createLinearGradient(0,0,0,height);
            grad.addColorStop(0, isSolar ? `rgba(135,206,235,${alpha})` : `rgba(2,6,23,${alpha})`);
            grad.addColorStop(1, isSolar ? `rgba(224,247,250,${alpha})` : `rgba(15,23,42,${alpha})`);
            ctx.fillStyle = grad; ctx.fillRect(0,0,width,height);
        }

        const lst = Astro.getLST(state.lon);

        // Draw Horizon Grid (Fixed Reference)
        ctx.strokeStyle = "rgba(0, 255, 255, 0.2)"; ctx.lineWidth = 1; ctx.beginPath();
        let firstH = null;
        for(let a=0; a<=360; a+=10) {
            const vec = Astro.getVector(0, a * Math.PI/180);
            const pos = Math3D.project(vec, state.viewMat, width, height, state.fov);
            if(pos){ if(firstH===null) { ctx.moveTo(pos.x,pos.y); firstH=pos; } else ctx.lineTo(pos.x,pos.y); } else firstH=null;
        }
        ctx.stroke();

        // Milky Way (Cloud Style)
        if (!isSolar && state.opacity.milky > 0) {
            ctx.globalCompositeOperation = 'lighter'; 
            state.milkyWay.forEach(p => {
                const vec = Astro.getVector(Astro.getHorizontalCoords(p.ra, p.dec, state.lat, lst).alt, Astro.getHorizontalCoords(p.ra, p.dec, state.lat, lst).az);
                const pos = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if (pos) {
                    const size = p.size * (width/1500);
                    const grad = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, size);
                    grad.addColorStop(0, `rgba(${p.r},${p.g},${p.b},${p.alpha * state.opacity.milky})`);
                    grad.addColorStop(1, `rgba(${p.r},${p.g},${p.b},0)`);
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(pos.x, pos.y, size, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.globalCompositeOperation = 'source-over';
        }

        // Stars & Constellations
        const starPos = {};
        state.stars.forEach(s => {
            const hc = Astro.getHorizontalCoords(s.ra, s.dec, state.lat, lst);
            const vec = Astro.getVector(hc.alt, hc.az);
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            if(p) {
                if(s.name) starPos[s.name] = p;
                let col = s.isProc ? {r:255,g:255,b:255} : Utils.bvToColor(s.ci||0.5);
                let size = s.isProc ? Math.random()*1 : Math.max(0.8, (3.5-s.mag)*1.2);
                if(isSolar){ size*=0.8; col={r:0,g:0,b:0}; }
                ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${s.mag<2?1:0.6})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI*2); ctx.fill();
            }
        });

        // Constellations
        ctx.strokeStyle = isSolar ? "rgba(0,0,0,0.3)" : "rgba(34,211,238,0.6)"; ctx.lineWidth = 1.5;
        ctx.beginPath();
        const visibleConsts = [];
        
        CONSTELLATION_DB.forEach(c => {
            if (!state.ranks[c.rank]) return;
            const isTarget = (state.mode === 'guide' && Guide.target && Guide.target.id === c.id);
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = "#4ade80"; ctx.lineWidth = 3; }
            
            let cx=0, cy=0, n=0;
            if(c.lines) {
                for(let i=0; i<c.lines.length; i+=2) {
                    const p1 = starPos[c.lines[i]]; const p2 = starPos[c.lines[i+1]];
                    if(p1 && p2) { 
                        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); 
                        cx+=(p1.x+p2.x)/2; cy+=(p1.y+p2.y)/2; n++;
                    }
                }
            }
            if(n>0) {
                cx/=n; cy/=n;
                const d = Math.hypot(cx-width/2, cy-height/2);
                if(d < 250) {
                    visibleConsts.push({c, x:cx, y:cy, dist:d});
                    ctx.fillStyle = isTarget ? "#4ade80" : (isSolar?"#000":"rgba(255,255,255,0.7)");
                    ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                    ctx.fillText(c.name, cx, cy);
                }
            }
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = isSolar?"rgba(0,0,0,0.3)":"rgba(34,211,238,0.6)"; ctx.lineWidth = 1.5; }
        });
        ctx.stroke();

        // Bubble
        const bubble = document.getElementById('smart-bubble');
        if (visibleConsts.length > 0) {
            visibleConsts.sort((a,b) => a.dist - b.dist);
            const t = visibleConsts[0];
            if (t.dist < 150) {
                document.getElementById('bubble-title').innerText = t.c.name;
                document.getElementById('bubble-desc').innerText = t.c.desc;
                bubble.style.left = t.x + 'px'; bubble.style.top = Math.max(t.y-20, 40) + 'px'; bubble.style.opacity = 1;
            } else bubble.style.opacity = 0;
        } else bubble.style.opacity = 0;

        // Target Lock
        if (state.mode === 'guide' && Guide.target) {
            const t = Guide.target;
            const hc = Astro.getHorizontalCoords(t.centerRA, t.centerDec, state.lat, lst);
            const p = Math3D.project(Astro.getVector(hc.alt, hc.az), state.viewMat, width, height, state.fov);
            const lockEl = document.getElementById('lock-on');
            if (p && p.x>0 && p.x<width && p.y>0 && p.y<height) {
                lockEl.style.opacity = 1; lockEl.style.left = p.x + 'px'; lockEl.style.top = p.y + 'px';
                document.getElementById('nav-msg').style.transform = `translate(0,0)`;
            } else lockEl.style.opacity = 0;
        }

        requestAnimationFrame(App.loop);
    },

    resize: () => { App.width = window.innerWidth; App.height = window.innerHeight; App.canvas.width = App.width; App.canvas.height = App.height; App.state.fov = (App.width > App.height) ? 35 : 60; },
    toggleLocation: () => { App.state.useGPS = !App.state.useGPS; document.getElementById('loc-name').innerText = App.state.useGPS ? "ÁèæÂú®Âú∞ (GPS)" : "‰∫îÂ≥∂ÂàóÂ≥∂ (Fixed)"; Utils.toast(App.state.useGPS ? "GPS ON" : "Loc Fixed"); },
    toggleSettings: () => document.getElementById('settings-modal').classList.toggle('hidden-force'),
    toggleAR: (v) => { App.state.isAR = v; const c = document.getElementById('camera-feed'); if(v) navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{c.srcObject=s;c.style.opacity=1}); else {if(c.srcObject)c.srcObject.getTracks().forEach(t=>t.stop());c.style.opacity=0;} App.setOpacity('bg', v?0:1); document.querySelector('input[oninput*="bg"]').value = v?0:1; },
    toggleViewMode: () => { App.state.viewMode=(App.state.viewMode+1)%3; document.body.className = App.state.viewMode===1?'mode-red':(App.state.viewMode===2?'mode-solar':''); document.getElementById('btn-mode').innerText = ['üåô','üî¥','‚òÄÔ∏è'][App.state.viewMode]; },
    setOpacity: (k,v) => { App.state.opacity[k] = parseFloat(v); document.getElementById(`val-${k}`).innerText = Math.round(v*100)+"%"; },
    takeScreenshot: () => { const l=document.createElement('a'); l.download='stargazer.png'; l.href=App.canvas.toDataURL(); l.click(); Utils.toast("‰øùÂ≠ò„Åó„Åæ„Åó„Åü üì∏"); },
    setupTouch: () => { /* Add touch controls if needed */ }
};

// Guide System
const Guide = {
    target: null,
    toggle: () => {
        const el = document.getElementById('guide-modal');
        if(el.classList.contains('hidden-force')) {
            const list = document.getElementById('guide-list'); list.innerHTML = '';
            CONSTELLATION_DB.forEach(c => {
                const div = document.createElement('div');
                div.className = "p-4 rounded-xl border border-white/10 bg-slate-800/80 mb-2";
                div.innerHTML = `<h3 class="font-bold text-lg text-white">${c.name}</h3><p class="text-xs text-slate-300 mb-2">${c.desc}</p><button onclick="Guide.startNav('${c.id}')" class="w-full py-2 bg-cyan-600 rounded text-sm font-bold">GOTO</button>`;
                list.appendChild(div);
            });
            el.classList.remove('hidden-force');
        } else el.classList.add('hidden-force');
    },
    startNav: (id) => { const c = CONSTELLATION_DB.find(x=>x.id===id); if(c){ Guide.target=c; App.state.mode='guide'; document.getElementById('guide-modal').classList.add('hidden-force'); document.getElementById('nav-ui').classList.remove('hidden-force'); document.getElementById('nav-target-name').innerText=c.name; document.getElementById('btn-cancel-nav').classList.remove('hidden-force'); Utils.toast("Nav Start üöÄ"); } },
    stopNav: () => { Guide.target=null; App.state.mode='normal'; document.getElementById('nav-ui').classList.add('hidden-force'); document.getElementById('btn-cancel-nav').classList.add('hidden-force'); Utils.toast("Nav End"); }
};

const Gate = {
    check: () => { if(('ontouchstart' in window) && window.innerWidth <= 1024) { document.getElementById('app-container').classList.remove('hidden-force'); document.getElementById('start-modal').classList.remove('hidden-force'); } else { document.getElementById('star-gate').classList.remove('hidden-force'); new QRious({element:document.getElementById('qr-canvas'),value:window.location.href,size:180}); } },
    startUnlock: () => { document.getElementById('star-gate').classList.add('hidden-force'); document.getElementById('app-container').classList.remove('hidden-force'); document.getElementById('start-modal').classList.remove('hidden-force'); }
};

window.onload = Gate.check;
</script>
</body>
</html>
