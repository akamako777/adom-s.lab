<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Five Islands Stargazer v26 (World Lock)</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* ğŸ›‘ Core Stability */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            touch-action: none; font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-user-select: none; user-select: none; color: white;
            overscroll-behavior: none;
        }

        /* ğŸŒŒ Layers */
        #layers-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #camera-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0; transition: opacity 0.8s; }
        #sky-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        
        /* Overlay for Smart Bubble */
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; overflow: hidden; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        .glass {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* ğŸŒ“ Modes */
        body.mode-red #layers-container { filter: sepia(100%) hue-rotate(-50deg) saturate(300%) contrast(1.2) brightness(0.6); }
        body.mode-red #ui-layer { filter: sepia(100%) hue-rotate(-50deg) saturate(200%); }
        
        body.mode-solar { background-color: #87CEEB; color: #0f172a; }
        body.mode-solar .glass { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0,0,0,0.1); color: #0f172a; }
        body.mode-solar h1, body.mode-solar h2, body.mode-solar h3, body.mode-solar span, body.mode-solar div { color: #0f172a; text-shadow: none !important; }
        body.mode-solar .text-cyan-400 { color: #0066cc !important; }
        body.mode-solar .text-white { color: #0f172a !important; }
        
        /* Smart Bubble */
        .info-bubble {
            position: absolute; transition: opacity 0.3s, transform 0.1s linear; will-change: transform, left, top;
        }
        .bubble-tail {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-top: 8px solid rgba(15, 23, 42, 0.9);
        }
        body.mode-solar .bubble-tail { border-top-color: rgba(255, 255, 255, 0.95); }

        /* Time Slider */
        #time-slider-container {
            position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 400px; z-index: 30;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #time-slider-container.active { opacity: 1; pointer-events: auto; }
        .time-label { font-size: 12px; color: #fbbf24; text-align: center; font-weight: bold; margin-bottom: 4px; text-shadow: 0 0 5px black; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #22d3ee; border: 2px solid #ffffff; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }

        /* ğŸšª PC Gate */
        #star-gate {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            overflow-y: auto; padding-top: 10vh; padding-bottom: 40px;
        }

        .hidden-force { display: none !important; }
        .check-box { appearance: none; width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.5); border-radius: 6px; background: transparent; cursor: pointer; position: relative; transition: all 0.2s; }
        .check-box:checked { background: #22d3ee; border-color: #22d3ee; }
        .check-box:checked::after { content: 'âœ”'; position: absolute; top: 0px; left: 5px; color: #000; font-size: 16px; font-weight: bold; }
        
        #debug-hud { font-family: 'Share Tech Mono', monospace; font-size: 11px; text-shadow: 1px 1px 0 #000; }
        
        @keyframes swipe-anim { 0% { opacity: 0; transform: translateX(-10px); } 50% { opacity: 1; transform: translateX(10px); } 100% { opacity: 0; transform: translateX(-10px); } }
        .swipe-hint { animation: swipe-anim 2s infinite; }

        /* Guide Accordion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
    </style>
</head>
<body>

    <!-- ğŸšª PC GATE -->
    <div id="star-gate" class="hidden-force">
        <div class="relative z-10 flex flex-col items-center max-w-md text-center p-4">
            <div class="text-8xl mb-4 drop-shadow-[0_0_20px_rgba(34,211,238,0.5)]">ğŸŒ</div>
            <h1 class="text-4xl font-black text-white mb-2 tracking-tight">Five Islands<br><span class="text-cyan-400">Stargazer v26</span></h1>
            <p class="text-slate-400 text-sm font-bold tracking-[0.2em] mb-8 uppercase">World Lock Edition</p>
            <div class="bg-white p-3 rounded-2xl shadow-2xl mb-6 transform transition hover:scale-105 duration-500">
                <canvas id="qr-canvas"></canvas>
            </div>
            <p class="text-slate-300 text-sm leading-relaxed font-medium mb-8">
                ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å°‚ç”¨ã§ã™ã€‚<br>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>
            <button onclick="Gate.startUnlock()" class="group flex items-center gap-2 px-6 py-3 rounded-full bg-slate-800/50 border border-slate-700 hover:bg-slate-700 hover:border-cyan-500 transition-all cursor-pointer">
                <span class="text-yellow-400 text-xl group-hover:animate-spin">â˜…</span>
                <span class="text-xs font-bold text-slate-300 group-hover:text-white">PC DEBUG MODE</span>
            </button>
        </div>
    </div>

    <!-- ğŸ“± APP CONTAINER -->
    <div id="app-container" class="hidden-force w-full h-full relative">
        <div id="layers-container">
            <video id="camera-feed" autoplay playsinline muted></video>
            <canvas id="sky-canvas"></canvas>
            
            <!-- HTML Overlay -->
            <div id="overlay-layer">
                <div id="smart-bubble" class="info-bubble opacity-0 w-64 p-4 rounded-xl bg-slate-900/90 border border-cyan-500/30 backdrop-blur-md shadow-2xl flex flex-col items-center text-center">
                    <h3 id="bubble-title" class="text-base font-bold text-cyan-400 mb-1 leading-tight">Title</h3>
                    <div id="bubble-tag" class="text-[9px] bg-white/10 px-2 py-0.5 rounded text-slate-300 mb-2">Constellation</div>
                    <p id="bubble-desc" class="text-[11px] text-white font-medium leading-relaxed text-left w-full">Description...</p>
                    <div class="bubble-tail"></div>
                </div>
            </div>
        </div>

        <!-- NAV UI -->
        <div id="nav-ui" class="absolute inset-0 pointer-events-none hidden-force z-30">
            <div id="nav-msg" class="absolute top-24 w-full text-center">
                <div class="inline-block bg-black/60 backdrop-blur px-4 py-2 rounded-lg border border-cyan-500/50">
                    <div class="text-[10px] text-cyan-300 uppercase tracking-widest mb-1 font-mono">NAVIGATING TO</div>
                    <div id="nav-target-name" class="text-xl font-bold text-white drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">Target</div>
                </div>
            </div>
            <div id="lock-on" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-300">
                <div class="w-24 h-24 border-2 border-green-400 rounded-full flex items-center justify-center animate-pulse">
                    <div class="w-1 h-1 bg-green-400 rounded-full"></div>
                </div>
                <div class="absolute top-28 w-full text-center text-green-400 font-bold text-sm tracking-widest bg-black/50 px-2 rounded font-mono">TARGET LOCKED</div>
            </div>
        </div>

        <!-- UI LAYER -->
        <div id="ui-layer" class="safe-area-inset p-4">
            <!-- Top -->
            <div class="flex justify-between items-start interactive pt-2">
                <button onclick="App.toggleLocation()" class="glass px-3 py-2 rounded-full flex items-center gap-2 active:scale-95 transition">
                    <span id="gps-icon" class="text-sm">ğŸ“</span>
                    <div class="flex flex-col items-start">
                        <span class="text-[8px] font-bold text-cyan-400 tracking-widest uppercase">LOCATION</span>
                        <span id="loc-name" class="text-[10px] font-bold text-white leading-none">äº”å³¶åˆ—å³¶ (Fixed)</span>
                    </div>
                </button>
                <div class="flex gap-3">
                    <button onclick="Guide.toggle()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition border border-white/20 bg-cyan-900/30">ğŸ“–</button>
                    <button onclick="App.toggleSettings()" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition">âš™ï¸</button>
                    <button onclick="App.toggleViewMode()" id="btn-mode" class="glass w-10 h-10 rounded-full flex items-center justify-center text-lg active:scale-95 transition bg-indigo-900/50 border-indigo-500/30">ğŸŒ™</button>
                </div>
            </div>

            <!-- Swipe Hint -->
            <div id="swipe-hint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none transition-opacity duration-1000 opacity-0">
                <div class="flex flex-col items-center">
                    <div class="text-4xl mb-2 swipe-hint text-cyan-400">â†”ï¸</div>
                    <div class="bg-black/60 px-3 py-1 rounded-full text-xs text-white backdrop-blur border border-white/20 font-bold">Swipe to Rotate Sky</div>
                </div>
            </div>
            
            <!-- Offset Indicator (Only shows when dragging) -->
            <div id="offset-indicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity">
                <div class="text-4xl font-bold text-cyan-400 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] font-mono" id="offset-val">0Â°</div>
            </div>

            <!-- Time Slider -->
            <div id="time-slider-container">
                <div id="time-display" class="time-label">TIME TRAVEL: +0h</div>
                <input type="range" id="time-range" min="-12" max="12" step="0.5" value="0" oninput="App.setTimeOffset(this.value)" onchange="App.resetTime(this.value)">
            </div>

            <!-- Debug Info -->
            <div class="absolute bottom-24 left-4 pointer-events-none opacity-80">
                <div id="debug-hud" class="text-cyan-300 leading-tight bg-black/40 p-1 rounded border border-cyan-500/20">
                    <div>AZ : <span id="debug-az" class="text-yellow-400 font-bold text-sm">0</span>Â°</div>
                    <div>ALT: <span id="debug-alt">0</span>Â°</div>
                    <div class="text-[8px] text-slate-400 mt-1">v26 WorldLock</div>
                </div>
            </div>

            <!-- Bottom Buttons -->
            <div class="flex justify-center items-end pb-8 interactive gap-6">
                <button onclick="App.toggleTimeSlider()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-yellow-400 text-yellow-300 shadow-lg bg-yellow-900/30">
                    <span class="text-xl">â³</span>
                </button>
                
                <button onclick="App.takeScreenshot()" class="glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-white/20 active:scale-90 transition hover:border-cyan-400 shadow-lg">
                    <span class="text-xl">ğŸ“¸</span>
                </button>
                
                <button id="btn-cancel-nav" onclick="Guide.stopNav()" class="hidden-force glass w-14 h-14 rounded-full flex items-center justify-center border-2 border-red-500/50 bg-red-900/20 active:scale-90 transition text-red-300 font-bold text-xs">
                    STOP
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ“– GUIDE MODAL -->
    <div id="guide-modal" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-xl hidden-force interactive flex flex-col">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
            <h2 class="font-bold text-white text-lg flex items-center gap-2">
                <span class="text-2xl">ğŸ“–</span> <span data-i18n="guide_title">æ˜Ÿåº§è©³ç´°è§£èª¬</span>
            </h2>
            <button onclick="Guide.toggle()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition text-xl">âœ•</button>
        </div>
        <div id="guide-list" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20"></div>
    </div>

    <!-- ğŸš€ START MODAL -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] interactive">
        <div class="relative z-10 w-full max-w-sm px-6 text-center">
            <div class="text-6xl mb-4 animate-bounce">ğŸŒ</div>
            <h1 class="text-3xl font-black text-white mb-2">Five Islands<br><span class="text-cyan-400 font-light">Stargazer</span></h1>
            <p class="text-slate-400 text-xs font-bold tracking-widest mb-8">v26 WORLD LOCK EDITION</p>
            <div class="bg-slate-800/50 p-4 rounded-xl text-left mb-6 border border-white/10">
                 <p class="text-xs text-cyan-300 font-bold mb-1">âœ¨ New in v26:</p>
                 <ul class="text-[11px] text-slate-300 list-disc list-inside space-y-1">
                     <li>æ°´å¹³ç·šã¨æ–¹ä½ã‚°ãƒªãƒƒãƒ‰ã®è¡¨ç¤º</li>
                     <li>ã‚¹ãƒ¯ã‚¤ãƒ—ã§ç©ºå…¨ä½“ã‚’å›è»¢è£œæ­£</li>
                     <li>ã‚«ãƒ¡ãƒ©ãƒ¯ãƒ¼ã‚¯ã®å®‰å®šæ€§å‘ä¸Š</li>
                 </ul>
            </div>
            <button onclick="App.init()" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition hover:shadow-cyan-500/30">
                START / å‡ºç™º
            </button>
        </div>
    </div>

    <!-- âš™ï¸ SETTINGS MODAL -->
    <div id="settings-modal" onclick="if(event.target === this) App.toggleSettings()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur hidden-force flex items-center justify-center interactive transition-opacity duration-300 cursor-pointer">
        <div onclick="event.stopPropagation()" class="glass bg-[#0f172a]/95 w-11/12 max-w-sm rounded-2xl border border-white/10 p-6 space-y-6 shadow-2xl overflow-y-auto max-h-[85vh] cursor-default">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <h2 class="font-bold text-white text-lg" data-i18n="settings_title">è¨­å®š (Settings)</h2>
                <button onclick="App.toggleSettings()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-slate-300 hover:text-white transition text-xl">âœ•</button>
            </div>
            
            <!-- Category Boxes -->
            <div class="space-y-3">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider" data-i18n="cat_title">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª</p>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold" data-i18n="cat_famous">ğŸ¦ æœ‰åãªæ˜Ÿåº§ (Famous)</span>
                    <input type="checkbox" checked onchange="App.setRank(1, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer border-l-4 border-yellow-400">
                    <span class="text-sm font-bold" data-i18n="cat_star_gal">âœ¨ æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³ (Stars & Gal)</span>
                    <input type="checkbox" onchange="App.setRank(4, this.checked)" class="check-box">
                </label>
                <label class="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                    <span class="text-sm font-bold" data-i18n="cat_medium">ğŸ» æ™®é€šã®æ˜Ÿåº§ (Medium)</span>
                    <input type="checkbox" checked onchange="App.setRank(2, this.checked)" class="check-box">
                </label>
            </div>

            <!-- Visibility -->
            <div class="space-y-4 pt-4 border-t border-white/10">
                <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider" data-i18n="opt_title">è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</p>
                
                <!-- Grid Toggle -->
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm font-bold text-green-300">ğŸŒ æ–¹ä½ã‚°ãƒªãƒƒãƒ‰ (Grid)</span>
                        <div class="text-[10px] text-slate-400">æ°´å¹³ç·šã¨æ–¹ä½ã‚’è¡¨ç¤ºã—ã¾ã™</div>
                    </div>
                    <input type="checkbox" checked onchange="App.setFlag('showGrid', this.checked)" class="check-box">
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm" data-i18n="opt_ar">ğŸ¥ ARã‚«ãƒ¡ãƒ©</span>
                    <input type="checkbox" id="toggle-ar" onchange="App.toggleAR(this.checked)" class="check-box">
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span data-i18n="opt_bg">èƒŒæ™¯ã®æ¿ƒã•</span><span id="val-bg" class="text-cyan-400">100%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="App.setOpacity('bg', this.value)">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span data-i18n="opt_milky">å¤©ã®å· (Milky Way)</span><span id="val-milky" class="text-cyan-400">50%</span></div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="App.setOpacity('milky', this.value)">
                </div>
            </div>

            <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-yellow-300">âš¡ Reset Rotation</span>
                        <div class="text-[10px] text-slate-400">å›è»¢è£œæ­£ã‚’0ã«æˆ»ã—ã¾ã™</div>
                    </div>
                    <button onclick="App.state.manualOffset = 0; Utils.toast('Reset OK');" class="px-3 py-1 rounded bg-white/10 text-xs">RESET</button>
                </div>
            </div>

            <!-- Language -->
            <div class="pt-4 border-t border-white/10">
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-300">ğŸ‡ºğŸ‡¸ English Mode</span>
                    <input type="checkbox" onchange="App.setLang(this.checked ? 'en' : 'ja')" class="check-box">
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full shadow-2xl text-sm opacity-0 pointer-events-none transition-opacity z-[60] border border-cyan-500/30 font-bold text-center w-max max-w-[90%] backdrop-blur">Msg</div>

<script>
/**
 * ğŸŒŒ FIVE ISLANDS STARGAZER v26 (World Lock Edition)
 * Key Features:
 * - World Rotation System: Rotate the sky, not the camera.
 * - Horizon Grid: Visual reference for N/S/E/W and Horizon.
 * - Swipe to Adjust: Intuitive correction.
 */

// --- 0. DATA & CONSTANTS ---
const I18N = {
    ja: {
        guide_title: "æ˜Ÿåº§è©³ç´°è§£èª¬",
        settings_title: "è¨­å®š (Settings)",
        cat_title: "è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª (Categories)",
        cat_famous: "ğŸ¦ æœ‰åãªæ˜Ÿåº§ (Famous)",
        cat_star_gal: "âœ¨ æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³ (Stars/Gal)",
        cat_medium: "ğŸ» æ™®é€šã®æ˜Ÿåº§ (Medium)",
        cat_minor: "ğŸ¦ ãƒã‚¤ãƒŠãƒ¼æ˜Ÿåº§ (Minor)",
        opt_title: "è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ (Visibility)",
        opt_info: "ğŸŒŸ æ˜Ÿåº§ã®è§£èª¬ã‚’è¡¨ç¤º",
        opt_ar: "ğŸ¥ ARã‚«ãƒ¡ãƒ©",
        opt_bg: "èƒŒæ™¯ã®æ¿ƒã•",
        opt_milky: "å¤©ã®å· (Milky Way)",
        loc_fixed: "äº”å³¶åˆ—å³¶ (Fixed)",
        loc_gps: "ç¾åœ¨åœ° (GPS)",
        nav_start: "ã¸ã®ãƒŠãƒ“ã‚’é–‹å§‹ ğŸš€",
        nav_end: "ãƒŠãƒ“ã‚’çµ‚äº†ã—ã¾ã—ãŸ",
        constellation: "æ˜Ÿåº§",
        famous_const: "æœ‰åãªæ˜Ÿåº§",
        star_gal: "æœ‰åãªæ˜Ÿãƒ»éŠ€æ²³",
        time_travel: "æ™‚é–“æ—…è¡Œ",
        time_reset: "ç¾åœ¨æ™‚åˆ»ã«æˆ»ã‚‹"
    },
    en: {
        guide_title: "Star Detailed Guide",
        settings_title: "Settings",
        cat_title: "Categories",
        cat_famous: "ğŸ¦ Famous Stars",
        cat_star_gal: "âœ¨ Major Stars & Galaxy",
        cat_medium: "ğŸ» Medium Stars",
        cat_minor: "ğŸ¦ Minor Stars",
        opt_title: "Visibility Options",
        opt_info: "ğŸŒŸ Show Info Bubble",
        opt_ar: "ğŸ¥ AR Camera",
        opt_bg: "Background Opacity",
        opt_milky: "Milky Way Visibility",
        loc_fixed: "Goto Islands (Fixed)",
        loc_gps: "Current loc (GPS)",
        nav_start: "Navigating to ",
        nav_end: "Navigation Ended",
        constellation: "Constellation",
        famous_const: "Famous Constellation",
        star_gal: "Major Star/Galaxy",
        time_travel: "TIME TRAVEL",
        time_reset: "Reset Time"
    }
};

const RANK = { FAMOUS: 1, MEDIUM: 2, MINOR: 3, STAR_GAL: 4 };

// --- CONSTELLATION DB (Reused from v25) ---
const CONSTELLATION_DB = [
    { 
        id: "ori", rank: 1, name: "ã‚ªãƒªã‚ªãƒ³åº§", en: "Orion", 
        desc: "ã€å†¬ã®ç‹è€…ã€‘å¤œç©ºã§æœ€ã‚‚è¯ã‚„ã‹ã§æ•´ã£ãŸæ˜Ÿåº§ã§ã™ã€‚ä¸­å¤®ã«ä¸¦ã¶ã€Œä¸‰ã¤æ˜Ÿã€ã¨ã€ãã‚Œã‚’å–ã‚Šå›²ã‚€4ã¤ã®æ˜ŸãŒç‰¹å¾´çš„ãªã€Œé¼“ï¼ˆã¤ã¥ã¿ï¼‰ã€ã®å½¢ã‚’æãã¾ã™ã€‚å·¦ä¸Šã®èµ¤è‰²è¶…å·¨æ˜Ÿã€Œãƒ™ãƒ†ãƒ«ã‚®ã‚¦ã‚¹ã€ã¯å¤ªé™½ã®ç´„1000å€ã‚‚ã®å¤§ãã•ãŒã‚ã‚Šã€å¤©æ–‡å­¦çš„ãªã‚¹ã‚±ãƒ¼ãƒ«ã§ã¯å¯¿å‘½ãŒå°½ãã‹ã‘ã¦ã„ã‚‹ãŸã‚ã€ã„ã¤è¶…æ–°æ˜Ÿçˆ†ç™ºã‚’èµ·ã“ã—ã¦ã‚‚ãŠã‹ã—ããªã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚", 
        desc_en: "[Winter King] The most spectacular constellation. The three belt stars are surrounded by four stars forming an hourglass shape. The red supergiant Betelgeuse is 1,000 times larger than the Sun.",
        myth: "æµ·ã®ç¥ãƒã‚»ã‚¤ãƒ‰ãƒ³ã®å­ã§ã€æ€ªåŠ›ã®å·¨äººã®ç‹©äººã§ã—ãŸã€‚ã‚µã‚½ãƒªãŒè‹¦æ‰‹ã§ã€ã•ãã‚Šåº§ãŒæ˜‡ã‚‹ã¨è¥¿ã¸æ²ˆã‚“ã§ã„ãã¾ã™ã€‚", myth_en: "Son of Poseidon. He sets in the west whenever the Scorpion rises.",
        centerRA: 5.5, centerDec: -1.0, 
        lines: ["Betelgeuse","Alnitak", "Bellatrix","Mintaka", "Alnitak","Saiph", "Mintaka","Rigel", "Alnitak","Alnilam", "Alnilam","Mintaka", "Betelgeuse","Bellatrix", "Saiph","Rigel", "Betelgeuse","Meissa", "Bellatrix","Meissa"] 
    },
    { 
        id: "sco", rank: 1, name: "ã•ãã‚Šåº§", en: "Scorpius", 
        desc: "ã€å¤ã®Så­—ã€‘å—ã®ç©ºã«å¤§ããæã‹ã‚Œã‚‹Så­—ã‚«ãƒ¼ãƒ–ãŒç‰¹å¾´ã§ã™ã€‚å¿ƒè‡“ã«ä½ç½®ã™ã‚‹èµ¤ã„1ç­‰æ˜Ÿã€Œã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹ã€ã¯ã€Œç«æ˜Ÿï¼ˆAresï¼‰ã«å¯¾æŠ—ï¼ˆAntiï¼‰ã™ã‚‹ã‚‚ã®ã€ã¨ã„ã†æ„å‘³ã‚’æŒã¡ã¾ã™ã€‚", 
        desc_en: "[Summer S-Shape] A large S-curve in the south. The red star Antares means 'Rival of Mars'.",
        myth: "å‚²æ…¢ãªç‹©äººã‚ªãƒªã‚ªãƒ³ã‚’å€’ã™ãŸã‚ã«ç¥ãŒæ”¾ã£ãŸæ¯’ã‚µã‚½ãƒªã§ã™ã€‚", myth_en: "The scorpion sent by the gods to defeat Orion.",
        centerRA: 16.5, centerDec: -26.0, 
        lines: ["Antares","Dschubba", "Dschubba","Graffias", "Dschubba","Pi Sco", "Antares","Wei", "Antares","Tau Sco", "Wei","Mu Sco", "Mu Sco","Zeta Sco", "Zeta Sco","Eta Sco", "Eta Sco","Sargas", "Sargas","Iota Sco", "Iota Sco","Kappa Sco", "Kappa Sco","Shaula", "Shaula","Lesath"] 
    },
    { 
        id: "cas", rank: 2, name: "ã‚«ã‚·ã‚ªãƒšãƒ¤åº§", en: "Cassiopeia", 
        desc: "ã€åŒ—ã®Wå­—ã€‘5ã¤ã®æ˜ŸãŒã€ŒWã€ã®å½¢ã«ä¸¦ã³ã¾ã™ã€‚åŒ—æ¥µæ˜Ÿã‚’æ¢ã™ãŸã‚ã®é‡è¦ãªç›®å°ã§ã™ã€‚", 
        desc_en: "[North W] Features a distinctive 'W' or 'M' shape. A key guide to finding Polaris.",
        myth: "å¤ä»£ã‚¨ãƒã‚ªãƒ”ã‚¢ã®ç‹å¦ƒã€‚å¨˜ã®ç¾ã—ã•ã‚’è‡ªæ…¢ã—ãŸç½°ã§æ¤…å­ã«ç¸›ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚", myth_en: "The vain queen punished by rotating in the sky while tied to her chair.",
        centerRA: 1.0, centerDec: 60.0, 
        lines: ["Caph","Schedar", "Schedar","Gamma Cas", "Gamma Cas","Ruchbah", "Ruchbah","Segin"] 
    },
    { 
        id: "and", rank: 2, name: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€åº§", en: "Andromeda", 
        desc: "ã€éŠ€æ²³ã®çª“ã€‘è†ã®ã‚ãŸã‚Šã«ã¯ã€è‚‰çœ¼ã§è¦‹ãˆã‚‹æœ€ã‚‚é ã„å¤©ä½“ã€Œã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ï¼ˆM31ï¼‰ã€ãŒã‚ã‚Šã¾ã™ã€‚", 
        desc_en: "[Galaxy Window] Home to the Andromeda Galaxy (M31), the farthest object visible to the naked eye.",
        myth: "ç”Ÿè´„ã¨ã—ã¦é–ã§ç¹‹ãŒã‚Œã¾ã—ãŸãŒã€ãƒšãƒ«ã‚»ã‚¦ã‚¹ã«ã‚ˆã£ã¦æ•‘å‡ºã•ã‚Œã¾ã—ãŸã€‚", myth_en: "The princess chained to a rock but saved by Perseus.",
        centerRA: 0.7, centerDec: 38.0, 
        lines: ["Alpheratz","Mirach", "Mirach","Almach"] 
    },
    { 
        id: "sirius", rank: 4, name: "ã‚·ãƒªã‚¦ã‚¹", en: "Sirius", 
        desc: "ã€å…¨å¤©ä¸€ã®è¼ãã€‘ãŠãŠã„ã¬åº§ã«ã‚ã‚‹ã€å¤œç©ºã§æœ€ã‚‚æ˜ã‚‹ã„æ’æ˜Ÿã§ã™ã€‚", 
        desc_en: "The brightest star in the night sky.",
        myth: "ã‚ªãƒªã‚ªãƒ³ãŒé€£ã‚Œã¦ã„ã‚‹çŒŸçŠ¬ã§ã™ã€‚", myth_en: "Orion's hunting dog.",
        centerRA: 6.75, centerDec: -16.7, lines: [] 
    },
    { 
        id: "m31", rank: 4, name: "ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ (M31)", en: "Andromeda Galaxy", 
        desc: "ã€ãŠéš£ã®å·¨å¤§éŠ€æ²³ã€‘ç´„250ä¸‡å…‰å¹´å½¼æ–¹ã«ã‚ã‚‹æ¸¦å·»éŠ€æ²³ã§ã™ã€‚", 
        desc_en: "A giant spiral galaxy 2.5 million light-years away.",
        myth: "40å„„å¹´å¾Œã«å¤©ã®å·éŠ€æ²³ã¨è¡çªã™ã‚‹ã¨äºˆæ¸¬ã•ã‚Œã¦ã„ã¾ã™ã€‚", myth_en: "Predicted to collide with Milky Way.",
        centerRA: 0.7, centerDec: 41.2, lines: [] 
    },
    { 
        id: "polaris", rank: 1, name: "åŒ—æ¥µæ˜Ÿ (Polaris)", en: "Polaris", 
        desc: "ã€ä¸å‹•ã®æ˜Ÿã€‘ã“ãã¾åº§ã®å°»å°¾ã«ã‚ã‚Šã€ã»ã¼çœŸåŒ—ã«ä½ç½®ã—ã¦å‹•ãã¾ã›ã‚“ã€‚æ˜”ã‹ã‚‰æ—…äººã®é“ã—ã‚‹ã¹ã¨ã•ã‚Œã¦ãã¾ã—ãŸã€‚", 
        desc_en: "[The North Star] Located almost exactly at the North Celestial Pole. It does not move.",
        myth: "å¤©ã®åŒ—æ¥µã«ä½ç½®ã™ã‚‹ãŸã‚ã€å…¨ã¦ã®æ˜ŸãŒã“ã®æ˜Ÿã‚’ä¸­å¿ƒã«å›ã£ã¦ã„ã¾ã™ã€‚", myth_en: "All stars revolve around this star.",
        centerRA: 2.5, centerDec: 89.2, lines: [] 
    }
];

// --- STARS DATA (Simplified for length, but functional) ---
const STARS_DATA = [
    { name: "Betelgeuse", ra: 5.919, dec: 7.407, mag: 0.45, ci: 1.85 },
    { name: "Rigel", ra: 5.242, dec: -8.202, mag: 0.12, ci: -0.03 },
    { name: "Bellatrix", ra: 5.418, dec: 6.349, mag: 1.64, ci: -0.22 },
    { name: "Saiph", ra: 5.795, dec: -9.669, mag: 2.07, ci: -0.18 },
    { name: "Alnitak", ra: 5.679, dec: -1.943, mag: 1.74, ci: -0.21 },
    { name: "Alnilam", ra: 5.603, dec: -1.202, mag: 1.69, ci: -0.19 },
    { name: "Mintaka", ra: 5.533, dec: -0.299, mag: 2.25, ci: -0.21 },
    { name: "Meissa", ra: 5.585, dec: 9.934, mag: 3.39, ci: -0.14 },
    { name: "Antares", ra: 16.490, dec: -26.432, mag: 1.06, ci: 1.83 },
    { name: "Dschubba", ra: 16.005, dec: -22.622, mag: 2.29, ci: -0.13 },
    { name: "Graffias", ra: 16.088, dec: -19.805, mag: 2.56, ci: -0.11 },
    { name: "Pi Sco", ra: 15.979, dec: -26.114, mag: 2.89, ci: -0.21 },
    { name: "Wei", ra: 16.834, dec: -38.020, mag: 2.29, ci: 1.14 },
    { name: "Mu Sco", ra: 16.863, dec: -38.048, mag: 3.00, ci: -0.20 },
    { name: "Zeta Sco", ra: 16.904, dec: -42.360, mag: 3.62, ci: 1.50 },
    { name: "Eta Sco", ra: 17.202, dec: -43.238, mag: 3.32, ci: 0.05 },
    { name: "Sargas", ra: 17.623, dec: -42.998, mag: 1.86, ci: 0.38 },
    { name: "Iota Sco", ra: 17.795, dec: -40.125, mag: 2.99, ci: 0.17 },
    { name: "Kappa Sco", ra: 17.703, dec: -39.029, mag: 2.39, ci: -0.20 },
    { name: "Shaula", ra: 17.560, dec: -37.104, mag: 1.62, ci: -0.22 },
    { name: "Lesath", ra: 17.513, dec: -37.291, mag: 2.70, ci: -0.21 },
    { name: "Vega", ra: 18.615, dec: 38.783, mag: 0.03, ci: 0.00 },
    { name: "Altair", ra: 19.846, dec: 8.868, mag: 0.76, ci: 0.22 },
    { name: "Deneb", ra: 20.690, dec: 45.280, mag: 1.25, ci: 0.09 },
    { name: "Schedar", ra: 0.675, dec: 56.537, mag: 2.24, ci: 1.17 },
    { name: "Caph", ra: 0.153, dec: 59.150, mag: 2.28, ci: 0.34 },
    { name: "Gamma Cas", ra: 0.945, dec: 60.717, mag: 2.15, ci: -0.1 },
    { name: "Ruchbah", ra: 1.430, dec: 60.235, mag: 2.66, ci: 0.13 },
    { name: "Segin", ra: 1.907, dec: 63.670, mag: 3.35, ci: 0.26 },
    { name: "Alpheratz", ra: 0.139, dec: 29.090, mag: 2.07, ci: -0.11 },
    { name: "Mirach", ra: 1.162, dec: 35.620, mag: 2.07, ci: 1.64 },
    { name: "Almach", ra: 2.064, dec: 42.329, mag: 2.10, ci: 1.37 },
    { name: "Polaris", ra: 2.530, dec: 89.264, mag: 1.97, ci: 0.63 },
    { name: "Sirius", ra: 6.752, dec: -16.716, mag: -1.46, ci: 0.00 },
    { name: "M31 Andromeda Galaxy", ra: 0.712, dec: 41.269, mag: 3.44, ci: 0.80 },
    { name: "M45 Pleiades", ra: 3.783, dec: 24.116, mag: 1.6, ci: -0.05 },
    { name: "M42 Orion Nebula", ra: 5.588, dec: -5.391, mag: 4.0, ci: 0.50 }
];

// --- 1. VECTOR ENGINE (v26 World Lock) ---
const Math3D = {
    qMultiply: (a, b) => {
        const ax = a[0], ay = a[1], az = a[2], aw = a[3];
        const bx = b[0], by = b[1], bz = b[2], bw = b[3];
        return [
            ax * bw + aw * bx + ay * bz - az * by,
            ay * bw + aw * by + az * bx - ax * bz,
            az * bw + aw * bz + ax * by - ay * bx,
            aw * bw - ax * bx - ay * by - az * bz
        ];
    },
    qFromAxisAngle: (axis, angle) => {
        const halfAngle = angle / 2;
        const s = Math.sin(halfAngle);
        return [axis[0] * s, axis[1] * s, axis[2] * s, Math.cos(halfAngle)];
    },
    matFromQ: (q) => {
        const x = q[0], y = q[1], z = q[2], w = q[3];
        const x2 = x + x, y2 = y + y, z2 = z + z;
        const xx = x * x2, xy = x * y2, xz = x * z2;
        const yy = y * y2, yz = y * z2, zz = z * z2;
        const wx = w * x2, wy = w * y2, wz = w * z2;
        return [
            1 - (yy + zz), xy - wz, xz + wy, 0,
            xy + wz, 1 - (xx + zz), yz - wx, 0,
            xz - wy, yz + wx, 1 - (xx + yy), 0,
            0, 0, 0, 1
        ];
    },
    // NEW: Rotate Vector around Z-axis (World Rotation)
    rotateZ: (vec, angleDeg) => {
        const rad = angleDeg * Math.PI / 180;
        const cos = Math.cos(rad);
        const sin = Math.sin(rad);
        return {
            x: vec.x * cos - vec.y * sin,
            y: vec.x * sin + vec.y * cos,
            z: vec.z
        };
    },
    project: (vec, viewMat, width, height, fovDeg) => {
        // â˜… COORDINATE FIX: World(Z-up) to GL(Y-up, -Z forward)
        // World: X=East, Y=North, Z=Up
        // GL:    X=Right, Y=Up, -Z=Forward
        // Map:   World.X -> GL.X, World.Z -> GL.Y, World.Y -> GL.-Z (North is forward/into screen)
        const v = { x: vec.x, y: vec.z, z: -vec.y };

        // Apply View Matrix
        const x = v.x*viewMat[0] + v.y*viewMat[4] + v.z*viewMat[8];
        const y = v.x*viewMat[1] + v.y*viewMat[5] + v.z*viewMat[9];
        const z = v.x*viewMat[2] + v.y*viewMat[6] + v.z*viewMat[10];
        
        if (z >= -0.1) return null; // Clipping
        const scale = (height / 2) / Math.tan(fovDeg * Math.PI / 360);
        return { x: x*(scale/-z)+width/2, y: -y*(scale/-z)+height/2, z: z };
    }
};

// --- 2. ASTRO PHYSICS ---
const Astro = {
    getLST: (lon, date, offsetHours) => {
        const t = date.getTime() + offsetHours * 3600000;
        const d = (t/1000 - 946727935.816) / 86400;
        return ((18.697374558 + 24.06570982441908 * d) % 24 + lon/15 + 24) % 24;
    },
    // Returns Vector in Horizontal Coordinates (N=y+, E=x+, Z=z+)
    getStarVector: (ra, dec, lat, lst) => {
        const haRad = (lst - ra) * 15 * Math.PI / 180;
        const decRad = dec * Math.PI / 180;
        const latRad = lat * Math.PI / 180;
        const sinAlt = Math.sin(decRad)*Math.sin(latRad) + Math.cos(decRad)*Math.cos(latRad)*Math.cos(haRad);
        const altRad = Math.asin(sinAlt);
        const cosAz = (Math.sin(decRad) - Math.sin(altRad)*Math.sin(latRad)) / (Math.cos(altRad)*Math.cos(latRad));
        let azRad = Math.acos(Math.min(1, Math.max(-1, cosAz)));
        if (Math.sin(haRad) > 0) azRad = 2*Math.PI - azRad;
        
        // Convert Az/Alt to Cartesian (N=Y, E=X, Z=Z)
        // Note: Azimuth is usually measured from North (0) clockwise. 
        // Here we map it to standard math coords where 0 is usually East.
        // But for consistency with rotation logic:
        // x = sin(Az) * cos(Alt) (East component)
        // y = cos(Az) * cos(Alt) (North component)
        // z = sin(Alt)           (Up component)
        return { 
            x: Math.sin(azRad)*Math.cos(altRad), 
            y: Math.cos(azRad)*Math.cos(altRad), 
            z: Math.sin(altRad) 
        };
    },
    // Helper to get vector from Az/Alt directly
    getVectorFromAzAlt: (azDeg, altDeg) => {
        const azRad = azDeg * Math.PI / 180;
        const altRad = altDeg * Math.PI / 180;
        return {
            x: Math.sin(azRad)*Math.cos(altRad),
            y: Math.cos(azRad)*Math.cos(altRad),
            z: Math.sin(altRad) 
        };
    }
};

// --- 3. UTILS ---
const Utils = {
    toast: (msg) => { const el = document.getElementById('toast'); el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000); },
    bvToColor: (bv) => {
        if (bv < 0.0) return {r:180, g:200, b:255}; if (bv < 0.5) return {r:230, g:240, b:255}; 
        if (bv < 1.0) return {r:255, g:255, b:240}; if (bv < 1.5) return {r:255, g:220, b:180}; 
        return {r:255, g:200, b:180}; 
    },
    updateDOMText: () => {
        const dict = I18N[App.state.lang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) el.innerHTML = dict[key];
        });
        const locKey = App.state.useGPS ? 'loc_gps' : 'loc_fixed';
        const txt = App.state.useGPS ? `${dict[locKey]} (${App.state.lat.toFixed(1)},${App.state.lon.toFixed(1)})` : dict[locKey];
        document.getElementById('loc-name').innerText = txt;
    }
};

// --- 4. GUIDE SYSTEM ---
const Guide = {
    target: null,
    toggle: () => {
        const el = document.getElementById('guide-modal');
        if (el.classList.contains('hidden-force')) { Guide.buildList(); el.classList.remove('hidden-force'); } else { el.classList.add('hidden-force'); }
    },
    buildList: () => {
        const list = document.getElementById('guide-list'); list.innerHTML = '';
        const dict = I18N[App.state.lang];
        const categories = [
            { id: RANK.FAMOUS, title: dict.cat_famous, icon: 'ğŸ¦', color: 'text-yellow-400' },
            { id: RANK.STAR_GAL, title: dict.cat_star_gal, icon: 'âœ¨', color: 'text-cyan-400' }, 
            { id: RANK.MEDIUM, title: dict.cat_medium, icon: 'ğŸ»', color: 'text-blue-300' },
            { id: RANK.MINOR, title: dict.cat_minor, icon: 'ğŸ¦', color: 'text-slate-400' }
        ];
        categories.forEach(cat => {
            const items = CONSTELLATION_DB.filter(c => c.rank === cat.id);
            if (items.length === 0) return;
            const details = document.createElement('details'); details.className = "group mb-4"; details.open = true;
            details.innerHTML = `<summary class="flex items-center gap-2 cursor-pointer bg-white/5 p-3 rounded-lg hover:bg-white/10 transition mb-2"><span class="${cat.color} text-xl">${cat.icon}</span><span class="font-bold text-white text-sm flex-1">${cat.title}</span><span class="text-xs text-slate-500 group-open:rotate-180 transition">â–¼</span></summary>`;
            const content = document.createElement('div'); content.className = "space-y-3 pl-2";
            items.forEach(c => {
                const name = App.state.lang === 'en' ? c.en : c.name;
                const desc = App.state.lang === 'en' ? c.desc_en : c.desc;
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl border border-white/10 bg-slate-800/80 backdrop-blur-sm`;
                div.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg text-white">${name}</h3></div><span class="px-2 py-1 bg-green-500/20 text-green-400 text-[10px] font-bold rounded uppercase">âœ¨ INFO</span></div><p class="text-sm text-slate-300 mb-2 font-bold leading-relaxed">${desc}</p><button onclick="Guide.startNav('${c.id}')" class="w-full py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 mt-2 bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg">ğŸ”­ GOTO NAVI</button>`;
                content.appendChild(div);
            });
            details.appendChild(content); list.appendChild(details);
        });
    },
    startNav: (id) => {
        const c = CONSTELLATION_DB.find(x => x.id === id); if (!c) return;
        Guide.target = { ...c }; App.state.mode = 'guide';
        document.getElementById('guide-modal').classList.add('hidden-force');
        document.getElementById('nav-ui').classList.remove('hidden-force');
        document.getElementById('nav-target-name').innerText = App.state.lang==='en' ? c.en : c.name;
        document.getElementById('btn-cancel-nav').classList.remove('hidden-force');
        Utils.toast(`${I18N[App.state.lang].nav_start}`);
    },
    stopNav: () => {
        Guide.target = null; App.state.mode = 'normal';
        document.getElementById('nav-ui').classList.add('hidden-force');
        document.getElementById('btn-cancel-nav').classList.add('hidden-force');
        Utils.toast(I18N[App.state.lang].nav_end);
    }
};

// --- 5. GATEKEEPER ---
const Gate = {
    check: () => {
        const isMobile = ('ontouchstart' in window) && (window.innerWidth <= 1024);
        if (isMobile) {
            document.getElementById('app-container').classList.remove('hidden-force'); document.getElementById('start-modal').classList.remove('hidden-force');
        } else {
            document.getElementById('star-gate').classList.remove('hidden-force');
            new QRious({element:document.getElementById('qr-canvas'),value:window.location.href,size:180});
        }
    },
    startUnlock: () => {
        document.getElementById('star-gate').classList.add('hidden-force');
        document.getElementById('app-container').classList.remove('hidden-force');
        document.getElementById('start-modal').classList.remove('hidden-force');
        App.state.isDev = true;
    }
};

// --- 6. APP CORE ---
const App = {
    canvas: null, ctx: null, width: 0, height: 0,
    state: {
        lat: 32.698, lon: 128.839,
        viewMat: [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1],
        manualOffset: 0, // WORLD ROTATION OFFSET
        mode: 'normal', viewMode: 0,
        ranks: { [RANK.FAMOUS]: true, [RANK.MEDIUM]: true, [RANK.MINOR]: true, [RANK.STAR_GAL]: true },
        isAR: false, useGPS: false, opacity: {bg:1, milky:0.5},
        showInfo: true, showGrid: true, meteorEnabled: true, lang: 'ja',
        stars: [], milkyWay: [], meteors: [],
        fov: 60, orientation: { alpha: 0, beta: 90, gamma: 0 }
    },

    init: async () => {
        document.getElementById('start-modal').classList.add('hidden-force');
        document.getElementById('toggle-ar').checked = false; App.toggleAR(false);
        setTimeout(() => { document.getElementById('swipe-hint').style.opacity = 1; }, 2000);
        setTimeout(() => { document.getElementById('swipe-hint').style.opacity = 0; }, 6000);

        App.canvas = document.getElementById('sky-canvas'); App.ctx = App.canvas.getContext('2d');
        
        // Stars Data
        STARS_DATA.forEach(s => App.state.stars.push(s));
        for(let i=0; i<800; i++) App.state.stars.push({ ra: Math.random()*24, dec: Math.random()*180-90, mag: Math.random()*3+3.5, ci: Math.random()*1.5, isProc: true });
        
        // Milky Way
        const mwPoints = [{ra:0,dec:63, w:20}, {ra:6,dec:10, w:15}, {ra:12,dec:-60, w:30}, {ra:18,dec:-15, w:40}, {ra:23,dec:60, w:22}];
        for(let i=0; i<mwPoints.length-1; i++) {
            const p1 = mwPoints[i], p2 = mwPoints[i+1];
            for(let j=0; j<400; j++) {
                const t = j/400;
                App.state.milkyWay.push({
                    ra: p1.ra+(p2.ra-p1.ra)*t + (Math.random()-0.5)*2,
                    dec: p1.dec+(p2.dec-p1.dec)*t + (Math.random()-0.5)*p1.w*1.5,
                    size: Math.random()*100+100, alpha: Math.random()*0.015+0.005,
                    r:200, g:220, b:255
                });
            }
        }

        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { const res = await DeviceOrientationEvent.requestPermission(); if (res==='granted') window.addEventListener('deviceorientation', App.handleOri); } catch(e){}
        } else { window.addEventListener('deviceorientation', App.handleOri); }
        try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}

        window.addEventListener('resize', App.resize);
        App.setupTouch(); App.resize(); App.loop();
    },

    handleOri: (e) => {
        const k = 0.15; // Smoothing
        const lerpAngle = (c, p) => {
            let d = c - p; while (d > 180) d -= 360; while (d < -180) d += 360; return p + d * k;
        };
        let { alpha, beta, gamma, webkitCompassHeading } = e;
        if(alpha == null) return;
        
        if (!App.state.lastOri) App.state.lastOri = { alpha, beta, gamma, compass: webkitCompassHeading||0 };
        const last = App.state.lastOri;
        
        App.state.orientation = { 
            alpha: lerpAngle(alpha, last.alpha),
            beta: lerpAngle(beta, last.beta),
            gamma: lerpAngle(gamma, last.gamma),
            isIOS: !!webkitCompassHeading,
            compass: webkitCompassHeading ? lerpAngle(webkitCompassHeading, last.compass) : null
        };
        App.state.lastOri = { ...App.state.orientation };
    },

    // --- PURE CAMERA MATRIX (FIXED AXIS) ---
    updateViewMatrix: () => {
        const { alpha, beta, gamma, isIOS, compass } = App.state.orientation;
        const deg2rad = Math.PI / 180;
        
        // â˜… FIX: Axis Mapping and Rotation Direction
        // Standard Web API:
        // Alpha: Z-axis rotation (0=North, 90=West? East? -> Browser dependent but often CCW from North)
        // Beta: X-axis rotation (Front-to-Back tilt)
        // Gamma: Y-axis rotation (Left-to-Right tilt)
        
        // Our Goal:
        // Beta=90 (Upright) -> Look at Horizon (North, Y-axis in World) -> Camera Forward (-Z in GL)
        // Beta=0 (Flat/Up) -> Look at Zenith (Up, Z-axis in World) -> Camera Up (Y in GL)

        // 1. Get Heading
        // For iOS: compass is 0=N, 90=E (CW). We need -compass to make it CCW.
        // For Android: alpha is usually 0=N, 90=E (CCW?).
        // Empirical Fix: Reverse alpha to match World Rotation logic.
        let a = isIOS && compass != null ? -compass : alpha;
        
        // 2. Build Rotation Quaternions (Standard Order: Z -> X -> Y)
        const qAlpha = Math3D.qFromAxisAngle([0, 0, 1], a * deg2rad); // Z-axis (Heading)
        const qBeta = Math3D.qFromAxisAngle([1, 0, 0], beta * deg2rad); // X-axis (Pitch)
        const qGamma = Math3D.qFromAxisAngle([0, 1, 0], gamma * deg2rad); // Y-axis (Roll)

        // Combined Rotation (Device Attitude)
        // Order matters: Apply Z (heading), then X (tilt), then Y (roll)
        let qDev = Math3D.qMultiply(qAlpha, qBeta);
        qDev = Math3D.qMultiply(qDev, qGamma);

        // 3. Screen Orientation Fix (Landscape/Portrait)
        let screenOrient = window.screen?.orientation?.angle || window.orientation || 0;
        const qScreen = Math3D.qFromAxisAngle([0, 0, 1], -screenOrient * deg2rad);
        qDev = Math3D.qMultiply(qDev, qScreen);

        // 4. Final View Matrix
        App.state.viewMat = Math3D.matFromQ(qDev);

        // Debug Display
        const starFwdZ = -App.state.viewMat[10];
        const alt = Math.asin(starFwdZ) * 180/Math.PI; 
        document.getElementById('debug-alt').innerText = Math.round(alt);
    },

    loop: () => {
        App.updateViewMatrix();
        const {ctx, width, height, state} = App;
        ctx.clearRect(0,0,width,height);
        
        const isSolar = state.viewMode === 2;
        if (state.opacity.bg > 0) {
            const alpha = state.isAR ? state.opacity.bg : 1;
            const grad = ctx.createLinearGradient(0,0,0,height);
            if (isSolar) { grad.addColorStop(0, `rgba(135,206,235,${alpha})`); grad.addColorStop(1, `rgba(224,247,250,${alpha})`); }
            else { grad.addColorStop(0, `rgba(2,6,23,${alpha})`); grad.addColorStop(1, `rgba(15,23,42,${alpha})`); }
            ctx.fillStyle = grad; ctx.fillRect(0,0,width,height);
        }

        const lst = Astro.getLST(state.lon, new Date(), 0);
        const worldOffset = state.manualOffset; // â˜… THE WORLD LOCK KEY

        // --- GRID DRAWING ---
        if (state.showGrid) {
            ctx.lineWidth = 1; 
            ctx.strokeStyle = isSolar ? "rgba(0,0,0,0.2)" : "rgba(34,211,238,0.3)";
            ctx.fillStyle = isSolar ? "#000" : "#22d3ee";
            ctx.font = "10px monospace";
            
            // Horizon
            const horizonPts = [];
            for(let az=0; az<=360; az+=5) {
                let vec = Astro.getVectorFromAzAlt(az, 0);
                vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE GRID
                const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if(p) horizonPts.push(p);
            }
            if(horizonPts.length > 1) {
                ctx.beginPath();
                ctx.moveTo(horizonPts[0].x, horizonPts[0].y);
                for(let i=1; i<horizonPts.length; i++) ctx.lineTo(horizonPts[i].x, horizonPts[i].y);
                ctx.stroke();
            }

            // Cardinals
            const cards = [{az:0,l:"N"}, {az:90,l:"E"}, {az:180,l:"S"}, {az:270,l:"W"}];
            cards.forEach(c => {
                ctx.beginPath();
                for(let alt=-20; alt<=80; alt+=10) {
                    let vec = Astro.getVectorFromAzAlt(c.az, alt);
                    vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE GRID
                    const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
                    if(p) {
                        if(alt===-20) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                        if(alt===0) ctx.fillText(c.l, p.x, p.y-5);
                    }
                }
                ctx.stroke();
            });
        }

        // --- MILKY WAY ---
        if (!isSolar && state.opacity.milky > 0) {
            ctx.globalCompositeOperation = 'lighter'; 
            state.milkyWay.forEach(p => {
                let vec = Astro.getStarVector(p.ra, p.dec, state.lat, lst);
                vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE SKY
                const pos = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if (pos) {
                    const size = p.size * (width/1500);
                    const grad = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, size);
                    grad.addColorStop(0, `rgba(${p.r},${p.g},${p.b},${p.alpha * state.opacity.milky})`);
                    grad.addColorStop(1, `rgba(${p.r},${p.g},${p.b},0)`);
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(pos.x, pos.y, size, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.globalCompositeOperation = 'source-over';
        }

        // --- STARS ---
        const starPos = {};
        state.stars.forEach(s => {
            let vec = Astro.getStarVector(s.ra, s.dec, state.lat, lst);
            vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE SKY
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            if (p) {
                if(s.name) starPos[s.name] = p;
                let col = s.isProc ? {r:255,g:255,b:255} : Utils.bvToColor(s.ci||0.5);
                let size = s.isProc ? Math.random()*1 : Math.max(0.8, (3.5-s.mag)*1.2);
                let alpha = (s.mag<2?1.0:0.6);
                if (isSolar) { size*=0.8; alpha=0.7; col={r:0,g:0,b:0}; }
                ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${alpha})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI*2); ctx.fill();
            }
        });

        // --- CONSTELLATIONS ---
        ctx.strokeStyle = isSolar ? "rgba(0,0,0,0.3)" : "rgba(34,211,238,0.6)"; ctx.lineWidth = 2;
        ctx.beginPath();
        const visibleConsts = [];
        
        CONSTELLATION_DB.forEach(c => {
            if (!state.ranks[c.rank]) return;
            const isTarget = (state.mode === 'guide' && Guide.target && Guide.target.id === c.id);
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = "#4ade80"; ctx.lineWidth = 3; }
            
            // 1. Line Drawing
            if (c.lines && c.lines.length > 0) {
                let cx=0, cy=0, n=0;
                for(let i=0; i<c.lines.length; i+=2) {
                    const p1 = starPos[c.lines[i]]; const p2 = starPos[c.lines[i+1]];
                    if(p1 && p2) { 
                        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); 
                        cx+=(p1.x+p2.x)/2; cy+=(p1.y+p2.y)/2; n++;
                    }
                }
                if(n>0) {
                    cx/=n; cy/=n;
                    const d = Math.hypot(cx-width/2, cy-height/2);
                    if(c.rank === 1 || d < 200) {
                        visibleConsts.push({c, x:cx, y:cy, dist:d});
                        ctx.fillStyle = isTarget ? "#4ade80" : (isSolar ? "#000" : "#fff");
                        ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                        ctx.fillText(App.state.lang==='en' ? c.en : c.name, cx, cy);
                    }
                }
            } 
            // 2. Point Objects (Rank 4 etc)
            else {
                let vec = Astro.getStarVector(c.centerRA, c.centerDec, state.lat, lst);
                vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE SKY
                const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
                if(p) {
                    const d = Math.hypot(p.x-width/2, p.y-height/2);
                    if(d < 200 || isTarget) {
                        visibleConsts.push({c, x:p.x, y:p.y, dist:d});
                        ctx.fillStyle = isTarget ? "#4ade80" : "#fbbf24";
                        ctx.font = isTarget ? "bold 14px 'Zen Maru Gothic'" : "10px 'Zen Maru Gothic'";
                        ctx.fillText(App.state.lang==='en' ? c.en : c.name, p.x, p.y - 10);
                        ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                    }
                }
            }
            if(isTarget) { ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = isSolar?"rgba(0,0,0,0.3)":"rgba(34,211,238,0.6)"; ctx.lineWidth = 2; }
        });
        ctx.stroke();

        // --- BUBBLE & NAV ---
        const bubble = document.getElementById('smart-bubble');
        if (state.showInfo && visibleConsts.length > 0) {
            visibleConsts.sort((a,b) => a.dist - b.dist);
            const target = visibleConsts[0];
            if (target.dist < 150) {
                document.getElementById('bubble-title').innerText = state.lang==='en' ? target.c.en : target.c.name;
                document.getElementById('bubble-desc').innerText = state.lang==='en' ? target.c.desc_en : target.c.desc;
                bubble.style.left = (Math.min(Math.max(target.x, 140), width-140) - 128) + 'px'; 
                bubble.style.top = Math.max(target.y - 140, 20) + 'px';
                bubble.style.opacity = 1;
            } else bubble.style.opacity = 0;
        } else bubble.style.opacity = 0;

        if (state.mode === 'guide' && Guide.target) {
            const t = Guide.target;
            let vec = Astro.getStarVector(t.centerRA, t.centerDec, state.lat, lst);
            vec = Math3D.rotateZ(vec, worldOffset); // â˜… ROTATE SKY
            const p = Math3D.project(vec, state.viewMat, width, height, state.fov);
            const lockEl = document.getElementById('lock-on');
            if (p && p.x>50 && p.x<width-50 && p.y>50 && p.y<height-50) {
                lockEl.style.opacity = 1; lockEl.style.left = p.x + 'px'; lockEl.style.top = p.y + 'px';
            } else lockEl.style.opacity = 0;
        }
        
        requestAnimationFrame(App.loop);
    },

    resize: () => { 
        App.width = window.innerWidth; App.height = window.innerHeight; 
        App.canvas.width = App.width; App.canvas.height = App.height; 
        App.state.fov = (App.width > App.height) ? 28 : 60; // Landscape/Portrait FOV
    },

    // --- UI TOGGLES ---
    toggleLocation: () => { 
        if(!App.state.useGPS) {
            navigator.geolocation.getCurrentPosition(pos => {
                App.state.lat = pos.coords.latitude; App.state.lon = pos.coords.longitude;
                App.state.useGPS = true; Utils.updateDOMText(); Utils.toast(I18N[App.state.lang].loc_gps + " OK");
            }, () => Utils.toast("GPS Error"));
        } else {
            App.state.lat = 32.698; App.state.lon = 128.839; App.state.useGPS = false; Utils.updateDOMText(); Utils.toast(I18N[App.state.lang].loc_fixed);
        }
    },
    toggleSettings: () => document.getElementById('settings-modal').classList.toggle('hidden-force'),
    toggleTimeSlider: () => { document.getElementById('time-slider-container').classList.toggle('active'); Utils.toast(I18N[App.state.lang].time_travel); },
    setTimeOffset: (val) => { App.state.timeOffset = parseFloat(val); document.getElementById('time-display').innerText = `TIME TRAVEL: ${val}h`; },
    resetTime: (val) => { if(val==0) Utils.toast(I18N[App.state.lang].time_reset); },
    toggleAR: (v) => { 
        App.state.isAR = v; const cam = document.getElementById('camera-feed');
        if (v) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => { cam.srcObject = stream; cam.style.opacity = 1; })
                .catch(e => Utils.toast("Cam Error"));
            App.setOpacity('bg', 0.0); document.querySelector('input[oninput*="bg"]').value = 0.0;
        } else {
            if (cam.srcObject) cam.srcObject.getTracks().forEach(t => t.stop());
            cam.srcObject = null; cam.style.opacity = 0;
            App.setOpacity('bg', 1); document.querySelector('input[oninput*="bg"]').value = 1;
        }
    },
    toggleViewMode: () => {
        App.state.viewMode = (App.state.viewMode + 1) % 3;
        const body = document.body, btn = document.getElementById('btn-mode');
        body.classList.remove('mode-red', 'mode-solar');
        if(App.state.viewMode === 1) { body.classList.add('mode-red'); btn.innerText = "ğŸ”´"; }
        else if(App.state.viewMode === 2) { body.classList.add('mode-solar'); btn.innerText = "â˜€ï¸"; }
        else btn.innerText = "ğŸŒ™";
    },
    setOpacity: (k,v) => { App.state.opacity[k] = parseFloat(v); if(k==='bg')document.getElementById('val-bg').innerText=Math.round(v*100)+"%"; if(k==='milky')document.getElementById('val-milky').innerText=Math.round(v*100)+"%"; },
    setRank: (r,v) => { App.state.ranks[r] = v; Guide.buildList(); },
    setFlag: (k,v) => App.state[k] = v,
    setLang: (l) => { App.state.lang = l; Guide.buildList(); Utils.updateDOMText(); },
    takeScreenshot: () => { const l=document.createElement('a'); l.download='stargazer-v26.png'; l.href=App.canvas.toDataURL(); l.click(); Utils.toast("Saved ğŸ“¸"); },

    // --- TOUCH TO ROTATE WORLD ---
    setupTouch: () => {
        let lx = 0, isDragging = false;
        const indic = document.getElementById('offset-indicator');
        const indicVal = document.getElementById('offset-val');
        
        window.addEventListener('touchstart', e => { lx = e.touches[0].clientX; isDragging = true; });
        window.addEventListener('touchmove', e => {
            if(!isDragging) return;
            const dx = e.touches[0].clientX - lx; 
            // Sensitivity: Pixels to Degrees
            App.state.manualOffset += dx * 0.2; 
            lx = e.touches[0].clientX;
            
            // Show Indicator
            indic.style.opacity = 1;
            indicVal.innerText = `${Math.round(App.state.manualOffset)}Â°`;
        });
        window.addEventListener('touchend', () => { 
            isDragging = false; 
            indic.style.opacity = 0; 
        });
    }
};

window.onload = () => Gate.check();
</script>
<script>
    // Service Worker Registration with Protocol Check to avoid "URL protocol not supported" error in Preview/Canvas
    if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('StarGazer: SW Registered!', reg))
                .catch(err => console.warn('StarGazer: SW Registration Failed (Ignore in Preview)', err));
        });
    }
</script>
</body>
</html>
