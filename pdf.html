<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF All-in-One Pro v3.6 (Final Perfect)</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Processing Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Image Conversion Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'aurora-1': 'aurora-1 10s infinite ease-in-out',
                        'aurora-2': 'aurora-2 12s infinite ease-in-out',
                        'fade-in-up': 'fade-in-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'aurora-1': {
                            '0%, 100%': { transform: 'translate(0, 0) scale(1)' },
                            '50%': { transform: 'translate(20px, -20px) scale(1.1)' },
                        },
                        'aurora-2': {
                            '0%, 100%': { transform: 'translate(0, 0) scale(1)' },
                            '50%': { transform: 'translate(-20px, 10px) scale(1.2)' },
                        },
                        'fade-in-up': {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile-first scroll behavior */
        body { margin: 0; overflow-x: hidden; background-color: #020617; font-family: 'Helvetica Neue', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar for PC */
        @media (min-width: 768px) {
            ::-webkit-scrollbar { width: 8px; height: 8px; }
            ::-webkit-scrollbar-track { background: #0f172a; }
            ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #475569; }
            * { scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.75rem;
        }
        
        /* Safe area for iPhone X+ */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Switch Toggle Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // --- Icons ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Scissors = (props) => <IconBase {...props}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></IconBase>;
        const Merge = (props) => <IconBase {...props}><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22"/><path d="m20 22-5-5"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const Images = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
        
        const RotateCw = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></IconBase>;
        const CheckCircle2 = (props) => <IconBase {...props}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const FileIcon = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ArrowUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;
        const ArrowDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const Undo2 = (props) => <IconBase {...props}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></IconBase>;
        const Film = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></IconBase>;
        const FileArchive = (props) => <IconBase {...props}><path d="M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><circle cx="10" cy="20" r="2"/><path d="M10 7V6"/><path d="M10 12v-1"/><path d="M10 18v-2"/></IconBase>;
        const ScrollText = (props) => <IconBase {...props}><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></IconBase>;
        const Presentation = (props) => <IconBase {...props}><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Hash = (props) => <IconBase {...props}><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;

        // --- Thumbnail Component (Optimized) ---
        const DraggableThumbnail = React.memo(({ pageItem, index, onRotate, onDelete, onDragStart, onDragEnter, onDragEnd }) => {
            const canvasRef = useRef(null);
            const [rendered, setRendered] = useState(false);

            useEffect(() => {
                let mounted = true;
                const renderPage = async () => {
                    if (!pageItem.pageProxy || rendered || !canvasRef.current) return;
                    
                    const viewport = pageItem.pageProxy.getViewport({ scale: 0.3 });
                    const canvas = canvasRef.current;
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    try {
                        await pageItem.pageProxy.render({ canvasContext: context, viewport }).promise;
                        if(mounted) setRendered(true);
                    } catch (e) { console.error(e); }
                };
                renderPage();
                return () => { mounted = false; };
            }, [pageItem.pageProxy]);

            return (
                <div 
                    draggable
                    onDragStart={(e) => onDragStart(e, index)}
                    onDragEnter={(e) => onDragEnter(e, index)}
                    onDragEnd={onDragEnd}
                    onDragOver={(e) => e.preventDefault()}
                    className={`relative group bg-slate-800 rounded-lg p-2 border border-white/10 transition-all duration-200 cursor-move
                        ${pageItem.deleted ? 'opacity-40 grayscale bg-red-900/10' : 'hover:border-blue-500 hover:shadow-lg hover:shadow-blue-500/10'}
                        active:scale-95 active:cursor-grabbing touch-manipulation
                    `}
                >
                    <div className="flex items-center justify-between mb-1">
                         <span className="text-[10px] text-slate-500 bg-black/30 px-1.5 rounded truncate max-w-[60px]">
                            {pageItem.fileName}
                        </span>
                        <div className="flex gap-1">
                            <button onClick={(e) => {e.stopPropagation(); onRotate(index)}} className="p-1.5 bg-slate-700/50 rounded text-blue-300 transition-colors" title="回転">
                                <RotateCw className="w-3 h-3" />
                            </button>
                            <button onClick={(e) => {e.stopPropagation(); onDelete(index)}} className={`p-1.5 bg-slate-700/50 rounded transition-colors ${pageItem.deleted ? 'text-emerald-400' : 'text-red-400'}`} title={pageItem.deleted ? "復元" : "削除"}>
                                {pageItem.deleted ? <Undo2 className="w-3 h-3" /> : <Trash2 className="w-3 h-3" />}
                            </button>
                        </div>
                    </div>

                    <div className="relative aspect-[1/1.414] w-full flex items-center justify-center bg-white rounded overflow-hidden shadow-inner pointer-events-none">
                        <canvas ref={canvasRef} className="max-w-full max-h-full object-contain transition-transform duration-300" style={{ transform: `rotate(${pageItem.rotation}deg)` }} />
                        {pageItem.deleted && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-900/60 backdrop-blur-[1px] z-10">
                                <span className="text-red-400 font-bold text-[10px] uppercase border border-red-400 px-1.5 py-0.5 rounded">DEL</span>
                            </div>
                        )}
                        <div className="absolute bottom-1 right-1 bg-black/60 text-white text-[9px] px-1.5 rounded z-20 font-mono">
                            {pageItem.origPageIndex + 1}
                        </div>
                    </div>
                </div>
            );
        });

        // --- App Component ---
        function App() {
            // Modes: split, simple_merge, pro_merge, convert
            const [mode, setMode] = useState('pro_merge'); 
            const [isDragging, setIsDragging] = useState(false);
            const [files, setFiles] = useState([]); 
            
            // Pro Merge State
            const [sourceDocs, setSourceDocs] = useState([]); 
            const [pageItems, setPageItems] = useState([]); 
            const [isParsing, setIsParsing] = useState(false);
            const [addPageNumbers, setAddPageNumbers] = useState(false); 
            const [showPageSettings, setShowPageSettings] = useState(false); 

            // Page Number Settings
            const [pageNumFormat, setPageNumFormat] = useState('simple'); // 'simple' | 'hyphen' | 'slash_total' | 'p_slash_total'
            const [pageNumStartPage, setPageNumStartPage] = useState(1); 
            const [pageNumStartNum, setPageNumStartNum] = useState(1); 
            const [pageNumPosV, setPageNumPosV] = useState('bottom'); 
            const [pageNumPosH, setPageNumPosH] = useState('center'); 
            const [pageNumFontSize, setPageNumFontSize] = useState('medium'); // 'small' | 'medium' | 'large'

            const dragItemIndex = useRef(null);
            const dragOverItemIndex = useRef(null);

            // Processing State
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState(0);
            const [statusMessage, setStatusMessage] = useState('');
            const [resultBlob, setResultBlob] = useState(null);
            const [resultName, setResultName] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [resultCount, setResultCount] = useState(0); 
            
            // Settings
            const [splitCount, setSplitCount] = useState(1);
            const [totalPages, setTotalPages] = useState(0); 
            
            // Convert Mode State
            const [generatedImages, setGeneratedImages] = useState([]);
            const [gifStatus, setGifStatus] = useState('idle'); 
            const [longImageStatus, setLongImageStatus] = useState('idle');
            const [pptxStatus, setPptxStatus] = useState('idle');
            const [gifInterval, setGifInterval] = useState(1.0);
            
            const fileInputRef = useRef(null);
            const cancelRef = useRef(false);

            // --- Handlers ---

            const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
            const handleDragLeave = (e) => { e.preventDefault(); setIsDragging(false); };
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    addFiles(Array.from(e.dataTransfer.files));
                }
            };
            const handleFileSelect = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    addFiles(Array.from(e.target.files));
                    e.target.value = ''; // Reset input to allow re-selection
                }
            };
            
            const triggerFileSelect = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const addFiles = async (newFiles) => {
                const validFiles = newFiles.filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
                if (validFiles.length === 0) {
                    alert('PDFファイルのみ選択可能です。');
                    return;
                }

                if (mode === 'pro_merge') {
                    setFiles(prev => [...prev, ...validFiles]);
                    await addToProMerge(validFiles);
                    setStatus('idle');
                } else if (mode === 'convert') {
                    setFiles([validFiles[0]]); 
                    startProcessingConvert(validFiles[0]);
                } else {
                    if (mode === 'split') {
                        setFiles([validFiles[0]]);
                        try {
                            const arrayBuffer = await validFiles[0].arrayBuffer();
                            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                            const pdf = await loadingTask.promise;
                            const pages = pdf.numPages;
                            setTotalPages(pages);
                            if (splitCount > pages) setSplitCount(pages);
                        } catch (e) { console.error(e); setTotalPages(0); }
                    }
                    else {
                        setFiles(prev => [...prev, ...validFiles]);
                    }
                    setStatus('idle');
                }
            };

            const removeFile = (index) => setFiles(prev => prev.filter((_, i) => i !== index));
            const moveFile = (index, direction) => {
                const newFiles = [...files];
                if (direction === 'up' && index > 0) {
                    [newFiles[index - 1], newFiles[index]] = [newFiles[index], newFiles[index - 1]];
                } else if (direction === 'down' && index < newFiles.length - 1) {
                    [newFiles[index + 1], newFiles[index]] = [newFiles[index], newFiles[index + 1]];
                }
                setFiles(newFiles);
            };

            const addToProMerge = async (newFiles) => {
                setIsParsing(true);
                try {
                    const newSourceDocs = [];
                    const newPageItems = [];

                    for (const file of newFiles) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        const docId = Math.random().toString(36).substr(2, 9);
                        newSourceDocs.push({ id: docId, file, pdfDoc: pdf });

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            newPageItems.push({
                                id: Math.random().toString(36).substr(2, 9),
                                docId: docId,
                                pageProxy: page,
                                fileName: file.name,
                                origPageIndex: i - 1,
                                rotation: 0,
                                deleted: false
                            });
                        }
                    }

                    setSourceDocs(prev => [...prev, ...newSourceDocs]);
                    setPageItems(prev => [...prev, ...newPageItems]);
                } catch (e) {
                    console.error(e);
                    setErrorMsg("ファイルの読み込みに失敗しました");
                    setStatus('error');
                } finally {
                    setIsParsing(false);
                }
            };

            const onDragStart = (e, index) => {
                dragItemIndex.current = index;
                e.dataTransfer.effectAllowed = "move";
            };
            
            const onDragEnter = (e, index) => {
                if (dragItemIndex.current === null) return;
                if (dragItemIndex.current === index) return;
                dragOverItemIndex.current = index;
                
                const newItems = [...pageItems];
                const dragItem = newItems[dragItemIndex.current];
                newItems.splice(dragItemIndex.current, 1);
                newItems.splice(index, 0, dragItem);
                
                dragItemIndex.current = index;
                setPageItems(newItems);
            };

            const onDragEnd = () => {
                dragItemIndex.current = null;
                dragOverItemIndex.current = null;
            };

            const toggleRotate = useCallback((index) => {
                setPageItems(prev => {
                    const newItems = [...prev];
                    newItems[index] = { ...newItems[index], rotation: (newItems[index].rotation + 90) % 360 };
                    return newItems;
                });
            }, []);

            const toggleDelete = useCallback((index) => {
                setPageItems(prev => {
                    const newItems = [...prev];
                    newItems[index] = { ...newItems[index], deleted: !newItems[index].deleted };
                    return newItems;
                });
            }, []);

            const switchMode = (m) => {
                setMode(m);
                setFiles([]);
                setSourceDocs([]);
                setPageItems([]);
                setTotalPages(0);
                setStatus('idle');
                setProgress(0);
                setResultBlob(null);
                setGeneratedImages([]);
                setGifStatus('idle');
                setLongImageStatus('idle');
                setPptxStatus('idle');
                setAddPageNumbers(false);
                setShowPageSettings(false);
            };

            const startProcessing = async () => {
                setStatus('processing');
                setProgress(0);
                setErrorMsg('');
                cancelRef.current = false;

                try {
                    switch (mode) {
                        case 'pro_merge': await processProMerge(); break;
                        case 'simple_merge': await processSimpleMerge(); break;
                        case 'split': await processSplit(); break;
                    }
                } catch (err) {
                    console.error(err);
                    setErrorMsg(err.message || "処理に失敗しました");
                    setStatus('error');
                }
            };

            const processProMerge = async () => {
                setStatusMessage("PDFを構築中...");
                const mergedPdf = await PDFLib.PDFDocument.create();
                
                let font;
                if (addPageNumbers) {
                    font = await mergedPdf.embedFont(PDFLib.StandardFonts.Helvetica);
                }
                
                const pdfLibDocs = {}; 
                let loadedCount = 0;
                for (const doc of sourceDocs) {
                    if (cancelRef.current) return;
                    setStatusMessage(`ソースファイルを読み込み中 (${loadedCount + 1}/${sourceDocs.length})...`);
                    const ab = await doc.file.arrayBuffer();
                    pdfLibDocs[doc.id] = await PDFLib.PDFDocument.load(ab);
                    loadedCount++;
                }

                const activeItems = pageItems.filter(p => !p.deleted);
                const total = activeItems.length;

                for (let i = 0; i < total; i++) {
                    if (cancelRef.current) return;
                    setStatusMessage(`ページを結合中 (${i + 1}/${total})...`);
                    
                    const item = activeItems[i];
                    const srcDoc = pdfLibDocs[item.docId];
                    const [copiedPage] = await mergedPdf.copyPages(srcDoc, [item.origPageIndex]);
                    
                    if (item.rotation !== 0) {
                         const currentRotation = copiedPage.getRotation().angle;
                         copiedPage.setRotation(PDFLib.degrees((currentRotation + item.rotation) % 360));
                    }
                    
                    mergedPdf.addPage(copiedPage);
                    
                    // ページ番号の描画
                    const currentPageIndex = i + 1; // 1-based index
                    if (addPageNumbers && currentPageIndex >= pageNumStartPage) {
                         const { width, height } = copiedPage.getSize();
                         
                         let fontSize = 12;
                         if (pageNumFontSize === 'small') fontSize = 9;
                         else if (pageNumFontSize === 'large') fontSize = 16;

                         const margin = 20;

                         // 表示する数値
                         const displayNum = (currentPageIndex - pageNumStartPage) + pageNumStartNum;
                         
                         let text = `${displayNum}`;
                         if (pageNumFormat === 'hyphen') text = `- ${displayNum} -`;
                         else if (pageNumFormat === 'slash_total') text = `${displayNum} / ${total}`;
                         else if (pageNumFormat === 'p_slash_total') text = `${displayNum}p / ${total}p`;

                         const textWidth = font.widthOfTextAtSize(text, fontSize);
                         const textHeight = font.heightAtSize(fontSize);

                         let x, y;
                         // 横位置
                         if (pageNumPosH === 'left') x = margin;
                         else if (pageNumPosH === 'right') x = width - textWidth - margin;
                         else x = width / 2 - textWidth / 2;

                         // 縦位置
                         if (pageNumPosV === 'top') y = height - margin - textHeight;
                         else y = margin;

                         copiedPage.drawText(text, {
                             x,
                             y,
                             size: fontSize,
                             font: font,
                             color: PDFLib.rgb(0, 0, 0),
                         });
                    }

                    setProgress(Math.round(((i + 1) / total) * 100));
                    
                    if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
                }

                setStatusMessage("ファイルを生成中...");
                const bytes = await mergedPdf.save();
                setResultBlob(new Blob([bytes], {type:'application/pdf'}));
                setResultName("merged_pro.pdf");
                setResultCount(1);
                setStatus('complete');
            };

            const processSimpleMerge = async () => {
                setStatusMessage('結合中...');
                const mergedPdf = await PDFLib.PDFDocument.create();
                let step = 90 / files.length; let prog = 0;
                for(let i=0; i<files.length; i++){
                    if(cancelRef.current) return;
                    const ab = await files[i].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(ab);
                    const copied = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copied.forEach(p=>mergedPdf.addPage(p));
                    prog += step; setProgress(Math.round(prog));
                }
                const bytes = await mergedPdf.save();
                setResultBlob(new Blob([bytes], {type:'application/pdf'}));
                setResultName('merged_simple.pdf');
                setResultCount(1);
                setStatus('complete');
            };

            const processSplit = async () => {
                const file = files[0];
                setStatusMessage('PDF解析中...');
                const ab = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(ab);
                const total = pdfDoc.getPageCount();
                
                const safeSplitCount = Math.min(Math.max(1, splitCount), total);
                const zip = new JSZip();
                const baseName = file.name.replace(/\.pdf$/i, '');
                let count = 0;
                for(let i=0; i<total; i+=safeSplitCount) {
                    if(cancelRef.current) return;
                    const newPdf = await PDFLib.PDFDocument.create();
                    const end = Math.min(i+safeSplitCount, total);
                    const indices = []; for(let j=i; j<end; j++) indices.push(j);
                    const copied = await newPdf.copyPages(pdfDoc, indices);
                    copied.forEach(p=>newPdf.addPage(p));
                    const bytes = await newPdf.save();
                    zip.file(`${baseName}_${(count+1).toString().padStart(2,'0')}.pdf`, bytes);
                    count++;
                    setProgress(Math.round((i/total)*100));
                }
                setStatusMessage('ZIP圧縮中...');
                const content = await zip.generateAsync({type:"blob"});
                setResultBlob(content);
                setResultName(`${baseName}_split.zip`);
                setResultCount(count);
                setStatus('complete');
            };

            const startProcessingConvert = async (file) => {
                setStatus('processing');
                setProgress(0);
                setStatusMessage('PDFを画像化中...');
                setGeneratedImages([]);
                setResultBlob(null);
                setGifStatus('idle'); setLongImageStatus('idle'); setPptxStatus('idle');
                cancelRef.current = false;

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const totalPages = pdf.numPages;
                    const images = [];
                    const zip = new JSZip();
                    const folder = zip.folder("images");

                    for (let i = 1; i <= totalPages; i++) {
                        if (cancelRef.current) break;
                        const page = await pdf.getPage(i);
                        const scale = 2.0; 
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport }).promise;
                        
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const dataUrl = canvas.toDataURL('image/png');
                        images.push({ id: i, dataUrl, width: viewport.width, height: viewport.height });
                        folder.file(`slide_${String(i).padStart(2, '0')}.png`, blob);
                        
                        setProgress(Math.round((i / totalPages) * 100));
                        setStatusMessage(`ページ ${i} / ${totalPages} を変換中...`);
                        await new Promise(r => setTimeout(r, 10)); 
                    }
                    if (cancelRef.current) { setStatus('idle'); setFiles([]); return; }
                    setGeneratedImages(images);
                    setStatusMessage('ZIP圧縮中...');
                    const content = await zip.generateAsync({ type: "blob" });
                    setResultBlob(content);
                    setResultName(`${file.name.replace('.pdf', '')}_images.zip`);
                    setStatus('complete');
                } catch (err) {
                    console.error(err);
                    setErrorMsg('処理中にエラーが発生しました。メモリ不足の可能性があります。');
                    setStatus('error');
                }
            };

            const downloadFile = () => { if(resultBlob) saveAs(resultBlob, resultName); };
            const downloadFileLocal = (blob, filename) => saveAs(blob, filename);
            const reset = () => { switchMode(mode); if(fileInputRef.current) fileInputRef.current.value = ''; };
            const cancel = () => { cancelRef.current = true; setStatus('idle'); };
            const getFileSizeMB = (size) => (size ? (size/(1024*1024)).toFixed(1) : '0.0');

            // --- Render ---

            // Improved TabBtn: No more hidden text on mobile, controlled line breaks
            const TabBtn = ({ m, icon: Icon, label }) => (
                <button onClick={() => switchMode(m)} className={`relative z-10 px-1 py-2 rounded-xl text-[10px] md:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1 md:gap-2 flex-1 leading-tight ${mode === m ? 'text-white' : 'text-slate-400 hover:text-white'}`}>
                    <Icon className="w-4 h-4 shrink-0" /> 
                    <span className="text-center break-keep min-w-0">{label}</span>
                </button>
            );

            const generateGif = async () => {
                if (!window.GIF || generatedImages.length === 0) return;
                setGifStatus('processing');
                try {
                    const workerResponse = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                    const workerBlob = await workerResponse.blob();
                    const workerUrl = URL.createObjectURL(workerBlob);
                    const gif = new window.GIF({ workers: 2, quality: 10, workerScript: workerUrl, width: generatedImages[0].width, height: generatedImages[0].height });
                    for (const imgData of generatedImages) {
                        const img = new Image(); img.src = imgData.dataUrl;
                        await new Promise(resolve => { img.complete ? resolve() : img.onload = resolve; });
                        gif.addFrame(img, { delay: gifInterval * 1000 });
                    }
                    gif.on('finished', (blob) => { downloadFileLocal(blob, 'animation.gif'); setGifStatus('complete'); URL.revokeObjectURL(workerUrl); });
                    gif.render();
                } catch (e) { setGifStatus('error'); }
            };
            const generatePptx = async () => {
                if (!window.PptxGenJS || generatedImages.length === 0) return;
                setPptxStatus('processing');
                try {
                    const pptx = new window.PptxGenJS();
                    const firstImg = generatedImages[0];
                    const ratio = firstImg.width / firstImg.height;
                    if (Math.abs(ratio - 16/9) < 0.1) pptx.layout = 'LAYOUT_16x9';
                    else if (Math.abs(ratio - 4/3) < 0.1) pptx.layout = 'LAYOUT_4x3';
                    else { pptx.defineLayout({ name: 'CUSTOM', width: 10, height: 10 / ratio }); pptx.layout = 'CUSTOM'; }
                    for (const imgData of generatedImages) {
                        const slide = pptx.addSlide();
                        slide.addImage({ data: imgData.dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                    }
                    await pptx.writeFile({ fileName: 'slides.pptx' });
                    setPptxStatus('complete');
                } catch (e) { setPptxStatus('error'); }
            };
            const generateLongImage = async () => {
                if (generatedImages.length === 0) return;
                setLongImageStatus('processing');
                try {
                    const maxWidth = Math.max(...generatedImages.map(img => img.width));
                    const totalHeight = generatedImages.reduce((sum, img) => sum + img.height, 0);
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.width = maxWidth; canvas.height = totalHeight; ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width, canvas.height);
                    let currentY = 0;
                    for (const imgData of generatedImages) {
                        const img = new Image(); img.src = imgData.dataUrl;
                        await new Promise(resolve => { img.complete ? resolve() : img.onload = resolve; });
                        const x = (maxWidth - imgData.width) / 2;
                        ctx.drawImage(img, x, currentY); currentY += imgData.height;
                    }
                    canvas.toBlob(b => { if(b){ downloadFileLocal(b, 'long.png'); setLongImageStatus('complete'); } else setLongImageStatus('error'); }, 'image/png');
                } catch(e) { setLongImageStatus('error'); }
            };


            return (
                <div className={`relative min-h-screen bg-slate-950 text-slate-200 font-sans p-4 md:p-6 flex flex-col items-center justify-start md:justify-center selection:bg-blue-500/30 selection:text-blue-100 safe-pb`}>
                    
                    <input type="file" ref={fileInputRef} className="hidden" accept=".pdf" multiple={mode !== 'convert' && mode !== 'split'} onChange={handleFileSelect} />

                    {/* Background */}
                    <div className="fixed inset-0 pointer-events-none">
                        <div className={`absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full blur-[100px] animate-aurora-1 ${mode==='convert' ? 'bg-indigo-600/20' : 'bg-blue-600/20'}`}></div>
                        <div className={`absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] rounded-full blur-[100px] animate-aurora-2 ${mode==='convert' ? 'bg-cyan-600/20' : 'bg-indigo-600/20'}`}></div>
                        <div className="absolute inset-0 opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
                    </div>

                    <div className="w-full max-w-6xl space-y-6 relative z-10 flex flex-col md:h-full md:max-h-[95vh]">
                        {/* Header */}
                        <div className={`text-center space-y-2 shrink-0 transition-all duration-500 ${status === 'complete' ? 'mb-2' : ''}`}>
                            <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 shadow-[0_0_15px_rgba(255,255,255,0.05)] backdrop-blur-md mt-4 md:mt-0`}>
                                <Sparkles className={`w-3.5 h-3.5 ${mode==='convert' ? 'text-cyan-300' : 'text-blue-300'}`} />
                                <span className={`text-[11px] uppercase tracking-[0.2em] font-bold ${mode==='convert' ? 'text-cyan-300/90' : 'text-blue-300/90'}`}>PDF All-in-One Pro</span>
                            </div>
                            {status !== 'complete' && (
                                <h1 className="text-2xl md:text-4xl font-extrabold tracking-tight text-white leading-tight drop-shadow-xl">
                                    {mode === 'pro_merge' ? <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-300 via-indigo-300 to-cyan-300">Pro 結合・編集</span> :
                                     mode === 'convert' ? <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-indigo-300 to-fuchsia-300">画像・変換</span> :
                                     mode === 'split' ? "分割" : "シンプル結合"}
                                </h1>
                            )}
                        </div>

                        {/* Tabs */}
                        {status === 'idle' && (
                            <div className="flex justify-center shrink-0">
                                <div className="bg-slate-900/50 p-1 rounded-xl border border-white/10 flex relative backdrop-blur-md overflow-x-auto max-w-[95vw]">
                                    <div className={`absolute top-1 bottom-1 rounded-lg transition-all duration-300 ease-out shadow-lg ${mode==='convert' ? 'bg-cyan-600' : 'bg-blue-600'}`} 
                                        style={{ 
                                            width: 'calc(25% - 2px)', 
                                            left: mode === 'pro_merge' ? '4px' : 
                                                  mode === 'simple_merge' ? 'calc(25% + 2px)' : 
                                                  mode === 'split' ? '50%' : 'calc(75% - 2px)' 
                                        }}></div>
                                    <TabBtn m="pro_merge" icon={Layers} label="Pro結合" />
                                    <TabBtn m="simple_merge" icon={Merge} label="シンプル" />
                                    <TabBtn m="split" icon={Scissors} label="　分割　" />
                                    <TabBtn m="convert" icon={Images} label="　変換　" />
                                </div>
                            </div>
                        )}

                        {/* Main Card */}
                        <div className={`flex-1 bg-white/5 backdrop-blur-2xl rounded-[2rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 flex flex-col relative transition-all duration-500 mb-4 md:mb-0 
                            ${status==='complete' ? 'max-h-[90vh] overflow-y-auto overflow-x-hidden' : 'overflow-hidden'} 
                            ${mode==='pro_merge' && files.length>0 ? 'min-h-[60vh]' : 'min-h-[300px]'}`}
                        >
                            
                            {/* Pro Merge Editor UI */}
                            {mode === 'pro_merge' && pageItems.length > 0 && status === 'idle' && (
                                <div className="flex flex-col h-full absolute inset-0">
                                    {/* Toolbar */}
                                    <div className="bg-slate-900/40 border-b border-white/5 p-3 flex flex-wrap gap-2 justify-between items-center shrink-0">
                                        <div className="flex items-center gap-2 md:gap-4">
                                            <div className="text-xs text-slate-400 font-mono bg-black/20 px-2 py-1 rounded">
                                                {pageItems.filter(p=>!p.deleted).length}p
                                            </div>
                                            <div className="hidden md:flex text-[10px] text-slate-500 gap-3">
                                                <span className="flex items-center gap-1"><GripVertical className="w-3 h-3"/> ドラッグで移動</span>
                                                <span className="flex items-center gap-1"><RotateCw className="w-3 h-3"/> 回転</span>
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-2 ml-auto">
                                            {/* Page Number Settings Button */}
                                            <button 
                                                onClick={() => {
                                                    setAddPageNumbers(true); // ボタンを押したらONにする
                                                    setShowPageSettings(!showPageSettings);
                                                }} 
                                                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all ${addPageNumbers ? 'bg-slate-700 border-blue-500/50 text-blue-300' : 'bg-slate-800/50 border-white/5 text-slate-400 hover:bg-slate-700'}`}
                                                title="ページ番号挿入"
                                            >
                                                <Hash className="w-4 h-4" />
                                                <span className="text-xs font-bold hidden md:inline">ページ番号挿入</span>
                                                <Settings className="w-3 h-3 opacity-70" />
                                            </button>

                                            <button onClick={triggerFileSelect} className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                                <Plus className="w-3 h-3" /> 追加
                                            </button>
                                            <button onClick={startProcessing} className="text-xs bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-1.5 rounded-lg shadow-lg shadow-blue-900/20 transition-all flex items-center gap-1">
                                                <Download className="w-3 h-3" /> 保存
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Page Number Settings Panel */}
                                    {showPageSettings && (
                                        <div className="bg-slate-800 border-b border-white/10 p-4 animate-fade-in-up shrink-0 shadow-xl z-20">
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="flex items-center gap-3">
                                                    <h3 className="text-sm font-bold text-white flex items-center gap-2"><Hash className="w-4 h-4 text-blue-400"/> ページ番号詳細設定</h3>
                                                    {/* Toggle Switch moved inside panel */}
                                                    <div className="flex items-center gap-2 bg-black/20 px-2 py-1 rounded-lg">
                                                        <label htmlFor="page-num-toggle" className="text-[10px] text-slate-400 cursor-pointer select-none">有効/無効</label>
                                                        <div className="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                                                            <input type="checkbox" name="page-num-toggle" id="page-num-toggle" checked={addPageNumbers} onChange={(e) => setAddPageNumbers(e.target.checked)} className="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out"/>
                                                            <label htmlFor="page-num-toggle" className={`toggle-label block overflow-hidden h-4 rounded-full cursor-pointer transition-colors duration-300 ${addPageNumbers ? 'bg-blue-600' : 'bg-slate-700'}`}></label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onClick={() => setShowPageSettings(false)} className="text-slate-500 hover:text-white"><X className="w-4 h-4"/></button>
                                            </div>
                                            
                                            {/* Settings Content (Disabled when toggle is off) */}
                                            <div className={`grid grid-cols-2 md:grid-cols-5 gap-4 transition-opacity duration-300 ${!addPageNumbers ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                                                <div className="flex flex-col gap-1">
                                                    <label className="text-[10px] text-slate-400 font-bold">フォーマット</label>
                                                    <select value={pageNumFormat} onChange={(e) => setPageNumFormat(e.target.value)} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none">
                                                        <option value="simple">1</option>
                                                        <option value="hyphen">- 1 -</option>
                                                        <option value="slash_total">1 / 10</option>
                                                        <option value="p_slash_total">1p / 10p</option>
                                                    </select>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <label className="text-[10px] text-slate-400 font-bold">文字サイズ</label>
                                                    <select value={pageNumFontSize} onChange={(e) => setPageNumFontSize(e.target.value)} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none">
                                                        <option value="small">小</option>
                                                        <option value="medium">中</option>
                                                        <option value="large">大</option>
                                                    </select>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <label className="text-[10px] text-slate-400 font-bold">開始ページ (PDF)</label>
                                                    <input type="number" min="1" value={pageNumStartPage} onChange={(e) => setPageNumStartPage(Number(e.target.value))} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none" placeholder="1ページ目から"/>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <label className="text-[10px] text-slate-400 font-bold">開始番号 (No.)</label>
                                                    <input type="number" min="1" value={pageNumStartNum} onChange={(e) => setPageNumStartNum(Number(e.target.value))} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none" placeholder="1から開始"/>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    <label className="text-[10px] text-slate-400 font-bold">表示位置</label>
                                                    <div className="flex gap-2">
                                                        <select value={pageNumPosV} onChange={(e) => setPageNumPosV(e.target.value)} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none flex-1">
                                                            <option value="top">上</option>
                                                            <option value="bottom">下</option>
                                                        </select>
                                                        <select value={pageNumPosH} onChange={(e) => setPageNumPosH(e.target.value)} className="bg-slate-900 border border-white/10 text-xs rounded p-1.5 text-slate-200 focus:border-blue-500 outline-none flex-1">
                                                            <option value="left">左</option>
                                                            <option value="center">中</option>
                                                            <option value="right">右</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Grid Area */}
                                    <div className="flex-1 overflow-y-auto p-2 md:p-4 bg-slate-900/20 scroll-smooth">
                                        {isParsing && (
                                            <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/80 backdrop-blur-sm rounded-b-[2rem]">
                                                <Loader2 className="w-8 h-8 text-blue-400 animate-spin mb-2" />
                                                <p className="text-sm font-bold text-white">ページを展開中...</p>
                                            </div>
                                        )}
                                        <div className="preview-grid pb-20">
                                            {pageItems.map((item, index) => (
                                                <DraggableThumbnail 
                                                    key={item.id}
                                                    pageItem={item}
                                                    index={index}
                                                    onRotate={toggleRotate}
                                                    onDelete={toggleDelete}
                                                    onDragStart={onDragStart}
                                                    onDragEnter={onDragEnter}
                                                    onDragEnd={onDragEnd}
                                                />
                                            ))}
                                            <button onClick={triggerFileSelect} className="flex flex-col items-center justify-center min-h-[150px] border-2 border-dashed border-white/10 rounded-lg text-slate-500 hover:text-blue-300 hover:border-blue-500/30 hover:bg-white/5 transition-all gap-2 group">
                                                <div className="p-3 bg-slate-800/50 rounded-full group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                                    <Plus className="w-6 h-6" />
                                                </div>
                                                <span className="text-xs font-bold">追加</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Drop Zone (Initial or Add) */}
                            {((status === 'idle' && files.length === 0 && pageItems.length === 0)) && (
                                <div 
                                    onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop} onClick={triggerFileSelect}
                                    className={`flex-1 flex flex-col items-center justify-center p-8 md:p-12 text-center cursor-pointer group transition-all duration-300 ${isDragging ? 'bg-blue-500/10' : 'hover:bg-white/5'}`}
                                >
                                    <div className={`w-16 h-16 md:w-20 md:h-20 mb-6 rounded-3xl flex items-center justify-center border border-white/10 transition-all duration-500 ${isDragging ? 'bg-blue-500 text-white scale-110 rotate-3' : 'bg-slate-800/50 text-slate-300 group-hover:scale-105'}`}>
                                        {mode === 'pro_merge' ? <Layers className="w-8 h-8 md:w-10 md:h-10" /> : mode === 'simple_merge' ? <Merge className="w-8 h-8 md:w-10 md:h-10" /> : mode === 'split' ? <Scissors className="w-8 h-8 md:w-10 md:h-10" /> : <Images className="w-8 h-8 md:w-10 md:h-10" />}
                                    </div>
                                    <p className="text-lg md:text-xl font-bold text-slate-200 group-hover:text-white">PDFをここにドロップ</p>
                                    <p className="text-xs text-slate-500 mt-2 px-4 leading-relaxed">
                                        {mode === 'pro_merge' ? '複数ファイル可。全ページを展開して編集できます。' :
                                         mode === 'simple_merge' ? '大量のファイルを高速に結合します。' :
                                         mode === 'split' ? '1つのPDFを分割します。' : '画像を抽出、GIF/PPTX作成。'}
                                    </p>
                                    <p className="md:hidden text-xs text-blue-400 mt-4 font-bold border border-blue-500/30 px-3 py-1 rounded-full">タップしてファイルを選択</p>
                                </div>
                            )}

                             {/* Standard List UI (Simple Merge / Split / Convert) - Only if files selected */}
                             {status === 'idle' && files.length > 0 && mode !== 'pro_merge' && (
                                <div className="flex-1 p-6 flex flex-col">
                                     {/* Split Settings */}
                                    {mode === 'split' && (
                                        <div className="flex justify-center mb-6">
                                            <div className="flex items-center gap-2 bg-slate-800 p-2 rounded-lg border border-white/10">
                                                <span className="text-xs font-bold px-2">分割単位:</span>
                                                <input 
                                                    type="number" min="1" 
                                                    max={totalPages > 0 ? totalPages : undefined}
                                                    value={splitCount} 
                                                    onChange={(e) => {
                                                        let val = parseInt(e.target.value);
                                                        if (isNaN(val)) val = 1;
                                                        if (totalPages > 0 && val > totalPages) val = totalPages;
                                                        setSplitCount(val);
                                                    }}
                                                    className="bg-slate-700 text-blue-300 text-sm rounded px-2 py-1 w-16 text-center focus:outline-none" 
                                                />
                                                <span className="text-xs text-slate-500 px-2">
                                                    / 全{totalPages}p 
                                                    {totalPages > 0 && splitCount > 0 && ` (約${Math.ceil(totalPages/splitCount)}ファイル)`}
                                                </span>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex-1 overflow-y-auto space-y-2 max-h-[40vh] md:max-h-[350px]">
                                        {files.map((f, i) => (
                                            <div key={i} className="flex items-center gap-3 bg-slate-800/60 p-3 rounded-xl border border-white/5">
                                                <FileIcon className="w-4 h-4 text-slate-400 shrink-0"/>
                                                <span className="flex-1 text-sm truncate">{f.name}</span>
                                                <span className="text-[10px] text-slate-500 shrink-0">{getFileSizeMB(f.size)} MB</span>
                                                {mode === 'merge' && (
                                                    <div className="flex gap-1 shrink-0">
                                                        <button onClick={(e)=>{e.stopPropagation();moveFile(i,'up')}} disabled={i===0} className="p-1.5 hover:bg-slate-700 rounded disabled:opacity-30"><ArrowUp className="w-3 h-3"/></button>
                                                        <button onClick={(e)=>{e.stopPropagation();moveFile(i,'down')}} disabled={i===files.length-1} className="p-1.5 hover:bg-slate-700 rounded disabled:opacity-30"><ArrowDown className="w-3 h-3"/></button>
                                                    </div>
                                                )}
                                                <button onClick={(e)=>{e.stopPropagation();removeFile(i)}} className="p-2 hover:bg-red-500/20 hover:text-red-400 rounded-lg transition-colors shrink-0"><Trash2 className="w-4 h-4"/></button>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Simple Merge Add Button */}
                                    {mode === 'simple_merge' && (
                                        <div 
                                            onClick={triggerFileSelect}
                                            onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}
                                            className="mt-4 p-4 border-2 border-dashed border-white/10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:text-white hover:bg-white/5 hover:border-white/20 transition-all cursor-pointer touch-manipulation"
                                        >
                                            <Plus className="w-4 h-4" />
                                            <span className="text-xs font-bold">さらにファイルを追加</span>
                                        </div>
                                    )}

                                    <button onClick={startProcessing} className="w-full mt-6 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition-all transform hover:-translate-y-0.5 active:scale-95">
                                        {mode === 'split' ? '分割を実行' : `結合を実行 (${files.length}件)`}
                                    </button>
                                </div>
                             )}

                            {/* Processing View */}
                            {status === 'processing' && (
                                <div className="flex-1 flex flex-col items-center justify-center p-12 min-h-[300px]">
                                    <div className="relative w-24 h-24 mb-8">
                                        <svg className="w-full h-full rotate-[-90deg]" viewBox="0 0 100 100">
                                            <circle className="text-slate-800/50 stroke-current" strokeWidth="4" cx="50" cy="50" r="46" fill="transparent"></circle>
                                            <circle className={`${mode==='convert' ? 'text-cyan-400' : 'text-blue-400'} stroke-current transition-all duration-300`} strokeWidth="4" strokeLinecap="round" cx="50" cy="50" r="46" fill="transparent" strokeDasharray={`${289.02 * (progress / 100)} 289.02`}></circle>
                                        </svg>
                                        <div className="absolute inset-0 flex items-center justify-center"><span className="text-2xl font-bold text-white">{progress}%</span></div>
                                    </div>
                                    <h3 className="text-lg font-bold text-white mb-8 animate-pulse text-center">{statusMessage}</h3>
                                    <button onClick={cancel} className="text-xs tracking-widest font-bold px-6 py-2 rounded-full border border-white/10 hover:bg-white/10 transition-all text-slate-400 hover:text-white">CANCEL</button>
                                </div>
                            )}

                            {/* Complete View */}
                            {status === 'complete' && (
                                <div className="flex-1 flex flex-col items-center justify-center p-6 md:p-8 w-full max-w-2xl mx-auto animate-fade-in-up">
                                    
                                    {mode === 'convert' ? (
                                        <div className="w-full">
                                            <div className="text-center mb-6">
                                                <div className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-full text-emerald-400 mb-4 backdrop-blur-md">
                                                    <CheckCircle2 className="w-4 h-4" />
                                                    <span className="text-sm font-bold tracking-wide">Ready</span>
                                                </div>
                                                <h2 className="text-xl md:text-2xl font-bold text-white mb-2 line-clamp-1">{files[0]?.name}</h2>
                                                <div className="flex items-center justify-center gap-4 text-sm text-slate-400 font-mono">
                                                    <span className="bg-white/5 px-3 py-1 rounded-md border border-white/5">{generatedImages.length} Slides</span>
                                                    <span className="bg-white/5 px-3 py-1 rounded-md border border-white/5">{getFileSizeMB(resultBlob?.size)} MB</span>
                                                </div>
                                            </div>

                                            {/* Responsive Grid for Convert Options */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                                                {/* PNG ZIP - Full Width on Mobile, Half on PC */}
                                                <button onClick={downloadFile} className="group relative col-span-1 md:col-span-2 p-6 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-cyan-500/30 transition-all duration-300 text-left overflow-hidden shadow-lg">
                                                    <div className="absolute top-0 right-0 p-32 bg-cyan-500/10 rounded-full blur-3xl group-hover:bg-cyan-400/20 transition-all duration-500 translate-x-1/2 -translate-y-1/2"></div>
                                                    <div className="flex items-start justify-between relative z-10">
                                                        <div className="space-y-1">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <div className="p-1.5 bg-cyan-500/20 rounded text-cyan-300 border border-cyan-500/20"><FileArchive className="w-4 h-4" /></div>
                                                                <span className="text-[10px] font-bold text-cyan-300/80 uppercase tracking-wider border border-cyan-500/20 px-2 py-0.5 rounded-full bg-cyan-500/5">Recommended</span>
                                                            </div>
                                                            <h4 className="text-lg md:text-2xl font-bold text-white">PNG Images (ZIP)</h4>
                                                            <p className="text-xs md:text-sm text-slate-400">全ページを高解像度画像として一括保存</p>
                                                        </div>
                                                        <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-cyan-500 group-hover:text-white transition-all border border-white/5 shrink-0"><Download className="w-5 h-5 md:w-6 md:h-6" /></div>
                                                    </div>
                                                </button>

                                                {/* PPTX */}
                                                <button onClick={generatePptx} disabled={pptxStatus === 'processing'} className="group relative p-4 md:p-6 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-orange-500/30 transition-all duration-300 text-left overflow-hidden shadow-lg disabled:opacity-50">
                                                    <div className="flex flex-col h-full justify-between relative z-10 gap-4">
                                                        <div className="flex justify-between items-start">
                                                            <div className="p-2 bg-orange-500/20 rounded-lg text-orange-300 border border-orange-500/20">
                                                                {pptxStatus === 'processing' ? <Loader2 className="w-5 h-5 animate-spin" /> : <Presentation className="w-5 h-5" />}
                                                            </div>
                                                            {pptxStatus === 'complete' ? <div className="text-emerald-400 p-1"><CheckCircle2 className="w-5 h-5" /></div> : <div className="bg-white/5 p-1.5 rounded-full"><Download className="w-4 h-4 text-slate-500" /></div>}
                                                        </div>
                                                        <div>
                                                            <h4 className="text-base md:text-lg font-bold text-white mb-0.5">PowerPoint</h4>
                                                            <p className="text--[10px] text-slate-400">画像貼り付け済みスライド</p>
                                                        </div>
                                                    </div>
                                                </button>

                                                {/* GIF & Long PNG Container - Vertical on Mobile */}
                                                <div className="flex flex-col gap-4">
                                                    {/* GIF */}
                                                    <div className="p-4 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className="p-2 bg-fuchsia-500/20 rounded-lg text-fuchsia-300 border border-fuchsia-500/20">
                                                                {gifStatus === 'processing' ? <Loader2 className="w-4 h-4 animate-spin" /> : <Film className="w-4 h-4" />}
                                                            </div>
                                                            <div className="flex flex-col">
                                                                <h4 className="text-sm font-bold text-white">GIF Animation</h4>
                                                                <select value={gifInterval} onChange={(e) => setGifInterval(Number(e.target.value))} disabled={gifStatus === 'processing'} className="text-[10px] bg-black/30 border border-white/10 rounded mt-1 text-slate-300 w-fit">
                                                                    <option value={0.5}>0.5s</option><option value={1.0}>1.0s</option><option value={2.0}>2.0s</option>
                                                                    <option value={3.0}>3.0s</option><option value={5.0}>5.0s</option>
                                                                    <option value={8.0}>8.0s</option><option value={10.0}>10.0s</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button onClick={generateGif} disabled={gifStatus === 'processing'} className="text-[10px] font-bold bg-white/5 text-slate-300 border border-white/5 px-3 py-2 rounded-full hover:bg-fuchsia-500 hover:text-white transition-all">
                                                            {gifStatus === 'complete' ? 'RETRY' : 'CREATE'}
                                                        </button>
                                                    </div>

                                                    {/* Long PNG */}
                                                    <button onClick={generateLongImage} disabled={longImageStatus === 'processing'} className="p-4 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] flex items-center justify-between text-left disabled:opacity-50">
                                                        <div className="flex items-center gap-3">
                                                            <div className="p-2 bg-blue-500/20 rounded-lg text-blue-300 border border-blue-500/20">
                                                                {longImageStatus === 'processing' ? <Loader2 className="w-4 h-4 animate-spin" /> : <ScrollText className="w-4 h-4" />}
                                                            </div>
                                                            <div>
                                                                <h4 className="text-sm font-bold text-white">Long PNG</h4>
                                                                <p className="text-[10px] text-slate-400">縦読みスクロール</p>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            {longImageStatus === 'complete' ? <div className="text-emerald-400"><CheckCircle2 className="w-5 h-5" /></div> : <div className="bg-white/5 p-1.5 rounded-full"><Download className="w-4 h-4 text-slate-500" /></div>}
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        /* Standard Result */
                                        <div className="w-full max-w-lg text-center">
                                            <div className="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 mb-6 border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.2)] mx-auto"><CheckCircle2 className="w-8 h-8"/></div>
                                            <h2 className="text-2xl font-bold text-white mb-2">完了しました！</h2>
                                            <p className="text-slate-400 mb-8 text-sm">
                                                {mode === 'split' ? `${resultCount}個のファイルを作成しました。` : 'ファイルの処理が正常に終了しました。'}
                                            </p>
                                            <div className="w-full bg-slate-900/50 rounded-xl p-4 border border-white/5 mb-8 flex items-center gap-4 text-left">
                                                <div className="p-3 bg-slate-800 rounded-lg text-blue-400"><FileIcon className="w-6 h-6"/></div>
                                                <div className="flex-1 min-w-0">
                                                    <h4 className="text-white font-medium truncate">{resultName}</h4>
                                                    <p className="text-xs text-slate-500 mt-1">{getFileSizeMB(resultBlob?.size)} MB</p>
                                                </div>
                                                <button onClick={downloadFile} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-all flex items-center gap-2"><Download className="w-4 h-4"/> 保存</button>
                                            </div>
                                        </div>
                                    )}
                                    <button onClick={reset} className="mt-6 text-slate-500 hover:text-white flex items-center gap-2 text-xs font-bold uppercase hover:underline"><RefreshCw className="w-3.5 h-3.5" /> Start Over</button>
                                </div>
                            )}

                             {/* Error View */}
                             {status === 'error' && (
                                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center min-h-[300px]">
                                    <div className="w-16 h-16 bg-red-900/20 border border-red-500/20 text-red-500 rounded-2xl flex items-center justify-center mb-4"><AlertTriangle className="w-8 h-8"/></div>
                                    <h3 className="text-xl font-bold text-slate-200 mb-2">エラーが発生しました</h3>
                                    <p className="text-slate-500 mb-6 text-sm">{errorMsg}</p>
                                    <button onClick={()=>setStatus('idle')} className="px-6 py-2 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all text-sm font-bold">戻る</button>
                                </div>
                            )}

                        </div>
                        
                        <div className="text-center pb-8 pt-4 opacity-40 hover:opacity-100 transition-opacity shrink-0">
                             <p className="text-[10px] md:text-xs font-medium text-slate-600">Powered by <span className="text-blue-600/80">pdf-lib</span> & React. All processing is local.</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

